<!DOCTYPE html>
<html lang="ja">







<head>
  <title>ウェブエンドポイントの認可 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com https://ajax.googleapis.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />

  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/guides/security-authorize-web-endpoints-reference" />
  <meta property="og:title" content="ウェブエンドポイントの認可" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/security-authorize-web-endpoints-reference">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="guides">

  


<div class="grid-wrapper communitysite">
  <div class="grid__item width-12-12">The <a href="https://quarkus.io/guides/security-authorize-web-endpoints-reference">English version of quarkus.io</a> is the official project site. Translated sites are community supported on a best-effort basis.</div>
</div>


  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="#">Why<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/performance" class="">パフォーマンス</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
          <li><a href="/versatility" class="">多用途性</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/spring" class="">USING SPRING?</a></li>
          <li class="tertiarydropdown">
            <span href="#">AI<i class="fas fa-chevron-down"></i></span>
            <ul class="tertiarymenu">
              <li><a href="/ai" class="">AI OVERVIEW</a></li>
              <li><a href="/java-for-ai" class="">JAVA FOR AI</a></li>
              <li><a href="/quarkus-for-ai" class="">WHY QUARKUS FOR AI</a></li>
              <li><a href="/ai-blueprints" class="">AI BLUEPRINTS</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Learn<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ドキュメント</a></li>
          <li><a href="/userstories/" class="">ユーザーストーリー</a></li>  
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="#">Extensions<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
<li><a href="https://quarkus.io/extensions/" class="">エクステンションを探す</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">エクステンションの使用</a></li>
          <li><a href="/guides/writing-extensions" class="">エクステンションの作成</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">エクステンションの共有</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Community<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/working-groups" class="">ワーキンググループ</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ロードマップ</a></li>
          <li><a href="/benefactors" class="">BENEFACTORS</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/guides/security-authorize-web-endpoints-reference" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/guides/security-authorize-web-endpoints-reference">ポルトガル（BR）</a></li>
          <li><a href="https://es.quarkus.io/guides/security-authorize-web-endpoints-reference">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/guides/security-authorize-web-endpoints-reference">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/guides/security-authorize-web-endpoints-reference">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas
fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    







<section class="full-width-version-bg flexfilterbar guides">
  <div class="guideflexcontainer">
    <div class="docslink">
      <a class="returnlink" href="/guides/"> Back to Guides</a>
    </div>
    <div class="flexlabel">
      <label>バージョン:</label>
    </div>
    <div class="guidepulldown version">
    <select id="guide-version-dropdown">
      
        
        
        <option value="main" >Main - SNAPSHOT</option>
        
        
        
        <option value="latest" selected>3.31.3 - Latest</option>
        
        
        
        <option value="3.27" >3.27</option>
        
        
        
        <option value="3.20" >3.20</option>
        
        
        
        <option value="3.15" >3.15</option>
        
        
        
        <option value="3.8" >3.8</option>
        </select>
    </div>
  </div>
</section>

<div class="guide">
  <div class="grid-wrapper">
    <div class="grid__item width-8-12 width-12-12-m">
      
      <a class="editlink" href="https://github.com/quarkusio/quarkus/edit/main/docs/src/main/asciidoc/security-authorize-web-endpoints-reference.adoc">このページを編集</a>
      
      <h1 class="text-caps">ウェブエンドポイントの認可 </h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus には、プラグ可能な Web セキュリティーレイヤーが組み込まれています。
セキュリティーがアクティブな場合、システムはすべての HTTP リクエストに対して権限チェックを実行し、続行するかどうかを決定します。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Jakarta RESTful Web サービスを使用する場合は、HTTP パスレベルのマッチングではなく、 <code>quarkus.security.jaxrs.deny-unannotated-endpoints</code> または <code>quarkus.security.jaxrs.default-roles-allowed</code> を使用して、デフォルトのセキュリティー要件を設定することを検討してください。アノテーションによって、個々のエンドポイントでこれらのプロパティーをオーバーライドできるためです。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>認可は、セキュリティ・プロバイダーが提供するユーザー・ロールに基づきます。これらのロールをカスタマイズするには、
<code>SecurityIdentityAugmentor</code> を作成することができます。
<a href="security-customization.html#security-identity-customization">セキュリティ・アイデンティティのカスタマイズ</a> を参照してください。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authorization-using-configuration"><a class="anchor" href="#authorization-using-configuration"></a>設定を利用した認可</h2>
<div class="sectionbody">
<div class="paragraph">
<p>権限は、Quarkus 設定で権限セットによって定義されます。各権限セットで、アクセス制御用のポリシーを指定します。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When a security policy&#8217;s <code>paths</code> property contains the most specific path that matches the current request path, it takes precedence over other security policies with matching paths and is said to win.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Quarkus ポリシーの概要</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">組込ポリシー</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>deny</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このポリシーは、すべてのユーザーを拒否します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>permit</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このポリシーは、すべてのユーザーを許可します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>authenticated</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このポリシーは、認証されたユーザーのみを許可します。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>特定のロールを持つユーザーにリソースへのアクセスを許可するロールベースのポリシーを定義できます。</p>
</div>
<div class="listingblock">
<div class="title">ロールベースポリシーの例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.policy.role-policy1.roles-allowed=user,admin                  <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>これは、 <code>user</code> ロールと <code>admin</code> ロールを持つユーザーを許可するロールベースのポリシーを定義します。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次の設定例に示すように、 <code>application.properties</code> ファイルで定義されている組み込みの権限セットを設定することで、カスタムポリシーを参照できます。</p>
</div>
<div class="listingblock">
<div class="title">ポリシーの設定例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.permit1.paths=/public/*                            <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.http.auth.permission.permit1.policy=permit
quarkus.http.auth.permission.permit1.methods=GET

quarkus.http.auth.permission.deny1.paths=/forbidden                             <i class="conum" data-value="2"></i><b>(2)</b>
quarkus.http.auth.permission.deny1.policy=deny

quarkus.http.auth.permission.roles1.paths=/roles-secured/*,/other/*,/api/*      <i class="conum" data-value="3"></i><b>(3)</b>
quarkus.http.auth.permission.roles1.policy=role-policy1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>この権限は、デフォルトの組み込み <code>permit</code> ポリシーを参照して、 <code>/public</code> への <code>GET</code> メソッドを許可します。
この場合、このリクエストはいずれにせよ許可されるため、示されている設定によるこの例への影響はありません。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>この権限は、 <code>/forbidden</code> パスと <code>/forbidden/</code> パスの両方に対して組み込みの <code>deny</code> ポリシーを参照します。
これは <code>*</code> で終わっていないため、パスが完マッチします。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>この権限セットは、以前に定義されたポリシーを参照します。
<code>roles1</code> は例の名前です。権限セットには任意の名前を付けることができます。</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上記の例の正確なパスパターン <code>/forbidden</code> は、 <code>/forbidden/</code> パスも保護します。
このようにして、以下の例の <code>forbidden</code> エンドポイントは <code>deny1</code> 権限によって保護されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.crud;

import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;

@Path("/forbidden")
public class ForbiddenResource {
    @GET
    public String forbidden() { <i class="conum" data-value="1"></i><b>(1)</b>
        return "No!";
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>forbidden</code> エンドポイントを保護するには、 <code>/forbidden</code> パスと <code>/forbidden/</code> パスの両方を保護する必要があります。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>/forbidden/</code> パスへのアクセスを許可する必要がある場合は、以下の例のように、より具体的な正確なパスを使用して新しい権限を追加してください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.permit1.paths=/forbidden/ <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.http.auth.permission.permit1.policy=permit</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>/forbidden/</code> パスは保護されていません。</td>
</tr>
</table>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="custom-http-security-policy"><a class="anchor" href="#custom-http-security-policy"></a>カスタムの HttpSecurityPolicy</h3>
<div class="paragraph">
<p>独自の名前付きポリシーを登録すると便利な場合があります。以下の例のように、
<code>io.quarkus.vertx.http.runtime.security.HttpSecurityPolicy</code> インターフェイスを実装するアプリケーションスコープの CDI Bean を作成することでこれを実現できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import jakarta.enterprise.context.ApplicationScoped;

import io.quarkus.security.identity.SecurityIdentity;
import io.quarkus.vertx.http.runtime.security.HttpSecurityPolicy;
import io.smallrye.mutiny.Uni;
import io.vertx.ext.web.RoutingContext;

@ApplicationScoped
public class CustomNamedHttpSecPolicy implements HttpSecurityPolicy {
    @Override
    public Uni&lt;CheckResult&gt; checkPermission(RoutingContext event, Uni&lt;SecurityIdentity&gt; identity,
            AuthorizationRequestContext requestContext) {
        if (customRequestAuthorization(event)) {
            return CheckResult.permit();
        }
        return CheckResult.deny();
    }

    @Override
    public String name() {
        return "custom"; <i class="conum" data-value="1"></i><b>(1)</b>
    }

    private static boolean customRequestAuthorization(RoutingContext event) {
        // here comes your own security check
        return !event.request().path().endsWith("denied");
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>名前付き HTTP セキュリティーポリシーは、 <code>application.properties</code> パスマッチングルールにマッチするリクエストにのみ適用されます。</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">設定ファイルから参照されるカスタム名の HttpSecurityPolicy の例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.custom1.paths=/custom/*
quarkus.http.auth.permission.custom1.policy=custom                              <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>カスタムポリシー名は、 <code>io.quarkus.vertx.http.runtime.security.HttpSecurityPolicy.name</code> メソッドによって返される値とマッチする必要があります。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>または、 <code>@AuthorizationPolicy</code> セキュリティーアノテーションを使用して、カスタム名 HttpSecurityPolicy を Jakarta REST エンドポイントにバインドすることもできます。</p>
</div>
<div id="authorization-policy-example" class="listingblock">
<div class="title">Jakarta REST エンドポイントにバインドされたカスタム名の HttpSecurityPolicy の例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.vertx.http.security.AuthorizationPolicy;
import jakarta.annotation.security.DenyAll;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;

@DenyAll <i class="conum" data-value="1"></i><b>(1)</b>
@Path("hello")
public class HelloResource {

    @AuthorizationPolicy(name = "custom") <i class="conum" data-value="2"></i><b>(2)</b>
    @GET
    public String hello() {
        return "hello";
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@AuthorizationPolicy</code> アノテーションは、他の標準セキュリティーアノテーションと合わせて使用できます。
通常どおり、メソッドレベルのアノテーションはクラスレベルのアノテーションよりも優先されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>カスタム名の HttpSecurityPolicy を Jakarta REST <code>hello</code> エンドポイントに適用します。</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>すべてのリクエストで呼び出されるグローバル <code>HttpSecurityPolicy</code> を作成することもできます。
<code>io.quarkus.vertx.http.runtime.security.HttpSecurityPolicy.name</code> メソッドを実装せず、ポリシーに名前を付けないままにします。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="policy-active-cdi-request-context"><a class="anchor" href="#policy-active-cdi-request-context"></a><code>@RequestScoped</code> Bean の <code>HttpSecurityPolicy</code> への挿入</h3>
<div class="paragraph">
<p><code>@RequestScoped</code> beans can only be injected when the <a href="cdi-reference#request-context-lifecycle">CDI request context</a> is active.
The context can be activated by users, for example with the <code>@ActivateRequestContext</code>, however authorization happens before Quarkus prepares some <code>@RequestScoped</code> beans.
We recommend to let Quarkus activate and prepare CDI request context for you.
For example, consider a situation where you want to inject a bean from the Jakarta REST context, such as the <code>jakarta.ws.rs.core.UriInfo</code> bean.
In this case, you must apply the <code>HttpSecurityPolicy</code> to Jakarta REST endpoints. This can be achieved in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the <code>@AuthorizationPolicy</code> security annotation.</p>
</li>
<li>
<p>Set the <code>quarkus.http.auth.permission.custom1.applies-to=jaxrs</code> configuration property.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="matching-on-paths-and-methods"><a class="anchor" href="#matching-on-paths-and-methods"></a>パスとメソッドのマッチング</h3>
<div class="paragraph">
<p>権限セットでは、パスとメソッドをコンマ区切りのリストとして指定することもできます。
パスが <code>*</code> ワイルドカードで終わる場合、生成されるクエリーはすべてのサブパスにマッチします。
それ以外の場合は、完全一致を照会し、特定のパスにのみマッチします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.permit1.paths=/public*,/css/*,/js/*,/robots.txt    <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.http.auth.permission.permit1.policy=permit
quarkus.http.auth.permission.permit1.methods=GET,HEAD</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>パスの末尾にある <code>*</code> ワイルドカードは、0 個以上のパスセグメントにマッチしますが、 <code>/public</code> パスから始まる単語にはマッチしません。
そのため、 <code>/public-info</code> のようなパスはこのパターンとはマッチしません。</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="matching-a-path-but-not-a-method"><a class="anchor" href="#matching-a-path-but-not-a-method"></a>パスはマッチするがメソッドはマッチしない場合</h3>
<div class="paragraph">
<p>パスに基づいて 1 つ以上の権限セットにマッチしても、必要なメソッドのいずれにもマッチしない場合、リクエストは拒否されます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上記の権限セットが与えられている場合、 <code>GET/public/foo</code> はパスとメソッドの両方にマッチするため、許可されます。
対照的に、 <code>POST/public/foo</code> はパスにマッチしますが、メソッドにはマッチしないため、拒否されます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="matching-multiple-paths"><a class="anchor" href="#matching-multiple-paths"></a>複数のパスのマッチング:一番長いパスが勝ちます。</h3>
<div class="paragraph">
<p>マッチングは常に「最長パスが優先される」という基準で行われます。
具体的な権限セットがマッチした場合、それよりも具体性に欠ける権限セットは考慮されません。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.permit1.paths=/public/*
quarkus.http.auth.permission.permit1.policy=permit
quarkus.http.auth.permission.permit1.methods=GET,HEAD

quarkus.http.auth.permission.deny1.paths=/public/forbidden-folder/*
quarkus.http.auth.permission.deny1.policy=deny</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>上記の権限セットの場合、 <code>GET/public/forbidden-folder/foo</code> は両方の権限セットのパスとマッチします。
ただし、より長いパスが <code>deny1</code> 権限セットのパスとマッチするため、 <code>deny1</code> が選択され、リクエストは拒否されます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>前述の <code>deny1</code> 権限と <code>permit1</code> 権限の例で示したように、サブパスの権限がルートパスの権限よりも優先されます。</p>
</div>
<div class="paragraph">
<p>このルールをさらに例示するために、サブパス権限ではパブリックリソースへのアクセスを許可し、ルートパス権限では認可を要求するシナリオを示します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.policy.user-policy.roles-allowed=user
quarkus.http.auth.permission.roles.paths=/api/*
quarkus.http.auth.permission.roles.policy=user-policy

quarkus.http.auth.permission.public.paths=/api/noauth/*
quarkus.http.auth.permission.public.policy=permit</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="matching-multiple-sub-paths-longest-path-to-the-wildcard-wins"><a class="anchor" href="#matching-multiple-sub-paths-longest-path-to-the-wildcard-wins"></a>複数のサブパスのマッチング: <code>*</code> ワイルドカードへの最長パスが優先される</h3>
<div class="paragraph">
<p>前の例では、パスの末尾が <code>*</code> ワイルドカードの場合に、すべてのサブパスがマッチすることを
示しました。</p>
</div>
<div class="paragraph">
<p>This wildcard can also be applied in the middle of a path, representing a single path segment.
It cannot be mixed with other path segment characters; thus, path separators always enclose the <code>*</code> wildcard, as seen in the <code>/public/*/about-us</code> path.</p>
</div>
<div class="paragraph">
<p>複数のパスパターンが同じリクエストパスに対応する場合、システムは <code>*</code> ワイルドカードにつながる最長のサブパスを選択します。
この文脈では、すべてのパスセグメント文字は、 <code>*</code> ワイルドカード
よりも具体的になります。</p>
</div>
<div class="paragraph">
<p>簡単な例を挙げてみます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.secured.paths=/api/*/detail                    <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.http.auth.permission.secured.policy=authenticated
quarkus.http.auth.permission.public.paths=/api/public-product/detail        <i class="conum" data-value="2"></i><b>(2)</b>
quarkus.http.auth.permission.public.policy=permit</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>/api/product/detail</code> などのリクエストパスには、認証済みユーザーのみがアクセスできます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>パス <code>/api/public-product/detail</code> はより詳細であるため、どのユーザーもアクセスできます。</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>設定を使用した認可で保護されたすべてのパスをテストする必要があります。
複数のワイルドカードを使用してパスパターンを記述するのは面倒な場合があります。
パスが意図したとおりに認可されていることを確認してください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次の例では、パスは最も詳細なものから最も詳細でないものの順に並べられています。</p>
</div>
<div class="listingblock">
<div class="title">最も詳細なパスから最も詳細でないパスの順に並べたリクエストパス <code>/one/two/three/four/five</code> のマッチ</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">/one/two/three/four/five
/one/two/three/four/*
/one/two/three/*/five
/one/two/three/*/*
/one/two/*/four/five
/one/*/three/four/five
/*/two/three/four/five
/*/two/three/*/five
/*</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>パスの末尾にある <code>*</code> ワイルドカードは、0 個以上のパスセグメントにマッチします。
他の場所に配置された <code>*</code> ワイルドカードは、1 つのパスセグメントのみにマッチします。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="matching-multiple-paths-most-specific-method-wins"><a class="anchor" href="#matching-multiple-paths-most-specific-method-wins"></a>複数のパスのマッチング:一番具体的なパスが勝ちます</h3>
<div class="paragraph">
<p>パスが複数の権限セットに登録されている場合、リクエストにマッチする HTTP メソッドを明示的に指定する権限セットが優先されます。
この場合、メソッドのない権限セットは、リクエストメソッドがメソッド仕様を持つ権限セットとマッチしない場合にのみ、有効になります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.permit1.paths=/public/*
quarkus.http.auth.permission.permit1.policy=permit
quarkus.http.auth.permission.permit1.methods=GET,HEAD

quarkus.http.auth.permission.deny1.paths=/public/*
quarkus.http.auth.permission.deny1.policy=deny</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The preceding permission set shows that <code>GET /public/foo</code> matches the paths of both permission sets.However, it specifically aligns with the explicit method of the <code>permit1</code> permission set. Therefore, <code>permit1</code> is selected, and the request is accepted.</p>
</div>
<div class="paragraph">
<p>一方、 <code>PUT/public/foo</code> は <code>permit1</code> のメソッド権限とマッチしません。その結果、 <code>deny1</code> がアクティブになり、リクエストが拒否されます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="matching-multiple-paths-and-methods-both-win"><a class="anchor" href="#matching-multiple-paths-and-methods-both-win"></a>複数のパスのマッチング:一番長いパスが勝ちます</h3>
<div class="paragraph">
<p>場合によっては、前述のルールにより、複数の権限セットが同時に適用されることがあります。
その場合、リクエストを続行するには、すべての権限でアクセスが許可されている必要があります。
そのためには、両方にメソッドが指定されているか、メソッドが存在しない必要があります。
メソッド固有のマッチが優先されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.policy.user-policy1.roles-allowed=user
quarkus.http.auth.policy.admin-policy1.roles-allowed=admin

quarkus.http.auth.permission.roles1.paths=/api/*,/restricted/*
quarkus.http.auth.permission.roles1.policy=user-policy1

quarkus.http.auth.permission.roles2.paths=/api/*,/admin/*
quarkus.http.auth.permission.roles2.policy=admin-policy1</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
上記の権限セットの場合、 <code>GET /api/foo</code> は両方の権限セットのパスにマッチするため、 <code>user</code> と <code>admin</code> の両方のロールが必要です。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configuration-properties-to-deny-access"><a class="anchor" href="#configuration-properties-to-deny-access"></a>アクセスを拒否するための設定プロパティ</h3>
<div class="paragraph">
<p>以下の設定により、ロールベースアクセスコントロール（RBAC）の拒否動作が変更されます:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>quarkus.security.jaxrs.deny-unannotated-endpoints=true|false</code></dt>
<dd>
<p>true に設定すると、すべての Jakarta REST エンドポイントへのアクセスがデフォルトで拒否されます。
Jakarta REST エンドポイントにセキュリティーアノテーションがない場合、デフォルトで <code>@DenyAll</code> 動作になります。
これにより、保護されているはずのエンドポイントが誤って公開されることを回避できます。
デフォルトは <code>false</code> です。</p>
</dd>
<dt class="hdlist1"><code>quarkus.security.jaxrs.default-roles-allowed=role1,role2</code></dt>
<dd>
<p>アノテーションのないエンドポイントのデフォルトのロール要件を定義します。
<code>**</code> ロールは、認証されたすべてのユーザーを意味する特別なロールです。
代わりに <code>deny</code> が有効になるため、これを <code>deny-unannotated-endpoints</code> と組み合わせることはできません。</p>
</dd>
<dt class="hdlist1"><code>quarkus.security.deny-unannotated-members=true|false</code></dt>
<dd>
<p>true に設定すると、セキュリティーアノテーションを持たないが、セキュリティーアノテーションを持つメソッドを含むクラスで定義されているすべての CDI メソッドと Jakarta REST エンドポイントへのアクセスが拒否されます。
デフォルトは <code>false</code> です。</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="disabling-permissions"><a class="anchor" href="#disabling-permissions"></a>権限の無効化</h3>
<div class="paragraph">
<p>権限は、宣言された各権限の <code>enabled</code> プロパティを使って、ビルド時に次のように無効にすることができます:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.permit1.enabled=false
quarkus.http.auth.permission.permit1.paths=/public/*,/css/*,/js/*,/robots.txt
quarkus.http.auth.permission.permit1.policy=permit
quarkus.http.auth.permission.permit1.methods=GET,HEAD</code></pre>
</div>
</div>
<div class="paragraph">
<p>権限は、システムプロパティや環境変数を使って実行時に再有効化することができます（例えば、以下のように）: <code>-Dquarkus.http.auth.permission.permit1.enabled=true</code> .</p>
</div>
</div>
<div class="sect2">
<h3 id="permission-paths-and-http-root-path"><a class="anchor" href="#permission-paths-and-http-root-path"></a>権限パスとHTTPルートパス</h3>
<div class="paragraph">
<p><code>quarkus.http.root-path</code> 設定プロパティは、 <a href="http-reference#context-path">http endpoint context path</a> を変更します。</p>
</div>
<div class="paragraph">
<p>デフォルトでは、設定された権限のパスの前に自動的に <code>quarkus.http.root-path</code> 、フォワードスラッシュを使用しない場合などです。 :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.permit1.paths=public/*,css/*,js/*,robots.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>この構成は以下に相当します。 :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.permit1.paths=${quarkus.http.root-path}/public/*,${quarkus.http.root-path}/css/*,${quarkus.http.root-path}/js/*,${quarkus.http.root-path}/robots.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>先頭のスラッシュは、設定された権限パスの解釈方法を変更します。
設定された URL はそのまま使用され、 <code>quarkus.http.root-path</code> の値が変更されてもパスは調整されません。</p>
</div>
<div class="listingblock">
<div class="title">以下に例を示します。</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.permit1.paths=/public/*,css/*,js/*,robots.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>この設定は、固定または静的 URL <code>/public</code> から提供されるリソースにのみ影響します。この URL は、 <code>quarkus.http.root-path</code> が <code>/</code> 以外に設定されていると、アプリケーションリソースとマッチしない可能性があります。</p>
</div>
<div class="paragraph">
<p>詳細は、<a href="https://quarkus.io/blog/path-resolution-in-quarkus/">Path Resolution in Quarkus</a> を参照してください。</p>
</div>
</div>
<div class="sect2">
<h3 id="map-security-identity-roles"><a class="anchor" href="#map-security-identity-roles"></a><code>SecurityIdentity</code> ロールのマッピング</h3>
<div class="paragraph">
<p>The winning role-based policy that was chosen to authorize the current request can map <code>SecurityIdentity</code> roles to deployment-specific roles.
These roles are then applicable for endpoint authorization by using the <code>@RolesAllowed</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.policy.admin-policy1.roles.admin=Admin1 <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.http.auth.permission.roles1.paths=/* <i class="conum" data-value="2"></i><b>(2)</b>
quarkus.http.auth.permission.roles1.policy=admin-policy1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>admin</code> ロールを <code>Admin1</code> ロールにマップします。 <code>SecurityIdentity</code> には <code>admin</code> ロールと <code>Admin1</code> ロールの両方が存在します。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>/*</code> パスは保護されており、認証された HTTP リクエストのみにアクセスが許可されます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>パスに関係なく、 <code>SecurityIdentity</code> ロールをデプロイメント固有のロールにマッピングするだけの場合は、次のようにすることもできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.roles-mapping.admin=Admin1 <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>admin</code> ロールを <code>Admin1</code> ロールにマップします。 <code>SecurityIdentity</code> には <code>admin</code> ロールと <code>Admin1</code> ロールの両方が存在します。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>/*</code> パスは保護されていません。標準のセキュリティーアノテーションを使用してエンドポイントを保護するか、この設定プロパティーに加えて HTTP 権限を定義する必要があります。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you prefer a programmatic configuration, the same mapping can be added with the <code>io.quarkus.vertx.http.security.HttpSecurity</code> CDI event:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.http.security;

import io.quarkus.vertx.http.security.HttpSecurity;
import jakarta.enterprise.event.Observes;

public class HttpSecurityConfiguration {

    void configure(@Observes HttpSecurity httpSecurity) {
        httpSecurity.rolesMapping("admin", "Admin1");
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="shared-permission-checks"><a class="anchor" href="#shared-permission-checks"></a>共有権限チェック</h3>
<div class="paragraph">
<p>One important rule for unshared permission checks is that only one path match is applied, the most specific one.
When a path matches as the most specific, you can specify multiple permissions for that path and they are all applied.
However, there can be permission checks you want to apply to many paths without repeating them over and over again.
That&#8217;s where shared permission checks come in, they are always applied when the permission path is matched.</p>
</div>
<div class="listingblock">
<div class="title">すべての HTTP リクエストに適用されるカスタム名の HttpSecurityPolicy の例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.custom1.paths=/*
quarkus.http.auth.permission.custom1.shared=true    <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.http.auth.permission.custom1.policy=custom

quarkus.http.auth.policy.admin-policy1.roles-allowed=admin
quarkus.http.auth.permission.roles1.paths=/admin/*
quarkus.http.auth.permission.roles1.policy=admin-policy1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="#custom-http-security-policy">カスタムの HttpSecurityPolicy</a> は、 <code>admin-policy1</code> ポリシーとともに <code>/admin/1</code> パスにも適用されます。</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
共有権限チェックを多数設定することは、共有されていない権限チェックを設定する場合よりも効果が低くなります。
以下の例のように、共有権限を使用して非共有権限チェックを補完します。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">共有権限を持つ <code>SecurityIdentity</code> ロールのマッピング</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.policy.role-policy1.roles.root=admin,user <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.http.auth.permission.roles1.paths=/secured/*        <i class="conum" data-value="2"></i><b>(2)</b>
quarkus.http.auth.permission.roles1.policy=role-policy1
quarkus.http.auth.permission.roles1.shared=true

quarkus.http.auth.policy.role-policy2.roles-allowed=user    <i class="conum" data-value="3"></i><b>(3)</b>
quarkus.http.auth.permission.roles2.paths=/secured/user/*
quarkus.http.auth.permission.roles2.policy=role-policy2

quarkus.http.auth.policy.role-policy3.roles-allowed=admin
quarkus.http.auth.permission.roles3.paths=/secured/admin/*
quarkus.http.auth.permission.roles3.policy=role-policy3</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ロール <code>root</code> は、 <code>/secured/user/*</code> および <code>/secured/admin/*</code> パスにアクセスできるようになります。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>/secured/*</code> パスには、認証されたユーザーのみがアクセスできます。このようにして、 <code>/secured/all</code> パスなどが保護されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>共有権限は常に非共有権限の前に適用されるため、 <code>root</code> ロールを持つ <code>SecurityIdentity</code> には <code>user</code> ロールも付与されます。</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="path-specific-authz-programmatic-set-up"><a class="anchor" href="#path-specific-authz-programmatic-set-up"></a>Set up path-specific authorization programmatically</h3>
<div class="paragraph">
<p>You can also configure the authorization policies presented by this guide so far programmatically.
Consider the example mentioned earlier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.permit1.paths=/public/*
quarkus.http.auth.permission.permit1.policy=permit
quarkus.http.auth.permission.permit1.methods=GET

quarkus.http.auth.permission.deny1.paths=/forbidden
quarkus.http.auth.permission.deny1.policy=deny

quarkus.http.auth.permission.roles1.paths=/roles-secured/*,/other/*,/api/*
quarkus.http.auth.permission.roles1.policy=role-policy1
quarkus.http.auth.policy.role-policy1.roles-allowed=user,admin</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same authorization policies can be configured programmatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.http.security;

import jakarta.enterprise.event.Observes;

import io.quarkus.vertx.http.security.HttpSecurity;

public class HttpSecurityConfiguration {

    void configure(@Observes HttpSecurity httpSecurity) {
        httpSecurity
                .get("/public/*").permit()
                .path("/roles-secured/*", "/other/*", "/api/*").roles("admin", "user")
                .path("/forbidden").authorization().deny();
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, the <code>io.quarkus.vertx.http.security.HttpSecurity</code> CDI event can be used to configure specific authentication mechanisms and policies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.http.security;

import io.quarkus.vertx.http.security.HttpSecurity;
import jakarta.enterprise.event.Observes;
import org.eclipse.microprofile.config.inject.ConfigProperty;

public class HttpSecurityConfiguration {

    void configure(@Observes HttpSecurity httpSecurity, CustomHttpSecurityPolicy customHttpSecurityPolicy,
                        @ConfigProperty(name = "secured-path") String securedPath) {

        httpSecurity.path("/other/*").basic().policy(customHttpSecurityPolicy); <i class="conum" data-value="1"></i><b>(1)</b>

        httpSecurity.path("/roles-secured/*").bearer().authorization()
                .policy(identity -&gt; identity.hasRole("user") || "root".equals(identity.getPrincipal().getName()));  <i class="conum" data-value="2"></i><b>(2)</b>

        httpSecurity.path("/other/administration").authorizationCodeFlow()
                .authorization().policy((identity, routingContext) -&gt; {
                    if (!identity.isAnonymous()) {
                        String customAuthorization = routingContext.request().getHeader("Custom Authorization");
                        return yourCustomAuthorizationCheck(customAuthorization);
                    }
                    return false;
                });     <i class="conum" data-value="3"></i><b>(3)</b>

        httpSecurity.path(securedPath).form();  <i class="conum" data-value="4"></i><b>(4)</b>

        httpSecurity.path("/user-info").bearer().authorization().permissions("openid", "email", "profile"); <i class="conum" data-value="5"></i><b>(5)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the Basic authentication and authorize the requests with a custom <code>io.quarkus.vertx.http.runtime.security.HttpSecurityPolicy</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the Bearer token authentication and authorize the <code>SecurityIdentity</code> with your own policy.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use Authorization Code Flow mechanism and write your own policy based on incoming request headers.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>When Quarkus fires the <code>HttpSecurity</code> CDI event, the runtime configuration is ready.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Require that all the requests to the <code>/user-info</code> path have string permissions <code>openid</code>, <code>email</code> and <code>profile</code>.
The same authorization can be required with the <code>@PermissionsAllowed(value = { "openid", "email", "profile" }, inclusive = true)</code> annotation instance placed on an endpoint.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="programmatic-set-up-references"><a class="anchor" href="#programmatic-set-up-references"></a>Programmatic set up references</h4>
<div class="ulist">
<ul>
<li>
<p><a href="security-basic-authentication#basic-auth-programmatic-set-up">Set up Basic authentication programmatically</a></p>
</li>
<li>
<p><a href="security-openid-connect-multitenancy#programmatic-startup">Programmatic OIDC start-up for multitenant application</a></p>
</li>
<li>
<p><a href="security-authentication-mechanisms#form-based-auth-programmatic-set-up">Set up Form-based authentication programmatically</a></p>
</li>
<li>
<p><a href="security-authentication-mechanisms#mtls-programmatic-set-up">Set up the mutual TLS client authentication programmatically</a></p>
</li>
<li>
<p><a href="security-cors#cors-filter-programmatic-set-up">Configuring the CORS filter programmatically</a></p>
</li>
<li>
<p><a href="security-csrf-prevention#csrf-prevention-programmatic-set-up">Configuring the CSRF prevention programmatically</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="standard-security-annotations"><a class="anchor" href="#standard-security-annotations"></a>アノテーションを使った認可</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus には、REST エンドポイントと CDI Bean 上の共通セキュリティーアノテーション <code>@RolesAllowed</code>、 <code>@DenyAll</code>、 <code>@PermitAll</code> に基づく <a href="https://en.wikipedia.org/wiki/Role-based_access_control">Role-Based Access Control (RBAC)</a> を可能にするセキュリティーが組み込まれています。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Authorization checks for <code>quarkus.http.auth.</code> configurations are performed before security checks for standard security annotations.
Therefore, <code>@PermitAll</code> only permits access to paths that are not already restricted by HTTP permissions.
<code>@PermitAll</code> cannot override HTTP-level security configurations, only relax restrictions imposed by other standard security annotations such as <code>@RolesAllowed</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Quarkus アノテーションの種類の概要</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">アノテーション型</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>@DenyAll</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">どのセキュリティロールも指定されたメソッドを呼び出すことを許可されていないことを指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>@PermitAll</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">すべてのセキュリティロールが指定されたメソッドを呼び出すことを許可されるように指定します。</p>
<p class="tableblock"><code>@PermitAll</code> は認証なしでも誰でもアクセスできるようにします。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>@RolesAllowed</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">アプリケーション内のメソッドへのアクセスを許可するセキュリティーロールのリストを指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>@Authenticated</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Quarkus は、認証されたすべてのユーザーがリソースにアクセスできるようにする <code>io.quarkus.security.Authenticated</code> アノテーションを提供します。これは <code>@RolesAllowed ("**")</code> と同等です。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>@PermissionsAllowed</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">指定されたメソッドを呼び出すことが許可される権限のリストを指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>@AuthorizationPolicy</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">指定された Jakarta REST エンドポイントへのアクセスを許可する名前付き <code>io.quarkus.vertx.http.runtime.security.HttpSecurityPolicy</code> を指定します。
<a href="#authorization-policy-example">Jakarta REST エンドポイントにバインドされたカスタム名の HttpSecurityPolicy の例</a> で例示されているように、名前付き HttpSecurityPolicy は、一般的な認可チェックに使用できます。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>次の <a href="#subject-example">SubjectExposingResourceの例</a> は、エンドポイントを記述および保護するために Jakarta REST と Common Security アノテーションの両方を使用するエンドポイントを示します。</p>
</div>
<div id="subject-example" class="listingblock">
<div class="title">SubjectExposingResourceの例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import java.security.Principal;

import jakarta.annotation.security.DenyAll;
import jakarta.annotation.security.PermitAll;
import jakarta.annotation.security.RolesAllowed;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.core.Context;
import jakarta.ws.rs.core.SecurityContext;

@Path("subject")
public class SubjectExposingResource {

    @GET
    @Path("secured")
    @RolesAllowed("Tester") <i class="conum" data-value="1"></i><b>(1)</b>
    public String getSubjectSecured(@Context SecurityContext sec) {
        Principal user = sec.getUserPrincipal(); <i class="conum" data-value="2"></i><b>(2)</b>
        String name = user != null ? user.getName() : "anonymous";
        return name;
    }

    @GET
    @Path("authenticated")
    @Authenticated <i class="conum" data-value="3"></i><b>(3)</b>
    public String getSubjectAuthenticated(@Context SecurityContext sec) {
        Principal user = sec.getUserPrincipal();
        String name = user != null ? user.getName() : "anonymous";
        return name;
    }

    @GET
    @Path("unsecured")
    @PermitAll <i class="conum" data-value="4"></i><b>(4)</b>
    public String getSubjectUnsecured(@Context SecurityContext sec) {
        Principal user = sec.getUserPrincipal(); <i class="conum" data-value="5"></i><b>(5)</b>
        String name = user != null ? user.getName() : "anonymous";
        return name;
    }

    @GET
    @Path("denied")
    @DenyAll <i class="conum" data-value="6"></i><b>(6)</b>
    public String getSubjectDenied(@Context SecurityContext sec) {
        Principal user = sec.getUserPrincipal();
        String name = user != null ? user.getName() : "anonymous";
        return name;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>/subject/secured</code> エンドポイントは、 <code>@RolesAllowed("Tester")</code> アノテーションを使用して"Tester"というロールを付与された認証済みユーザーが必要です。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>エンドポイントは、Jakarta REST <code>SecurityContext</code> からユーザープリンシパルを取得します。
これは、保護されたエンドポイントに対して <code>non-null</code> を返します。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>/subject/authenticated</code> エンドポイントでは、 <code>@Authenticated</code> アノテーションを指定して、認証されたすべてのユーザーを許可します。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>/subject/unsecured</code> エンドポイントでは、 <code>@PermitAll</code> アノテーションを指定することで、認証されていないアクセスが可能になります。</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>ユーザープリンシパルを取得するためのこの呼び出しは、呼び出し元が認証されていない場合は <code>null</code> を返し、呼び出し元が認証されている場合は <code>non-null</code> を返します。</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>/subject/denied</code> エンドポイントは <code>@DenyAll</code> アノテーションを宣言し、ユーザーが呼び出すかどうかに関係なく、REST メソッドとしてのすべての直接アクセスを禁止します。
このメソッドは、このクラスの他のメソッドによって引き続き内部的に呼び出すことができます。</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>IO スレッドで標準のセキュリティーアノテーションを使用する予定の場合は、<a href="security-proactive-authentication">Proactive Authentication</a> の情報を確認してください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>@RolesAllowed</code> アノテーション値は、デフォルト値とネストされたプロパティー式を含む <a href="config-reference#property-expressions">property expressions</a> をサポートします。
アノテーションで使用される設定プロパティーは実行時に解決されます。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. アノテーション値の例</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">アノテーション</th>
<th class="tableblock halign-left valign-top">値の説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>@RolesAllowed("${admin-role}")</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">エンドポイントは、 <code>admin-role</code> プロパティーの値によって示されるロールを持つユーザーを許可します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>@RolesAllowed("${tester.group}-${tester.role}")</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">値が複数の変数を含むことができることを示す例。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>@RolesAllowed("${customer:User}")</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">デフォルト値のデモンストレーション。
必要なロールは、 <code>customer</code> プロパティーの値によって示されます。
ただし、そのプロパティーが指定されていない場合は、デフォルトで <code>User</code> という名前のロールが必要になります。</p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="title"><code>@RolesAllowed</code> アノテーションにおけるプロパティ式の使用例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">admin=Administrator
tester.group=Software
tester.role=Tester
%prod.secured=User
%dev.secured=**
all-roles=Administrator,Software,Tester,User</code></pre>
</div>
</div>
<div id="subject-access-control-example" class="listingblock">
<div class="title">サブジェクトアクセス制御の例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import java.security.Principal;

import jakarta.annotation.security.RolesAllowed;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.core.Context;
import jakarta.ws.rs.core.SecurityContext;

@Path("subject")
public class SubjectExposingResource {

    @GET
    @Path("admin")
    @RolesAllowed("${admin}") <i class="conum" data-value="1"></i><b>(1)</b>
    public String getSubjectSecuredAdmin(@Context SecurityContext sec) {
        return getUsername(sec);
    }

    @GET
    @Path("software-tester")
    @RolesAllowed("${tester.group}-${tester.role}") <i class="conum" data-value="2"></i><b>(2)</b>
    public String getSubjectSoftwareTester(@Context SecurityContext sec) {
        return getUsername(sec);
    }

    @GET
    @Path("user")
    @RolesAllowed("${customer:User}") <i class="conum" data-value="3"></i><b>(3)</b>
    public String getSubjectUser(@Context SecurityContext sec) {
        return getUsername(sec);
    }

    @GET
    @Path("secured")
    @RolesAllowed("${secured}") <i class="conum" data-value="4"></i><b>(4)</b>
    public String getSubjectSecured(@Context SecurityContext sec) {
        return getUsername(sec);
    }

    @GET
    @Path("list")
    @RolesAllowed("${all-roles}") <i class="conum" data-value="5"></i><b>(5)</b>
    public String getSubjectList(@Context SecurityContext sec) {
        return getUsername(sec);
    }

    private String getUsername(SecurityContext sec) {
        Principal user = sec.getUserPrincipal();
        String name = user != null ? user.getName() : "anonymous";
        return name;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@RolesAllowed</code> アノテーション値は、 <code>Administrator</code> の値に設定されています。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>この <code>/subject/software-tester</code> エンドポイントには、"Software-Tester" のロールが付与された認証済みユーザーが必要です。
ロール定義では複数の式を使用できます。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>この <code>/subject/user</code> エンドポイントには、 <code>@RolesAllowed("${customer:User}")</code> アノテーションを使用して "User" ロールが付与された認証済みユーザーが必要です。これは、設定プロパティー <code>customer</code> を設定しなかったためです。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>実稼働環境では、この <code>/subject/secured</code> エンドポイントには <code>User</code> ロールを持つ認証済みユーザーが必要です。
開発モードでは、認証されたすべてのユーザーが許可されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>プロパティー式 <code>all-roles</code> は、コレクション型 <code>List</code> として扱われます。そのため、このエンドポイントには、 <code>Administrator</code>、 <code>Software</code>、 <code>Tester</code> および <code>User</code> の各ロールがアクセスできるようになります。</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="endpoint-security-annotations-and-jakarta-rest-inheritance"><a class="anchor" href="#endpoint-security-annotations-and-jakarta-rest-inheritance"></a>エンドポイントセキュリティーアノテーションと Jakarta REST 継承</h3>
<div class="paragraph">
<p>Quarkus は、次の例のように、エンドポイント実装またはそのクラスに配置されたセキュリティーアノテーションをサポートしています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Path("hello")
public interface HelloInterface {

    @GET
    String hello();

}

@DenyAll <i class="conum" data-value="1"></i><b>(1)</b>
public class HelloInterfaceImpl implements HelloInterface {

    @RolesAllowed("admin") <i class="conum" data-value="2"></i><b>(2)</b>
    @Override
    public String hello() {
        return "Hello";
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>クラスレベルのセキュリティーアノテーションは、エンドポイント実装が宣言されているクラスに配置する必要があります。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>メソッドレベルのセキュリティーアノテーションはエンドポイント実装に配置する必要があります。</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>デフォルトのインターフェイスメソッドとして宣言された <a href="resteasy">RESTEasy</a> サブリソースロケーターは
標準のセキュリティーアノテーションでは保護できません
保護されたサブリソースロケーターは、次の例のように、インターフェイス実装者に実装され、保護される必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Path("hello")
public interface HelloInterface {

    @RolesAllowed("admin")
    @Path("sub")
    default HelloSubResource wrongWay() {
        // not supported
    }

    @Path("sub")
    HelloSubResource rightWay();

}

public class HelloInterfaceImpl implements HelloInterface {

    @RolesAllowed("admin")
    @Override
    public HelloSubResource rightWay() {
        return new HelloSubResource();
    }
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="permission-annotation"><a class="anchor" href="#permission-annotation"></a>権限アノテーション</h3>
<div class="paragraph">
<p>Quarkus は、指定された権限を持つ認証済みユーザーにリソースへのアクセスを認可する <code>io.quarkus.security.PermissionsAllowed</code> アノテーションも提供します。
このアノテーションは、一般的なセキュリティーアノテーションのエクステンションであり、 <code>SecurityIdentity</code> インスタンスに付与された権限をチェックします。</p>
</div>
<div class="listingblock">
<div class="title"><code>@PermissionsAllowed</code> アノテーションで保護されたエンドポイントの例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.crud;

import io.quarkus.arc.Arc;
import io.vertx.ext.web.RoutingContext;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.POST;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.QueryParam;

import io.quarkus.security.PermissionsAllowed;

import java.security.BasicPermission;
import java.security.Permission;
import java.util.Collection;
import java.util.Collections;

@Path("/crud")
public class CRUDResource {

    @PermissionsAllowed("create") <i class="conum" data-value="1"></i><b>(1)</b>
    @PermissionsAllowed("update")
    @POST
    @Path("/modify/repeated")
    public String createOrUpdate() {
        return "modified";
    }

    @PermissionsAllowed(value = {"create", "update"}, inclusive=true) <i class="conum" data-value="2"></i><b>(2)</b>
    @POST
    @Path("/modify/inclusive")
    public String createOrUpdate(Long id) {
        return id + " modified";
    }

    @PermissionsAllowed({"see:detail", "see:all", "read"}) <i class="conum" data-value="3"></i><b>(3)</b>
    @GET
    @Path("/id/{id}")
    public String getItem(String id) {
        return "item-detail-" + id;
    }

    @PermissionsAllowed(value = "list", permission = CustomPermission.class) <i class="conum" data-value="4"></i><b>(4)</b>
    @Path("/list")
    @GET
    public Collection&lt;String&gt; list(@QueryParam("query-options") String queryOptions) {
        // your business logic comes here
        return Collections.emptySet();
    }

    public static class CustomPermission extends BasicPermission {

        public CustomPermission(String name) {
            super(name);
        }

        @Override
        public boolean implies(Permission permission) {
            var event = Arc.container().instance(RoutingContext.class).get(); <i class="conum" data-value="5"></i><b>(5)</b>
            var publicContent = "public-content".equals(event.request().params().get("query-options"));
            var hasPermission = getName().equals(permission.getName());
            return hasPermission &amp;&amp; publicContent;
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>リソースメソッド <code>createOrUpdate</code> にアクセスできるのは、 <code>create</code> 権限と <code>update</code> 権限の両方を持つユーザーのみです。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>デフォルトでは、1 つのアノテーションインスタンスを通じて指定された権限の少なくとも 1 つが必要です。
<code>inclusive=true</code> を設定することで、すべての権限を要求することができます。
両方のリソースメソッド <code>createOrUpdate</code> には同等の認可要件があります。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>SecurityIdentity</code> に <code>read</code> 権限または <code>see</code> 権限と、 <code>all</code> アクションまたは <code>detail</code> アクションのどちらかがある場合は、 <code>getItem</code> へのアクセスが許可されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>希望する <code>java.security.Permission</code> 実装を使用できます。
デフォルトでは、文字列ベースの権限は <code>io.quarkus.security.StringPermission</code> によって実行されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>権限は Bean ではないため、Bean インスタンスを取得する唯一の方法は、 <code>Arc.container()</code> を使用してプログラム的に取得することです。</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
IO スレッドで <code>@PermissionsAllowed</code> を使用する予定の場合は <a href="security-proactive-authentication">Proactive Authentication</a> の情報を確認してください。
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Quarkus インターセプターの制限により、 <code>@PermissionsAllowed</code> はクラスレベルで繰り返すことができません。
詳細は、Quarkus CDI リファレンスガイドの <a href="cdi-reference#repeatable-interceptor-bindings">Repeatable interceptor bindings</a> セクションを参照してください。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ロール対応の <code>SecurityIdentity</code> インスタンスに権限を追加する最も簡単な方法は、ロールを権限にマップすることです。
<a href="#authorization-using-configuration">設定を利用した認可</a> を使用して、次の例に示すように、認証されたリクエストに対して <code>CRUDResource</code> エンドポイントに必要な <code>SecurityIdentity</code> 権限を付与します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.policy.role-policy1.permissions.user=see:all                                      <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.http.auth.policy.role-policy1.permissions.admin=create,update,read                          <i class="conum" data-value="2"></i><b>(2)</b>
quarkus.http.auth.permission.roles1.paths=/crud/modify/*,/crud/id/*                                 <i class="conum" data-value="3"></i><b>(3)</b>
quarkus.http.auth.permission.roles1.policy=role-policy1

quarkus.http.auth.policy.role-policy2.permissions.user=list
quarkus.http.auth.policy.role-policy2.permission-class=org.acme.crud.CRUDResource$CustomPermission  <i class="conum" data-value="4"></i><b>(4)</b>
quarkus.http.auth.permission.roles2.paths=/crud/list
quarkus.http.auth.permission.roles2.policy=role-policy2</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>user</code> ロールの <code>SecurityIdentity</code> インスタンスに、権限 <code>see</code> とアクション <code>all</code> を追加します。
同様に、 <code>@PermissionsAllowed</code> アノテーションの場合は、デフォルトで <code>io.quarkus.security.StringPermission</code> が使用されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>権限 <code>create</code>、 <code>update</code>、および <code>read</code> は、ロール <code>admin</code> にマップされます。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>ロールポリシー <code>role-policy1</code> は、認証されたリクエストのみが <code>/crud/modify</code> および <code>/crud/id</code> サブパスにアクセスできるようにします。
パスマッチングアルゴリズムの詳細は、このガイドの <a href="#matching-multiple-paths">複数のパスのマッチング:一番長いパスが勝ちます。</a> を参照してください。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>java.security.Permission</code> クラスのカスタム実装を指定できます。
カスタムクラスでは、権限名と、オプションでいくつかのアクション (たとえば、 <code>String</code> 配列) を受け入れるコンストラクターを 1 つだけ定義する必要があります。
このシナリオでは、権限 <code>list</code> が <code>new CustomPermission ("list")</code> として <code>SecurityIdentity</code> インスタンスに追加されます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>追加のコンストラクターパラメーターを使用してカスタム <code>java.security.Permission</code> クラスを作成することもできます。
これらの追加パラメーターの名前は、 <code>@PermissionsAllowed</code> アノテーションが付けられたメソッドの引数名と一致します。
その後、Quarkus は、 <code>@PermissionsAllowed</code> アノテーションが付けられたメソッドが呼び出された実際の引数を使用して、カスタム権限をインスタンス化します。</p>
</div>
<div class="listingblock">
<div class="title">追加の引数を受け入れるカスタムの <code>java.security.Permission</code> クラスの例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.library;

import java.security.Permission;
import java.util.Arrays;
import java.util.Set;

public class LibraryPermission extends Permission {

    private final Set&lt;String&gt; actions;
    private final Library library;

    public LibraryPermission(String libraryName, String[] actions, Library library) { <i class="conum" data-value="1"></i><b>(1)</b>
        super(libraryName);
        this.actions = Set.copyOf(Arrays.asList(actions));
        this.library = library;
    }

    @Override
    public boolean implies(Permission requiredPermission) {
        if (requiredPermission instanceof LibraryPermission) {
            LibraryPermission that = (LibraryPermission) requiredPermission;
            boolean librariesMatch = getName().equals(that.getName());
            boolean requiredLibraryIsSublibrary = library.isParentLibraryOf(that.library);
            boolean hasOneOfRequiredActions = that.actions.stream().anyMatch(actions::contains);
            return (librariesMatch || requiredLibraryIsSublibrary) &amp;&amp; hasOneOfRequiredActions;
        }
        return false;
    }

    // here comes your own implementation of the `java.security.Permission` class methods

    public static abstract class Library {

        protected String description;

        abstract boolean isParentLibraryOf(Library library);

    }

    public static class MediaLibrary extends Library {

        @Override
        boolean isParentLibraryOf(Library library) {
            return library instanceof MediaLibrary;
        }
    }

    public static class TvLibrary extends MediaLibrary {
        // TvLibrary specific implementation of the 'isParentLibraryOf' method
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>カスタム <code>Permission</code> クラスのコンストラクターは 1 つだけ存在する必要があります。
最初のパラメーターは常に権限名とみなされ、 <code>String</code> 型である必要があります。
Quarkus はオプションでコンストラクターに権限アクションを渡すことができます。
これを実現するには、2 番目のパラメーターを <code>String[]</code> として宣言します。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>LibraryPermission</code> クラスは、 <code>SecurityIdentity</code> が <code>read</code>、 <code>write</code>、または <code>list</code> などの必要なアクションのいずれかを実行することを許可されている場合に、現在のライブラリーまたは親ライブラリーへのアクセスを許可します。</p>
</div>
<div class="paragraph">
<p>次の例は、 <code>LibraryPermission</code> クラスの使用方法を示しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.library;

import io.quarkus.security.PermissionsAllowed;
import jakarta.enterprise.context.ApplicationScoped;
import org.acme.library.LibraryPermission.Library;

@ApplicationScoped
public class LibraryService {

    @PermissionsAllowed(value = "tv:write", permission = LibraryPermission.class) <i class="conum" data-value="1"></i><b>(1)</b>
    public Library updateLibrary(String newDesc, Library library) {
        library.description = newDesc;
        return library;
    }

    @PermissionsAllowed(value = "tv:write", permission = LibraryPermission.class) <i class="conum" data-value="2"></i><b>(2)</b>
    @PermissionsAllowed(value = {"tv:read", "tv:list"}, permission = LibraryPermission.class)
    public Library migrateLibrary(Library migrate, Library library) {
        // migrate libraries
        return library;
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>仮パラメーター <code>library</code> は、同じ名前の <code>LibraryPermission</code> コンストラクターパラメーターと一致するパラメーターとして識別されます。
したがって、Quarkus は <code>library</code> パラメーターを <code>LibraryPermission</code> クラスコンストラクターに渡します。
ただし、 <code>updateLibrary</code> メソッドが呼び出されるたびに <code>LibraryPermission</code> をインスタンス化する必要があります。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ここで、2 番目の <code>Library</code> パラメーターは名前 <code>library</code> と一致しますが、
<code>migrate</code> パラメーターは <code>LibraryPermission</code> 権限のインスタンス化中に無視されます。</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><code>LibraryPermission</code> で保護されたリソースの例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.library;

import io.quarkus.security.PermissionsAllowed;
import jakarta.inject.Inject;
import jakarta.ws.rs.PUT;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.PathParam;
import org.acme.library.LibraryPermission.Library;

@Path("/library")
public class LibraryResource {

    @Inject
    LibraryService libraryService;

    @PermissionsAllowed(value = "tv:write", permission = LibraryPermission.class)
    @PUT
    @Path("/id/{id}")
    public Library updateLibrary(@PathParam("id") Integer id, Library library) {
        ...
    }

    @PUT
    @Path("/service-way/id/{id}")
    public Library updateLibrarySvc(@PathParam("id") Integer id, Library library) {
        String newDescription = "new description " + id;
        return libraryService.updateLibrary(newDescription, library);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>CRUDResource</code> の例と同様に、次の例は、 <code>admin</code> ロールを持つユーザーに <code>MediaLibrary</code> を更新する権限を付与する方法を示しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.library;

import io.quarkus.runtime.annotations.RegisterForReflection;

@RegisterForReflection <i class="conum" data-value="1"></i><b>(1)</b>
public class MediaLibraryPermission extends LibraryPermission {

    public MediaLibraryPermission(String libraryName, String[] actions) {
        super(libraryName, actions, new MediaLibrary());    <i class="conum" data-value="2"></i><b>(2)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ネイティブ実行可能ファイルを構築する場合、少なくとも 1 つの <code>io.quarkus.security.PermissionsAllowed#name</code> パラメーターでも使用されていない限り、権限クラスをリフレクション用に登録する必要があります。 <code>@RegisterForReflection</code> アノテーションの詳細は、<a href="writing-native-applications-tips#registerForReflection">native application tips</a> ページを参照してください。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>MediaLibrary</code> インスタンスを <code>LibraryPermission</code> コンストラクターに渡します。</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.policy.role-policy3.permissions.admin=media-library:list,media-library:read,media-library:write   <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.http.auth.policy.role-policy3.permission-class=org.acme.library.MediaLibraryPermission
quarkus.http.auth.permission.roles3.paths=/library/*
quarkus.http.auth.permission.roles3.policy=role-policy3</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>media-library</code> 権限を付与します。これにより、 <code>read</code>、 <code>write</code>、および <code>list</code> アクションが許可されます。
<code>MediaLibrary</code> は <code>TvLibrary</code> クラスの親であるため、 <code>admin</code> ロールを持つユーザーも <code>TvLibrary</code> を変更することが許可されます。</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>/library/*`パスは Keycloak プロバイダーの Dev UI ページからテストできます。これは、<a href="security-openid-connect-dev-services">Dev Services for Keycloak</a> によって自動的に作成されたユーザー`alice</code> に
 <code>admin</code> ロールが付与されるためです。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>これまでに示した例は、ロールと権限のマッピングを示しています。
<code>SecurityIdentity</code> インスタンスにプログラムで権限を追加することも可能です。
次の例では、<a href="security-customization#security-identity-customization"><code>SecurityIdentity</code></a> がカスタマイズされ、以前に HTTP ロールベースポリシーで付与されたものと同じ権限が追加されます。</p>
</div>
<div class="listingblock">
<div class="title">プログラムで <code>SecurityIdentity</code> に <code>LibraryPermission</code> を追加する例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import java.security.Permission;

import jakarta.enterprise.context.ApplicationScoped;

import io.quarkus.security.identity.AuthenticationRequestContext;
import io.quarkus.security.identity.SecurityIdentity;
import io.quarkus.security.identity.SecurityIdentityAugmentor;
import io.quarkus.security.runtime.QuarkusSecurityIdentity;
import io.smallrye.mutiny.Uni;

@ApplicationScoped
public class PermissionsIdentityAugmentor implements SecurityIdentityAugmentor {

    @Override
    public Uni&lt;SecurityIdentity&gt; augment(SecurityIdentity identity, AuthenticationRequestContext context) {
        if (isNotAdmin(identity)) {
            return Uni.createFrom().item(identity);
        }
        return Uni.createFrom().item(build(identity));
    }

    private boolean isNotAdmin(SecurityIdentity identity) {
        return identity.isAnonymous() || !"admin".equals(identity.getPrincipal().getName());
    }

    SecurityIdentity build(SecurityIdentity identity) {
        return QuarkusSecurityIdentity.builder(identity)
                .addPermission(new MediaLibraryPermission("media-library", new String[] { "read", "write", "list"}); <i class="conum" data-value="1"></i><b>(1)</b>
                .build();
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>作成された権限 <code>media-library</code> を追加すると、 <code>read</code>、 <code>write</code>、および <code>list</code> アクションを実行できます。
<code>MediaLibrary</code> は <code>TvLibrary</code> クラスの親であるため、 <code>admin</code> ロールを持つユーザーも <code>TvLibrary</code> を変更することが許可されます。</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<code>jakarta.ws.rs.core.SecurityContext</code> には権限がないため、アノテーションベースの権限はカスタム <a href="security-customization#jaxrs-security-context">Jakarta REST SecurityContexts</a> では機能しません。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="permission-checker"><a class="anchor" href="#permission-checker"></a>権限チェッカーを作成する</h4>
<div class="paragraph">
<p>デフォルトでは、 <code>Security アイデンティティー</code> は、この ID が <code>@PermissionAllowed</code> 認可制限を通過するかどうかを確認するために使用できる権限で設定されている必要があります。
または、 <code>@PermissionChecker</code> アノテーションを使用して、任意の CDI Bean メソッドを権限チェッカーとしてマークすることもできます。
<code>@PermissionChecker</code> アノテーション値は、 <code>@PermissionsAllowed</code> アノテーション値によって宣言された必要な権限と一致する必要があります。
たとえば、権限チェッカーは次のように作成できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security.rest.resource;

import io.quarkus.security.PermissionChecker;
import io.quarkus.security.PermissionsAllowed;
import io.quarkus.security.identity.SecurityIdentity;
import jakarta.ws.rs.POST;
import jakarta.ws.rs.Path;

import org.jboss.resteasy.reactive.RestForm;
import org.jboss.resteasy.reactive.RestPath;

@Path("/project/{projectName}")
public class ProjectResource {

    @PermissionsAllowed("rename-project") <i class="conum" data-value="1"></i><b>(1)</b>
    @POST
    public void renameProject(@RestPath String projectName, @RestForm String newName) {
        Project project = Project.findByName(projectName);
        project.name = newName;
    }

    @PermissionChecker("rename-project") <i class="conum" data-value="2"></i><b>(2)</b>
    boolean canRenameProject(SecurityIdentity identity, String projectName) { <i class="conum" data-value="3"></i><b>(3)</b> <i class="conum" data-value="4"></i><b>(4)</b>
        var principalName = identity.getPrincipal().getName();
        var user = User.getUserByName(principalName);
        return userOwnsProject(projectName, user);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>ProjectResource#renameProject</code> にアクセスするために必要な権限は、 <code>rename-project</code> 権限です。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>ProjectResource#canRenameProject</code> メソッドは、 <code>ProjectResource#renameProject</code> エンドポイントへのアクセスを承認します。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>SecurityIdentity</code> インスタンスは、任意の権限チェッカーメソッドに挿入できます。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>この例では、 <code>rename-project</code> 権限チェッカーが同じリソースで宣言されています。
ただし、次の例に示すように、この権限チェッカーを宣言できる場所に制限はありません。</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
権限チェッカーメソッドは、通常のスコープの CDI Bean または <code>@Singleton</code> Bean で宣言できます。
<code>@Dependent</code> CDI Bean スコープは現在サポートされていません。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>上記の権限チェッカーでは、 <code>renameProject</code> エンドポイントを承認するために <code>SecurityIdentity</code> インスタンスが必要です。
<code>rename-project</code> 権限チェッカーをリソース上で直接宣言する代わりに、次の例のように任意の CDI Bean 上で宣言できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security.rest.resource;

import io.quarkus.security.PermissionChecker;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;

@ApplicationScoped <i class="conum" data-value="1"></i><b>(1)</b>
public class ProjectPermissionChecker {

    @PermissionChecker("rename-project")
    boolean canRenameProject(String projectName, SecurityIdentity identity) {   <i class="conum" data-value="2"></i><b>(2)</b>
        var principalName = identity.getPrincipal().getName();
        var user = User.getUserByName(principalName);
        return userOwnsProject(projectName, user);
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>権限チェッカーを備えた CDI Bean は、通常のスコープ Bean または <code>@Singleton</code> Bean のいずれかである必要があります。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>権限チェッカーメソッドは、 <code>boolean</code> または <code>Uni&lt;Boolean&gt;</code> を返す必要があります。プライベートチェッカーメソッドはサポートされていません。</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
権限チェックは、イベントループでデフォルトで実行されます。
ワーカースレッドでチェックを実行する場合は、権限チェッカーメソッドに <code>io.smallrye.common.annotation.Blocking</code> アノテーションを付けます。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>@PermissionsAllowed</code> 値と <code>@PermissionChecker</code> 値の一致は、次の例に示すように、文字列の等価性に基づいて行われます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security;

import io.quarkus.security.PermissionChecker;
import io.quarkus.security.PermissionsAllowed;
import jakarta.enterprise.context.ApplicationScoped;

@ApplicationScoped
public class FileService {

    @PermissionsAllowed({ "delete:all", "delete:dir" }) <i class="conum" data-value="1"></i><b>(1)</b>
    void deleteDirectory(Path directoryPath) {
        // delete directory
    }

    @PermissionsAllowed(value = { "delete:service", "delete:file" }, inclusive = true) <i class="conum" data-value="2"></i><b>(2)</b>
    void deleteServiceFile(Path serviceFilePath) {
        // delete service file
    }

    @PermissionChecker("delete:all")
    boolean canDeleteAllDirectories(SecurityIdentity identity) {
        String filePermissions = identity.getAttribute("user-group-file-permissions");
        return filePermissions != null &amp;&amp; filePermissions.contains("w");
    }

    @PermissionChecker("delete:service")
    boolean canDeleteService(SecurityIdentity identity) {
        return identity.hasRole("admin");
    }

    @PermissionChecker("delete:file")
    boolean canDeleteFile(Path serviceFilePath) {
        return serviceFilePath != null &amp;&amp; !serviceFilePath.endsWith("critical");
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>権限チェッカーメソッド <code>canDeleteAllDirectories</code> は、 <code>delete:all</code> 値が等しいため、 <code>deleteDirectory</code> へのアクセスを許可します。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>権限チェッカーメソッドは 2 つ必要です。1 つは <code>delete:service</code> 権限用、もう 1 つは <code>delete:file</code> 権限用です。</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="permission-meta-annotation"><a class="anchor" href="#permission-meta-annotation"></a>権限メタアノテーションを作成する</h4>
<div class="paragraph">
<p><code>@PermissionsAllowed</code> はメタアノテーションでも使用できます。
たとえば、新しい <code>@CanWrite</code> セキュリティーアノテーションは次のように作成できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

import io.quarkus.security.PermissionsAllowed;

@Retention(RetentionPolicy.RUNTIME)
@Target({ ElementType.METHOD, ElementType.TYPE })
@PermissionsAllowed(value = "write", permission = CustomPermission.class) <i class="conum" data-value="1"></i><b>(1)</b>
public @interface CanWrite {

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@CanWrite</code> アノテーションが付けられたメソッドまたはクラスは、この <code>@PermissionsAllowed</code> アノテーションインスタンスにより保護されます。</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="permission-bean-params"><a class="anchor" href="#permission-bean-params"></a><code>@BeanParam</code> パラメーターをカスタム権限に渡す</h4>
<div class="paragraph">
<p>Quarkus は、保護されたメソッドパラメーターのフィールドをカスタム権限コンストラクターパラメーターにマップできます。
この機能を使用すると、 <code>jakarta.ws.rs.BeanParam</code> パラメーターをカスタム権限に渡すことができます。
次の Jakarta REST リソースを考えてみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security.rest.resource;

import io.quarkus.security.PermissionsAllowed;
import jakarta.ws.rs.BeanParam;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;

@Path("/hello")
public class HelloResource {

    @PermissionsAllowed(value = "say-hello", params = "beanParam.securityContext.userPrincipal.name") <i class="conum" data-value="1"></i><b>(1)</b>
    @GET
    public String sayHello(@BeanParam SimpleBeanParam beanParam) {
        return "Hello from " + beanParam.uriInfo.getPath();
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>params</code> アノテーション属性は、ユーザープリンシパル名を <code>BeanParamPermissionChecker#canSayHello</code> メソッドに渡すことを指定します。
<code>customAuthorizationHeader</code> や <code>query</code> などの他の <code>BeanParamPermissionChecker#canSayHello</code> メソッドパラメーターは自動的に一致します。
Quarkus は、 <code>beanParam</code> フィールドとそのパブリックアクセサーの中から <code>BeanParamPermissionChecker#canSayHello</code> メソッドパラメーターを識別します。
あいまいな解決を避けるため、自動検出は <code>beanParam</code> フィールドに対してのみ機能します。
そのため、ユーザープリンシパル名へのパスを明示的に指定する必要がありました。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>SimpleBeanParam</code> クラスは以下の例のように宣言されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security.rest.dto;

import java.util.List;

import jakarta.ws.rs.HeaderParam;
import jakarta.ws.rs.QueryParam;
import jakarta.ws.rs.core.Context;
import jakarta.ws.rs.core.SecurityContext;
import jakarta.ws.rs.core.UriInfo;

public class SimpleBeanParam {

    @HeaderParam("CustomAuthorization")
    private String customAuthorizationHeader;

    @Context
    SecurityContext securityContext;

    @Context
    public UriInfo uriInfo;

    @QueryParam("query")
    public String query;    <i class="conum" data-value="1"></i><b>(1)</b>

    public SecurityContext getSecurityContext() { <i class="conum" data-value="2"></i><b>(2)</b>
        return securityContext;
    }

    public String customAuthorizationHeader() { <i class="conum" data-value="3"></i><b>(3)</b>
        return customAuthorizationHeader;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Quarkus Security は、カスタム権限コンストラクターにパブリックフィールドのみを渡すことができます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Quarkus Security は、パブリックゲッターメソッドが利用可能な場合はそれを自動的に使用します。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>customAuthorizationHeader</code> フィールドはパブリックではないため、Quarkus は <code>customAuthorizationHeader</code> アクセサーを使用してこのフィールドにアクセスします。
これは、生成されたアクセサーに接頭辞 <code>get</code> が付かない Java レコードで特に便利です。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以下は、ユーザープリンシパル、カスタムヘッダー、クエリーパラメーターに基づいて <code>say-hello</code> 権限をチェックする <code>@PermissionChecker</code> メソッドの例です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security.permission;

import jakarta.enterprise.context.ApplicationScoped;
import io.quarkus.security.PermissionChecker;

@ApplicationScoped
public class BeanParamPermissionChecker {

    @PermissionChecker("say-hello")
    boolean canSayHello(String customAuthorizationHeader, String name, String query) {
        boolean queryParamAllowedForPermissionName = checkQueryParams(query);
        boolean usernameWhitelisted = isUserNameWhitelisted(name);
        boolean customAuthorizationMatches = checkCustomAuthorization(customAuthorizationHeader);
        return queryParamAllowedForPermissionName &amp;&amp; usernameWhitelisted &amp;&amp; customAuthorizationMatches;
    }

    ...
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>@BeanParam</code> を <code>@PermissionChecker</code> メソッドに直接渡し、プログラムでそのフィールドにアクセスできます。
<code>@PermissionsAllowed#params</code> 属性を使用して <code>@BeanParam</code> フィールドを参照する機能は、異なる構造の <code>@BeanParam</code> クラスが複数ある場合に便利です。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references"><a class="anchor" href="#references"></a>参考資料</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="security-overview">Quarkus Security の概要</a></p>
</li>
<li>
<p><a href="security-architecture">Quarkus Security アーキテクチャー</a></p>
</li>
<li>
<p><a href="security-authentication-mechanisms#other-supported-authentication-mechanisms">Quarkusの認証メカニズム</a></p>
</li>
<li>
<p><a href="security-basic-authentication">Basic 認証</a></p>
</li>
<li>
<p><a href="security-getting-started-tutorial">Basic 認証と Jakarta Persistence を使ったセキュリティー入門</a></p>
</li>
<li>
<p><a href="security-oidc-bearer-token-authentication#token-scopes-and-security-identity-permissions">OpenID Connect ベアラートークンの範囲と SecurityIdentity 権限</a></p>
</li>
</ul>
</div>
</div>
</div>
    </div>
    <div class="grid__item width-4-12 width-12-12-m tocwrapper">
      <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#authorization-using-configuration">設定を利用した認可</a>
<ul class="sectlevel2">
<li><a href="#custom-http-security-policy">カスタムの HttpSecurityPolicy</a></li>
<li><a href="#policy-active-cdi-request-context"><code>@RequestScoped</code> Bean の <code>HttpSecurityPolicy</code> への挿入</a></li>
<li><a href="#matching-on-paths-and-methods">パスとメソッドのマッチング</a></li>
<li><a href="#matching-a-path-but-not-a-method">パスはマッチするがメソッドはマッチしない場合</a></li>
<li><a href="#matching-multiple-paths">複数のパスのマッチング:一番長いパスが勝ちます。</a></li>
<li><a href="#matching-multiple-sub-paths-longest-path-to-the-wildcard-wins">複数のサブパスのマッチング: <code>*</code> ワイルドカードへの最長パスが優先される</a></li>
<li><a href="#matching-multiple-paths-most-specific-method-wins">複数のパスのマッチング:一番具体的なパスが勝ちます</a></li>
<li><a href="#matching-multiple-paths-and-methods-both-win">複数のパスのマッチング:一番長いパスが勝ちます</a></li>
<li><a href="#configuration-properties-to-deny-access">アクセスを拒否するための設定プロパティ</a></li>
<li><a href="#disabling-permissions">権限の無効化</a></li>
<li><a href="#permission-paths-and-http-root-path">権限パスとHTTPルートパス</a></li>
<li><a href="#map-security-identity-roles"><code>SecurityIdentity</code> ロールのマッピング</a></li>
<li><a href="#shared-permission-checks">共有権限チェック</a></li>
<li><a href="#path-specific-authz-programmatic-set-up">Set up path-specific authorization programmatically</a></li>
</ul>
</li>
<li><a href="#standard-security-annotations">アノテーションを使った認可</a>
<ul class="sectlevel2">
<li><a href="#endpoint-security-annotations-and-jakarta-rest-inheritance">エンドポイントセキュリティーアノテーションと Jakarta REST 継承</a></li>
<li><a href="#permission-annotation">権限アノテーション</a></li>
</ul>
</li>
<li><a href="#references">参考資料</a></li>
</ul></div>
    </div>
  </div>
  <h2>関連コンテンツ</h2>
  <div class="grid-wrapper relations">
    <div class="grid__item width-6-12 width-12-12-m">
      <h3>同じエクステンションについて</h3>
      <ul class="related-content">
      
        
        <li class="concepts"><a href="/guides/security-basic-authentication">Basic認証</a></li>
      
        
        <li class="reference"><a href="/guides/security-cors">クロスオリジンリソース共有（CORS）</a></li>
      
        
        <li class="howto"><a href="/guides/security-basic-authentication-howto">ベーシック認証の有効化</a></li>
      
        
        <li class="tutorial"><a href="/guides/security-getting-started-tutorial">Basic認証とJakarta Persistenceを使用したセキュリティの入門</a></li>
      
        
        <li class="reference"><a href="/guides/http-reference">HTTPリファレンス</a></li>
      
        
        <li class="reference"><a href="/guides/management-interface-reference">マネジメントインターフェースリファレンス</a></li>
      
        
        <li class="guide"><a href="/guides/rest-migration">Quarkus REST（旧RESTEasy Reactive）への移行</a></li>
      
        
        <li class="concepts"><a href="/guides/security-proactive-authentication">プロアクティブ認証</a></li>
      
        
        <li class="guide"><a href="/guides/resteasy">RESTEasy Classic</a></li>
      
        
        <li class="howto"><a href="/guides/rest-virtual-threads">RESTアプリケーションで仮想スレッドを使用する</a></li>
      
        
        <li class="guide"><a href="/guides/rest-json">JSON RESTサービスの実装</a></li>
      
        
        <li class="guide"><a href="/guides/rest">Quarkus REST（旧RESTEasy Reactive）によるRESTサービスの作成</a></li>
      </ul>
    </div>
    <div class="grid__item width-6-12 width-12-12-m">
      <h3>同じトピックについて</h3>
      <ul class="related-content">
      
        
        <li class="concepts"><a href="/guides/security-basic-authentication">Basic認証</a></li>
      
        
        <li class="guide"><a href="/guides/security-csrf-prevention">クロスサイトリクエストフォージェリー対策</a></li>
      
        
        <li class="howto"><a href="/guides/security-basic-authentication-howto">ベーシック認証の有効化</a></li>
      
        
        <li class="tutorial"><a href="/guides/security-getting-started-tutorial">Basic認証とJakarta Persistenceを使用したセキュリティの入門</a></li>
      
        
        <li class="tutorial"><a href="/guides/security-oidc-code-flow-authentication-tutorial">Quarkus - 認可コードフローのOpenID Connectを使用してWebアプリケーションを保護</a></li>
      
        
        <li class="reference"><a href="/guides/tls-registry-reference">TLS レジストリーリファレンス</a></li>
      
        
        <li class="guide"><a href="/guides/security-keycloak-admin-client">Keycloak Admin Clientの使用</a></li>
      
        
        <li class="howto"><a href="/guides/security-keycloak-authorization">OpenID Connect (OIDC)とKeycloakを使用した認可の一元化</a></li>
      
        
        <li class="guide"><a href="/guides/proxy-registry">Using Proxy Registry</a></li>
      
        
        <li class="guide"><a href="/guides/security-webauthn">WebAuthnと共にSecurityを使用</a></li>
      
        
        <li class="concepts"><a href="/guides/security-authentication-mechanisms">Quarkusの認証メカニズム</a></li>
      
        
        <li class="guide"><a href="/guides/security-jwt-build">JSON Web トークン (JWT) のビルド、署名、暗号化</a></li>
      
        
        <li class="concepts"><a href="/guides/security-openid-connect-providers">よく知られたOpenID Connect プロバイダーの設定</a></li>
      
        
        <li class="howto"><a href="/guides/security-openid-connect-dev-services">OpenID Connect (OIDC)のDev ServicesとDev UI</a></li>
      
        
        <li class="guide"><a href="/guides/rest-data-panache">PanacheでJakarta RESTリソースを生成する</a></li>
      
        
        <li class="reference"><a href="/guides/http-reference">HTTPリファレンス</a></li>
      
        
        <li class="concepts"><a href="/guides/security-identity-providers">アイデンティティ・プロバイダー</a></li>
      
        
        <li class="tutorial"><a href="/guides/security-vertx-oidc-to-quarkus-oidc-migration">Migrate from Vert.x OIDC to Quarkus OIDC</a></li>
      
        
        <li class="guide"><a href="/guides/rest-migration">Quarkus REST（旧RESTEasy Reactive）への移行</a></li>
      
        
        <li class="reference"><a href="/guides/security-openid-connect-client-reference">OpenID Connect (OIDC) と OAuth2 クライアントおよびフィルター</a></li>
      </ul>
    </div>
    </div>
  </div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license. <i class='fab fa-creative-commons'></i><i class='fab fa-creative-commons-by'></i> <a href='https://creativecommons.org/licenses/by/3.0/' target='_blank'>CC by 3.0</a><br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">ホーム</a></li>
          
          
          
            <li><a href="/about" target="_blank">Quarkusについて</a></li>
          
          
          
            <li><a href="/blog" target="_blank">ブログ</a></li>
          
          
          
            <li><a href="/insights" target="_blank">ポッドキャスト</a></li>
          
          
          
            <li><a href="/events" target="_blank">イベント</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">ニュースレター</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">ユーザーストーリー</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">ロードマップ</a></li>
          
          
          
            <li><a href="/security" target="_blank">セキュリティ&nbsp;ポリシー</a></li>
          
          
          
            <li><a href="/usage" target="_blank">使用方法</a></li>
          
          
          
            <li><a href="https://github.com/commonhaus/artwork/tree/main/projects/quarkus" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
          
            <li><a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy Policy</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォローする</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.threads.com/@quarkusio" target="_blank">Threads</a></li>
          
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">サポート</a></li>
          
          
          
            <li><a href="/guides" target="_blank">ガイド</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">入門</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">ディスカッション</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">開発メーリングリスト</a></li>
          
          
          
            <li><a href="https://stats.uptimerobot.com/ze1PfweT2p" target="_blank">Quarkus Service Status</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>言語</span>
        <ul class="footer-links">
          
          
            <li><a href=" https://quarkus.io/ " target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href=" https://es.quarkus.io/ " target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href=" https://ja.quarkus.io/ " target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate ORM</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">その他多数...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content cf-footer">
  <div class="flexcontainer">
    <div class="cf-logo">
      <a class="cf-logo" href="https://www.commonhaus.org/" target="_blank"><img src="https://raw.githubusercontent.com/commonhaus/artwork/main/foundation/brand/svg/CF_logo_horizontal_single_reverse.svg"/></a>
    </div>
    <div class="license">
      Copyright © Quarkus. All rights reserved. For details on our trademarks, please visit our <a href="https://www.commonhaus.org/policies/trademark-policy/">Trademark Policy</a> and <a href="https://www.commonhaus.org/trademarks/">Trademark List</a>. Trademarks of third parties are owned by their respective holders and their mention here does not suggest any endorsement or association.
    </div>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
  <script src="/assets/javascript/randomize.js" type="text/javascript"></script>
  <script src="/assets/javascript/time.js" type="text/javascript"></script>
</body>

</html>
