<!DOCTYPE html>
<html lang="ja">







<head>
  <title>OpenID Connect (OIDC) および OAuth2 クライアントとフィルターのリファレンスガイド  - 2.16 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com https://ajax.googleapis.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />

  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/2.16/guides/security-openid-connect-client-reference" />
  <meta property="og:title" content="OpenID Connect (OIDC) および OAuth2 クライアントとフィルターのリファレンスガイド  - 2.16" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/security-openid-connect-client-reference">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="guides">

  


<div class="grid-wrapper communitysite">
  <div class="grid__item width-12-12">The <a href="https://quarkus.io/version/2.16/guides/security-openid-connect-client-reference">English version of quarkus.io</a> is the official project site. Translated sites are community supported on a best-effort basis.</div>
</div>


  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="#">Why<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/performance" class="">パフォーマンス</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
          <li><a href="/versatility" class="">多用途性</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/spring" class="">USING SPRING?</a></li>
          <li class="tertiarydropdown">
            <span href="#">AI<i class="fas fa-chevron-down"></i></span>
            <ul class="tertiarymenu">
              <li><a href="/ai" class="">AI OVERVIEW</a></li>
              <li><a href="/java-for-ai" class="">JAVA FOR AI</a></li>
              <li><a href="/quarkus-for-ai" class="">WHY QUARKUS FOR AI</a></li>
              <li><a href="/ai-blueprints" class="">AI BLUEPRINTS</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Learn<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ドキュメント</a></li>
          <li><a href="/userstories/" class="">ユーザーストーリー</a></li>  
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="#">Extensions<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
<li><a href="https://quarkus.io/extensions/" class="">エクステンションを探す</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">エクステンションの使用</a></li>
          <li><a href="/guides/writing-extensions" class="">エクステンションの作成</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">エクステンションの共有</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Community<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/working-groups" class="">ワーキンググループ</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ロードマップ</a></li>
          <li><a href="/benefactors" class="">BENEFACTORS</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/version/2.16/guides/security-openid-connect-client-reference" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/version/2.16/guides/security-openid-connect-client-reference">ポルトガル（BR）</a></li>
          <li><a href="https://es.quarkus.io/version/2.16/guides/security-openid-connect-client-reference">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/version/2.16/guides/security-openid-connect-client-reference">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/version/2.16/guides/security-openid-connect-client-reference">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas
fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    







<section class="full-width-version-bg flexfilterbar guides">
  <div class="guideflexcontainer">
    <div class="docslink">
      <a class="returnlink" href="/version/2.16/guides/"> Back to Guides</a>
    </div>
    <div class="flexlabel">
      <label>バージョン:</label>
    </div>
    <div class="guidepulldown version">
    <select id="guide-version-dropdown">
      
        
        
        <option value="main" >Main - SNAPSHOT</option>
        
        
        
        <option value="latest" >3.31.3 - Latest</option>
        
        
        
        <option value="3.27" >3.27</option>
        
        
        
        <option value="3.20" >3.20</option>
        
        
        
        <option value="3.15" >3.15</option>
        
        
        
        <option value="3.8" >3.8</option>
        </select>
    </div>
  </div>
</section>

<div class="guide">
  <div class="grid-wrapper">
    <div class="grid__item width-8-12 width-12-12-m">
      
      <h1 class="text-caps">OpenID Connect (OIDC) および OAuth2 クライアントとフィルターのリファレンスガイド  </h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>このリファレンスガイドは、以下の使用方法について説明しています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>quarkus-oidc-client</code>、 <code>quarkus-oidc-client-reactive-filter</code>、および <code>quarkus-oidc-client-filter</code> エクステンションを使用して、OpenId Connect および <a href="https://www.keycloak.org">Keycloak</a> などの OAuth 2.0 準拠の認可サーバーからアクセストークンを取得し、更新する方法</p>
</li>
<li>
<p>現在の <code>Bearer</code> または <code>Authorization Code Flow</code> アクセストークンを伝播する <code>quarkus-oidc-token-propagation-reactive</code> エクステンションと <code>quarkus-oidc-token-propagation</code> エクステンション</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これらのエクステンションで管理されているアクセストークンをHTTP Authorization Bearerトークンとして使用して、リモートサービスにアクセスすることができます。</p>
</div>
<div class="paragraph">
<p><a href="security-openid-connect-client">OpenID Connect Clientとトークン伝搬クイックスタート</a> も参照してください。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="oidcclient"><a class="anchor" href="#oidcclient"></a>OidcClient</h2>
<div class="sectionbody">
<div class="paragraph">
<p>次の依存関係を追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-oidc-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>quarkus-oidc-client</code> エクステンションは、SmallRye Mutiny <code>Uni</code> および <code>Vert.xWebClient</code> を使用してトークンを取得および更新するために使用できるリアクティブな <code>io.quarkus.oidc.client.OidcClient</code> を提供します。</p>
</div>
<div class="paragraph">
<p><code>OidcClient</code> は自動検出または手動で構成することができる IDP トークンのエンドポイント URL でビルド時に初期化され、このエンドポイントを使用して <code>client_credentials</code> または <code>password</code> トークングラントを使用してアクセストークンを取得し、 <code>refresh_token</code> グラントを使用してトークンを更新します。</p>
</div>
<div class="sect2">
<h3 id="token-endpoint-configuration"><a class="anchor" href="#token-endpoint-configuration"></a>トークンエンドポイントの設定</h3>
<div class="paragraph">
<p>デフォルトでは、トークンのエンドポイントアドレスは、設定された <code>quarkus.oidc-client.auth-server-url</code> に <code>/.well-known/openid-configuration</code> パスを追加することによって検出されます。</p>
</div>
<div class="paragraph">
<p>たとえば、次の KeycloakURL を指定した場合:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus</code></pre>
</div>
</div>
<div class="paragraph">
<p>OidcClient` は、トークンのエンドポイント URL が <code><a href="http://localhost:8180/auth/realms/quarkus/protocol/openid-connect/tokens" class="bare">http://localhost:8180/auth/realms/quarkus/protocol/openid-connect/tokens</a></code> であることを検出します。</p>
</div>
<div class="paragraph">
<p>また、ディスカバリーエンドポイントが利用できない場合や、ディスカバリーエンドポイントのラウンドトリップを節約したい場合は、ディスカバリーを無効にして、相対パス値でトークンエンドポイントアドレスを設定することもできます。例えば:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus
quarkus.oidc-client.discovery-enabled=false
# Token endpoint: http://localhost:8180/auth/realms/quarkus/protocol/openid-connect/tokens
quarkus.oidc-client.token-path=/protocol/openid-connect/tokens</code></pre>
</div>
</div>
<div class="paragraph">
<p>検出せずにトークンエンドポイント URL を設定するよりコンパクトな方法は、 <code>quarkus.oidc-client.token-path</code> を絶対 URL に設定することです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.token-path=http://localhost:8180/auth/realms/quarkus/protocol/openid-connect/tokens</code></pre>
</div>
</div>
<div class="paragraph">
<p>この場合、'quarkus.oidc-client.auth-server-url' および 'quarkus.oidc-client.discovery-enabled' の設定は必要ありません。</p>
</div>
</div>
<div class="sect2">
<h3 id="supported-token-grants"><a class="anchor" href="#supported-token-grants"></a>サポートされるトークングラント</h3>
<div class="paragraph">
<p><code>OidcClient</code> がトークンを取得するために使用できる主なトークングラントは、 <code>client_credentials</code> (デフォルト) と <code>password</code> グラントです。</p>
</div>
<div class="sect3">
<h4 id="client-credentials-grant"><a class="anchor" href="#client-credentials-grant"></a>クライアントクレデンシャル・グラント</h4>
<div class="paragraph">
<p><code>OidcClient</code> が <code>client_credentials</code> グラントを使用するように設定する方法は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.secret=secret</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>client_credentials</code> グラントにより、 <code>quarkus.oidc-client.grant-options.client.&lt;param-name&gt;=&lt;value&gt;</code> を介してトークンリクエストに追加のパラメータを設定できます。 <code>audience</code> パラメータを使用して目的のトークン受信者を設定する方法は次のとおりです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.secret=secret
# 'client' is a shortcut for `client_credentials`
quarkus.oidc-client.grant.type=client
quarkus.oidc-client.grant-options.client.audience=https://example.com/api</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="password-grant"><a class="anchor" href="#password-grant"></a>パスワード・グラント</h4>
<div class="paragraph">
<p><code>OidcClient</code> が <code>password</code> グラントを使用するように設定する方法は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.secret=secret
quarkus.oidc-client.grant.type=password
quarkus.oidc-client.grant-options.password.username=alice
quarkus.oidc-client.grant-options.password.password=alice</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは、クライアント認証情報のグラントをカスタマイズする方法と同様に、 <code>quarkus.oidc-client.grant-options.password</code> 設定接頭辞を使用してさらにカスタマイズできます。</p>
</div>
</div>
<div class="sect3">
<h4 id="other-grants"><a class="anchor" href="#other-grants"></a>その他の助成金</h4>
<div class="paragraph">
<p><code>OidcClient</code> は設定にはない特別な入力パラメータを必要とするグラントを使用して、トークンの取得を支援することもできます。これらのグラントとは、 <code>refresh_token</code> （外部リフレッシュ・トークン付き）、 <code>authorization_code</code> 、および現在のアクセストークンを交換するために使用できる2つのグラント`urn:ietf:params:oauth:grant-type:token-exchange` および `urn:ietf:params:oauth:grant-type:jwt-bearer`です。</p>
</div>
<div class="paragraph">
<p>アクセストークンを取得するために、既存のリフレッシュトークンが現在の Quarkus エンドポイントにポストされた場合、帯域外リフレッシュトークンを使用して新しいトークンセットを取得する <code>refresh_token</code> グラントを使用する必要があります。この場合、 <code>OidcClient</code> を次のように設定する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.secret=secret
quarkus.oidc-client.grant.type=refresh</code></pre>
</div>
</div>
<div class="paragraph">
<p>続いて、提供されたリフレッシュトークンを使って <code>OidcClient.refreshTokens</code> メソッドを使用して、アクセストークンを取得することができます。</p>
</div>
<div class="paragraph">
<p>Using the <code>urn:ietf:params:oauth:grant-type:token-exchange</code> or <code>urn:ietf:params:oauth:grant-type:jwt-bearer</code> grants may be required if you are building a complex microservices application and would like to avoid the same <code>Bearer</code> token be propagated to and used by more than one service. Please see <a href="#token-propagation-reactive">Token Propagation in MicroProfile RestClient Reactive filter</a> and <a href="#token-propagation">Token Propagation in MicroProfile RestClient filter</a> for more details.</p>
</div>
<div class="paragraph">
<p>何らかの理由で <a href="security-openid-connect-web-authentication">Quarkus OpenID Connect extension</a> を使用して認可コードフローをサポートできない場合は、 <code>OidcClient</code> を使用した <code>authorization code</code> グラントのサポートが必要な場合があります。認可コードフローを実装する正当な理由がある場合は、 <code>OidcClient</code> を以下のように設定することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.secret=secret
quarkus.oidc-client.grant.type=code</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、追加のプロパティーのマップを受け入れる <code>OidcClient.accessTokens</code> メソッドを使用し、現在の <code>code</code> パラメーターと <code>redirect_uri</code> パラメーターを渡して、トークンの認可コードを交換できます。</p>
</div>
</div>
<div class="sect3">
<h4 id="grant-scopes"><a class="anchor" href="#grant-scopes"></a>スコープのグラント</h4>
<div class="paragraph">
<p>スコープの特定のセットが発行されたアクセストークンに関連付けられるように要求する必要がある場合があります。専用の <code>quarkus.oidc-client.scopes</code> リストプロパティーを使用してください (例: <code>quarkus.oidc-client.scopes=email,phone</code>)。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="use-oidcclient-directly"><a class="anchor" href="#use-oidcclient-directly"></a>OidcClient を直接使用する</h3>
<div class="paragraph">
<p>以下のように <code>OidcClient</code> を直接使用することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import javax.inject.PostConstruct;
import javax.inject.Inject;
import javax.ws.rs.GET;

import io.quarkus.oidc.client.OidcClient;
import io.quarkus.oidc.client.Tokens;

@Path("/service")
public class OidcClientResource {

    @Inject
    OidcClient client;

    volatile Tokens currentTokens;

    @PostConstruct
    public void init() {
        currentTokens = client.getTokens().await().indefinitely();
    }

    @GET
    public String getResponse() {

        Tokens tokens = currentTokens;
        if (tokens.isAccessTokenExpired()) {
            // Add @Blocking method annotation if this code is used with Reactive RestClient
            tokens = client.refreshTokens(tokens.getRefreshToken()).await().indefinitely();
            currentTokens = tokens;
        }
        // Use tokens.getAccessToken() to configure MP RestClient Authorization header/etc
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="inject-tokens"><a class="anchor" href="#inject-tokens"></a>トークンを注入する</h3>
<div class="paragraph">
<p>内部で <code>OidcClient</code> を使用する <code>Tokens</code> を注入することができます。 <code>Tokens</code> を使用してアクセストークンを取得し、必要に応じて更新することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import javax.inject.PostConstruct;
import javax.inject.Inject;
import javax.ws.rs.GET;

import io.quarkus.oidc.client.Tokens;

@Path("/service")
public class OidcClientResource {

    @Inject Tokens tokens;

    @GET
    public String getResponse() {
        //  Get the access token which may have been refreshed.
        String accessToken = tokens.getAccessToken();
        // Use the access token to configure MP RestClient Authorization header/etc
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="use-oidc-clients"><a class="anchor" href="#use-oidc-clients"></a>OidcClientsの使用</h3>
<div class="paragraph">
<p><code>io.quarkus.oidc.client.OidcClients</code> は、 <code>OidcClient</code>s のコンテナーです。デフォルトの <code>OidcClient</code> と名前付きクライアントを含み、以下のように設定することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.client-enabled=false

quarkus.oidc-client.jwt-secret.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.jwt-secret.client-id=quarkus-app
quarkus.oidc-client.jwt-secret.credentials.jwt.secret=AyM1SysPpbyDfgZld3umj1qzKObwVMkoqQ-EstJQLr_T-1qS0gZH75aKtMN3Yj0iPS4hcgUuTwjAzZr1Z9CAow</code></pre>
</div>
</div>
<div class="paragraph">
<p>この場合、デフォルトのクライアントは <code>client-enabled=false</code> プロパティーで無効になっていることに注意してください。 <code>jwt-secret</code> クライアントは以下のようにアクセスできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import javax.inject.Inject;
import javax.ws.rs.GET;
import javax.ws.rs.Path;

import io.quarkus.oidc.client.OidcClient;
import io.quarkus.oidc.client.OidcClients;

@Path("/clients")
public class OidcClientResource {

    @Inject
    OidcClients clients;

    @GET
    public String getResponse() {
        OidcClient client = clients.getClient("jwt-secret");
        // use this client to get the token
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="security-openid-connect-multitenancy">OIDC multitenancy</a> を使用し、各 OIDC テナントが独自の関連する <code>OidcClient</code> を持っている場合は、Vert.x <code>RoutingContext</code> <code>tenantId</code> 属性を使用することができます。以下に例を示します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import javax.inject.Inject;
import javax.ws.rs.GET;
import javax.ws.rs.Path;

import io.quarkus.oidc.client.OidcClient;
import io.quarkus.oidc.client.OidcClients;
import io.vertx.ext.web.RoutingContext;

@Path("/clients")
public class OidcClientResource {

    @Inject
    OidcClients clients;
    @Inject
    RoutingContext context;

    @GET
    public String getResponse() {
        String tenantId = context.get("tenantId");
        // named OIDC tenant and client configurations use the same key:
        OidcClient client = clients.getClient(tenantId);
        // use this client to get the token
    }
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>必要であれば、このようにプログラム的に新しい <code>OidcClient</code> を作成することもできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import javax.inject.Inject;
import javax.ws.rs.GET;
import javax.ws.rs.Path;

import io.quarkus.oidc.client.OidcClient;
import io.quarkus.oidc.client.OidcClients;
import io.quarkus.oidc.client.OidcClientConfig;

import io.smallrye.mutiny.Uni;

@Path("/clients")
public class OidcClientResource {

    @Inject
    OidcClients clients;

    @GET
    public String getResponse() {
        OidcClientConfig cfg = new OidcClientConfig();
        cfg.setId("myclient");
        cfg.setAuthServerUrl("http://localhost:8081/auth/realms/quarkus/");
        cfg.setClientId("quarkus");
        cfg.getCredentials().setSecret("secret");
        Uni&lt;OidcClient&gt; client = clients.newClient(cfg);
        // use this client to get the token
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="named-oidc-clients"><a class="anchor" href="#named-oidc-clients"></a>名前付き OidcClient とトークンの挿入</h3>
<div class="paragraph">
<p>複数の設定済みの <code>OidcClient</code>s の場合は、 <code>OidcClients</code> で作業する代わりに、追加の修飾子 <code>@NamedOidcClient</code> で <code>OidcClient</code> 注入ターゲットを指定できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkus.oidc.client;

import javax.inject.Inject;
import javax.ws.rs.GET;
import javax.ws.rs.Path;

@Path("/clients")
public class OidcClientResource {

    @Inject
    @NamedOidcClient("jwt-secret")
    OidcClient client;

    @GET
    public String getResponse() {
        // use client to get the token
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>同じ修飾子を使用して、 <code>Tokens</code> インジェクションに使用される <code>OidcClient</code> を指定できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Provider
@Priority(Priorities.AUTHENTICATION)
@RequestScoped
public class OidcClientRequestCustomFilter implements ClientRequestFilter {

    @Inject
    @NamedOidcClient("jwt-secret")
    Tokens tokens;

    @Override
    public void filter(ClientRequestContext requestContext) throws IOException {
        requestContext.getHeaders().add(HttpHeaders.AUTHORIZATION, "Bearer " + tokens.getAccessToken());
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="oidc-client-reactive-filter"><a class="anchor" href="#oidc-client-reactive-filter"></a>RestClient の Reactive ClientFilter で OidcClient を使用する</h3>
<div class="paragraph">
<p>以下の Maven 依存関係を追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-oidc-client-reactive-filter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>io.quarkus:quarkus-oidc-client</code> も表示されることに注意してください。</p>
</div>
<div class="paragraph">
<p><code>quarkus-oidc-client-reactive-filter</code> エクステンションは、 <code>io.quarkus.oidc.client.filter.OidcClientRequestReactiveFilter</code> を提供します。</p>
</div>
<div class="paragraph">
<p>これは <code>OidcClientRequestFilter</code> と同じように機能します (<a href="#oidc-client-filter">Use OidcClient in MicroProfile RestClient client filter</a> を参照) - <code>OidcClient</code> を使用してアクセストークンを取得し、必要に応じてリフレッシュして、HTTP <code>Authorization</code> <code>Bearer</code> スキームの値としてセットします。違いは、<a href="rest-client-reactive">Reactive RestClient</a> で機能することと、トークンの取得や更新時に現在の IO スレッドをブロックしないノンブロッキングクライアントフィルターを実装している点です。</p>
</div>
<div class="paragraph">
<p>IOスレッドのブロックを避けるために、 <code>OidcClientRequestReactiveFilter</code> は実行されるまで最初のトークン取得を遅らせます。</p>
</div>
<div class="paragraph">
<p><code>io.quarkus.oidc.client.filter.OidcClientFilter</code> または <code>org.eclipse.microprofile.rest.client.annotation.RegisterProvider</code> アノテーションを使用して <code>OidcClientRequestFilter</code> を選択的に登録することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.rest.client.annotation.RegisterProvider;
import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.client.filter.OidcClientFilter;
import io.smallrye.mutiny.Uni;

@RegisterRestClient
@OidcClientFilter
@Path("/")
public interface ProtectedResourceService {

    @GET
    Uni&lt;String&gt; getUserName();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.rest.client.annotation.RegisterProvider;
import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.client.reactive.filter.OidcClientRequestReactiveFilter;
import io.smallrye.mutiny.Uni;

@RegisterRestClient
@RegisterProvider(OidcClientRequestReactiveFilter.class)
@Path("/")
public interface ProtectedResourceService {

    @GET
    Uni&lt;String&gt; getUserName();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>OidcClientRequestReactiveFilter</code> uses a default <code>OidcClient</code> by default. A named <code>OidcClient</code> can be selected with a <code>quarkus.oidc-client-reactive-filter.client-name</code> configuration property.
You can also select <code>OidcClient</code> by setting <code>value</code> attribute of the <code>@OidcClientFilter</code> annotation. The client name set through annotation has higher priority than the <code>quarkus.oidc-client-reactive-filter.client-name</code> configuration property.
For example, given <a href="#use-oidc-clients">this</a> <code>jwt-secret</code> named OIDC client declaration, you can refer to this client like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.rest.client.annotation.RegisterProvider;
import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.client.filter.OidcClientFilter;
import io.smallrye.mutiny.Uni;

@RegisterRestClient
@OidcClientFilter("jwt-secret")
@Path("/")
public interface ProtectedResourceService {

    @GET
    Uni&lt;String&gt; getUserName();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="oidc-client-filter"><a class="anchor" href="#oidc-client-filter"></a>RestClient の ClientFilter で OidcClient を使用する</h3>
<div class="paragraph">
<p>以下の Maven 依存関係を追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-oidc-client-filter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>io.quarkus:quarkus-oidc-client</code> も表示されることに注意してください。</p>
</div>
<div class="paragraph">
<p><code>quarkus-oidc-client-filter</code> エクステンションは <code>io.quarkus.oidc.client.filter.OidcClientRequestFilter</code> JAX-RS ClientRequestFilter を提供します。このフィルターは、 <code>OidcClient</code> を使用してアクセストークンを取得し、必要に応じて更新し、HTTP <code>Authorization</code> <code>Bearer</code> スキーム値として設定します。</p>
</div>
<div class="paragraph">
<p>デフォルトでは、このフィルタは初期化時に <code>OidcClient</code> を取得してアクセストークンとリフレッシュトークンの最初のペアを取得します。アクセストークンが短命でリフレッシュトークンが利用できない場合は、 <code>quarkus.oidc-client.early-tokens-acquisition=false</code> でトークンの取得を遅延させるべきです。</p>
</div>
<div class="paragraph">
<p><code>io.quarkus.oidc.client.filter.OidcClientFilter</code> または <code>org.eclipse.microprofile.rest.client.annotation.RegisterProvider</code> アノテーションを使用して <code>OidcClientRequestFilter</code> を選択的に登録することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.client.filter.OidcClientFilter;

@RegisterRestClient
@OidcClientFilter
@Path("/")
public interface ProtectedResourceService {

    @GET
    String getUserName();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.rest.client.annotation.RegisterProvider;
import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.client.filter.OidcClientRequestFilter;

@RegisterRestClient
@RegisterProvider(OidcClientRequestFilter.class)
@Path("/")
public interface ProtectedResourceService {

    @GET
    String getUserName();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>または、 <code>quarkus.oidc-client-filter.register-filter=true</code> プロパティーが設定されている場合、すべての MP Rest または JAX-RS クライアントで <code>OidcClientRequestFilter</code> を自動的に登録することができます。</p>
</div>
<div class="paragraph">
<p><code>OidcClientRequestFilter</code> uses a default <code>OidcClient</code> by default. A named <code>OidcClient</code> can be selected with a <code>quarkus.oidc-client-filter.client-name</code> configuration property.
You can also select <code>OidcClient</code> by setting <code>value</code> attribute of the <code>@OidcClientFilter</code> annotation. The client name set through annotation has higher priority than the <code>quarkus.oidc-client-filter.client-name</code> configuration property.
For example, given <a href="#use-oidc-clients">this</a> <code>jwt-secret</code> named OIDC client declaration, you can refer to this client like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.client.filter.OidcClientFilter;

@RegisterRestClient
@OidcClientFilter("jwt-secret")
@Path("/")
public interface ProtectedResourceService {

    @GET
    String getUserName();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="use-custom-restclient-clientfilter"><a class="anchor" href="#use-custom-restclient-clientfilter"></a>カスタム RestClient ClientFilter の使用</h3>
<div class="paragraph">
<p>ご希望の場合は、独自のカスタムフィルターを使用して、 <code>Tokens</code> を注入することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.oidc.client.Tokens;

@Provider
@Priority(Priorities.AUTHENTICATION)
public class OidcClientRequestCustomFilter implements ClientRequestFilter {

    @Inject
    Tokens tokens;

    @Override
    public void filter(ClientRequestContext requestContext) throws IOException {
        requestContext.getHeaders().add(HttpHeaders.AUTHORIZATION, "Bearer " + tokens.getAccessToken());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Tokens</code> プロデューサーがトークンを取得・更新し、カスタムフィルターが何時、どのようにトークンを使用するかを決定します。</p>
</div>
<div class="paragraph">
<p>名前付きの <code>Tokens</code> を挿入することもできます。<a href="#named-oidc-clients">Inject named OidcClient and Tokens</a> を参照してください。</p>
</div>
</div>
<div class="sect2">
<h3 id="refresh-access-tokens"><a class="anchor" href="#refresh-access-tokens"></a>アクセストークンの更新</h3>
<div class="paragraph">
<p><code>OidcClientRequestReactiveFilter</code>、 <code>OidcClientRequestFilter</code> および <code>Tokens</code> プロデューサーは、リフレッシュトークンが利用可能な場合、現在の期限切れアクセストークンをリフレッシュします。さらに、 <code>quarkus.oidc-client.refresh-token-time-skew</code> プロパティーは、HTTP 401 エラーの原因となる可能性のある期限切れ間近のアクセストークンの送信を避けるために、アクセストークンのリフレッシュを先取りして行うことに使用できます。たとえば、このプロパティーが <code>3S</code> に設定されていて、アクセストークンが 3 秒以内に期限切れになる場合、このトークンは自動的にリフレッシュされます。</p>
</div>
<div class="paragraph">
<p>アクセストークンの更新が必要なのにリフレッシュトークンがない場合は、 <code>client_credentials</code> のように設定されたグラントを使って新しいトークンの取得を試みます。</p>
</div>
<div class="paragraph">
<p>一部の OpenID Connect プロバイダーは、 <code>client_credentials</code> グラントレスポンスでリフレッシュトークンを返さない点にご注意ください。たとえば、Keycloak 12 以降、 <code>client_credentials</code> のリフレッシュトークンはデフォルトでは返されません。また、プロバイダーは、リフレッシュトークンを使用できる回数を制限する場合もあります。</p>
</div>
</div>
<div class="sect2">
<h3 id="revoke-access-tokens"><a class="anchor" href="#revoke-access-tokens"></a>アクセストークンの失効</h3>
<div class="paragraph">
<p>Keycloak などの OpenId Connect プロバイダがトークンの失効エンドポイントをサポートしている場合、 <code>OidcClient#revokeAccessToken</code> を使うことで現在のアクセストークンを失効させることができます。失効エンドポイントの URL は、トークン要求 URI と共に検出されるか、または <code>quarkus.oidc-client.revoke-path</code> で設定することができます。</p>
</div>
<div class="paragraph">
<p>RESTクライアントで使用するとHTTP <code>401</code> で失敗するアクセストークンを使っている場合や、長い時間使用されているアクセストークンをリフレッシュしたい場合は、アクセストークンを失効させることができます。</p>
</div>
<div class="paragraph">
<p>リフレッシュトークンを使用してトークンのリフレッシュを要求することができます。リフレッシュトークンが利用できない場合は、まずそれを失効させてから、新しいアクセストークンをリクエストすることでリフレッシュできます。</p>
</div>
</div>
<div class="sect2">
<h3 id="oidc-client-authentication"><a class="anchor" href="#oidc-client-authentication"></a>OidcClient 認証</h3>
<div class="paragraph">
<p><code>OidcClient</code> は、 <code>client_credentials</code> および他のグラントリクエストが成功するために OpenID Connect プロバイダーに対して認証する必要があります。 <a href="https://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication">OIDC Client Authentication</a> オプションはすべてサポートされています。以下に例を示します。</p>
</div>
<div class="paragraph">
<p><code>client_secret_basic</code> .</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.secret=mysecret</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.client-secret.value=mysecret</code></pre>
</div>
</div>
<div class="paragraph">
<p>または、<a href="credentials-provider">CredentialsProvider</a>: から取得したシークレットを使用します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app

# This is a key which will be used to retrieve a secret from the map of credentials returned from CredentialsProvider
quarkus.oidc-client.credentials.client-secret.provider.key=mysecret-key
# Set it only if more than one CredentialsProvider can be registered
quarkus.oidc-client.credentials.client-secret.provider.name=oidc-credentials-provider</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>client_secret_post</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.client-secret.value=mysecret
quarkus.oidc-client.credentials.client-secret.method=post</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>client_secret_jwt</code>、署名アルゴリズムは <code>HS256</code> です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.jwt.secret=AyM1SysPpbyDfgZld3umj1qzKObwVMkoqQ-EstJQLr_T-1qS0gZH75aKtMN3Yj0iPS4hcgUuTwjAzZr1Z9CAow</code></pre>
</div>
</div>
<div class="paragraph">
<p>または、<a href="credentials-provider">CredentialsProvider</a> から取得したシークレットを使用すると、署名アルゴリズムは <code>HS256</code> になります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app

# This is a key which will be used to retrieve a secret from the map of credentials returned from CredentialsProvider
quarkus.oidc-client.credentials.jwt.secret-provider.key=mysecret-key
# Set it only if more than one CredentialsProvider can be registered
quarkus.oidc-client.credentials.jwt.secret-provider.name=oidc-credentials-provider</code></pre>
</div>
</div>
<div class="paragraph">
<p>PEM キーファイルを使用した`private_key_jwt`、署名アルゴリズムは <code>RS256</code> です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.jwt.key-file=privateKey.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>キーストアファイルを使用した`private_key_jwt`、署名アルゴリズムは <code>RS256</code> です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.jwt.key-store-file=keystore.jks
quarkus.oidc-client.credentials.jwt.key-store-password=mypassword
quarkus.oidc-client.credentials.jwt.key-password=mykeypassword

# Private key alias inside the keystore
quarkus.oidc-client.credentials.jwt.key-id=mykeyAlias</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>client_secret_jwt</code> または <code>private_key_jwt</code> 認証方法を使用することで、クライアントシークレットが漏れることはありません。</p>
</div>
<div class="sect3">
<h4 id="additional-jwt-authentication-options"><a class="anchor" href="#additional-jwt-authentication-options"></a>追加の JWT 認証オプション</h4>
<div class="paragraph">
<p><code>client_secret_jwt</code> または <code>private_key_jwt</code> のいずれかの認証方法を使用する場合は、JWT 署名アルゴリズム、鍵識別子、オーディエンス、サブジェクト、および発行者をカスタマイズすることができます。以下に例を示します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># private_key_jwt client authentication

quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus/
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.jwt.key-file=privateKey.pem

# This is a token key identifier 'kid' header - set it if your OpenID Connect provider requires it.
# Note if the key is represented in a JSON Web Key (JWK) format with a `kid` property then
# using 'quarkus.oidc-client.credentials.jwt.token-key-id' is not necessary.
quarkus.oidc-client.credentials.jwt.token-key-id=mykey

# Use RS512 signature algorithm instead of the default RS256
quarkus.oidc-client.credentials.jwt.signature-algorithm=RS512

# The token endpoint URL is the default audience value, use the base address URL instead:
quarkus.oidc-client.credentials.jwt.audience=${quarkus.oidc-client.auth-server-url}

# custom subject instead of the client id :
quarkus.oidc-client.credentials.jwt.subject=custom-subject

# custom issuer instead of the client id :
quarkus.oidc-client.credentials.jwt.issuer=custom-issuer</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="apple-post-jwt"><a class="anchor" href="#apple-post-jwt"></a>Apple POST JWT</h4>
<div class="paragraph">
<p>Apple OpenID Connect プロバイダーは <code>client_secret_post</code> メソッドを使用します。ここで、secret は <code>private_key_jwt</code> 認証メソッドで生成された JWT ですが、Apple アカウント固有の発行者とサブジェクトプロパティーを使用します。</p>
</div>
<div class="paragraph">
<p><code>quarkus-oidc-client</code> は、以下のように設定できる標準外の <code>client_secret_post_jwt</code> 認証方法をサポートしています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=${apple.url}
quarkus.oidc-client.client-id=${apple.client-id}
quarkus.oidc-client.credentials.client-secret.method=post-jwt

quarkus.oidc-client.credentials.jwt.key-file=ecPrivateKey.pem
quarkus.oidc-client.credentials.jwt.signature-algorithm=ES256
quarkus.oidc-client.credentials.jwt.subject=${apple.subject}
quarkus.oidc-client.credentials.jwt.issuer=${apple.issuer}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="mutual-tls"><a class="anchor" href="#mutual-tls"></a>相互 TLS</h4>
<div class="paragraph">
<p>OpenID Connect プロバイダーによっては、クライアントが <code>Mutual TLS</code> (<code>mTLS</code>) 認証プロセスの一部として認証されることを要求する場合があります。</p>
</div>
<div class="paragraph">
<p><code>mTLS</code> をサポートする為に <code>quarkus-oidc-client</code> は以下のように設定出来ます :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc.tls.verification=certificate-validation

# Keystore configuration
quarkus.oidc.client.tls.key-store-file=client-keystore.jks
quarkus.oidc.client.tls.key-store-password=${key-store-password}

# Add more keystore properties if needed:
#quarkus.oidc.client.tls.key-store-alias=keyAlias
#quarkus.oidc.client.tls.key-store-alias-password=keyAliasPassword

# Truststore configuration
quarkus.oidc-client.tls.trust-store-file=client-truststore.jks
quarkus.oidc-client.tls.trust-store-password=${trust-store-password}
# Add more truststore properties if needed:
#quarkus.oidc.client.tls.trust-store-alias=certAlias</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integration-testing-oidc-client"><a class="anchor" href="#integration-testing-oidc-client"></a>テスト</h3>
<div class="paragraph">
<p>テストプロジェクトに以下の依存関係を追加することから始めます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-junit5&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.awaitility&lt;/groupId&gt;
    &lt;artifactId&gt;awaitility&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="integration-testing-wiremock"><a class="anchor" href="#integration-testing-wiremock"></a>Wiremock</h4>
<div class="paragraph">
<p>テストプロジェクトに以下の依存関係を追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.github.tomakehurst&lt;/groupId&gt;
    &lt;artifactId&gt;wiremock-jre8&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wiremockベースの <code>QuarkusTestResourceLifecycleManager</code> を例えば以下のように書きます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkus.it.keycloak;

import static com.github.tomakehurst.wiremock.client.WireMock.matching;
import static com.github.tomakehurst.wiremock.core.WireMockConfiguration.wireMockConfig;

import java.util.HashMap;
import java.util.Map;

import com.github.tomakehurst.wiremock.WireMockServer;
import com.github.tomakehurst.wiremock.client.WireMock;
import com.github.tomakehurst.wiremock.core.Options.ChunkedEncodingPolicy;

import io.quarkus.test.common.QuarkusTestResourceLifecycleManager;

public class KeycloakRealmResourceManager implements QuarkusTestResourceLifecycleManager {
    private WireMockServer server;

    @Override
    public Map&lt;String, String&gt; start() {

        server = new WireMockServer(wireMockConfig().dynamicPort().useChunkedTransferEncoding(ChunkedEncodingPolicy.NEVER));
        server.start();

        server.stubFor(WireMock.post("/tokens")
                .withRequestBody(matching("grant_type=password&amp;username=alice&amp;password=alice"))
                .willReturn(WireMock
                        .aResponse()
                        .withHeader("Content-Type", "application/json")
                        .withBody(
                                "{\"access_token\":\"access_token_1\", \"expires_in\":4, \"refresh_token\":\"refresh_token_1\"}")));
        server.stubFor(WireMock.post("/tokens")
                .withRequestBody(matching("grant_type=refresh_token&amp;refresh_token=refresh_token_1"))
                .willReturn(WireMock
                        .aResponse()
                        .withHeader("Content-Type", "application/json")
                        .withBody(
                                "{\"access_token\":\"access_token_2\", \"expires_in\":4, \"refresh_token\":\"refresh_token_1\"}")));


        Map&lt;String, String&gt; conf = new HashMap&lt;&gt;();
        conf.put("keycloak.url", server.baseUrl());
        return conf;
    }

    @Override
    public synchronized void stop() {
        if (server != null) {
            server.stop();
            server = null;
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>RESTテストエンドポイントを用意します。注入されたMP RESTクライアントを登録されたOidcClientフィルターで使用するテスト用フロントエンドエンドポイントが、トークンをエコーバックするダウンストリームエンドポイントを呼び出すことができます。例として、 <code>main</code> Quarkusリポジトリの <code>integration-tests/oidc-client-wiremock</code> を参照してください。</p>
</div>
<div class="paragraph">
<p><code>application.properties</code> を次のように設定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># Use 'keycloak.url' property set by the test KeycloakRealmResourceManager
quarkus.oidc-client.auth-server-url=${keycloak.url}
quarkus.oidc-client.discovery-enabled=false
quarkus.oidc-client.token-path=/tokens
quarkus.oidc-client.client-id=quarkus-service-app
quarkus.oidc-client.credentials.secret=secret
quarkus.oidc-client.grant.type=password
quarkus.oidc-client.grant-options.password.username=alice
quarkus.oidc-client.grant-options.password.password=alice</code></pre>
</div>
</div>
<div class="paragraph">
<p>そして最後にテストコードを書きます。上記の Wiremock ベースのリソースがある場合、最初のテスト起動では <code>access_token_1</code> アクセストークンが返却されますが、このアクセストークンは 4 秒で期限切れになります。 <code>awaitility</code> を使用して約 5 秒間待つと、次のテスト起動時に <code>access_token_2</code> アクセストークンが返され、期限切れの <code>access_token_1</code> アクセストークンがリフレッシュされたことが確認できます。</p>
</div>
</div>
<div class="sect3">
<h4 id="keycloak"><a class="anchor" href="#keycloak"></a>Keycloak</h4>
<div class="paragraph">
<p>Keycloak を使用する場合は、<a href="security-openid-connect#integration-testing-keycloak">OpenID Connect Bearer Token 結合テスト</a> Keycloak セクションで説明したのと同じ方法を使用することができます。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="how-to-check-the-errors-in-the-logs"><a class="anchor" href="#how-to-check-the-errors-in-the-logs"></a>ログでエラーを確認する方法</h3>
<div class="paragraph">
<p>トークンの取得および更新エラーの詳細を確認するには、 <code>io.quarkus.oidc.client.runtime.OidcClientImpl</code> <code>TRACE</code> レベルのロギングを有効にしてください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.log.category."io.quarkus.oidc.client.runtime.OidcClientImpl".level=TRACE
quarkus.log.category."io.quarkus.oidc.client.runtime.OidcClientImpl".min-level=TRACE</code></pre>
</div>
</div>
<div class="paragraph">
<p>OidcClient 初期化エラーの詳細を確認するには、 <code>io.quarkus.oidc.client.runtime.OidcClientRecorder</code> <code>TRACE</code> レベルのログを有効にしてください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.log.category."io.quarkus.oidc.client.runtime.OidcClientRecorder".level=TRACE
quarkus.log.category."io.quarkus.oidc.client.runtime.OidcClientRecorder".min-level=TRACE</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="token-propagation-reactive"><a class="anchor" href="#token-propagation-reactive"></a>トークン伝播リアクティブ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>quarkus-oidc-token-propagation-reactive</code> extension provides RestEasy Reactive Client <code>io.quarkus.oidc.token.propagation.reactive.AccessTokenRequestReactiveFilter</code> that simplifies the propagation of authentication information by propagating the <a href="security-openid-connect">Bearer</a> token present in the current active request or the token acquired from the <a href="security-openid-connect-web-authentication">Authorization Code Flow</a>, as the HTTP <code>Authorization</code> header&#8217;s <code>Bearer</code> scheme value.</p>
</div>
<div class="paragraph">
<p><code>io.quarkus.oidc.token.propagation.AccessToken</code> または <code>org.eclipse.microprofile.rest.client.annotation.RegisterProvider</code> のいずれかを使用して、 <code>AccessTokenRequestFilter</code> を選択的に登録できます。例:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.token.propagation.AccessToken;

@RegisterRestClient
@AccessToken
@Path("/")
public interface ProtectedResourceService {

    @GET
    String getUserName();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.rest.client.annotation.RegisterProvider;
import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.token.propagation.reactive.AccessTokenRequestReactiveFilter;

@RegisterRestClient
@RegisterProvider(AccessTokenRequestReactiveFilter.class)
@Path("/")
public interface ProtectedResourceService {

    @GET
    String getUserName();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>さらに、 <code>AccessTokenRequestReactiveFilter</code> 、トークンを伝播する前に交換する必要がある複雑なアプリケーションをサポートすることができます。</p>
</div>
<div class="paragraph">
<p>もし、現在のアクセストークンを伝播する前に交換する必要があり、かつ <a href="https://www.keycloak.org/docs/latest/securing_apps/#_token-exchange">Keycloak</a> やその他の <a href="https://tools.ietf.org/html/rfc8693">Token Exchange</a> トークングラントをサポートする OpenID Connect Provider で作業する場合は、 <code>AccessTokenRequestFilter</code> をこのように設定することが可能です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.secret=secret
quarkus.oidc-client.grant.type=exchange
quarkus.oidc-client.grant-options.exchange.audience=quarkus-app-exchange

quarkus.oidc-token-propagation.exchange-token=true</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>AccessTokenRequestReactiveFilter</code> は <code>OidcClient</code> を使用して現在のトークンを交換することに注意してください。また、 <code>quarkus.oidc-client.grant-options.exchange</code> を使用して OpenID Connect プロバイダーが期待する追加の交換プロパティーを設定できます。</p>
</div>
<div class="paragraph">
<p><code>Azure</code> のように、 <a href="https://www.rfc-editor.org/rfc/rfc7523#section-2.1">JWTベアラートークングラント</a> を使用して現在のトークンを交換する <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow#example">必要がある</a> プロバイダを使用する場合、 <code>AccessTokenRequestReactiveFilter</code> をトークンを交換するように設定することができます：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=${azure.provider.url}
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.secret=secret

quarkus.oidc-client.grant.type=jwt
quarkus.oidc-client.grant-options.jwt.requested_token_use=on_behalf_of
quarkus.oidc-client.scopes=https://graph.microsoft.com/user.read,offline_access

quarkus.oidc-token-propagation-reactive.exchange-token=true</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>AccessTokenRequestReactiveFilter</code> はデフォルトでデフォルトの <code>OidcClient</code> を使用します。名前付きの <code>OidcClient</code> は <code>quarkus.oidc-token-propagation-reactive.client-name</code> 設定プロパティーで選択することができます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="token-propagation"><a class="anchor" href="#token-propagation"></a>トークンの伝播</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>quarkus-oidc-token-propagation</code> エクステンションは、認証情報の伝搬を簡素化する 2 つの JAX-RS <code>javax.ws.rs.client.ClientRequestFilter</code> クラスの実装を提供します。 <code>io.quarkus.oidc.token.propagation.AccessTokenRequestFilter</code> は、現在のアクティブなリクエストに存在する <a href="security-openid-connect">Bearer</a> トークン、または HTTP <code>Authorization</code> ヘッダーの <code>Bearer</code> スキーム値として <a href="security-openid-connect-web-authentication">Authorization Code Flow</a> から取得したトークンを伝播させます。 <code>io.quarkus.oidc.token.propagation.JsonWebTokenRequestFilter</code> は同じ機能を提供しますが、これに加えて JWT トークンのサポートも提供します。</p>
</div>
<div class="paragraph">
<p>現在の認可コードフローアクセストークンを伝播する必要がある場合は、即時トークン伝播はうまく機能します - コードフローアクセストークン (ID トークンとは対照的に) は、現在認証されているユーザーに代わってリモートサービスにアクセスするように、現在の Quarkus エンドポイントに伝搬されることが意図されています。</p>
</div>
<div class="paragraph">
<p>ただし、可能であれば、エンドツーエンドのベアラートークンの直接伝播は避ける必要があります。たとえば、 <code>Client &#8594; Service A &#8594; Service B</code> で、 <code>Service B</code> は <code>Client</code> から <code>Service A</code> に送信されたトークンを受け取ります。このような場合、 <code>Service B</code> は、トークンが <code>Service A</code> からのものか、直接 <code>Client</code> からのものかを区別できません。トークンが <code>Service A</code> からのものであることを <code>Service B</code> が確認するには、新しい発行者とオーディエンスのクレームをアサートできる必要があります。</p>
</div>
<div class="paragraph">
<p>さらに、複雑なアプリケーションでは、トークンを伝搬する前に交換または更新する必要がある場合があります。たとえば、 <code>Service A</code> が <code>Service B</code> にアクセスするとき、アクセスコンテキストが異なるかもしれません。この場合、 <code>Service A</code> には <code>Service B</code> にアクセスするための狭いスコープまたは完全に異なるスコープのセットがグラントされることがあります。</p>
</div>
<div class="paragraph">
<p>次のセクションでは、 <code>AccessTokenRequestFilter</code> および <code>JsonWebTokenRequestFilter</code> がどのように役立つかを示します。</p>
</div>
<div class="sect2">
<h3 id="restclient-accesstokenrequestfilter"><a class="anchor" href="#restclient-accesstokenrequestfilter"></a>RestClient AccessTokenRequestFilter</h3>
<div class="paragraph">
<p><code>AccessTokenRequestFilter</code> は、すべてのトークンをStringとして扱うため、JWTトークンと不透明なトークンの両方を扱うことができます。</p>
</div>
<div class="paragraph">
<p><code>io.quarkus.oidc.token.propagation.AccessToken</code> または <code>org.eclipse.microprofile.rest.client.annotation.RegisterProvider</code> のいずれかを使用して、 <code>AccessTokenRequestFilter</code> を選択的に登録できます。例:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.token.propagation.AccessToken;

@RegisterRestClient
@AccessToken
@Path("/")
public interface ProtectedResourceService {

    @GET
    String getUserName();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.rest.client.annotation.RegisterProvider;
import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.token.propagation.AccessTokenRequestFilter;

@RegisterRestClient
@RegisterProvider(AccessTokenRequestFilter.class)
@Path("/")
public interface ProtectedResourceService {

    @GET
    String getUserName();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>または、 <code>quarkus.oidc-token-propagation.register-filter</code> プロパティが <code>true</code> に設定され、 <code>quarkus.oidc-token-propagation.json-web-token</code> プロパティが <code>false</code> に設定されている場合（デフォルト値です）、すべての MP Rest または JAX-RS クライアントで <code>AccessTokenRequestFilter</code> を自動的に登録することができます。</p>
</div>
<div class="sect3">
<h4 id="exchange-token-before-propagation"><a class="anchor" href="#exchange-token-before-propagation"></a>伝搬前のトークンの交換</h4>
<div class="paragraph">
<p>もし、現在のアクセストークンを伝搬する前に交換する必要があり、かつ <a href="https://www.keycloak.org/docs/latest/securing_apps/#_token-exchange">Keycloak</a> または他の <a href="https://tools.ietf.org/html/rfc8693">Token Exchange</a> トークングラントをサポートする OpenID Connect プロバイダーで作業する場合は、 <code>AccessTokenRequestFilter</code> を以下のように設定することが可能です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=http://localhost:8180/auth/realms/quarkus
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.secret=secret
quarkus.oidc-client.grant.type=exchange
quarkus.oidc-client.grant-options.exchange.audience=quarkus-app-exchange

quarkus.oidc-token-propagation.exchange-token=true</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Azure</code> のように、 <a href="https://www.rfc-editor.org/rfc/rfc7523#section-2.1">JWTベアラートークングラント</a> を使用して現在のトークンを交換する <a href="https://learn.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-on-behalf-of-flow#example">必要がある</a> プロバイダを使用する場合、 <code>AccessTokenRequestFilter</code> のようにトークンを交換するように設定することができます：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-client.auth-server-url=${azure.provider.url}
quarkus.oidc-client.client-id=quarkus-app
quarkus.oidc-client.credentials.secret=secret

quarkus.oidc-client.grant.type=jwt
quarkus.oidc-client.grant-options.jwt.requested_token_use=on_behalf_of
quarkus.oidc-client.scopes=https://graph.microsoft.com/user.read,offline_access

quarkus.oidc-token-propagation.exchange-token=true</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>AccessTokenRequestFilter</code> は <code>OidcClient</code> を使用して現在のトークンを交換することに注意してください。また、 <code>quarkus.oidc-client.grant-options.exchange</code> を使用して OpenID Connect プロバイダーが期待する追加の交換プロパティーを設定できます。</p>
</div>
<div class="paragraph">
<p><code>AccessTokenRequestFilter</code> はデフォルトで <code>OidcClient</code> を使用します。名前付きの <code>OidcClient</code> は、 <code>quarkus.oidc-token-propagation.client-name</code> 設定プロパティーで選択することができます。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="restclient-jsonwebtokenrequestfilter"><a class="anchor" href="#restclient-jsonwebtokenrequestfilter"></a>RestClient JsonWebTokenRequestFilter</h3>
<div class="paragraph">
<p><code>JsonWebTokenRequestFilter</code> の使用は、ベアラー JWT トークンで作業する場合に推奨されます。これらのトークンは <code>issuer</code> や <code>audience</code> などのクレームを変更し、更新されたトークンを再度保護 (再署名など) することができます。注入された <code>org.eclipse.microprofile.jwt.JsonWebToken</code> を想定しているため、不透明なトークンでは機能しません。また、OpenID Connect プロバイダーが Token Exchange プロトコルをサポートしている場合は、代わりに <code>AccessTokenRequestFilter</code> を使用することが推奨されます。JWT と不透明なベアラートークンの両方を <code>AccessTokenRequestFilter</code> と安全に交換することができるからです。</p>
</div>
<div class="paragraph">
<p><code>JsonWebTokenRequestFilter</code> は、 <code>Service A</code> の実装が、注入された <code>org.eclipse.microprofile.jwt.JsonWebToken</code> を新しい <code>issuer</code> と <code>audience</code> のクレーム値で更新し、更新されたトークンを新しい署名で再度保護することを容易にします。唯一の難しいステップは、 <code>Service A</code> に署名鍵を持たせることです。署名鍵は、安全なファイルシステムまたは Vault などのリモートの安全なストレージからプロビジョニングする必要があります。</p>
</div>
<div class="paragraph">
<p>たとえば、 <code>io.quarkus.oidc.token.propagation.JsonWebToken</code> または <code>org.eclipse.microprofile.rest.client.annotation.RegisterProvider</code> を使用して、 <code>JsonWebTokenRequestFilter</code> を選択的に登録することが可能です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.token.propagation.JsonWebToken;

@RegisterRestClient
@JsonWebToken
@Path("/")
public interface ProtectedResourceService {

    @GET
    String getUserName();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.rest.client.annotation.RegisterProvider;
import org.eclipse.microprofile.rest.client.inject.RegisterRestClient;
import io.quarkus.oidc.token.propagation.JsonWebTokenRequestFilter;

@RegisterRestClient
@RegisterProvider(JsonWebTokenRequestFilter.class)
@Path("/")
public interface ProtectedResourceService {

    @GET
    String getUserName();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>または、 <code>quarkus.oidc-token-propagation.register-filter</code> プロパティーおよび <code>quarkus.oidc-token-propagation.json-web-token</code> プロパティーの両方が <code>true</code> に設定されている場合、 <code>JsonWebTokenRequestFilter</code> は、すべての MP Rest または JAX-RS クライアントで自動的に登録することができます。</p>
</div>
<div class="sect3">
<h4 id="update-token-before-propagation"><a class="anchor" href="#update-token-before-propagation"></a>伝搬前のトークンの更新</h4>
<div class="paragraph">
<p>注入されたトークンの <code>iss</code> (発行者) や <code>aud</code> (オーディエンス) のクレームを更新して、新しい署名で保護する必要がある場合は、 <code>JsonWebTokenRequestFilter</code> を以下のように設定できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.oidc-token-propagation.secure-json-web-token=true
smallrye.jwt.sign.key.location=/privateKey.pem
# Set a new issuer
smallrye.jwt.new-token.issuer=http://frontend-resource
# Set a new audience
smallrye.jwt.new-token.audience=http://downstream-resource
# Override the existing token issuer and audience claims if they are already set
smallrye.jwt.new-token.override-matching-claims=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>前述のように、Token Exchange プロトコルをサポートする Keycloak または OpenID Connect プロバイダーを使用する場合は、 <code>AccessTokenRequestFilter</code> を使用してください。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="integration-testing-token-propagation"><a class="anchor" href="#integration-testing-token-propagation"></a>テスト</h3>
<div class="paragraph">
<p><a href="security-openid-connect#integration-testing">OpenID Connect Bearer Token Integration testing</a> のセクションで説明したように、トークンを生成することができます。REST テストエンドポイントを準備します。登録されたトークン伝搬フィルターで注入された MP REST クライアントを使用するテストフロントエンドエンドポイントは、ダウンストリームエンドポイントで呼び出すことができます。たとえば、 <code>main</code> Quarkus リポジトリーの <code>integration-tests/oidc-token-propagation</code> を参照してください。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reactive-token-propagation"><a class="anchor" href="#reactive-token-propagation"></a>トークン伝播リアクティブ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>以下の Maven 依存関係を追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-oidc-token-propagation-reactive&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>quarkus-oidc-token-propagation-reactive</code> エクステンションは、 <code>io.quarkus.oidc.token.propagation.reactive.AccessTokenRequestReactiveFilter</code> を提供します。これは、現在の <code>Bearer</code> または <code>Authorization Code Flow</code> アクセストークンを伝播するために使用することができます。</p>
</div>
<div class="paragraph">
<p>(非リアクティブの <code>quarkus-oidc-token-propagation</code> エクステンションとは対照的に) <code>quarkus-oidc-token-propagation-reactive</code> エクステンションは現在、伝播の前にトークンを交換したり放棄することをサポートしていません。しかし、これらの機能は将来的に追加される可能性があります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references"><a class="anchor" href="#references"></a>参照</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="security-openid-connect-client">OpenID Connect Clientとトークン伝搬クイックスタート</a></p>
</li>
<li>
<p><a href="security-openid-connect">Quarkus - OpenID Connect (OIDC) を使用した、ベアラートークン認可によるサービスアプリケーションの保護</a></p>
</li>
<li>
<p><a href="security-openid-connect-web-authentication">Quarkus - OpenID Connect を使用した、認可コードフローによる Web アプリケーションの保護</a></p>
</li>
<li>
<p><a href="security-overview-concept">Quarkus Security 概要</a></p>
</li>
</ul>
</div>
</div>
</div>
    </div>
    <div class="grid__item width-4-12 width-12-12-m tocwrapper">
      <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#oidcclient">OidcClient</a>
<ul class="sectlevel2">
<li><a href="#token-endpoint-configuration">トークンエンドポイントの設定</a></li>
<li><a href="#supported-token-grants">サポートされるトークングラント</a></li>
<li><a href="#use-oidcclient-directly">OidcClient を直接使用する</a></li>
<li><a href="#inject-tokens">トークンを注入する</a></li>
<li><a href="#use-oidc-clients">OidcClientsの使用</a></li>
<li><a href="#named-oidc-clients">名前付き OidcClient とトークンの挿入</a></li>
<li><a href="#oidc-client-reactive-filter">RestClient の Reactive ClientFilter で OidcClient を使用する</a></li>
<li><a href="#oidc-client-filter">RestClient の ClientFilter で OidcClient を使用する</a></li>
<li><a href="#use-custom-restclient-clientfilter">カスタム RestClient ClientFilter の使用</a></li>
<li><a href="#refresh-access-tokens">アクセストークンの更新</a></li>
<li><a href="#revoke-access-tokens">アクセストークンの失効</a></li>
<li><a href="#oidc-client-authentication">OidcClient 認証</a></li>
<li><a href="#integration-testing-oidc-client">テスト</a></li>
<li><a href="#how-to-check-the-errors-in-the-logs">ログでエラーを確認する方法</a></li>
</ul>
</li>
<li><a href="#token-propagation-reactive">トークン伝播リアクティブ</a></li>
<li><a href="#token-propagation">トークンの伝播</a>
<ul class="sectlevel2">
<li><a href="#restclient-accesstokenrequestfilter">RestClient AccessTokenRequestFilter</a></li>
<li><a href="#restclient-jsonwebtokenrequestfilter">RestClient JsonWebTokenRequestFilter</a></li>
<li><a href="#integration-testing-token-propagation">テスト</a></li>
</ul>
</li>
<li><a href="#reactive-token-propagation">トークン伝播リアクティブ</a></li>
<li><a href="#references">参照</a></li>
</ul></div>
    </div>
  </div>
  </div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license. <i class='fab fa-creative-commons'></i><i class='fab fa-creative-commons-by'></i> <a href='https://creativecommons.org/licenses/by/3.0/' target='_blank'>CC by 3.0</a><br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">ホーム</a></li>
          
          
          
            <li><a href="/about" target="_blank">Quarkusについて</a></li>
          
          
          
            <li><a href="/blog" target="_blank">ブログ</a></li>
          
          
          
            <li><a href="/insights" target="_blank">ポッドキャスト</a></li>
          
          
          
            <li><a href="/events" target="_blank">イベント</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">ニュースレター</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">ユーザーストーリー</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">ロードマップ</a></li>
          
          
          
            <li><a href="/security" target="_blank">セキュリティ&nbsp;ポリシー</a></li>
          
          
          
            <li><a href="/usage" target="_blank">使用方法</a></li>
          
          
          
            <li><a href="https://github.com/commonhaus/artwork/tree/main/projects/quarkus" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
          
            <li><a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy Policy</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォローする</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.threads.com/@quarkusio" target="_blank">Threads</a></li>
          
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">サポート</a></li>
          
          
          
            <li><a href="/guides" target="_blank">ガイド</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">入門</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">ディスカッション</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">開発メーリングリスト</a></li>
          
          
          
            <li><a href="https://stats.uptimerobot.com/ze1PfweT2p" target="_blank">Quarkus Service Status</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>言語</span>
        <ul class="footer-links">
          
          
            <li><a href=" https://quarkus.io/ " target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href=" https://es.quarkus.io/ " target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href=" https://ja.quarkus.io/ " target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate ORM</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">その他多数...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content cf-footer">
  <div class="flexcontainer">
    <div class="cf-logo">
      <a class="cf-logo" href="https://www.commonhaus.org/" target="_blank"><img src="https://raw.githubusercontent.com/commonhaus/artwork/main/foundation/brand/svg/CF_logo_horizontal_single_reverse.svg"/></a>
    </div>
    <div class="license">
      Copyright © Quarkus. All rights reserved. For details on our trademarks, please visit our <a href="https://www.commonhaus.org/policies/trademark-policy/">Trademark Policy</a> and <a href="https://www.commonhaus.org/trademarks/">Trademark List</a>. Trademarks of third parties are owned by their respective holders and their mention here does not suggest any endorsement or association.
    </div>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
  <script src="/assets/javascript/randomize.js" type="text/javascript"></script>
  <script src="/assets/javascript/time.js" type="text/javascript"></script>
</body>

</html>
