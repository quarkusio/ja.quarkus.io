<!DOCTYPE html>
<html lang="ja">







<head>
  <title>Micrometerを用いたメトリクスの収集 - 2.16 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com https://ajax.googleapis.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />

  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/2.16/guides/telemetry-micrometer-tutorial" />
  <meta property="og:title" content="Micrometerを用いたメトリクスの収集 - 2.16" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/telemetry-micrometer-tutorial">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="guides">

  


<div class="grid-wrapper communitysite">
  <div class="grid__item width-12-12">The <a href="https://quarkus.io/version/2.16/guides/telemetry-micrometer-tutorial">English version of quarkus.io</a> is the official project site. Translated sites are community supported on a best-effort basis.</div>
</div>


  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="#">Why<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/performance" class="">パフォーマンス</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
          <li><a href="/versatility" class="">多用途性</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/spring" class="">USING SPRING?</a></li>
          <li class="tertiarydropdown">
            <span href="#">AI<i class="fas fa-chevron-down"></i></span>
            <ul class="tertiarymenu">
              <li><a href="/ai" class="">AI OVERVIEW</a></li>
              <li><a href="/java-for-ai" class="">JAVA FOR AI</a></li>
              <li><a href="/quarkus-for-ai" class="">WHY QUARKUS FOR AI</a></li>
              <li><a href="/ai-blueprints" class="">AI BLUEPRINTS</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Learn<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ドキュメント</a></li>
          <li><a href="/userstories/" class="">ユーザーストーリー</a></li>  
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="#">Extensions<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
<li><a href="https://quarkus.io/extensions/" class="">エクステンションを探す</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">エクステンションの使用</a></li>
          <li><a href="/guides/writing-extensions" class="">エクステンションの作成</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">エクステンションの共有</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Community<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/working-groups" class="">ワーキンググループ</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ロードマップ</a></li>
          <li><a href="/benefactors" class="">BENEFACTORS</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/version/2.16/guides/telemetry-micrometer-tutorial" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/version/2.16/guides/telemetry-micrometer-tutorial">ポルトガル（BR）</a></li>
          <li><a href="https://es.quarkus.io/version/2.16/guides/telemetry-micrometer-tutorial">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/version/2.16/guides/telemetry-micrometer-tutorial">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/version/2.16/guides/telemetry-micrometer-tutorial">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas
fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    







<section class="full-width-version-bg flexfilterbar guides">
  <div class="guideflexcontainer">
    <div class="docslink">
      <a class="returnlink" href="/version/2.16/guides/"> Back to Guides</a>
    </div>
    <div class="flexlabel">
      <label>バージョン:</label>
    </div>
    <div class="guidepulldown version">
    <select id="guide-version-dropdown">
      
        
        
        <option value="main" >Main - SNAPSHOT</option>
        
        
        
        <option value="latest" >3.31.3 - Latest</option>
        
        
        
        <option value="3.27" >3.27</option>
        
        
        
        <option value="3.20" >3.20</option>
        
        
        
        <option value="3.15" >3.15</option>
        
        
        
        <option value="3.8" >3.8</option>
        </select>
    </div>
  </div>
</section>

<div class="guide">
  <div class="grid-wrapper">
    <div class="grid__item width-8-12 width-12-12-m">
      
      <h1 class="text-caps">Micrometerを用いたメトリクスの収集 </h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Micrometer メトリクスライブラリーを使用して、ランタイム、エクステンション、アプリケーションのメトリクスを収集し、Prometheus (OpenMetrics) エンドポイントとして公開するアプリケーションを作成します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>前提条件</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このガイドを完成させるには、以下が必要です:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>約15分</p>
</li>
<li>
<p>IDE</p>
</li>
<li>
<p>JDK 11+ がインストールされ、 <code>JAVA_HOME</code>  が適切に設定されていること</p>
</li>
<li>
<p>Apache Maven 3.8.6</p>
</li>
<li>
<p>使用したい場合は、 <a href="cli-tooling.html">Quarkus CLI</a></p>
</li>
<li>
<p>ネイティブ実行可能ファイルをビルドしたい場合、MandrelまたはGraalVM（あるいはネイティブなコンテナビルドを使用する場合はDocker）をインストールし、 <a href="building-native-image.html#configuring-graalvm">適切に設定</a>していること</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution"><a class="anchor" href="#solution"></a>ソリューション</h2>
<div class="sectionbody">
<div class="paragraph">
<p>手順に沿ってアプリケーションを作成することをお勧めしますが、必要に応じてソリューションに進むことも可能です。以下のいずれかを実行します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gitレポジトリをクローンするか <code>git clone <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code> 、</p>
</li>
<li>
<p><a href="https://github.com/quarkusio/quarkus-quickstarts/archive/2.16.zip">アーカイブ</a> をダウンロードします。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ソリューションは <code>micrometer-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/2.16/micrometer-quickstart">directory</a> にあります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-the-maven-project"><a class="anchor" href="#creating-the-maven-project"></a>1. Mavenプロジェクトの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>以下のコマンドで新規プロジェクトを作成します。</p>
</div>
<div class="sidebarblock primary asciidoc-tabs-sync-cli">
<div class="content">
<div class="title">コマンドラインインタフェース</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus create app org.acme:micrometer-quickstart \
    --stream=2.16 \
    --extension='resteasy-reactive,micrometer-registry-prometheus' \
    --no-code
cd micrometer-quickstart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradleプロジェクトを作成するには、 <code>--gradle</code> または <code>--gradle-kotlin-dsl</code> オプションを追加します。</p>
</div>
<div class="paragraph">
<p><em>Quarkus CLIのインストール方法や使用方法については、 <a href="cli-tooling">Quarkus CLIガイド</a> を参照してください。</em></p>
</div>
</div>
</div>
<div class="sidebarblock secondary asciidoc-tabs-sync-maven">
<div class="content">
<div class="title">Maven</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn io.quarkus.platform:quarkus-maven-plugin:2.16.12.Final:create \
    -DplatformVersion=2.16 \
    -DprojectGroupId=org.acme \
    -DprojectArtifactId=micrometer-quickstart \
    -Dextensions='resteasy-reactive,micrometer-registry-prometheus' \
    -DnoCode
cd micrometer-quickstart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradleプロジェクトを作成するには、 <code>-DbuildTool=gradle</code> または <code>-DbuildTool=gradle-kotlin-dsl</code> オプションを追加します。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>このコマンドは、 <code>micrometer-registry-prometheus</code> エクステンションを依存関係としてインポートする Maven プロジェクトを生成します。このエクステンションは、 <code>micrometer</code> エクステンションだけでなく、 Prometheus をサポートするために必要な追加のライブラリ依存関係もロードします。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-the-application"><a class="anchor" href="#writing-the-application"></a>2. アプリケーションの記述</h2>
<div class="sectionbody">
<div class="paragraph">
<p>まず、素数を計算する単純なエンドポイントを追加してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.micrometer;

import java.util.LinkedList;
import java.util.NoSuchElementException;

import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;

import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.Tags;
import io.micrometer.core.instrument.Timer;

@Path("/example")
@Produces("text/plain")
public class ExampleResource {
    private final LinkedList&lt;Long&gt; list = new LinkedList&lt;&gt;();

    @GET
    @Path("prime/{number}")
    public String checkIfPrime(@PathParam("number") long number) {
        if (number &lt; 1) {
            return "Only natural numbers can be prime numbers.";
        }
        if (number == 1) {
            return number + " is not prime.";
        }
        if (number == 2 || number % 2 == 0) {
            return number + " is not prime.";
        }

             * if (testPrimeNumber(number)) {
            return number + " is prime.";
        } else {
            return number + " is not prime.";
        }
    }

    protected boolean testPrimeNumber(long number) {
        for (int i = 3; i &lt; Math.floor(Math.sqrt(number)) + 1; i = i + 2) {
            if (number % i == 0) {
                return false;
            }
        }
        return true;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>アプリケーションを開発モードで起動します。</p>
</div>
<div class="listingblock primary asciidoc-tabs-sync-cli">
<div class="title">コマンドラインインタフェース</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus dev</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-maven">
<div class="title">Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:dev</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-gradle">
<div class="title">Gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./gradlew --console=plain quarkusDev</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="review-automatically-generated-metrics"><a class="anchor" href="#review-automatically-generated-metrics"></a>2.1. 自動生成されたメトリクスを確認する</h3>
<div class="paragraph">
<p>Micrometer エクステンションは、HTTP サーバー要求の時間を自動的に計ります。</p>
</div>
<div class="paragraph">
<p><code>curl</code> (またはブラウザー) を使用して、エンドポイントに数回アクセスしてみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl http://localhost:8080/example/prime/256
curl http://localhost:8080/example/prime/7919</code></pre>
</div>
</div>
<div class="paragraph">
<p>Micrometer Prometheus MeterRegistry エクステンションは、収集されたメトリクスの観察に使用できるエンドポイントを作成します。収集されたメトリクスを見てみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl http://localhost:8080/q/metrics</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力で、 <code>http_server_requests_seconds_count</code>、 <code>http_server_requests_seconds_sum</code>、 <code>http_server_requests_seconds_max</code> を探します。</p>
</div>
<div class="paragraph">
<p>リクエスト URI、HTTP メソッド (GET、POST など)、ステータスコード (200、302、404 など)、一般的な結果フィールドにディメンションラベルが追加されます。次のようなものが見つかるはずです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text"># HELP http_server_requests_seconds
# TYPE http_server_requests_seconds summary
http_server_requests_seconds_count{method="GET",outcome="SUCCESS",status="200",uri="/example/prime/{number}"} 2.0
http_server_requests_seconds_sum{method="GET",outcome="SUCCESS",status="200",uri="/example/prime/{number}"} 0.017385896
# HELP http_server_requests_seconds_max
# TYPE http_server_requests_seconds_max gauge
http_server_requests_seconds_max{method="GET",outcome="SUCCESS",status="200",uri="/example/prime/{number}"} 0.017385896
#</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
メトリクスは遅延して表示され、多くの場合はアクセスされるまでエンドポイントのデータは表示されません。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">エクスポートされるメトリクスフォーマット</div>
<p>デフォルトでは、メトリクスはPrometheusのフォーマット <code>application/openmetrics-text</code> を使用してエクスポートされます。 <code>Accept</code> リクエストヘッダを <code>plain/text</code> ( <code>curl -H "Accept: plain/text" localhost:8080/q/metrics/</code> ) に指定することで、以前のフォーマットに戻すことも可能です。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inject-the-meterregistry"><a class="anchor" href="#inject-the-meterregistry"></a>3. MeterRegistry の挿入</h2>
<div class="sectionbody">
<div class="paragraph">
<p>メーターを登録するには、Micrometer エクステンションが設定よび維持する <code>MeterRegistry</code> への参照が必要です。</p>
</div>
<div class="paragraph">
<p><code>MeterRegistry</code> は、次のようにアプリケーションに挿入できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    private final MeterRegistry registry;

    ExampleResource(MeterRegistry registry) {
        this.registry = registry;
    }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="add-a-counter"><a class="anchor" href="#add-a-counter"></a>4. カウンターの追加</h2>
<div class="sectionbody">
<div class="paragraph">
<p>カウンターは、増加するだけの値を測定するために使用されます。</p>
</div>
<div class="paragraph">
<p>数値が素数かどうかをテストする頻度を追跡するカウンターを追加しましょう。このカウンター値をさまざまな方法で集計できるようにするディメンションラベル (属性またはタグとも呼ばれます) を追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @GET
    @Path("prime/{number}")
    public String checkIfPrime(@PathParam("number") long number) {
        if (number &lt; 1) {
            registry.counter("example.prime.number", "type", "not-natural") <i class="conum" data-value="1"></i><b>(1)</b>
                    .increment(); <i class="conum" data-value="2"></i><b>(2)</b>
            return "Only natural numbers can be prime numbers.";
        }
        if (number == 1) {
            registry.counter("example.prime.number", "type", "one") <i class="conum" data-value="1"></i><b>(1)</b>
                    .increment(); <i class="conum" data-value="2"></i><b>(2)</b>
            return number + " is not prime.";
        }
        if (number == 2 || number % 2 == 0) {
            registry.counter("example.prime.number", "type", "even") <i class="conum" data-value="1"></i><b>(1)</b>
                    .increment(); <i class="conum" data-value="2"></i><b>(2)</b>
            return number + " is not prime.";
        }

             * if (testPrimeNumber(number)) {
            registry.counter("example.prime.number", "type", "prime") <i class="conum" data-value="1"></i><b>(1)</b>
                    .increment(); <i class="conum" data-value="2"></i><b>(2)</b>
            return number + " is prime.";
        } else {
            registry.counter("example.prime.number", "type", "not-prime") <i class="conum" data-value="1"></i><b>(1)</b>
                    .increment(); <i class="conum" data-value="2"></i><b>(2)</b>
            return number + " is not prime.";
        }
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>指定された値と <code>type</code> ラベルを持つ <code>example.prime.number</code> というカウンターを検索または作成します。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>そのカウンターをインクリメントします。</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="review-collected-metrics"><a class="anchor" href="#review-collected-metrics"></a>4.1. 収集されたメトリクスの確認</h3>
<div class="paragraph">
<p>Quarkusを開発モードで起動したままにしていない場合は、再度起動してください。</p>
</div>
<div class="listingblock primary asciidoc-tabs-sync-cli">
<div class="title">コマンドラインインタフェース</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus dev</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-maven">
<div class="title">Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:dev</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-gradle">
<div class="title">Gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./gradlew --console=plain quarkusDev</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のシーケンスを試して、プレーンテキストの出力で <code>example_prime_number_total</code> を確認してください。</p>
</div>
<div class="paragraph">
<p>Micrometer が最初に指定されたカウンター名である <code>example.prime.number</code> に Prometheus 命名規則を適用すると、サフィックス <code>_total</code> が追加されることに注意してください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl http://localhost:8080/example/prime/-1
curl http://localhost:8080/example/prime/0
curl http://localhost:8080/example/prime/1
curl http://localhost:8080/example/prime/2
curl http://localhost:8080/example/prime/3
curl http://localhost:8080/example/prime/15
curl http://localhost:8080/q/metrics</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>example_prime_number_total</code> と <code>type</code> の値の一意の組合せごとに 1 つの測定値があることに注意してください。</p>
</div>
<div class="paragraph">
<p>このカウンターによって生成されたディメンションデータで、以下を数えることができます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>負の数がチェックされた頻度: <code>type="not-natural"</code></p>
</li>
<li>
<p>1 がチェックされた頻度: <code>type="one"</code></p>
</li>
<li>
<p>偶数がチェックされた頻度: <code>type="even"</code></p>
</li>
<li>
<p>素数がチェックされた頻度: <code>type="prime"</code></p>
</li>
<li>
<p>非素数がチェックされた頻度: <code>type="not-prime"</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これらの値をすべて集計することで、(一般的に) 数値がチェックされた頻度をカウントすることもできます。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="add-a-timer"><a class="anchor" href="#add-a-timer"></a>5. タイマーの追加</h2>
<div class="sectionbody">
<div class="paragraph">
<p>タイマーは、期間を測定するための特殊な抽象化です。数値が素数かどうかを判断するのにかかる時間を測定するタイマーを追加しましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @GET
    @Path("prime/{number}")
    public String checkIfPrime(@PathParam("number") long number) {
        if (number &lt; 1) {
            registry.counter("example.prime.number", "type", "not-natural") <i class="conum" data-value="1"></i><b>(1)</b>
                    .increment(); <i class="conum" data-value="2"></i><b>(2)</b>
            return "Only natural numbers can be prime numbers.";
        }
        if (number == 1) {
            registry.counter("example.prime.number", "type", "one") <i class="conum" data-value="1"></i><b>(1)</b>
                    .increment(); <i class="conum" data-value="2"></i><b>(2)</b>
            return number + " is not prime.";
        }
        if (number == 2 || number % 2 == 0) {
            registry.counter("example.prime.number", "type", "even") <i class="conum" data-value="1"></i><b>(1)</b>
                    .increment(); <i class="conum" data-value="2"></i><b>(2)</b>
            return number + " is not prime.";
        }

        if (timedTestPrimeNumber(number)) { <i class="conum" data-value="3"></i><b>(3)</b>
            registry.counter("example.prime.number", "type", "prime") <i class="conum" data-value="1"></i><b>(1)</b>
                    .increment(); <i class="conum" data-value="2"></i><b>(2)</b>
            return number + " is prime.";
        } else {
            registry.counter("example.prime.number", "type", "not-prime") <i class="conum" data-value="1"></i><b>(1)</b>
                    .increment(); <i class="conum" data-value="2"></i><b>(2)</b>
            return number + " is not prime.";
        }
    }

    protected boolean timedTestPrimeNumber(long number) {
        Timer.Sample sample = Timer.start(registry); <i class="conum" data-value="4"></i><b>(4)</b>
        boolean result = testPrimeNumber(number); <i class="conum" data-value="5"></i><b>(5)</b>
        sample.stop(registry.timer("example.prime.number.test", "prime", result + "")); <i class="conum" data-value="6"></i><b>(6)</b>
        return result;
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>指定された値と <code>type</code> ラベルを持つ <code>example.prime.number</code> というカウンターを検索または作成します。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>そのカウンターをインクリメントします。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>元の <code>testPrimeNumber</code> メソッドをラップするメソッドを呼び出します。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>開始時間を追跡する Timer.Sample を作成します</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>時間を計測するメソッドを呼び出し、ブール値の結果を保存します</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>指定された ID と結果値を含む <code>prime</code> ラベルを使用して <code>prime</code> を検索または作成し、 <code>Timer.Sample</code> によってキャプチャされた期間を記録します。</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="review-collected-metrics-2"><a class="anchor" href="#review-collected-metrics-2"></a>5.1. 収集されたメトリクスの確認</h3>
<div class="paragraph">
<p>Quarkusを開発モードで起動したままにしていない場合は、再度起動してください。</p>
</div>
<div class="listingblock primary asciidoc-tabs-sync-cli">
<div class="title">コマンドラインインタフェース</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus dev</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-maven">
<div class="title">Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:dev</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-gradle">
<div class="title">Gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./gradlew --console=plain quarkusDev</code></pre>
</div>
</div>
<div class="paragraph">
<p>Micrometer は、このタイマーのメトリクスを出力するときに Prometheus 規則を適用します。具体的には、測定された期間は秒に変換され、この単位がメトリクス名に含まれます。</p>
</div>
<div class="paragraph">
<p>以下のシーケンスを試して、プレーンテキストの出力で次のエントリーを確認してください。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>example_prime_number_test_seconds_count</code>&#8201;&#8212;&#8201;メソッドが呼び出された回数</p>
</li>
<li>
<p><code>example_prime_number_test_seconds_sum</code>&#8201;&#8212;&#8201;すべてのメソッド呼び出しの合計時間</p>
</li>
<li>
<p><code>example_prime_number_test_seconds_max</code>&#8201;&#8212;&#8201;減衰間隔内での最大観測時間。メソッドが頻繁に呼び出されない場合、この値は 0 に戻ります。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">curl http://localhost:8080/example/prime/256
curl http://localhost:8080/q/metrics
curl http://localhost:8080/example/prime/7919
curl http://localhost:8080/q/metrics</code></pre>
</div>
</div>
<div class="paragraph">
<p>このカウンターによって生成されたディメンションデータを見ると、合計とカウントを使用して、数値が素数であるかどうかを判断するのにかかる (平均) 時間を計算できます。ディメンションラベルを使用すると、素数とそれ以外の数の期間に大きな違いがあるかどうかを理解できます。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary"><a class="anchor" href="#summary"></a>まとめ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>おめでとうございます。</p>
</div>
<div class="paragraph">
<p>これで Micrometer および Prometheus Meter Registry エクステンションを使用してメトリクスを収集するプロジェクトの作成が完了しました。Quarkus が自動的にキャプチャするいくつかのメトリクスを確認し、アプリケーションに固有の <code>Counter</code> と <code>Timer</code> を追加しました。さらに、メトリクスにディメンションラベルを追加し、それらのラベルが prometheus エンドポイントによって出力されるデータをどのように形成するかを観測しました。</p>
</div>
</div>
</div>
    </div>
    <div class="grid__item width-4-12 width-12-12-m tocwrapper">
      <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#prerequisites">前提条件</a></li>
<li><a href="#solution">ソリューション</a></li>
<li><a href="#creating-the-maven-project">1. Mavenプロジェクトの作成</a></li>
<li><a href="#writing-the-application">2. アプリケーションの記述</a>
<ul class="sectlevel2">
<li><a href="#review-automatically-generated-metrics">2.1. 自動生成されたメトリクスを確認する</a></li>
</ul>
</li>
<li><a href="#inject-the-meterregistry">3. MeterRegistry の挿入</a></li>
<li><a href="#add-a-counter">4. カウンターの追加</a>
<ul class="sectlevel2">
<li><a href="#review-collected-metrics">4.1. 収集されたメトリクスの確認</a></li>
</ul>
</li>
<li><a href="#add-a-timer">5. タイマーの追加</a>
<ul class="sectlevel2">
<li><a href="#review-collected-metrics-2">5.1. 収集されたメトリクスの確認</a></li>
</ul>
</li>
<li><a href="#summary">まとめ</a></li>
</ul></div>
    </div>
  </div>
  </div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license. <i class='fab fa-creative-commons'></i><i class='fab fa-creative-commons-by'></i> <a href='https://creativecommons.org/licenses/by/3.0/' target='_blank'>CC by 3.0</a><br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">ホーム</a></li>
          
          
          
            <li><a href="/about" target="_blank">Quarkusについて</a></li>
          
          
          
            <li><a href="/blog" target="_blank">ブログ</a></li>
          
          
          
            <li><a href="/insights" target="_blank">ポッドキャスト</a></li>
          
          
          
            <li><a href="/events" target="_blank">イベント</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">ニュースレター</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">ユーザーストーリー</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">ロードマップ</a></li>
          
          
          
            <li><a href="/security" target="_blank">セキュリティ&nbsp;ポリシー</a></li>
          
          
          
            <li><a href="/usage" target="_blank">使用方法</a></li>
          
          
          
            <li><a href="https://github.com/commonhaus/artwork/tree/main/projects/quarkus" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
          
            <li><a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy Policy</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォローする</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.threads.com/@quarkusio" target="_blank">Threads</a></li>
          
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">サポート</a></li>
          
          
          
            <li><a href="/guides" target="_blank">ガイド</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">入門</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">ディスカッション</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">開発メーリングリスト</a></li>
          
          
          
            <li><a href="https://stats.uptimerobot.com/ze1PfweT2p" target="_blank">Quarkus Service Status</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>言語</span>
        <ul class="footer-links">
          
          
            <li><a href=" https://quarkus.io/ " target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href=" https://es.quarkus.io/ " target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href=" https://ja.quarkus.io/ " target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate ORM</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">その他多数...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content cf-footer">
  <div class="flexcontainer">
    <div class="cf-logo">
      <a class="cf-logo" href="https://www.commonhaus.org/" target="_blank"><img src="https://raw.githubusercontent.com/commonhaus/artwork/main/foundation/brand/svg/CF_logo_horizontal_single_reverse.svg"/></a>
    </div>
    <div class="license">
      Copyright © Quarkus. All rights reserved. For details on our trademarks, please visit our <a href="https://www.commonhaus.org/policies/trademark-policy/">Trademark Policy</a> and <a href="https://www.commonhaus.org/trademarks/">Trademark List</a>. Trademarks of third parties are owned by their respective holders and their mention here does not suggest any endorsement or association.
    </div>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
  <script src="/assets/javascript/randomize.js" type="text/javascript"></script>
  <script src="/assets/javascript/time.js" type="text/javascript"></script>
</body>

</html>
