<!DOCTYPE html>
<html lang="ja">







<head>
  <title>シンプルになったMongoDB with Panache - 2.13 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com https://ajax.googleapis.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />

  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/2.13/guides/mongodb-panache" />
  <meta property="og:title" content="シンプルになったMongoDB with Panache - 2.13" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/mongodb-panache">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="guides">

  


<div class="grid-wrapper communitysite">
  <div class="grid__item width-12-12">The <a href="https://quarkus.io/version/2.13/guides/mongodb-panache">English version of quarkus.io</a> is the official project site. Translated sites are community supported on a best-effort basis.</div>
</div>


  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="#">Why<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/performance" class="">パフォーマンス</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
          <li><a href="/versatility" class="">多用途性</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/spring" class="">USING SPRING?</a></li>
          <li class="tertiarydropdown">
            <span href="#">AI<i class="fas fa-chevron-down"></i></span>
            <ul class="tertiarymenu">
              <li><a href="/ai" class="">AI OVERVIEW</a></li>
              <li><a href="/java-for-ai" class="">JAVA FOR AI</a></li>
              <li><a href="/quarkus-for-ai" class="">WHY QUARKUS FOR AI</a></li>
              <li><a href="/ai-blueprints" class="">AI BLUEPRINTS</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Learn<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ドキュメント</a></li>
          <li><a href="/userstories/" class="">ユーザーストーリー</a></li>  
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="#">Extensions<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
<li><a href="https://quarkus.io/extensions/" class="">エクステンションを探す</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">エクステンションの使用</a></li>
          <li><a href="/guides/writing-extensions" class="">エクステンションの作成</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">エクステンションの共有</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Community<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/working-groups" class="">ワーキンググループ</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ロードマップ</a></li>
          <li><a href="/benefactors" class="">BENEFACTORS</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/version/2.13/guides/mongodb-panache" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/version/2.13/guides/mongodb-panache">ポルトガル（BR）</a></li>
          <li><a href="https://es.quarkus.io/version/2.13/guides/mongodb-panache">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/version/2.13/guides/mongodb-panache">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/version/2.13/guides/mongodb-panache">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas
fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    







<section class="full-width-version-bg flexfilterbar guides">
  <div class="guideflexcontainer">
    <div class="docslink">
      <a class="returnlink" href="/version/2.13/guides/"> Back to Guides</a>
    </div>
    <div class="flexlabel">
      <label>バージョン:</label>
    </div>
    <div class="guidepulldown version">
    <select id="guide-version-dropdown">
      
        
        
        <option value="main" >Main - SNAPSHOT</option>
        
        
        
        <option value="latest" >3.31.3 - Latest</option>
        
        
        
        <option value="3.27" >3.27</option>
        
        
        
        <option value="3.20" >3.20</option>
        
        
        
        <option value="3.15" >3.15</option>
        
        
        
        <option value="3.8" >3.8</option>
        </select>
    </div>
  </div>
</section>

<div class="guide">
  <div class="grid-wrapper">
    <div class="grid__item width-8-12 width-12-12-m">
      
      <h1 class="text-caps">シンプルになったMongoDB with Panache </h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>MongoDB は広く利用されている有名な NoSQL データベースですが、エンティティとクエリを MongoDB <a href="https://www.mongodb.com/docs/drivers/java/sync/current/bson/documents/#document"><code>Document</code></a> として表現する必要があるため、生のAPIを使用するのは面倒です。</p>
</div>
<div class="paragraph">
<p>MongoDB with Panacheは、 <a href="hibernate-orm-panache.html">Hibernate ORM with Panache</a>にあるようなアクティブレコードスタイルのエンティティ（およびリポジトリ）を提供し、Quarkusでエンティティを簡単に楽しく書けるようにすることに重点を置いています。</p>
</div>
<div class="paragraph">
<p>これは、 <a href="mongodb.html">MongoDB Client</a>エクステンションの上に構築されています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="first-an-example"><a class="anchor" href="#first-an-example"></a>最初に:例</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Panacheでは、MongoDBのエンティティをこのように書くことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Person extends PanacheMongoEntity {
    public String name;
    public LocalDate birth;
    public Status status;

    public static Person findByName(String name){
        return find("name", name).firstResult();
    }

    public static List&lt;Person&gt; findAlive(){
        return list("status", Status.Alive);
    }

    public static void deleteLoics(){
        delete("name", "Loïc");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>MongoDBのAPIを使った場合と比べて、コードがどれだけコンパクトで読みやすくなったかお気づきでしょうか？これは面白いと思いませんか？読んでみてください。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>list()</code> の方法は、最初は驚くかもしれません。これは、PanacheQLのクエリ（JPQLのサブセット）の断片を取り出し、残りの部分を文脈化したものです。これにより、非常に簡潔でありながら読みやすいコードになっています。MongoDBのネイティブクエリもサポートしています。
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
上で説明したものは基本的に <a href="https://www.martinfowler.com/eaaCatalog/activeRecord.html">アクティブレコードパターン</a>で、単にエンティティパターンと呼ばれることもあります。MongoDB with Panacheでは、 <code>PanacheMongoRepository</code> を通じて、より古典的な <a href="https://martinfowler.com/eaaCatalog/repository.html">リポジトリパターン</a>を使うこともできます。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution"><a class="anchor" href="#solution"></a>ソリューション</h2>
<div class="sectionbody">
<div class="paragraph">
<p>次の章で紹介する手順に沿って、ステップを踏んでアプリを作成することをお勧めします。ただし、完成した例にそのまま進んでも構いません。</p>
</div>
<div class="paragraph">
<p>Gitリポジトリをクローンする： <code>git clone <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code> 、またはhttps://github.com/quarkusio/quarkus-quickstarts/archive/main.zip[archive] をダウンロードする。</p>
</div>
<div class="paragraph">
<p>ソリューションは <code>mongodb-panache-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/mongodb-panache-quickstart">ディレクトリー</a> にあります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="creating-the-maven-project"><a class="anchor" href="#creating-the-maven-project"></a>Mavenプロジェクトの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>まず、新しいプロジェクトが必要です。以下のコマンドで新規プロジェクトを作成します:</p>
</div>
<div class="sidebarblock primary asciidoc-tabs-sync-cli">
<div class="content">
<div class="title">コマンドラインインタフェース</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus create app org.acme:mongodb-panache-quickstart \
    --stream=2.13 \
    --extension='resteasy-reactive-jackson,mongodb-panache' \
    --no-code
cd mongodb-panache-quickstart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradleプロジェクトを作成するには、 <code>--gradle</code> または <code>--gradle-kotlin-dsl</code> オプションを追加します。</p>
</div>
<div class="paragraph">
<p><em>Quarkus CLIのインストール方法や使用方法については、 <a href="cli-tooling">Quarkus CLIガイド</a> を参照してください。</em></p>
</div>
</div>
</div>
<div class="sidebarblock secondary asciidoc-tabs-sync-maven">
<div class="content">
<div class="title">Maven</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn io.quarkus.platform:quarkus-maven-plugin:2.13.9.Final:create \
    -DplatformVersion=2.13.9.Final \
    -DprojectGroupId=org.acme \
    -DprojectArtifactId=mongodb-panache-quickstart \
    -Dextensions='resteasy-reactive-jackson,mongodb-panache' \
    -DnoCode
cd mongodb-panache-quickstart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradleプロジェクトを作成するには、 <code>-DbuildTool=gradle</code> または <code>-DbuildTool=gradle-kotlin-dsl</code> オプションを追加します。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>このコマンドは、RESTEasy Reactive JacksonとMongoDB with PanacheエクステンションをインポートするMaven構造を生成します。この後、 <code>quarkus-mongodb-panache</code> エクステンションがビルドファイルに追加されています。</p>
</div>
<div class="paragraph">
<p>新しいプロジェクトを生成したくない場合は、ビルドファイルに依存関係を追加してください。</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-mongodb-panache&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.quarkus:quarkus-mongodb-panache")</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>プロジェクトがすでに他のアノテーションプロセッサーを使用するように設定されている場合、追加でPanacheアノテーションプロセッサーを追加する必要があります:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
    &lt;version&gt;${compiler-plugin.version}&lt;/version&gt;
    &lt;configuration&gt;
        &lt;parameters&gt;${maven.compiler.parameters}&lt;/parameters&gt;
        &lt;annotationProcessorPaths&gt;
            &lt;!-- Your existing annotation processor(s)... --&gt;
            &lt;path&gt;
                &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
                &lt;artifactId&gt;quarkus-panache-common&lt;/artifactId&gt;
                &lt;version&gt;${quarkus.platform.version}&lt;/version&gt;
            &lt;/path&gt;
        &lt;/annotationProcessorPaths&gt;
    &lt;/configuration&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">annotationProcessor("io.quarkus:quarkus-panache-common")</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-up-and-configuring-mongodb-with-panache"><a class="anchor" href="#setting-up-and-configuring-mongodb-with-panache"></a>Panache による MongoDB のセットアップおよび設定</h2>
<div class="sectionbody">
<div class="paragraph">
<p>始めるには:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>application.properties</code> で設定を追加します</p>
</li>
<li>
<p>エンティティが <code>PanacheMongoEntity</code> を継承するようにする（リポジトリパターンを使用している場合はオプション）。</p>
</li>
<li>
<p>オプションとして、 <code>@MongoEntity</code> アノテーションを使用して、コレクションの名前、データベースの名前、またはクライアントの名前を指定します。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>次に、 <code>application.properties</code> で関連する設定プロパティを追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># configure the MongoDB client for a replica set of two nodes
quarkus.mongodb.connection-string = mongodb://mongo1:27017,mongo2:27017
# mandatory if you don't specify the name of the database using @MongoEntity
quarkus.mongodb.database = person</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>quarkus.mongodb.database</code> プロパティは、MongoDB with Panache でエンティティを永続化するデータベースの名前を決定するのに使われます（ <code>@MongoEntity</code> でオーバーライドされていない場合）。</p>
</div>
<div class="paragraph">
<p><code>@MongoEntity</code> のアノテーションでは次の設定が可能です。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>マルチテナントアプリケーション用のクライアントの名前を指定することもできます。 <a href="mongodb#multiple-mongodb-clients">Multiple MongoDB Clients</a> を参照してください。それ以外の場合は、デフォルトのクライアントを使います。</p>
</li>
<li>
<p>データベースの名前。そうでない場合は <code>quarkus.mongodb.database</code> プロパティが使用されます。</p>
</li>
<li>
<p>コレクションの名前。そうでない場合はクラスのシンプルな名前が使われます。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>MongoDBクライアントの高度な設定については、 <a href="mongodb.html#configuring-the-mongodb-database">Configuring the MongoDB database ガイド</a>に従ってください。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution-1-using-the-active-record-pattern"><a class="anchor" href="#solution-1-using-the-active-record-pattern"></a>解決策1:アクティブレコードパターンを使用する</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="defining-your-entity"><a class="anchor" href="#defining-your-entity"></a>エンティティの定義</h3>
<div class="paragraph">
<p>Panacheのエンティティを定義するには、 <code>PanacheMongoEntity</code> を拡張して、カラムをパブリックフィールドとして追加するだけです。コレクション、データベース、またはクライアントの名前をカスタマイズする必要がある場合は、 <code>@MongoEntity</code> アノテーションをエンティティに追加することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MongoEntity(collection="ThePerson")
public class Person extends PanacheMongoEntity {
    public String name;

    // will be persisted as a 'birth' field in MongoDB
    @BsonProperty("birth")
    public LocalDate birthDate;

    public Status status;
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>@MongoEntity</code> でのアノテーションはオプションです。ここでは、エンティティは、デフォルトの <code>Person</code> コレクションではなく、 <code>ThePerson</code> コレクションに保存されます。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>MongoDB with Panacheでは、<a href="https://www.mongodb.com/docs/drivers/java/sync/current/bson/pojos/">PojoCodecProvider</a> を使用してエンティティを MongoDB <code>Document</code> に変換します。</p>
</div>
<div class="paragraph">
<p>このマッピングをカスタマイズするために、以下のアノテーションを使用することができます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@BsonId</code>: IDフィールドをカスタマイズすることができます。 <a href="#custom-ids">カスタム ID</a> を参照してください。</p>
</li>
<li>
<p><code>@BsonProperty</code>: フィールドのシリアル化された名前をカスタマイズします。</p>
</li>
<li>
<p><code>@BsonIgnore</code>: シリアル化の際にフィールドを無視することができます。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>アクセサを書く必要がある場合は、以下のようにできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Person extends PanacheMongoEntity {

    public String name;
    public LocalDate birth;
    public Status status;

    // return name as uppercase in the model
    public String getName(){
        return name.toUpperCase();
    }

    // store all names in lowercase in the DB
    public void setName(String name){
        this.name = name.toLowerCase();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>また、当社のフィールドアクセスリライトのおかげで、ユーザーが <code>person.name</code> を読むときには、実際に <code>getName()</code> アクセサが呼び出されます。これはフィールドの書き込みやセッターについても同様です。これにより、すべてのフィールドの呼び出しが、対応するゲッター/セッターの呼び出しに置き換えられるため、実行時に適切なカプセル化が可能になります。</p>
</div>
</div>
<div class="sect2">
<h3 id="most-useful-operations"><a class="anchor" href="#most-useful-operations"></a>最も便利な操作</h3>
<div class="paragraph">
<p>エンティティを記述したら、ここでは実行できる最も一般的な操作を紹介します:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// creating a person
Person person = new Person();
person.name = "Loïc";
person.birth = LocalDate.of(1910, Month.FEBRUARY, 1);
person.status = Status.Alive;

// persist it: if you keep the default ObjectId ID field, it will be populated by the MongoDB driver
person.persist();

person.status = Status.Dead;

// Your must call update() in order to send your entity modifications to MongoDB
person.update();

// delete it
person.delete();

// getting a list of all Person entities
List&lt;Person&gt; allPersons = Person.listAll();

// finding a specific person by ID
// here we build a new ObjectId, but you can also retrieve it from the existing entity after being persisted
ObjectId personId = new ObjectId(idAsString);
person = Person.findById(personId);

// finding a specific person by ID via an Optional
Optional&lt;Person&gt; optional = Person.findByIdOptional(personId);
person = optional.orElseThrow(() -&gt; new NotFoundException());

// finding all living persons
List&lt;Person&gt; livingPersons = Person.list("status", Status.Alive);

// counting all persons
long countAll = Person.count();

// counting all living persons
long countAlive = Person.count("status", Status.Alive);

// delete all living persons
Person.delete("status", Status.Alive);

// delete all persons
Person.deleteAll();

// delete by id
boolean deleted = Person.deleteById(personId);

// set the name of all living persons to 'Mortal'
long updated = Person.update("name", "Mortal").where("status", Status.Alive);</code></pre>
</div>
</div>
<div class="paragraph">
<p>すべての <code>list</code> メソッドは、同等の <code>stream</code> バージョンがあります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Stream&lt;Person&gt; persons = Person.streamAll();
List&lt;String&gt; namesButEmmanuels = persons
    .map(p -&gt; p.name.toLowerCase() )
    .filter( n -&gt; ! "emmanuel".equals(n) )
    .collect(Collectors.toList());</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>persistOrUpdate()</code> メソッドは、データベース内のエンティティを永続化または更新するために存在し、MongoDB の <em>upsert</em> 機能を使用して単一のクエリでそれを行います。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="adding-entity-methods"><a class="anchor" href="#adding-entity-methods"></a>エンティティメソッドの追加</h3>
<div class="paragraph">
<p>エンティティに対するカスタムクエリを、エンティティ自体の中に追加できます。そうすることで、自分や同僚が簡単に見つけることができ、クエリは操作するオブジェクトと一緒に配置されます。エンティティクラスにスタティックメソッドとして追加するのがPanache Active Recordのやり方です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Person extends PanacheMongoEntity {
    public String name;
    public LocalDate birth;
    public Status status;

    public static Person findByName(String name){
        return find("name", name).firstResult();
    }

    public static List&lt;Person&gt; findAlive(){
        return list("status", Status.Alive);
    }

    public static void deleteLoics(){
        delete("name", "Loïc");
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution-2-using-the-repository-pattern"><a class="anchor" href="#solution-2-using-the-repository-pattern"></a>解決策2:リポジトリパターンを使用する</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="defining-your-entity-2"><a class="anchor" href="#defining-your-entity-2"></a>エンティティの定義</h3>
<div class="paragraph">
<p>エンティティは通常のPOJOとして定義することができます。コレクション、データベース、またはクライアントの名前をカスタマイズする必要がある場合は、 <code>@MongoEntity</code> アノテーションをエンティティに追加できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MongoEntity(collection="ThePerson")
public class Person  {
    public ObjectId id; // used by MongoDB for the _id field
    public String name;
    public LocalDate birth;
    public Status status;
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>@MongoEntity</code> でのアノテーションはオプションです。ここでは、エンティティは、デフォルトの <code>Person</code> コレクションではなく、 <code>ThePerson</code> コレクションに保存されます。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>MongoDB with Panacheでは、 <a href="https://www.mongodb.com/docs/drivers/java/sync/current/bson/pojos/">PojoCodecProvider</a> を使用してエンティティを MongoDB <code>Document</code> に変換します。</p>
</div>
<div class="paragraph">
<p>このマッピングをカスタマイズするために、以下のアノテーションを使用することができます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@BsonId</code>: IDフィールドをカスタマイズすることができます。 <a href="#custom-ids">カスタム ID</a> を参照してください。</p>
</li>
<li>
<p><code>@BsonProperty</code>: フィールドのシリアル化された名前をカスタマイズします。</p>
</li>
<li>
<p><code>@BsonIgnore</code>: シリアル化の際にフィールドを無視することができます。</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
ゲッターやセッターを使って、パブリックフィールドやプライベートフィールドを使うことができます。IDを自分で管理したくない場合は、 <code>PanacheMongoEntity</code> を拡張したエンティティを作ることができます。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="defining-your-repository"><a class="anchor" href="#defining-your-repository"></a>リポジトリの定義</h3>
<div class="paragraph">
<p>Repositories を使用する場合、それらが <code>PanacheMongoRepository</code> を実装するようにし、Repository に注入することで、アクティブレコードパターンと全く同じ便利なメソッドを取得することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class PersonRepository implements PanacheMongoRepository&lt;Person&gt; {

   // put your custom logic here as instance methods

   public Person findByName(String name){
       return find("name", name).firstResult();
   }

   public List&lt;Person&gt; findAlive(){
       return list("status", Status.Alive);
   }

   public void deleteLoics(){
       delete("name", "Loïc");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>PanacheMongoEntityBase</code> で定義されているすべての操作は、あなたのリポジトリで利用できます。そのため、これを使用することは、注入する必要があることを除けば、active record パターンを使用することとまったく同じです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject
PersonRepository personRepository;

@GET
public long count(){
    return personRepository.count();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="most-useful-operations-2"><a class="anchor" href="#most-useful-operations-2"></a>最も便利な操作</h3>
<div class="paragraph">
<p>リポジトリを書くことで実行可能な最も一般的な操作は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// creating a person
Person person = new Person();
person.name = "Loïc";
person.birth = LocalDate.of(1910, Month.FEBRUARY, 1);
person.status = Status.Alive;

// persist it: if you keep the default ObjectId ID field, it will be populated by the MongoDB driver
personRepository.persist(person);

person.status = Status.Dead;

// Your must call update() in order to send your entity modifications to MongoDB
personRepository.update(person);

// delete it
personRepository.delete(person);

// getting a list of all Person entities
List&lt;Person&gt; allPersons = personRepository.listAll();

// finding a specific person by ID
// here we build a new ObjectId, but you can also retrieve it from the existing entity after being persisted
ObjectId personId = new ObjectId(idAsString);
person = personRepository.findById(personId);

// finding a specific person by ID via an Optional
Optional&lt;Person&gt; optional = personRepository.findByIdOptional(personId);
person = optional.orElseThrow(() -&gt; new NotFoundException());

// finding all living persons
List&lt;Person&gt; livingPersons = personRepository.list("status", Status.Alive);

// counting all persons
long countAll = personRepository.count();

// counting all living persons
long countAlive = personRepository.count("status", Status.Alive);

// delete all living persons
personRepository.delete("status", Status.Alive);

// delete all persons
personRepository.deleteAll();

// delete by id
boolean deleted = personRepository.deleteById(personId);

// set the name of all living persons to 'Mortal'
long updated = personRepository.update("name", "Mortal").where("status", Status.Alive);</code></pre>
</div>
</div>
<div class="paragraph">
<p>すべての <code>list</code> メソッドは、同等の <code>stream</code> バージョンがあります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Stream&lt;Person&gt; persons = personRepository.streamAll();
List&lt;String&gt; namesButEmmanuels = persons
    .map(p -&gt; p.name.toLowerCase() )
    .filter( n -&gt; ! "emmanuel".equals(n) )
    .collect(Collectors.toList());</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>persistOrUpdate()</code> メソッドは、データベース内のエンティティを永続化または更新するために存在し、MongoDB の <em>upsert</em> 機能を使用して単一のクエリでそれを行います。
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
残りのドキュメントでは、アクティブレコードパターンに基づく使用法のみを示していますが、リポジトリパターンでも実行できることを覚えておいてください。リポジトリパターンの例は簡潔にするために省略しています。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-a-jax-rs-resource"><a class="anchor" href="#writing-a-jax-rs-resource"></a>JAX-RS リソースの書き方</h2>
<div class="sectionbody">
<div class="paragraph">
<p>まず、JAX-RSエンドポイントを有効にするために、RESTEasyのエクステンションの1つを含めます。例えば、JAX-RSとJSONのサポートのために、 <code>io.quarkus:quarkus-resteasy-reactive-jackson</code> の依存関係を追加します。</p>
</div>
<div class="paragraph">
<p>そして、次のようなリソースを作成することで、Personエンティティの作成/読み取り/更新/削除が可能になります:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Path("/persons")
@Consumes(MediaType.APPLICATION_JSON)
@Produces(MediaType.APPLICATION_JSON)
public class PersonResource {

    @GET
    public List&lt;Person&gt; list() {
        return Person.listAll();
    }

    @GET
    @Path("/{id}")
    public Person get(String id) {
        return Person.findById(new ObjectId(id));
    }

    @POST
    public Response create(Person person) {
        person.persist();
        return Response.created(URI.create("/persons/" + person.id)).build();
    }

    @PUT
    @Path("/{id}")
    public void update(String id, Person person) {
        person.update();
    }

    @DELETE
    @Path("/{id}")
    public void delete(String id) {
        Person person = Person.findById(new ObjectId(id));
        if(person == null) {
            throw new NotFoundException();
        }
        person.delete();
    }

    @GET
    @Path("/search/{name}")
    public Person search(String name) {
        return Person.findByName(name);
    }

    @GET
    @Path("/count")
    public Long count() {
        return Person.count();
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advanced-query"><a class="anchor" href="#advanced-query"></a>高度なクエリー</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="paging"><a class="anchor" href="#paging"></a>ページング</h3>
<div class="paragraph">
<p><code>list</code> および <code>stream</code> メソッドは、コレクションに含まれるデータセットが十分に小さい場合にのみ使用してください。より大きなデータセットの場合は、同等の <code>find</code> メソッドを使用して、ページングが可能な <code>PanacheQuery</code> を返すことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// create a query for all living persons
PanacheQuery&lt;Person&gt; livingPersons = Person.find("status", Status.Alive);

// make it use pages of 25 entries at a time
livingPersons.page(Page.ofSize(25));

// get the first page
List&lt;Person&gt; firstPage = livingPersons.list();

// get the second page
List&lt;Person&gt; secondPage = livingPersons.nextPage().list();

// get page 7
List&lt;Person&gt; page7 = livingPersons.page(Page.of(7, 25)).list();

// get the number of pages
int numberOfPages = livingPersons.pageCount();

// get the total number of entities returned by this query without paging
int count = livingPersons.count();

// and you can chain methods of course
return Person.find("status", Status.Alive)
    .page(Page.ofSize(25))
    .nextPage()
    .stream()</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>PanacheQuery</code> 型には、ページングや返されたストリームを処理するための他の多くのメソッドがあります。</p>
</div>
</div>
<div class="sect2">
<h3 id="using-a-range-instead-of-pages"><a class="anchor" href="#using-a-range-instead-of-pages"></a>ページの代わりにレンジを使用</h3>
<div class="paragraph">
<p><code>PanacheQuery</code> では、レンジベースのクエリーも使用できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// create a query for all living persons
PanacheQuery&lt;Person&gt; livingPersons = Person.find("status", Status.Alive);

// make it use a range: start at index 0 until index 24 (inclusive).
livingPersons.range(0, 24);

// get the range
List&lt;Person&gt; firstRange = livingPersons.list();

// to get the next range, you need to call range again
List&lt;Person&gt; secondRange = livingPersons.range(25, 49).list();</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>範囲とページを混在させることはできません。範囲を使用した場合、現在のページを持っていることに依存するすべてのメソッドは <code>UnsupportedOperationException</code> をスローします。 <code>page(Page)</code> もしくは <code>page(int, int)</code> を使用してページングに切り換えられます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="sorting"><a class="anchor" href="#sorting"></a>ソート</h3>
<div class="paragraph">
<p>クエリ文字列を受け付けるすべてのメソッドは、オプションで <code>Sort</code> パラメータも受け付けるので、ソートを抽象化することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;Person&gt; persons = Person.list(Sort.by("name").and("birth"));

// and with more restrictions
List&lt;Person&gt; persons = Person.list("status", Sort.by("name").and("birth"), Status.Alive);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Sort</code> クラスには、列を追加したり、ソート方向を指定したりするメソッドが豊富に用意されています。</p>
</div>
</div>
<div class="sect2">
<h3 id="simplified-queries"><a class="anchor" href="#simplified-queries"></a>シンプルなクエリー</h3>
<div class="paragraph">
<p>通常、MongoDB のクエリは <code>{'firstname': 'John', 'lastname':'Doe'}</code> 形式です。これを MongoDB ネイティブクエリと呼んでいます。</p>
</div>
<div class="paragraph">
<p><a href="https://docs.oracle.com/javaee/7/tutorial/persistence-querylanguage.htm#BNBTG">JPQL</a>(または <a href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#hql">HQL</a>)のサブセットとも言える *PanacheQL*というものもサポートしており、簡単にクエリを表現することができます。MongoDB with Panacheは、それをMongoDBのネイティブクエリにマッピングします。</p>
</div>
<div class="paragraph">
<p><code>{</code> で始まらないクエリは、PanacheQL クエリとみなします。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>&lt;singlePropertyName&gt;` (そしてシングルパラメーター) で、 <code>{'singleColumnName': '?1'}</code> に展開されます。</p>
</li>
<li>
<p><code>&lt;query&gt;</code> は <code>{&lt;query&gt;}</code> に展開され、PanacheQL のクエリを MongoDB のネイティブクエリ形式にマッピングします。以下の演算子をサポートしており、対応するMongoDBの演算子にマッピングされます。'and', 'or' ('and' と 'or' の混合は現在サポートされていません)、 '=', '&gt;', '&gt;=', '&lt;', '&lt;=', '!=', 'is null', 'is not null', そして MongoDB <code>$regex</code> 演算子にマッピングされる 'like' (String と JavaScript の両方のパターンをサポートしています)。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>クエリの例を紹介します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>firstname = ?1 and status = ?2</code> は <code>{'firstname': ?1, 'status': ?2}</code> にマッピングされます。</p>
</li>
<li>
<p><code>amount &gt; ?1 and firstname != ?2</code> は <code>{'amount': {'$gt': ?1}, 'firstname': {'$ne': ?2}}</code> にマッピングされます。</p>
</li>
<li>
<p><code>lastname like ?1</code> は <code>{'lastname': {'$regex': ?1}}</code> にマッピングされます。これは <a href="https://docs.mongodb.com/manual/reference/operator/query/regex/#op._S_regex">MongoDB の正規表現</a>をサポートするもので、SQL のようなパターンではないことに注意しましょう。</p>
</li>
<li>
<p><code>lastname is not null</code> は <code>{'lastname':{'$exists': true}}</code> にマッピングされます。</p>
</li>
<li>
<p><code>status in ?1</code> は <code>{'status':{$in: [?1]}}</code> にマッピングされます。</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
MongoDBのクエリは、有効なJSONドキュメントでなければなりません。同じフィールドをクエリ内で複数回使用することは、無効なJSONを生成することになるため、PanacheQLでは許可されません ( <a href="https://github.com/quarkusio/quarkus/issues/12086">GitHub のこの問題</a>を参照)。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>また、基本的な日付型の変換も行います。 <code>Date</code>, <code>LocalDate</code>, <code>LocalDateTime</code> もしくは <code>Instant</code> 型のすべてのフィールドは、 <code>ISODate</code> 型 (UTC datetime) を使って <a href="https://docs.mongodb.com/manual/reference/bson-types/#date">BSON Date</a>にマッピングされます。MongoDB POJO コーデックは <code>ZonedDateTime</code> と <code>OffsetDateTime</code> をサポートしていないので、使う前に変換しておく必要があります。</p>
</div>
<div class="paragraph">
<p>MongoDB with Panacheは、 <code>Document</code> クエリを提供することでMongoDBの拡張クエリもサポートしています。これはfind/list/stream/count/deleteメソッドでサポートされています。</p>
</div>
<div class="paragraph">
<p>MongoDB with Panache はアップデートドキュメントおよびクエリーに基づいて複数のドキュメントを更新する操作を提供します: <code>Person.update("foo = ?1 and bar = ?2", fooName, barName).where("name = ?1", name)</code></p>
</div>
<div class="paragraph">
<p>これらの操作では、クエリを表現するのと同じように、更新文書を表現することができます。以下に例を示します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>&lt;singlePropertyName&gt;` (そしてシングルパラメーター) で、更新ドキュメント <code>{'$set' : {'singleColumnName': '?1'}</code> に展開されます。</p>
</li>
<li>
<p><code>firstname = ?1 and status = ?2</code> は、更新ドキュメント <code>{'$set' : {'firstname': ?1, 'status': ?2}}</code> にマッピングされます。</p>
</li>
<li>
<p><code>firstname = :firstname and status = :status</code> は、更新ドキュメント <code>{'$set' : {'firstname': :firstname, 'status': :status}}</code> にマッピングされます。</p>
</li>
<li>
<p><code>{'firstname' : ?1 and 'status' : ?2}</code> は、更新ドキュメント <code>{'$set' : {'firstname': ?1, 'status': ?2}}</code> にマップされます。</p>
</li>
<li>
<p><code>{'firstname' : :firstname and 'status' : :status}</code> は、更新ドキュメント <code>{'$set' : {'firstname': :firstname, 'status': :status}}</code> にマップされます。</p>
</li>
<li>
<p><code>{'$inc': {'cpt': ?1}}</code> はそのまま使用されます。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="query-parameters"><a class="anchor" href="#query-parameters"></a>クエリパラメーター</h3>
<div class="paragraph">
<p>ネイティブクエリとPanacheQLクエリの両方で、以下のようにインデックス（1から始まる）ごとにクエリパラメータを渡すことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Person.find("name = ?1 and status = ?2", "Loïc", Status.Alive);
Person.find("{'name': ?1, 'status': ?2}", "Loïc", Status.Alive);</code></pre>
</div>
</div>
<div class="paragraph">
<p>または、 <code>Map</code> を使った名前で:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();
params.put("name", "Loïc");
params.put("status", Status.Alive);
Person.find("name = :name and status = :status", params);
Person.find("{'name': :name, 'status', :status}", params);</code></pre>
</div>
</div>
<div class="paragraph">
<p>または、便利なクラス <code>Parameters</code> をそのまま使用するか、 <code>Map</code> を構築する:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// generate a Map
Person.find("name = :name and status = :status",
         Parameters.with("name", "Loïc").and("status", Status.Alive).map());

// use it as-is
Person.find("{'name': :name, 'status': :status}",
         Parameters.with("name", "Loïc").and("status", Status.Alive));</code></pre>
</div>
</div>
<div class="paragraph">
<p>すべてのクエリー操作は、インデックス( <code>Object…​</code>)または名前付きパラメーター( <code>Map&lt;String,Object&gt;</code> または <code>Parameters</code>)でパラメータを渡すことができます。</p>
</div>
<div class="paragraph">
<p>クエリパラメータを使う場合、PanacheQLのクエリはObjectパラメータ名を参照しますが、ネイティブのクエリはMongoDBのフィールド名を参照するので注意が必要です。</p>
</div>
<div class="paragraph">
<p>次のようなエンティティを想像してみてください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Person extends PanacheMongoEntity {
    @BsonProperty("lastname")
    public String name;
    public LocalDate birth;
    public Status status;

    public static Person findByNameWithPanacheQLQuery(String name){
        return find("name", name).firstResult();
    }

    public static Person findByNameWithNativeQuery(String name){
        return find("{'lastname': ?1}", name).firstResult();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>findByNameWithPanacheQLQuery()</code> と <code>findByNameWithNativeQuery()</code> はどちらも同じ結果を返しますが、PanacheQL で書かれたクエリはエンティティのフィールド名 <code>name</code> を使用し、ネイティブクエリは MongoDB のフィールド名 <code>lastname</code> を使用します。</p>
</div>
</div>
<div class="sect2">
<h3 id="query-projection"><a class="anchor" href="#query-projection"></a>クエリーの射影</h3>
<div class="paragraph">
<p>クエリーの射影は、 <code>find()</code> のメソッドが返す <code>PanacheQuery</code> オブジェクトに対して <code>project(Class)</code> のメソッドで行うことができます。</p>
</div>
<div class="paragraph">
<p>これを使って、データベースから返されるフィールドを制限することができます。IDフィールドは常に返されますが、これをプロジェクションクラス内に含めることは必須ではありません。</p>
</div>
<div class="paragraph">
<p>そのためには、投影されたフィールドのみを含むクラス（POJO）を作成する必要があります。このPOJOには、 <code>@ProjectionFor(Entity.class)</code> でアノテーションを付ける必要があります。 <code>Entity</code> はエンティティ・クラスの名前です。プロジェクション・クラスのフィールド名（ゲッター）は、データベースから読み込まれるプロパティを制限するために使用されます。</p>
</div>
<div class="paragraph">
<p>射影は、PanacheQLとネイティブクエリの両方で行うことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.mongodb.panache.common.ProjectionFor;
import org.bson.codecs.pojo.annotations.BsonProperty;

// using public fields
@ProjectionFor(Person.class)
public class PersonName {
    public String name;
}

// using getters
@ProjectionFor(Person.class)
public class PersonNameWithGetter {
    private String name;

    public String getName(){
        return name;
    }

    public void setName(String name){
        this.name = name;
    }
}

// only 'name' will be loaded from the database
PanacheQuery&lt;PersonName&gt; shortQuery = Person.find("status ", Status.Alive).project(PersonName.class);
PanacheQuery&lt;PersonName&gt; query = Person.find("'status': ?1", Status.Alive).project(PersonNameWithGetter.class);
PanacheQuery&lt;PersonName&gt; nativeQuery = Person.find("{'status': 'ALIVE'}", Status.Alive).project(PersonName.class);</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
エンティティクラスのマッピングが使用されるため、カスタムカラムマッピングを定義するために <code>@BsonProperty</code> を使用する必要はありません。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
射影クラスが他のクラスを継承している場合があります。この場合、親クラスも <code>@ProjectionFor</code> アノテーションを持つ必要があります。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="query-debugging"><a class="anchor" href="#query-debugging"></a>クエリのデバッグ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MongoDB with Panacheではシンプルなクエリを書くことができますが、生成されたネイティブクエリをログに残しておくと、デバッグの際に便利なことがあります。</p>
</div>
<div class="paragraph">
<p>これは、 <code>application.properties</code> の中で以下のログカテゴリーを DEBUG に設定することで実現できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.log.category."io.quarkus.mongodb.panache.runtime".level=DEBUG</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-pojocodecprovider-easy-object-to-bson-document-conversion"><a class="anchor" href="#the-pojocodecprovider-easy-object-to-bson-document-conversion"></a>PojoCodecProvider: オブジェクトからBSONドキュメントへの変換を簡単に行うことができます。</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MongoDB with Panache は <a href="https://www.mongodb.com/docs/drivers/java/sync/current/fundamentals/data-formats/document-data-format-pojo/">PojoCodecProvider</a> と <a href="https://www.mongodb.com/docs/drivers/java/sync/current/fundamentals/data-formats/document-data-format-pojo/#configure-the-driver-for-pojos">automatic POJO support</a> で、オブジェクトから BSON ドキュメントに自動変換しています。</p>
</div>
<div class="paragraph">
<p><code>org.bson.codecs.configuration.CodecConfigurationException</code> の例外が発生した場合、コーデックがオブジェクトを自動的に変換できないことを意味します。このコーデックは、Java Bean 標準に準拠しているため、パブリックフィールドまたはゲッター/セッターを使用する POJO を正常に変換します。 <code>@BsonIgnore</code> を使用して、フィールドまたはゲッター/セッターをコーデックで無視することができます。</p>
</div>
<div class="paragraph">
<p>クラスがこれらの規則に従わない場合（例えば、 <code>get</code> で始まるがセッターではないメソッドを含む場合）、そのクラスにカスタムコーデックを提供することができます。あなたのカスタム・コーデックは、自動的に検出され、コーデック・レジストリに登録されます。詳しくは、 <a href="mongodb.html#simplifying-mongodb-client-usage-using-bson-codec">BSONコーデックの使用</a>をご覧ください。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="transactions"><a class="anchor" href="#transactions"></a>トランザクション</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MongoDBは、バージョン4.0からACIDトランザクションを提供しています。</p>
</div>
<div class="paragraph">
<p>MongoDB with Panacheでこれらを使うには、トランザクションを開始するメソッドに <code>@Transactional</code> アノテーションを付ける必要があります。</p>
</div>
<div class="paragraph">
<p>MongoDBでは、トランザクションはレプリカセットでのみ可能です。幸運なことに、 <a href="mongodb.html#dev-services">MongoDBの開発サービス</a> では、シングルノードのレプリカセットを設定するので、トランザクションと互換性があります。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
MongoDB with Panache内部のトランザクションサポートはまだ実験的なものです。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="custom-ids"><a class="anchor" href="#custom-ids"></a>カスタムID</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ID はしばしば微妙な問題です。MongoDBでは、IDは通常、 <code>ObjectId</code> 型でデータベースによって自動生成されます。MongoDB with Panacheでは、IDは <code>org.bson.types.ObjectId</code> 型の <code>id</code> というフィールドで定義されていますが、もしカスタマイズしたいのであれば、私たちがサポートします。</p>
</div>
<div class="paragraph">
<p><code>PanacheMongoEntity</code> の代わりに <code>PanacheMongoEntityBase</code> を拡張することで、独自のID戦略を指定することができます。そして、 <code>@BsonId</code> でアノテーションを付けて、好きなIDをパブリック・フィールドとして宣言します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@MongoEntity
public class Person extends PanacheMongoEntityBase {

    @BsonId
    public Integer myId;

    //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>リポジトリを使用している場合は、 <code>PanacheMongoRepository</code> の代わりに <code>PanacheMongoRepositoryBase</code> を拡張し、ID 型を追加の型パラメータとして指定することになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class PersonRepository implements PanacheMongoRepositoryBase&lt;Person,Integer&gt; {
    //...
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>ObjectId</code> を使う場合は、MongoDB が自動的に値を提供してくれますが、カスタムフィールド型を使う場合は、自分で値を提供する必要があります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>ObjectId</code> は、REST サービスでその値を公開したい場合、使用するのが難しいことがあります。そこで、RESTEasy Jackson extensionまたはRESTEasy JSON-B extensionに依存するプロジェクトであれば自動的に登録される、 <code>String</code> としてシリアライズ/デシリアライズするJacksonおよびJSON-Bプロバイダを作成しました。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>標準の <code>ObjectId</code> ID型を使用する場合、識別子がパスパラメータから来ているときは、新しい <code>ObjectId</code> を作成してエンティティを取得することを忘れないでください。例えば以下のように行います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@GET
@Path("/{id}")
public Person findById(String id) {
    return Person.findById(new ObjectId(id));
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="working-with-kotlin-data-classes"><a class="anchor" href="#working-with-kotlin-data-classes"></a>Kotlin のデータクラスで作業する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kotlinのデータクラスは、データキャリアクラスを定義する非常に便利な方法であり、エンティティクラスを定義するのに適しています。</p>
</div>
<div class="paragraph">
<p>しかし、このクラスの型はいくつかの制限があります。また、生成時に初期化される全てのフィールドは nullable としてマークされ、生成されたコンストラクタは、データクラスのすべてのフィールドをパラメータとして持つ必要があります。</p>
</div>
<div class="paragraph">
<p>MongoDB with Panache は <a href="https://www.mongodb.com/docs/drivers/java/sync/current/bson/pojos">PojoCodecProvider</a> を使用します。これは MongoDB のコーデックで、パラメータなしのコンストラクタの存在を義務付けています。</p>
</div>
<div class="paragraph">
<p>そのため、データクラスをエンティティクラスとして使用したい場合は、Kotlinに空のコンストラクタを生成させる方法が必要です。そのためには、クラスのすべてのフィールドにデフォルト値を用意する必要があります。Kotlinのドキュメントの次の文章で説明しています。</p>
</div>
<div class="paragraph">
<p><em>JVMでは、生成されたクラスがパラメータレス・コンストラクタを持つ必要がある場合、すべてのプロパティのデフォルト値を指定する必要があります（「コンストラクタ」を参照）。</em></p>
</div>
<div class="paragraph">
<p>何らかの理由で前述の解決策が受け入れられないと判断された場合、代替手段があります。</p>
</div>
<div class="paragraph">
<p>まず、BSON Codecを作成すると、Quarkusに自動的に登録され、 <code>PojoCodecProvider</code> の代わりに使用されます。ドキュメントのこの部分を参照してください。 <a href="mongodb.html#simplifying-mongodb-client-usage-using-bson-codec">BSONコーデックの使用</a></p>
</div>
<div class="paragraph">
<p>もうひとつの方法は、 <code>@BsonCreator</code> アノテーションを使用して、 <code>PojoCodecProvider</code> に Kotlin データクラスのデフォルトコンストラクタを使用するように指示することです。この場合、すべてのコンストラクタパラメータは <code>@BsonProperty</code> でアノテーションする必要があります。<a href="https://www.mongodb.com/docs/drivers/java/sync/current/fundamentals/data-formats/pojo-customization/#pojos-without-no-argument-constructors">引数なしのコンストラクタの無いPOJOのサポート</a> を参照してください。</p>
</div>
<div class="paragraph">
<p>これは、エンティティが <code>PanacheMongoEntity</code> ではなく <code>PanacheMongoEntityBase</code> を拡張している場合にのみ機能します。なぜなら、ID フィールドもコンストラクタに含める必要があるからです。</p>
</div>
<div class="paragraph">
<p>Kotlinのデータクラスとして定義された <code>Person</code> クラスの例は次のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">data class Person @BsonCreator constructor (
    @BsonId var id: ObjectId,
    @BsonProperty("name") var name: String,
    @BsonProperty("birth") var birth: LocalDate,
    @BsonProperty("status") var status: Status
): PanacheMongoEntityBase()</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ここでは、 <code>var</code> を使用していますが、 <code>val</code> も使用できることに注意してください。</p>
</div>
<div class="paragraph">
<p>簡潔にするために <code>@BsonProperty("_id")</code> の代わりに <code>@BsonId</code> のアノテーションを使用していますが、どちらを使用しても構いません。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>最後の方法は、 <a href="https://kotlinlang.org/docs/reference/compiler-plugins.html#no-arg-compiler-plugin">no-arg</a>compiler plugin を使うことです。このプラグインにはアノテーションのリストが設定されており、最終的にはアノテーションが設定されている各クラスのno-argsコンストラクタが生成されます。</p>
</div>
<div class="paragraph">
<p>MongoDB with Panache では、データクラスに <code>@MongoEntity</code> アノテーションを使用することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@MongoEntity
data class Person (
    var name: String,
    var birth: LocalDate,
    var status: Status
): PanacheMongoEntity()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reactive"><a class="anchor" href="#reactive"></a>リアクティブエンティティとレポジトリー</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MongoDB with Panacheでは、エンティティとリポジトリの両方でリアクティブスタイルの実装を使うことができます。そのためには、エンティティを定義するときには <code>ReactivePanacheMongoEntity</code> または <code>ReactivePanacheMongoEntityBase</code> を、リポジトリを定義するときには <code>ReactivePanacheMongoRepository</code> または <code>ReactivePanacheMongoRepositoryBase</code> を、それぞれ Reactive バリアントとして使用する必要があります。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Mutiny</div>
<div class="paragraph">
<p>MongoDB with PanacheのリアクティブAPIは、Mutinyのリアクティブ型を使用しています。Mutinyに慣れていない方は、 <a href="mutiny-primer.html">MUTINYによる非同期入門</a> をご覧ください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>Person</code> クラスのリアクティブ・バリアントは以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class ReactivePerson extends ReactivePanacheMongoEntity {
    public String name;
    public LocalDate birth;
    public Status status;

    // return name as uppercase in the model
    public String getName(){
        return name.toUpperCase();
    }

    // store all names in lowercase in the DB
    public void setName(String name){
        this.name = name.toLowerCase();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>bsonアノテーション、カスタムID、PanacheQLなど、 リアクティブ バリアント内で <em>命令型</em> のバリアントと同じ機能を利用できますが、エンティティやリポジトリのメソッドはすべてリアクティブ型を返します。</p>
</div>
<div class="paragraph">
<p>リアクティブ バリアントを持つ命令型の例から、同等のメソッドを見てみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// creating a person
ReactivePerson person = new ReactivePerson();
person.name = "Loïc";
person.birth = LocalDate.of(1910, Month.FEBRUARY, 1);
person.status = Status.Alive;

// persist it: if you keep the default ObjectId ID field, it will be populated by the MongoDB driver,
// and accessible when uni1 will be resolved
Uni&lt;ReactivePerson&gt; uni1 = person.persist();

person.status = Status.Dead;

// Your must call update() in order to send your entity modifications to MongoDB
Uni&lt;ReactivePerson&gt; uni2 = person.update();

// delete it
Uni&lt;Void&gt; uni3 = person.delete();

// getting a list of all persons
Uni&lt;List&lt;ReactivePerson&gt;&gt; allPersons = ReactivePerson.listAll();

// finding a specific person by ID
// here we build a new ObjectId, but you can also retrieve it from the existing entity after being persisted
ObjectId personId = new ObjectId(idAsString);
Uni&lt;ReactivePerson&gt; personById = ReactivePerson.findById(personId);

// finding a specific person by ID via an Optional
Uni&lt;Optional&lt;ReactivePerson&gt;&gt; optional = ReactivePerson.findByIdOptional(personId);
personById = optional.map(o -&gt; o.orElseThrow(() -&gt; new NotFoundException()));

// finding all living persons
Uni&lt;List&lt;ReactivePerson&gt;&gt; livingPersons = ReactivePerson.list("status", Status.Alive);

// counting all persons
Uni&lt;Long&gt; countAll = ReactivePerson.count();

// counting all living persons
Uni&lt;Long&gt; countAlive = ReactivePerson.count("status", Status.Alive);

// delete all living persons
Uni&lt;Long&gt;  deleteCount = ReactivePerson.delete("status", Status.Alive);

// delete all persons
deleteCount = ReactivePerson.deleteAll();

// delete by id
Uni&lt;Boolean&gt; deleted = ReactivePerson.deleteById(personId);

// set the name of all living persons to 'Mortal'
Uni&lt;Long&gt; updated = ReactivePerson.update("name", "Mortal").where("status", Status.Alive);</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
RESTEasyでMongoDB with Panacheを併用している場合、 <code>quarkus-resteasy-mutiny</code> エクステンションを含めれば、JAX-RSリソースエンドポイント内でリアクティブ型を直接返すことができます。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>リアクティブ型に対しても同様の問い合わせ機能がありますが、 <code>stream()</code> メソッドの動作は異なります。 <code>Stream</code> の代わりに <code>Multi</code> （リアクティブストリーム <code>Publisher</code> を実装したもの）を返します。</p>
</div>
<div class="paragraph">
<p>これにより、より高度なリアクティブなユースケースが可能となり、例えば、RESTEasyを介してSSE（Server-Sent Event）を送信するために使用することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.jboss.resteasy.reactive.RestStreamElementType;
import org.reactivestreams.Publisher;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;

@GET
@Path("/stream")
@Produces(MediaType.SERVER_SENT_EVENTS)
@RestStreamElementType(MediaType.APPLICATION_JSON)
public Multi&lt;ReactivePerson&gt; streamPersons() {
    return ReactivePerson.streamAll();
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>@SseElementType(MediaType.APPLICATION_JSON)</code> がRESTEasyにJSONでオブジェクトをシリアライズするように指示します。
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
トランザクションは、Reactive エンティティおよびRepositoryではサポートされていません。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mocking"><a class="anchor" href="#mocking"></a>モック</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="using-the-active-record-pattern"><a class="anchor" href="#using-the-active-record-pattern"></a>アクティブ・レコード・パターンの使用</h3>
<div class="paragraph">
<p>active-recordパターンを使用している場合、Mockitoはスタティック・メソッドのモックをサポートしていないため、直接使用することはできませんが、 <code>quarkus-panache-mock</code> モジュールを使用することで、Mockitoを使用して、あなた自身のメソッドを含む、提供されたすべてのスタティック・メソッドをモックすることができます。</p>
</div>
<div class="paragraph">
<p>この依存関係を <code>pom.xml</code> に追加してください:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-panache-mock&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">testImplementation("io.quarkus:quarkus-panache-mock")</code></pre>
</div>
</div>
<div class="paragraph">
<p>このシンプルなエンティティ:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Person extends PanacheMongoEntity {

    public String name;

    public static List&lt;Person&gt; findOrdered() {
        return findAll(Sort.by("lastname", "firstname")).list();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>モック化テストはこのように書くことができます:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
public class PanacheFunctionalityTest {

    @Test
    public void testPanacheMocking() {
        PanacheMock.mock(Person.class);

        // Mocked classes always return a default value
        Assertions.assertEquals(0, Person.count());

        // Now let's specify the return value
        Mockito.when(Person.count()).thenReturn(23L);
        Assertions.assertEquals(23, Person.count());

        // Now let's change the return value
        Mockito.when(Person.count()).thenReturn(42L);
        Assertions.assertEquals(42, Person.count());

        // Now let's call the original method
        Mockito.when(Person.count()).thenCallRealMethod();
        Assertions.assertEquals(0, Person.count());

        // Check that we called it 4 times
        PanacheMock.verify(Person.class, Mockito.times(4)).count();<i class="conum" data-value="1"></i><b>(1)</b>

        // Mock only with specific parameters
        Person p = new Person();
        Mockito.when(Person.findById(12L)).thenReturn(p);
        Assertions.assertSame(p, Person.findById(12L));
        Assertions.assertNull(Person.findById(42L));

        // Mock throwing
        Mockito.when(Person.findById(12L)).thenThrow(new WebApplicationException());
        Assertions.assertThrows(WebApplicationException.class, () -&gt; Person.findById(12L));

        // We can even mock your custom methods
        Mockito.when(Person.findOrdered()).thenReturn(Collections.emptyList());
        Assertions.assertTrue(Person.findOrdered().isEmpty());

        PanacheMock.verify(Person.class).findOrdered();
        PanacheMock.verify(Person.class, Mockito.atLeastOnce()).findById(Mockito.any());
        PanacheMock.verifyNoMoreInteractions(Person.class);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>verify</code> のメソッドを <code>Mockito</code> ではなく <code>PanacheMock</code> で呼び出すようにしてください。そうしないと、どのモックオブジェクトを渡せばいいのかわかりません。</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="using-the-repository-pattern"><a class="anchor" href="#using-the-repository-pattern"></a>リポジトリパターンの使用</h3>
<div class="paragraph">
<p>リポジトリパターンを使用している場合は、 <code>quarkus-junit5-mockito</code> モジュールを使用して、Mockito を直接使用することができます。これにより、ビーンのモッキングが非常に簡単になります。</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-junit5-mockito&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">testImplementation("io.quarkus:quarkus-junit5-mockito")</code></pre>
</div>
</div>
<div class="paragraph">
<p>このシンプルなエンティティ:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Person {

    @BsonId
    public Long id;

    public String name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>そしてこのリポジトリ:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class PersonRepository implements PanacheMongoRepository&lt;Person&gt; {
    public List&lt;Person&gt; findOrdered() {
        return findAll(Sort.by("lastname", "firstname")).list();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>モック化テストはこのように書くことができます:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
public class PanacheFunctionalityTest {
    @InjectMock
    PersonRepository personRepository;

    @Test
    public void testPanacheRepositoryMocking() throws Throwable {
        // Mocked classes always return a default value
        Assertions.assertEquals(0, personRepository.count());

        // Now let's specify the return value
        Mockito.when(personRepository.count()).thenReturn(23L);
        Assertions.assertEquals(23, personRepository.count());

        // Now let's change the return value
        Mockito.when(personRepository.count()).thenReturn(42L);
        Assertions.assertEquals(42, personRepository.count());

        // Now let's call the original method
        Mockito.when(personRepository.count()).thenCallRealMethod();
        Assertions.assertEquals(0, personRepository.count());

        // Check that we called it 4 times
        Mockito.verify(personRepository, Mockito.times(4)).count();

        // Mock only with specific parameters
        Person p = new Person();
        Mockito.when(personRepository.findById(12L)).thenReturn(p);
        Assertions.assertSame(p, personRepository.findById(12L));
        Assertions.assertNull(personRepository.findById(42L));

        // Mock throwing
        Mockito.when(personRepository.findById(12L)).thenThrow(new WebApplicationException());
        Assertions.assertThrows(WebApplicationException.class, () -&gt; personRepository.findById(12L));

        Mockito.when(personRepository.findOrdered()).thenReturn(Collections.emptyList());
        Assertions.assertTrue(personRepository.findOrdered().isEmpty());

        // We can even mock your custom methods
        Mockito.verify(personRepository).findOrdered();
        Mockito.verify(personRepository, Mockito.atLeastOnce()).findById(Mockito.any());
        Mockito.verifyNoMoreInteractions(personRepository);
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="how-and-why-we-simplify-mongodb-api"><a class="anchor" href="#how-and-why-we-simplify-mongodb-api"></a>MongoDB の API をシンプルにする方法と理由</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MongoDBのエンティティを書くときには、以下のように、ユーザーが不本意ながら慣れてしまっている厄介なことがたくさんあります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>IDロジックの重複:ほとんどのエンティティにはIDが必要ですが、モデルとはあまり関係がないため、ほとんどの人はIDの設定方法を気にしません。</p>
</li>
<li>
<p>ダサいゲッターとセッター：Javaは言語でプロパティをサポートしていないので、フィールドに対して読み書きを行わなかったとしてもフィールドを作成し、そのフィールドのためにゲッターとセッターを生成しなければなりません。</p>
</li>
<li>
<p>オブジェクト指向アーキテクチャの通常のオブジェクトでは、ステートとメソッドが同じクラスにないことはあり得ないのに、伝統的なEEパターンでは、エンティティの定義（モデル）とそれに対する操作（DAOやリポジトリ）を分けることが推奨されており、実際にはステートとその操作を不自然に分ける必要があります。さらに、エンティティごとに2つのクラスが必要になり、エンティティの操作を行う必要があるDAOやRepositoryをインジェクションする必要があるため、編集フローが崩れ、書いているコードから抜けてインジェクションポイントを設定してから戻って使用しなければなりません。</p>
</li>
<li>
<p>MongoDBのクエリは非常に強力ですが、一般的な操作では冗長すぎて、すべてのパーツが必要ではない場合でもクエリを書かなければなりません。</p>
</li>
<li>
<p>MongoDB のクエリは JSON ベースなので、文字列の操作や <code>Document</code> 型を使う必要があり、多くのボイラープレートコードが必要になります。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Panacheでは、これらの問題に対して、定見に基づいたアプローチをとりました。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>エンティティは <code>PanacheMongoEntity</code> を拡張するようにしてください：自動生成されるIDフィールドがあります。カスタムのID戦略が必要な場合は、代わりに <code>PanacheMongoEntityBase</code> を拡張して、IDを自分で処理することができます。</p>
</li>
<li>
<p>パブリックフィールドを使ってください。無駄なゲッターとセッターを無くせます。フードの下では、不足しているすべてのゲッターとセッターを生成し、これらのフィールドへのすべてのアクセスを、アクセサ・メソッドを使用するように書き換えます。この方法では、必要なときに <em>便利な</em> アクセサを書くことができ、エンティティ・ユーザーがフィールド・アクセスを使用していても、それが使用されます。</p>
</li>
<li>
<p>アクティブレコードパターンの使用: アクティブレコードパターンでは、すべてのエンティティロジックをエンティティクラスのスタティックメソッドに置き、DAOを作りません。エンティティスーパークラスには、非常に便利なスタティックメソッドがたくさん用意されていますし、エンティティクラスに独自のメソッドを追加することもできます。 <code>Person</code> ユーザーは、 <code>Person</code> と入力するだけで、すべての操作を一か所で完了させることができます。</p>
</li>
<li>
<p>必要のない部分を書かないようにしましょう: <code>Person.find("order by name")</code> や <code>Person.find("name = ?1 and status = ?2", "Loïc", Status.Alive)</code> 、さらには <code>Person.find("name", "Loïc")</code> のように書きましょう。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以上となります: Panacheを使えば、MongoDBがこれほどまでに整然としたものになるのです。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="defining-entities-in-external-projects-or-jars"><a class="anchor" href="#defining-entities-in-external-projects-or-jars"></a>外部プロジェクトや jar でエンティティを定義する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MongoDB with Panacheは、エンティティに対してコンパイル時にバイトコードを強化します。</p>
</div>
<div class="paragraph">
<p>これは、マーカーファイル <code>META-INF/panache-archive.marker</code> の存在によって、Panache エンティティを持つアーカイブ（および Panache エンティティのコンシューマー）を識別しようとするものです。Panacheには、Panacheに（間接的にでも）依存しているアーカイブでこのファイルを自動的に作成するアノテーションプロセッサが含まれています。アノテーションプロセッサを無効にしている場合、場合によってはこのファイルを手動で作成する必要があります。</p>
</div>
</div>
</div>
    </div>
    <div class="grid__item width-4-12 width-12-12-m tocwrapper">
      <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#first-an-example">最初に:例</a></li>
<li><a href="#solution">ソリューション</a></li>
<li><a href="#creating-the-maven-project">Mavenプロジェクトの作成</a></li>
<li><a href="#setting-up-and-configuring-mongodb-with-panache">Panache による MongoDB のセットアップおよび設定</a></li>
<li><a href="#solution-1-using-the-active-record-pattern">解決策1:アクティブレコードパターンを使用する</a>
<ul class="sectlevel2">
<li><a href="#defining-your-entity">エンティティの定義</a></li>
<li><a href="#most-useful-operations">最も便利な操作</a></li>
<li><a href="#adding-entity-methods">エンティティメソッドの追加</a></li>
</ul>
</li>
<li><a href="#solution-2-using-the-repository-pattern">解決策2:リポジトリパターンを使用する</a>
<ul class="sectlevel2">
<li><a href="#defining-your-entity-2">エンティティの定義</a></li>
<li><a href="#defining-your-repository">リポジトリの定義</a></li>
<li><a href="#most-useful-operations-2">最も便利な操作</a></li>
</ul>
</li>
<li><a href="#writing-a-jax-rs-resource">JAX-RS リソースの書き方</a></li>
<li><a href="#advanced-query">高度なクエリー</a>
<ul class="sectlevel2">
<li><a href="#paging">ページング</a></li>
<li><a href="#using-a-range-instead-of-pages">ページの代わりにレンジを使用</a></li>
<li><a href="#sorting">ソート</a></li>
<li><a href="#simplified-queries">シンプルなクエリー</a></li>
<li><a href="#query-parameters">クエリパラメーター</a></li>
<li><a href="#query-projection">クエリーの射影</a></li>
</ul>
</li>
<li><a href="#query-debugging">クエリのデバッグ</a></li>
<li><a href="#the-pojocodecprovider-easy-object-to-bson-document-conversion">PojoCodecProvider: オブジェクトからBSONドキュメントへの変換を簡単に行うことができます。</a></li>
<li><a href="#transactions">トランザクション</a></li>
<li><a href="#custom-ids">カスタムID</a></li>
<li><a href="#working-with-kotlin-data-classes">Kotlin のデータクラスで作業する</a></li>
<li><a href="#reactive">リアクティブエンティティとレポジトリー</a></li>
<li><a href="#mocking">モック</a>
<ul class="sectlevel2">
<li><a href="#using-the-active-record-pattern">アクティブ・レコード・パターンの使用</a></li>
<li><a href="#using-the-repository-pattern">リポジトリパターンの使用</a></li>
</ul>
</li>
<li><a href="#how-and-why-we-simplify-mongodb-api">MongoDB の API をシンプルにする方法と理由</a></li>
<li><a href="#defining-entities-in-external-projects-or-jars">外部プロジェクトや jar でエンティティを定義する</a></li>
</ul></div>
    </div>
  </div>
  </div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license. <i class='fab fa-creative-commons'></i><i class='fab fa-creative-commons-by'></i> <a href='https://creativecommons.org/licenses/by/3.0/' target='_blank'>CC by 3.0</a><br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">ホーム</a></li>
          
          
          
            <li><a href="/about" target="_blank">Quarkusについて</a></li>
          
          
          
            <li><a href="/blog" target="_blank">ブログ</a></li>
          
          
          
            <li><a href="/insights" target="_blank">ポッドキャスト</a></li>
          
          
          
            <li><a href="/events" target="_blank">イベント</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">ニュースレター</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">ユーザーストーリー</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">ロードマップ</a></li>
          
          
          
            <li><a href="/security" target="_blank">セキュリティ&nbsp;ポリシー</a></li>
          
          
          
            <li><a href="/usage" target="_blank">使用方法</a></li>
          
          
          
            <li><a href="https://github.com/commonhaus/artwork/tree/main/projects/quarkus" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
          
            <li><a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy Policy</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォローする</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.threads.com/@quarkusio" target="_blank">Threads</a></li>
          
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">サポート</a></li>
          
          
          
            <li><a href="/guides" target="_blank">ガイド</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">入門</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">ディスカッション</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">開発メーリングリスト</a></li>
          
          
          
            <li><a href="https://stats.uptimerobot.com/ze1PfweT2p" target="_blank">Quarkus Service Status</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>言語</span>
        <ul class="footer-links">
          
          
            <li><a href=" https://quarkus.io/ " target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href=" https://es.quarkus.io/ " target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href=" https://ja.quarkus.io/ " target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate ORM</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">その他多数...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content cf-footer">
  <div class="flexcontainer">
    <div class="cf-logo">
      <a class="cf-logo" href="https://www.commonhaus.org/" target="_blank"><img src="https://raw.githubusercontent.com/commonhaus/artwork/main/foundation/brand/svg/CF_logo_horizontal_single_reverse.svg"/></a>
    </div>
    <div class="license">
      Copyright © Quarkus. All rights reserved. For details on our trademarks, please visit our <a href="https://www.commonhaus.org/policies/trademark-policy/">Trademark Policy</a> and <a href="https://www.commonhaus.org/trademarks/">Trademark List</a>. Trademarks of third parties are owned by their respective holders and their mention here does not suggest any endorsement or association.
    </div>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
  <script src="/assets/javascript/randomize.js" type="text/javascript"></script>
  <script src="/assets/javascript/time.js" type="text/javascript"></script>
</body>

</html>
