<!DOCTYPE html>
<html lang="ja">







<head>
  <title>WebSockets Next リファレンスガイド - main - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/main/guides/websockets-next-reference" />
  <meta property="og:title" content="WebSockets Next リファレンスガイド - main" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/websockets-next-reference">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="guides">

  


<div class="grid-wrapper communitysite">
  <div class="grid__item width-12-12">The <a href="https://quarkus.io/version/main/guides/websockets-next-reference">English version of quarkus.io</a> is the official project site. Translated sites are community supported on a best-effort basis.</div>
</div>


  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="#">Why<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/performance" class="">パフォーマンス</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
          <li><a href="/versatility" class="">多用途性</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/spring" class="">USING SPRING?</a></li>
          <li class="tertiarydropdown">
            <span href="#">AI<i class="fas fa-chevron-down"></i></span>
            <ul class="tertiarymenu">
              <li><a href="/ai" class="">AI OVERVIEW</a></li>
              <li><a href="/java-for-ai" class="">JAVA FOR AI</a></li>
              <li><a href="/quarkus-for-ai" class="">WHY QUARKUS FOR AI</a></li>
              <li><a href="/ai-blueprints" class="">AI BLUEPRINTS</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Learn<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ドキュメント</a></li>
          <li><a href="/userstories/" class="">ユーザーストーリー</a></li>  
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="#">Extensions<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
<li><a href="https://quarkus.io/extensions/" class="">エクステンションを探す</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">エクステンションの使用</a></li>
          <li><a href="/guides/writing-extensions" class="">エクステンションの作成</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">エクステンションの共有</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Community<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/working-groups" class="">ワーキンググループ</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ロードマップ</a></li>
          <li><a href="/benefactors" class="">BENEFACTORS</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/version/main/guides/websockets-next-reference" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/version/main/guides/websockets-next-reference">ポルトガル（BR）</a></li>
          <li><a href="https://es.quarkus.io/version/main/guides/websockets-next-reference">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/version/main/guides/websockets-next-reference">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/version/main/guides/websockets-next-reference">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas
fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    







<section class="full-width-version-bg flexfilterbar guides">
  <div class="guideflexcontainer">
    <div class="docslink">
      <a class="returnlink" href="/version/main/guides/"> Back to Guides</a>
    </div>
    <div class="flexlabel">
      <label>バージョン:</label>
    </div>
    <div class="guidepulldown version">
    <select id="guide-version-dropdown">
      
        
        
        <option value="main" selected>Main - SNAPSHOT</option>
        
        
        
        <option value="latest" >3.28.4 - Latest</option>
        
        
        
        <option value="3.27" >3.27</option>
        
        
        
        <option value="3.20" >3.20</option>
        
        
        
        <option value="3.15" >3.15</option>
        
        
        
        </select>
    </div>
  </div>
</section>

<div class="guide">
  <div class="grid-wrapper">
    <div class="grid__item width-8-12 width-12-12-m">
      
      <a class="editlink" href="https://github.com/quarkusio/quarkus/edit/main/docs/src/main/asciidoc/websockets-next-reference.adoc">このページを編集</a>
      
      <h1 class="text-caps">WebSockets Next リファレンスガイド </h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><code>quarkus-websockets-next</code> エクステンションは、WebSocket サーバーおよびクライアントエンドポイントを定義するための最新の宣言型 API を提供します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-websocket-protocol"><a class="anchor" href="#the-websocket-protocol"></a>1. WebSocket プロトコル</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://datatracker.ietf.org/doc/html/rfc6455">RFC6455</a> に記載されている <em>WebSocket</em> プロトコルは、単一の TCP 接続を介してクライアントとサーバー間の双方向通信チャネルを作成するための標準化された方法を確立します。
HTTP とは異なり、WebSocket は別個の TCP プロトコルとして動作しますが、HTTP とシームレスに連携して機能するように設計されています。
たとえば、同じポートを再利用し、同じセキュリティーメカニズムと互換性があります。</p>
</div>
<div class="paragraph">
<p>WebSocket を使用したやり取りは、WebSocket プロトコルに移行するための 'Upgrade' ヘッダーを使用する HTTP リクエストで開始されます。
サーバーは、 <code>200 OK</code> レスポンスの代わりに <code>101 Switching Protocols</code> レスポンスを返し、HTTP 接続を WebSocket 接続へとアップグレードします。
このハンドシェイクが成功すると、最初の HTTP アップグレードリクエストで使用された TCP ソケットは開いたままとなり、クライアントとサーバーの双方が継続的に双方向のメッセージをやり取りできるようになります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="http-and-websocket-architecture-styles"><a class="anchor" href="#http-and-websocket-architecture-styles"></a>2. HTTP および WebSocket アーキテクチャースタイル</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WebSocket は HTTP と互換性があり、HTTP リクエストを通じて開始されますが、2 つのプロトコルは異なるアーキテクチャーとプログラミングモデルを導くため、その違いを認識することが重要です。</p>
</div>
<div class="paragraph">
<p>HTTP/REST では、アプリケーションはリソース/エンドポイントを中心に構成され、さまざまな HTTP メソッドやパスを処理します。
クライアントとのやり取りは、適切なメソッドとパスを指定した HTTP リクエストを送信することで行われ、リクエスト/レスポンスのパターンに従います
サーバーは、パス、メソッド、ヘッダーに基づいて、受信したリクエストを対応するハンドラーにルーティングし、明確に定義されたレスポンスで返します。</p>
</div>
<div class="paragraph">
<p>逆に、WebSocket では通常、最初の HTTP 接続に単一のエンドポイントが使用され、その後、すべてのメッセージが同じ TCP 接続を利用します。
これにより、非同期かつメッセージ駆動型のまったく異なるインタラクションモデルが導入されます。</p>
</div>
<div class="paragraph">
<p>WebSocket は、HTTP とは対照的に、低レベルのトランスポートプロトコルです。
メッセージの形式、ルーティング、または処理には、メッセージのセマンティクスに関するクライアントとサーバー間の事前の合意が必要です。</p>
</div>
<div class="paragraph">
<p>WebSocket クライアントとサーバーの場合、HTTP ハンドシェイクリクエストの <code>Sec-WebSocket-Protocol</code> ヘッダーにより、より高レベルのメッセージングプロトコルのネゴシエーションが可能になります。このヘッダーがない場合、サーバーとクライアントは独自の規則を確立する必要があります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quarkus-websockets-vs-quarkus-websockets-next"><a class="anchor" href="#quarkus-websockets-vs-quarkus-websockets-next"></a>3. Quarkus WebSockets と Quarkus WebSockets Next</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このガイドでは、従来の <code>quarkus-websockets</code> エクステンションに比べ、効率性と使いやすさが向上した WebSocket API の実装である <code>quarkus-websockets-next</code> エクステンションを利用します。
オリジナルの <code>quarkus-websockets</code> エクステンションは引き続きアクセス可能で、継続的なサポートが提供されますが、機能開発が行われる可能性は低いです。</p>
</div>
<div class="paragraph">
<p><code>quarkus-websockets</code> とは異なり、 <code>quarkus-websockets-next</code> エクステンションは Jakarta WebSocket 仕様を <strong>実装していません</strong>。
代わりに、使いやすさを重視した最新の API を導入しています。
さらに、Quarkus のリアクティブアーキテクチャーおよびネットワーク層とシームレスに統合するように調整されています。</p>
</div>
<div class="paragraph">
<p>Quarkus WebSockets Next エクステンションで使用されるアノテーションは、同じ名前を共有する場合もありますが、JSR 356 のアノテーションとは異なります。
JSR アノテーションには、Quarkus WebSockets Next エクステンションが従わないセマンティクスが含まれています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="project-setup"><a class="anchor" href="#project-setup"></a>4. プロジェクトのセットアップ</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>websockets-next</code> エクステンションを使用するには、プロジェクトに <code>io.quarkus:quarkus-websockets-next</code> 依存関係を追加する必要があります。</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-websockets-next&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.quarkus:quarkus-websockets-next")</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="endpoints"><a class="anchor" href="#endpoints"></a>5. Endpoints</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#server-api">サーバー API</a> and <a href="#client-api">クライアント API</a> は両方とも、メッセージを消費および送信するために使用される <em>エンドポイント</em> を定義します。
エンドポイントは CDI Bean として実装され、注入をサポートします。
エンドポイントは、 <code>@OnTextMessage</code>、 <code>@OnBinaryMessage</code>、 <code>@OnPingMessage</code>、 <code>@OnPongMessage</code>、 <code>@OnOpen</code>、 <code>@OnClose</code> および <code>@OnError</code> アノテーションが付けられた <a href="#callback-methods"><em>callback methods</em></a> を宣言します。
これらのメソッドは、さまざまな WebSocket イベントを処理するために使用されます。
通常、接続されたクライアントがサーバーにメッセージを送信するとき、およびサーバーが接続されたクライアントにメッセージを送信するときに、 <code>@OnTextMessage</code> アノテーションが付けられたメソッドが呼び出されます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
クライアント API には、新しい WebSocket 接続を設定および作成するために使用される <a href="#client-connectors">connectors</a> も含まれています。
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="server-endpoints"><a class="anchor" href="#server-endpoints"></a>5.1. サーバーエンドポイント</h3>
<div class="paragraph">
<p>サーバーエンドポイントは、 <code>@io.quarkus.websockets.next.WebSocket</code> アノテーションが付けられたクラスです。
<code>WebSocket#path()</code> の値は、エンドポイントのパスを定義するために使用されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.websockets;

import io.quarkus.websockets.next.WebSocket;
import jakarta.inject.Inject;

@WebSocket(path = "/chat/{username}") <i class="conum" data-value="1"></i><b>(1)</b>
public class ChatWebSocket {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>したがって、クライアントは <code>ws://localhost:8080/chat/your-name</code> を使用して、この Web ソケットエンドポイントに接続できます。
TLS が使用されている場合、URL は <code>wss://localhost:8443/chat/your-name</code> です。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
エンドポイントパスは、 <code>quarkus.http.root-path</code> (デフォルトでは <code>/</code>) によって設定された <a href="http-reference#context-path">root context</a> に対して相対的です。たとえば、 <code>application.properties</code> に <code>quarkus.http.root-path=/api</code> を追加すると、クライアントは <code><a href="http://localhost:8080/api/chat/the-name" class="bare">http://localhost:8080/api/chat/the-name</a></code> を使用してこのエンドポイントに接続できます。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="client-endpoints"><a class="anchor" href="#client-endpoints"></a>5.2. クライアントエンドポイント</h3>
<div class="paragraph">
<p>クライアントエンドポイントは、 <code>@io.quarkus.websockets.next.WebSocketClient</code> アノテーションが付けられたクラスです。
<code>WebSocketClient#path()</code> の値は、このクライアントが接続されるエンドポイントのパスを定義するために使用されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.websockets;

import io.quarkus.websockets.next.WebSocketClient;
import jakarta.inject.Inject;

@WebSocketClient(path = "/chat/{username}") <i class="conum" data-value="1"></i><b>(1)</b>
public class ChatWebSocket {

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
クライアントエンドポイントは、メッセージの受信と送信に使用されます。新しい WebSocket 接続を設定して開くには、<a href="#client-connectors">connectors API</a> が必要です。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="path-parameters"><a class="anchor" href="#path-parameters"></a>5.3. パスパラメーター</h3>
<div class="paragraph">
<p>WebSocket エンドポイントのパスには、パスパラメーターを含めることができます。
構文は JAX-RS リソースの場合と同じです: <code>{parameterName}</code></p>
</div>
<div class="paragraph">
<p>パスパラメーター値には、それぞれ <code>io.quarkus.websockets.next.WebSocketConnection#pathParam(String)</code> メソッドまたは <code>io.quarkus.websockets.next.WebSocketClientConnection#pathParam(String)</code> を使用してアクセスできます。
あるいは、 <code>@io.quarkus.websockets.next.PathParam</code> アノテーションが付与されたエンドポイントコールバックメソッドパラメーターが自動的に注入されます。</p>
</div>
<div class="listingblock">
<div class="title"><code>WebSocketConnection#pathParam(String)</code> の例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject io.quarkus.websockets.next.WebSocketConnection connection;
// ...
String value = connection.pathParam("parameterName");</code></pre>
</div>
</div>
<div class="paragraph">
<p>パスパラメーターの値は常に文字列です。
パス内にパスパラメーターが存在しない場合、 <code>WebSocketConnection#pathParam(String)</code>/<code>WebSocketClientConnection#pathParam(String)</code> メソッドは <code>null</code> を返します。
<code>@PathParam</code> アノテーションが付けられたエンドポイントコールバックメソッドパラメーターがあり、パラメーター名がエンドポイントパスで定義されていない場合、ビルドは失敗します。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
クエリーパラメーターはサポートされていません。ただし、 <code>WebSocketConnection#handshakeRequest().query()</code> を使用してクエリーにアクセスできます。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="cdi-scopes"><a class="anchor" href="#cdi-scopes"></a>5.4. CDI スコープ</h3>
<div class="paragraph">
<p>エンドポイントは CDI Bean として管理されます。
デフォルトでは、 <code>@Singleton</code> スコープが使用されます。
ただし、開発者は特定の要件に合わせて代替スコープを指定できます。</p>
</div>
<div class="paragraph">
<p><code>@Singleton</code> および <code>@ApplicationScoped</code> エンドポイントは、すべての WebSocket 接続間で共有されます。
したがって、実装はステートレスまたはスレッドセーフのいずれかである必要があります。</p>
</div>
<div class="sect3">
<h4 id="session-context"><a class="anchor" href="#session-context"></a>5.4.1. セッションコンテキスト</h4>
<div class="paragraph">
<p>エンドポイントに <code>@SessionScoped</code> アノテーションが付与されている場合、またはエンドポイントが直接的または間接的に <code>@SessionScoped</code> Bean に依存している場合、各 WebSocket 接続は独自の <em>セッションコンテキスト</em> に関連付けられます。
セッションコンテキストは、エンドポイントコールバックの呼び出し中にアクティブになります。
同じ接続内で後続の <a href="#callback-methods">コールバックメソッド</a> が呼び出される場合、同じセッションコンテキストが利用されます。
セッションコンテキストは、接続が閉じられるまで (通常は <code>@OnClose</code> メソッドの実行が完了したとき) アクティブなままになり、接続が閉じられた時点で終了します。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>quarkus.websockets-next.server.activate-session-context</code> 設定プロパティーを <code>always</code> に設定することもできます。この場合、 <code>@SessionScoped</code> Bean が依存関係ツリーに参加しているかどうかに関係なく、セッションコンテキストは常にアクティブ化されます。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><code>@SessionScoped</code> エンドポイント</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import jakarta.enterprise.context.SessionScoped;

@WebSocket(path = "/ws")
@SessionScoped <i class="conum" data-value="1"></i><b>(1)</b>
public class MyWebSocket {

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>このサーバーエンドポイントは共有されず、セッション/接続に限定されます。</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="request-context"><a class="anchor" href="#request-context"></a>5.4.2. リクエストコンテキスト</h4>
<div class="paragraph">
<p>エンドポイントが以下の場合、各 WebSocket エンドポイントコールバックメソッドの実行は、新しい CDI <em>リクエストコンテキスト</em> に関連付けられます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@RequestScoped</code> アノテーションが付けられています。</p>
</li>
<li>
<p><code>@RolesAllowed</code> などのセキュリティーアノテーションが付けられたメソッドがあります。</p>
</li>
<li>
<p><code>@RequestScoped</code> Bean に直接的または間接的に依存します。</p>
</li>
<li>
<p>標準のセキュリティーアノテーションで保護された CDI Bean に直接的または間接的に依存します。</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>quarkus.websockets-next.server.activate-request-context</code> 設定プロパティーを <code>always</code> に設定することもできます。この場合、エンドポイントコールバックが呼び出されると、リクエストコンテキストが常にアクティブ化されます。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><code>@RequestScoped</code> エンドポイント</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import jakarta.enterprise.context.RequestScoped;

@WebSocket(path = "/ws")
@RequestScoped <i class="conum" data-value="1"></i><b>(1)</b>
public class MyWebSocket {

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>このサーバーエンドポイントは、コールバックメソッドの実行ごとにインスタンス化されます。</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="callback-methods"><a class="anchor" href="#callback-methods"></a>5.5. コールバックメソッド</h3>
<div class="paragraph">
<p>WebSocket エンドポイントは以下を宣言できます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>最大 1 つの <code>@OnTextMessage</code> メソッド: 接続されたクライアント/サーバーからのテキストメッセージを処理します。</p>
</li>
<li>
<p>最大 1 つの <code>@OnBinaryMessage</code> メソッド: 接続されたクライアント/サーバーからのバイナリーメッセージを処理します。</p>
</li>
<li>
<p>最大 1 つの <code>@OnPingMessage</code> メソッド: 接続されたクライアント/サーバーからの ping メッセージを処理します。</p>
</li>
<li>
<p>最大 1 つの <code>@OnPongMessage</code> メソッド: 接続されたクライアント/サーバーからの pong メッセージを処理します。</p>
</li>
<li>
<p>最大 1 つの <code>@OnOpen</code> メソッド: 接続が開かれたときに呼び出されます。</p>
</li>
<li>
<p>最大 1 つの <code>@OnClose</code> メソッド: 接続が閉じられたときに実行されます。</p>
</li>
<li>
<p>任意の数の <code>@OnError</code> メソッド: エラーが発生したときに呼び出されます。つまり、エンドポイントコールバックがランタイムエラーをスローしたとき、変換エラーが発生したとき、または返された <code>io.smallrye.mutiny.Uni</code>/<code>io.smallrye.mutiny.Multi</code> が失敗を受け取ったときです。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>一部のエンドポイントのみにすべてのメソッドを含める必要があります。
ただし、少なくとも <code>@On[Text|Binary]Message</code> または <code>@OnOpen</code> が含まれている必要があります。</p>
</div>
<div class="paragraph">
<p>いずれかのエンドポイントがこれらのルールに違反すると、ビルド時にエラーがスローされます。
sub-websocket を表す静的なネストされたクラスは同じガイドラインに従います。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
WebSocket エンドポイントの外部で <code>@OnTextMessage</code>、 <code>@OnBinaryMessage</code>、 <code>@OnOpen</code>、および <code>@OnClose</code> アノテーションが付与されたメソッドはエラーとみなされ、適切なエラーメッセージが表示されてビルドが失敗します。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="processing-messages"><a class="anchor" href="#processing-messages"></a>5.6. メッセージの処理</h3>
<div class="paragraph">
<p>クライアントからメッセージを受信するメソッドには、 <code>@OnTextMessage</code> または <code>@OnBinaryMessage</code> アノテーションが付けられます。</p>
</div>
<div class="paragraph">
<p><code>OnTextMessage</code> は、クライアントから受信されるすべての <em>テキスト</em> メッセージに対して呼び出されます。
<code>OnBinaryMessage</code> は、クライアントが受信するすべての <em>バイナリー</em> メッセージに対して呼び出されます。</p>
</div>
<div class="sect3">
<h4 id="invocation-rules"><a class="anchor" href="#invocation-rules"></a>5.6.1. 呼び出しルール</h4>
<div class="paragraph">
<p>コールバックメソッドを呼び出すと、WebSocket 接続にリンクされた <em>セッション</em> スコープはアクティブなままになります。
さらに、リクエストスコープはメソッドが完了するまで (または非同期メソッドとリアクティブメソッドの場合は結果が生成されるまで) アクティブです。</p>
</div>
<div class="paragraph">
<p>WebSocket Next は、Quarkus REST に似た、メソッドの戻り値のタイプと <code>@Blocking</code> や <code>@NonBlocking</code> などの追加のアノテーションで決定される、<em>ブロッキング</em> と <em>ノンブロッキング</em> ロジックをサポートします。</p>
</div>
<div class="paragraph">
<p>実行に関するルールは次のとおりです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@RunOnVirtualThread</code>、 <code>@Blocking</code>、または <code>@Transactional</code> アノテーションが付与されたメソッドは、ブロッキングとみなされます。</p>
</li>
<li>
<p><code>@RunOnVirtualThread</code> アノテーションが付けられたクラスで宣言されたメソッドは、ブロッキングとみなされます。</p>
</li>
<li>
<p><code>@NonBlocking</code> アノテーションが付けられたメソッドは、ノンブロッキングとみなされます。</p>
</li>
<li>
<p><code>@Transactional</code> アノテーションが付けられたクラスで宣言されたメソッドは、 <code>@NonBlocking</code> アノテーションが付けられていない限り、ブロッキングとみなされます。</p>
</li>
<li>
<p>メソッドが上記のアノテーションのいずれも宣言していない場合、実行モデルは戻り値の型から派生します。</p>
<div class="ulist">
<ul>
<li>
<p><code>Uni</code> および <code>Multi</code> を返すメソッドは、ノンブロッキングとみなされます。</p>
</li>
<li>
<p><code>void</code> またはその他のタイプを返すメソッドは、ブロッキングとみなされます。</p>
</li>
</ul>
</div>
</li>
<li>
<p>Kotlin の <code>suspend</code> 関数は常にノンブロッキングとみなされるため、 <code>@Blocking</code>、 <code>@NonBlocking</code>、 <code>@RunOnVirtualThread</code> アノテーションのいずれかを付与することはできません。
また、 <code>@RunOnVirtualThread</code> アノテーションが付けられたクラス内に含めることもできません。</p>
</li>
<li>
<p>ノンブロッキングメソッドは、接続のイベントループスレッドで実行する必要があります。</p>
</li>
<li>
<p>ブロッキングメソッドは、 <code>@RunOnVirtualThread</code> アノテーションが付けられている場合、または、 <code>@RunOnVirtualThread</code> アノテーションがクラスに付けられている場合を除き、
ワーカースレッド上で実行される必要があります。</p>
</li>
<li>
<p><code>@RunOnVirtualThread</code> アノテーションが付与されたメソッド、または <code>@RunOnVirtualThread</code> アノテーションが付与されたクラスで宣言されたメソッドは、
仮想スレッド上で実行される必要があります。仮想スレッドは、呼び出しのたび新しく生成されます。</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="method-parameters"><a class="anchor" href="#method-parameters"></a>5.6.2. メソッドパラメーター</h4>
<div class="paragraph">
<p>メソッドは、メッセージパラメーターを 1 つのみ受け入れる必要があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>メッセージオブジェクト (任意のタイプ)。</p>
</li>
<li>
<p>メッセージタイプが X の <code>Multi&lt;X&gt;</code>。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ただし、次のパラメーターも受け入れる場合があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>WebSocketConnection</code>/<code>WebSocketClientConnection</code></p>
</li>
<li>
<p><code>HandshakeRequest</code></p>
</li>
<li>
<p><code>@PathParam</code> アノテーションが付けられた <code>String</code> パラメーター</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>メッセージオブジェクトは送信されたデータを表し、raw のコンテンツ (<code>String</code>、 <code>JsonObject</code>、 <code>JsonArray</code>、 <code>Buffer</code>、または <code>byte[]</code>) またはデシリアライズされた高レベルオブジェクトとしてアクセスできます。後者のアプローチが推奨されます。</p>
</div>
<div class="paragraph">
<p><code>Multi</code> を受信すると、メソッドは接続ごとに 1 回呼び出され、提供された <code>Multi</code> はこの接続によって送信された項目を受信します。
メソッドが <code>Multi</code> (受信したものから構築) を返す場合、Quarkus は自動的にそれをサブスクライブし、完了、失敗、またはキャンセルされるまで、発行された項目を書き込みます。
ただし、メソッドが <code>Multi</code> を返さない場合は、データを使用するために受信した <code>Multi</code> をサブスクライブする必要があります。</p>
</div>
<div class="paragraph">
<p>2 つの例があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// No need to subscribe to the incoming Multi as the method returns a Multi derived from the incoming one
@OnTextMessage
public Multi&lt;ChatMessage&gt; stream(Multi&lt;ChatMessage&gt; incoming) {
    return incoming.log();
}

// ...

// Must subscribe to the incoming Multi as the method does not return a Multi, otherwise no data will be consumed
@OnTextMessage
public void stream(Multi&lt;ChatMessage&gt; incoming) {
    incoming.subscribe().with(item -&gt; log(item));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>受信した <code>Multi</code> のサブスクライブに関する詳細は、<a href="#subscribe-or-not-subscribe"><code>Uni</code> または <code>Multi</code> をサブスクライブするタイミング</a> を参照してください。</p>
</div>
</div>
<div class="sect3">
<h4 id="supported-return-types"><a class="anchor" href="#supported-return-types"></a>5.6.3. サポートされている戻り値のタイプ</h4>
<div class="paragraph">
<p><code>@OnTextMessage</code> または <code>@OnBinaryMessage</code> アノテーションが付与されたメソッドは、WebSocket 通信を効率的に処理するためにさまざまなタイプを返すことができます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>void</code>: 明示的なレスポンスがクライアントに返されないブロッキングメソッドを示します。</p>
</li>
<li>
<p><code>Uni&lt;Void&gt;</code>: 返された <code>Uni</code> の完了が処理の終了を意味するノンブロッキングメソッドを示します。明示的なレスポンスはクライアントに返されません。</p>
</li>
<li>
<p><code>X</code> タイプのオブジェクトは、返されたオブジェクトがシリアライズされ、レスポンスとしてクライアントに送り返されるブロッキングメソッドを表します。</p>
</li>
<li>
<p><code>Uni&lt;X&gt;</code>: null 以外の <code>Uni</code> によって発行された項目がレスポンスとしてクライアントに送信されるノンブロッキングメソッドを指定します。</p>
</li>
<li>
<p><code>Multi&lt;X&gt;</code>: null 以外の <code>Multi</code> によって発行された項目が完了またはキャンセルされるまでクライアントに順番に送信されるノンブロッキングメソッドを示します。</p>
</li>
<li>
<p><code>Unit</code> を返す Kotlin の <code>suspend</code> 関数: 明示的なレスポンスがクライアントに返されないノンブロッキングメソッドを示します。</p>
</li>
<li>
<p><code>X</code> を返す Kotlin の <code>suspend</code> 関数: 返された項目がレスポンスとしてクライアントに送信されるノンブロッキングメソッドを指定します。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これらの方法の例をいくつか示します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OnTextMessage
void consume(Message m) {
// Process the incoming message. The method is called on an executor thread for each incoming message.
}

@OnTextMessage
Uni&lt;Void&gt; consumeAsync(Message m) {
// Process the incoming message. The method is called on an event loop thread for each incoming message.
// The method completes when the returned Uni emits its item.
}

@OnTextMessage
ResponseMessage process(Message m) {
// Process the incoming message and send a response to the client.
// The method is called for each incoming message.
// Note that if the method returns `null`, no response will be sent to the client.
}

@OnTextMessage
Uni&lt;ResponseMessage&gt; processAsync(Message m) {
// Process the incoming message and send a response to the client.
// The method is called for each incoming message.
// Note that if the method returns `null`, no response will be sent to the client. The method completes when the returned Uni emits its item.
}

@OnTextMessage
Multi&lt;ResponseMessage&gt; stream(Message m) {
// Process the incoming message and send multiple responses to the client.
// The method is called for each incoming message.
// The method completes when the returned Multi emits its completion signal.
// The method cannot return `null` (but an empty multi if no response must be sent)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Uni</code> および <code>Multi</code> を返すメソッドは、ノンブロッキングとみなされます。
さらに、Quarkus は返された <code>Multi</code>/<code>Uni</code> を自動的にサブスクライブし、完了、失敗、またはキャンセルされるまで、発行された項目を書き込みます。
失敗またはキャンセルにより接続が終了します。</p>
</div>
</div>
<div class="sect3">
<h4 id="streams"><a class="anchor" href="#streams"></a>5.6.4. ストリーム</h4>
<div class="paragraph">
<p>WebSocket エンドポイントは、個々のメッセージに加えて、メッセージのストリームも処理できます。
この場合、メソッドは <code>Multi&lt;X&gt;</code> をパラメーターとして受け取ります。
<code>X</code> の各インスタンスは、上記と同じルールを使用してデシリアライズされます。</p>
</div>
<div class="paragraph">
<p><code>Multi</code> を受け取るメソッドは、別の <code>Multi</code> または <code>void</code> を返すことができます。
メソッドが <code>Multi</code> を返す場合、受信する <code>multi</code> をサブスクライブする必要はありません。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OnTextMessage
public Multi&lt;ChatMessage&gt; stream(Multi&lt;ChatMessage&gt; incoming) {
    return incoming.log();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>このアプローチにより、双方向のストリーミングが可能になります。</p>
</div>
<div class="paragraph">
<p>メソッドが <code>void</code> を返し、 <code>Multi</code> を返さない場合、コードは受信する <code>Multi</code> をサブスクライブする必要があります。
そうしないと、データが消費されず、接続が閉じられません。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OnTextMessage
public void stream(Multi&lt;ChatMessage&gt; incoming) {
    incoming.subscribe().with(item -&gt; log(item));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>また、 <code>stream</code> メソッドは <code>Multi</code> が完了する前に完了することに注意してください。</p>
</div>
<div class="paragraph">
<p>受信した <code>Multi</code> のサブスクライブに関する詳細は、<a href="#subscribe-or-not-subscribe"><code>Uni</code> または <code>Multi</code> をサブスクライブするタイミング</a> を参照してください。</p>
</div>
</div>
<div class="sect3">
<h4 id="skipping-reply"><a class="anchor" href="#skipping-reply"></a>5.6.5. 返信をスキップする</h4>
<div class="paragraph">
<p>メソッドがクライアントに書き込まれるメッセージを生成することを意図している場合、 <code>null</code> を発行できます。
<code>null</code> を発行すると、クライアントにレスポンスが送信されないことを意味し、必要なときにレスポンスをスキップできるようになります。</p>
</div>
</div>
<div class="sect3">
<h4 id="jsonobject-and-jsonarray"><a class="anchor" href="#jsonobject-and-jsonarray"></a>5.6.6. JsonObject および JsonArray</h4>
<div class="paragraph">
<p>Vert.x の <code>JsonObject</code> および <code>JsonArray</code> インスタンスは、シリアライゼーションおよびデシリアライゼーションのメカニズムをバイパスします。
メッセージはテキストメッセージとして送信されます。</p>
</div>
</div>
<div class="sect3">
<h4 id="onopen-and-onclose-methods"><a class="anchor" href="#onopen-and-onclose-methods"></a>5.6.7. OnOpen および OnClose メソッド</h4>
<div class="paragraph">
<p>クライアントが接続または切断したときに、WebSocket エンドポイントに通知することもできます。</p>
</div>
<div class="paragraph">
<p>これは、メソッドに <code>@OnOpen</code> または <code>@OnClose</code> アノテーションを付けることで行われます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OnOpen(broadcast = true)
public ChatMessage onOpen() {
    return new ChatMessage(MessageType.USER_JOINED, connection.pathParam("username"), null);
}

@Inject WebSocketConnection connection;

@OnClose
public void onClose() {
    ChatMessage departure = new ChatMessage(MessageType.USER_LEFT, connection.pathParam("username"), null);
    connection.broadcast().sendTextAndAwait(departure);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@OnOpen</code> はクライアント接続時にトリガーされ、 <code>@OnClose</code> は切断時に呼び出されます。</p>
</div>
<div class="paragraph">
<p>これらのメソッドは、<em>セッションスコープ</em> の <code>WebSocketConnection</code> Bean にアクセスできます。</p>
</div>
</div>
<div class="sect3">
<h4 id="parameters"><a class="anchor" href="#parameters"></a>5.6.8. パラメーター</h4>
<div class="paragraph">
<p><code>@OnOpen</code> および <code>@OnClose</code> アノテーションが付けられたメソッドは、次のパラメーターを受け入れることができます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>WebSocketConnection</code>/<code>WebSocketClientConnection</code></p>
</li>
<li>
<p><code>HandshakeRequest</code></p>
</li>
<li>
<p><code>@PathParam</code> アノテーションが付けられた <code>String</code> パラメーター</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>@OnClose</code> アノテーションが付与されたエンドポイントメソッドは、接続を閉じる理由を示す <code>io.quarkus.websockets.next.CloseReason</code> パラメーターも受け入れる場合があります。</p>
</div>
</div>
<div class="sect3">
<h4 id="supported-return-types-2"><a class="anchor" href="#supported-return-types-2"></a>5.6.9. サポートされている戻り値のタイプ</h4>
<div class="paragraph">
<p><code>@OnOpen</code> メソッドと <code>@OnClose</code> メソッドは、異なる戻り値のタイプをサポートします。</p>
</div>
<div class="paragraph">
<p><code>@OnOpen</code> メソッドには、 <code>@On[Text|Binary]Message</code> と同じルールが適用されます。
したがって、 <code>@OnOpen</code> アノテーションが付与されたメソッドは、接続後すぐにクライアントにメッセージを送信できます。
<code>@OnOpen</code> メソッドでサポートされている戻り値のタイプは次のとおりです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>void</code>: 接続されたクライアントに明示的なメッセージが返されないブロッキングメソッドを示します。</p>
</li>
<li>
<p><code>Uni&lt;Void&gt;</code>: 返された <code>Uni</code> の完了が処理の終了を意味するノンブロッキングメソッドを示します。クライアントにメッセージは返されません。</p>
</li>
<li>
<p><code>X</code> タイプのオブジェクト: 返されたオブジェクトがシリアライズされてクライアントに送り返されるブロッキングメソッドを表します。</p>
</li>
<li>
<p><code>Uni&lt;X&gt;</code>: null 以外の <code>Uni</code> によって発行された項目がクライアントに送信されるノンブロッキングメソッドを指定します。</p>
</li>
<li>
<p><code>Multi&lt;X&gt;</code>: null 以外の <code>Multi</code> によって発行された項目が完了またはキャンセルされるまでクライアントに順番に送信されるノンブロッキングメソッドを示します。</p>
</li>
<li>
<p><code>Unit</code> を返す Kotlin の <code>suspend</code> 関数: 明示的なメッセージがクライアントに返されないノンブロッキングメソッドを示します。</p>
</li>
<li>
<p><code>X</code> を返す Kotlin の <code>suspend</code> 関数: 返された項目がクライアントに送信されるノンブロッキングメソッドを指定します。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>クライアントに送信される項目は、 <code>String</code>、 <code>io.vertx.core.json.JsonObject</code>、 <code>io.vertx.core.json.JsonArray</code>、 <code>io.vertx.core.buffer.Buffer</code>、および <code>byte[]</code> タイプを除いて、<a href="#serialization">シリアライズ</a> されます。
<code>Multi</code> の場合、Quarkus は返された <code>Multi</code> をサブスクライブし、項目が発行されると <code>WebSocket</code> に書き込みます。
<code>String</code>、 <code>JsonObject</code>、 <code>JsonArray</code> はテキストメッセージとして送信されます。
<code>Buffers</code> とバイト配列はバイナリーメッセージとして送信されます。</p>
</div>
<div class="paragraph">
<p><code>@OnClose</code> メソッドの場合、サポートされる戻り値のタイプは次のとおりです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>void</code>: メソッドはブロッキングであるとみなされます。</p>
</li>
<li>
<p><code>Uni&lt;Void&gt;</code>: メソッドはノンブロッキングであるとみなされます。</p>
</li>
<li>
<p><code>Unit</code> を返す Kotlin の <code>suspend</code> 関数: このメソッドはノンブロッキングとみなされます。</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
サーバーエンドポイントで宣言された <code>@OnClose</code> メソッドは、オブジェクトを返すことによって接続されたクライアントに項目を送信できません。
<code>WebSocketConnection</code> オブジェクトを使用してのみ、他のクライアントにメッセージを送信できます。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="error-handling"><a class="anchor" href="#error-handling"></a>5.7. エラー処理</h3>
<div class="paragraph">
<p>エラーが発生したときに WebSocket エンドポイントに通知することもできます。
<code>@io.quarkus.websockets.next.OnError</code> アノテーションが付与された WebSocket エンドポイントメソッドは、エンドポイントコールバックがランタイムエラーをスローしたとき、または変換エラーが発生したとき、
あるいは返された <code>io.smallrye.mutiny.Uni</code>/<code>io.smallrye.mutiny.Multi</code> が失敗した場合に呼び出されます。</p>
</div>
<div class="paragraph">
<p>メソッドは、<em>error</em> パラメーター、つまり <code>java.lang.Throwable</code> から割り当て可能なパラメーターを 1 つだけ受け入れる必要があります。
このメソッドは次のパラメーターも受け入れます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>WebSocketConnection</code>/<code>WebSocketClientConnection</code></p>
</li>
<li>
<p><code>HandshakeRequest</code></p>
</li>
<li>
<p><code>@PathParam</code> アノテーションが付けられた <code>String</code> パラメーター</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>エンドポイントは、 <code>@io.quarkus.websockets.next.OnError</code> アノテーションが付与された複数のメソッドを宣言できます。
ただし、各メソッドは異なるエラーパラメーターを宣言する必要があります。
実際の例外の最も具体的なスーパータイプを宣言するメソッドが選択されます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>@io.quarkus.websockets.next.OnError</code> アノテーションは、グローバルエラーハンドラー、つまり WebSocket エンドポイントで宣言されていないメソッドを宣言するためにも使用できます。このようなメソッドは、 <code>@PathParam</code> パラメーターを受け入れない場合があります。エンドポイントで宣言されたエラーハンドラーは、グローバルエラーハンドラーよりも優先されます。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>エラーが発生しても、エラーハンドラーが失敗を処理できない場合、Quarkus は <code>quarkus.websockets-next.server.unhandled-failure-strategy</code> で指定されたストラテジーを使用します。
サーバーエンドポイントの場合、エラーメッセージがログに記録され、接続はデフォルトで閉じられます。
クライアントエンドポイントの場合、エラーメッセージはデフォルトでログに記録されます。</p>
</div>
</div>
<div class="sect2">
<h3 id="serialization"><a class="anchor" href="#serialization"></a>5.8. シリアライズとデシリアライズ</h3>
<div class="paragraph">
<p>WebSocket Next エクステンションは、メッセージの自動シリアライゼーションとデシリアライゼーションをサポートします。</p>
</div>
<div class="paragraph">
<p><code>String</code>、 <code>JsonObject</code>、 <code>JsonArray</code>、 <code>Buffer</code>、および <code>byte[]</code> タイプのオブジェクトはそのまま送信され、シリアライゼーションとデシリアライゼーションをバイパスします。
コーデックが指定されていない場合、シリアライゼーションとデシリアライゼーションによってメッセージは JSON から、または JSON に自動的に変換されます。</p>
</div>
<div class="paragraph">
<p>シリアライゼーションとデシリアライゼーションをカスタマイズする必要がある場合は、カスタムコーデックを提供できます。</p>
</div>
<div class="sect3">
<h4 id="custom-codec"><a class="anchor" href="#custom-codec"></a>5.8.1. カスタムコーデック</h4>
<div class="paragraph">
<p>カスタムコーデックを実装するには、以下を実装する CDI Bean を提供する必要があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>バイナリーメッセージ用の <code>io.quarkus.websockets.next.BinaryMessageCodec</code></p>
</li>
<li>
<p>テキストメッセージの <code>io.quarkus.websockets.next.TextMessageCodec</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>次の例は、 <code>Item</code> クラスのカスタムコーデックを実装する方法を示しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Singleton
public class ItemBinaryMessageCodec implements BinaryMessageCodec&lt;Item&gt; {

    @Override
    public boolean supports(Type type) {
        // Allows selecting the right codec for the right type
        return type.equals(Item.class);
    }

    @Override
    public Buffer encode(Item value) {
        // Serialization
        return Buffer.buffer(value.toString());
    }

    @Override
    public Item decode(Type type, Buffer value) {
        // Deserialization
        return new Item(value.toString());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>OnTextMessage</code> メソッドと <code>OnBinaryMessage</code> メソッドでは、どのコーデックを使用するかを明示的に指定することもできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OnTextMessage(codec = MyInputCodec.class) <i class="conum" data-value="1"></i><b>(1)</b>
Item find(Item item) {
        //....
}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>メッセージのデシリアライゼーションとシリアライゼーションの両方に使用するコーデックを指定します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>シリアライゼーションとデシリアライゼーションで異なるコーデックを使用する必要がある場合は、シリアライゼーションとデシリアライゼーションに使用するコーデックを個別に指定できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OnTextMessage(
        codec = MyInputCodec.class, <i class="conum" data-value="1"></i><b>(1)</b>
        outputCodec = MyOutputCodec.class <i class="conum" data-value="2"></i><b>(2)</b>
Item find(Item item) {
        //....
}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>受信メッセージのデシリアライズに使用するコーデックを指定します</p>
</li>
<li>
<p>送信メッセージのシリアライゼーションに使用するコーデックを指定します。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pingpong-messages"><a class="anchor" href="#pingpong-messages"></a>5.9. Ping/Pong メッセージ</h3>
<div class="paragraph">
<p><a href="https://datatracker.ietf.org/doc/html/rfc6455#section-5.5.2">ping メッセージ</a> は、キープアライブとして、またはリモートエンドポイントを確認するために使用できます。
<a href="https://datatracker.ietf.org/doc/html/rfc6455#section-5.5.3">pong メッセージ</a> は、ping メッセージへのレスポンスとして送信され、同一のペイロードを持つ必要があります。</p>
</div>
<div class="sect3">
<h4 id="sending-ping-messages"><a class="anchor" href="#sending-ping-messages"></a>5.9.1. ping メッセージの送信</h4>
<div class="paragraph">
<p>ping メッセージはオプションであり、デフォルトでは送信されません。ただし、サーバーおよびクライアントのエンドポイントは、一定の間隔で ping メッセージを自動的に送信するように設定できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.websockets-next.server.auto-ping-interval=2 <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.websockets-next.client.auto-ping-interval=10 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>サーバーから接続された各クライアントに 2 秒ごとに ping メッセージを送信します。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>接続されているすべてのクライアントインスタンスからリモートサーバーに 10 秒ごとに ping メッセージを送信します。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>サーバーとクライアントは、 <code>WebSocketConnection</code> または <code>WebSocketClientConnection</code> を使用して、いつでもプログラムで ping メッセージを送信できます。
ノンブロッキングバリアント (<code>Sender#sendPing(Buffer)</code>) とブロッキングバリアント (<code>Sender#sendPingAndAwait(Buffer)</code>) があります。</p>
</div>
</div>
<div class="sect3">
<h4 id="sending-pong-messages"><a class="anchor" href="#sending-pong-messages"></a>5.9.2. pong メッセージの送信</h4>
<div class="paragraph">
<p>サーバーおよびクライアントのエンドポイントは、ping メッセージのアプリケーションデータを使用して、リモート側から送信された ping メッセージに対し、常に対応する pong メッセージでレスポンスします。
この動作は組み込まれており、追加のコードや設定は必要ありません。</p>
</div>
<div class="paragraph">
<p>サーバーとクライアントは、 <code>WebSocketConnection</code> または <code>WebSocketClientConnection</code> を使用して、一方向のハートビートとして機能する可能性のある非要求 pong メッセージを送信できます。ノンブロッキングバリアント (<code>Sender#sendPong(Buffer)</code>) とブロッキングバリアント (<code>Sender#sendPongAndAwait(Buffer)</code>) があります。</p>
</div>
</div>
<div class="sect3">
<h4 id="handling-pingpong-messages"><a class="anchor" href="#handling-pingpong-messages"></a>5.9.3. ping/pong メッセージの処理</h4>
<div class="paragraph">
<p>ping メッセージは自動的に処理され、pong メッセージはレスポンスを必要としないため、WebSocket プロトコルに準拠するためにこれらのメッセージのハンドラーを記述する必要はありません。
ただし、エンドポイントで ping または pong メッセージがいつ受信されたかを知ることが役立つ場合があります。</p>
</div>
<div class="paragraph">
<p><code>@OnPingMessage</code> および <code>@OnPongMessage</code> アノテーションを使用して、リモート側から送信された ping または pong メッセージを使用するコールバックを定義できます。
エンドポイントは、最大 1 つの <code>@OnPingMessage</code> コールバックと最大 1 つの <code>@OnPongMessage</code> コールバックを宣言できます。
コールバックメソッドは、 <code>void</code> または <code>Uni&lt;Void&gt;</code> を返す必要 (または <code>Unit</code> を返す Kotlin の <code>suspend</code> 関数である必要) があり、 <code>Buffer</code> タイプの単一のパラメーターを受け入れる必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OnPingMessage
void ping(Buffer data) {
    // an incoming ping that will automatically receive a pong
}

@OnPongMessage
void pong(Buffer data) {
    // an incoming pong in response to the last ping sent
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="inbound-processing-mode"><a class="anchor" href="#inbound-processing-mode"></a>5.10. 受信処理モード</h3>
<div class="paragraph">
<p>WebSocket エンドポイントは、それぞれ <code>@WebSocket#inboundProcessingMode()</code> と <code>@WebSocketClient.inboundProcessingMode()</code> を使用して、特定の接続の受信イベントを処理するために使用されるモードを定義できます。
受信イベントは、メッセージ (テキスト、バイナリー、pong)、接続の開始、接続の終了を表すことができます。
デフォルトでは、イベントは順番に処理され、順序が保証されます。
つまり、エンドポイントがイベント <code>A</code> と <code>B</code> を (この特定の順序で) 受信した場合、イベント <code>A</code> のコールバックが完了した後にイベント <code>B</code> のコールバックが呼び出されます。
ただし、状況によっては、順序の保証はなく、同時実行の制限もない状態でイベントを同時に処理することが望ましい場合があります。
このような場合には、 <code>InboundProcessingMode#CONCURRENT</code> を使用する必要があります。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="server-api"><a class="anchor" href="#server-api"></a>6. サーバー API</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="http-server-configuration"><a class="anchor" href="#http-server-configuration"></a>6.1. HTTP サーバーの設定</h3>
<div class="paragraph">
<p>このエクステンションは、<em>メイン</em> の HTTP サーバーを再利用します。</p>
</div>
<div class="paragraph">
<p>したがって、WebSocket サーバーの設定は <code>quarkus.http.</code> 設定セクションで行われます。</p>
</div>
<div class="paragraph">
<p>アプリケーション内で設定された WebSocket パスは、 <code>quarkus.http.root</code> (デフォルトは <code>/</code>) で定義されたルートパスと連結されます。
この連結により、WebSocket エンドポイントがアプリケーションの URL 構造内に適切に配置されるようになります。</p>
</div>
<div class="paragraph">
<p>詳細は、<a href="http-reference">HTTP ガイド</a> を参照してください。</p>
</div>
</div>
<div class="sect2">
<h3 id="sub-websockets-endpoints"><a class="anchor" href="#sub-websockets-endpoints"></a>6.2. sub-websocket エンドポイント</h3>
<div class="paragraph">
<p><code>@WebSocket</code> エンドポイントは、静的なネストされたクラスをカプセル化できます。これらのクラスも <code>@WebSocket</code> アノテーションが付与され、<em>sub-websocket</em> を表します。
これらの sub-websocket のパスは、外側のクラスとネストされたクラスからのパスを連結したものになります。
この結果得られるパスは、HTTP URL の規則に従って正規化されます。</p>
</div>
<div class="paragraph">
<p>sub-websocket は、外側のクラスとネストされたクラスの両方の <code>@WebSocket</code> アノテーションで宣言されたパスパラメーターへのアクセスを継承します。
次の例では、外側のクラス内の <code>consumePrimary</code> メソッドは <code>version</code> パラメーターにアクセスできます。
一方、ネストされたクラス内の <code>consumeNested</code> メソッドは、 <code>version</code> パラメーターと <code>id</code> パラメーターの両方にアクセスできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@WebSocket(path = "/ws/v{version}")
public class MyPrimaryWebSocket {

    @OnTextMessage
    void consumePrimary(String s)    { ... }

    @WebSocket(path = "/products/{id}")
    public static class MyNestedWebSocket {

      @OnTextMessage
      void consumeNested(String s)    { ... }

    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ws-connection"><a class="anchor" href="#ws-connection"></a>6.3. WebSocket 接続</h3>
<div class="paragraph">
<p><code>io.quarkus.websockets.next.WebSocketConnection</code> オブジェクトは WebSocket 接続を表します。
Quarkus は、このインターフェイスを実装し、 <code>WebSocket</code> エンドポイントに注入して、接続されたクライアントと対話するために使用できる <code>@SessionScoped</code> CDI Bean を提供します。</p>
</div>
<div class="paragraph">
<p><code>@OnOpen</code>、 <code>@OnTextMessage</code>、 <code>@OnBinaryMessage</code>、および <code>@OnClose</code> アノテーションが付与されたメソッドは、注入された <code>WebSocketConnection</code> オブジェクトにアクセスできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject WebSocketConnection connection;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
これらのメソッド以外では、 <code>WebSocketConnection</code> オブジェクトは利用できないことに注意してください。ただし、<a href="#list-open-connections">開いているすべての接続をリスト表示</a> できます.。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>接続を使用して、クライアントにメッセージを送信したり、パスパラメーターにアクセスしたり、接続されているすべてのクライアントにメッセージをブロードキャストしたりできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Send a message:
connection.sendTextAndAwait("Hello!");

// Broadcast messages:
connection.broadcast().sendTextAndAwait(departure);

// Access path parameters:
String param = connection.pathParam("foo");</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>WebSocketConnection</code> は、メッセージを送信するためのブロッキングメソッドとノンブロッキングメソッドの両方のバリアントを提供します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sendTextAndAwait(String message)</code>: テキストメッセージをクライアントに送信し、メッセージが送信されるのを待ちます。これはブロッキングであり、エグゼキュータースレッドからのみ呼び出す必要があります。</p>
</li>
<li>
<p><code>sendText(String message)</code>: テキストメッセージをクライアントに送信します。 <code>Uni</code> を返します。これはノンブロッキングです。メッセージを送信するには、返された <code>Uni</code> をユーザーまたは Quarkus がサブスクライブしていることを確認してください。
Quarkus によって呼び出されたメソッド (Quarkus REST、Quarkus WebSocket Next、Quarkus Messaging など) から <code>Uni</code> を返すと、それをサブスクライブしてメッセージを送信します。
以下に例を示します。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@POST
public Uni&lt;Void&gt; send() {
    return connection.sendText("Hello!"); // Quarkus automatically subscribes to the returned Uni and sends the message.
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Uni</code> への登録に関する詳細は、<a href="#subscribe-or-not-subscribe"><code>Uni</code> または <code>Multi</code> をサブスクライブするタイミング</a> を参照してください。</p>
</div>
<div class="sect3">
<h4 id="list-open-connections"><a class="anchor" href="#list-open-connections"></a>6.3.1. 開いている接続をリスト表示する</h4>
<div class="paragraph">
<p>開いているすべての接続をリスト表示することもできます。
Quarkus は、接続にアクセスするための便利なメソッドを宣言する <code>io.quarkus.websockets.next.OpenConnections</code> タイプの CDI Bean を提供します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.logging.Log;
import io.quarkus.websockets.next.OpenConnections;

class MyBean {

  @Inject
  OpenConnections connections;

  void logAllOpenConnections() {
     Log.infof("Open connections: %s", connections.listAll()); <i class="conum" data-value="1"></i><b>(1)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>OpenConnections#listAll()</code> は、指定された時点で開いているすべての接続のイミュータブルなスナップショットを返します。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>他にも便利な方法があります。
たとえば、 <code>OpenConnections#findByEndpointId(String)</code> を使用すると、特定のエンドポイントの接続を簡単に見つけることができます。</p>
</div>
</div>
<div class="sect3">
<h4 id="user-data"><a class="anchor" href="#user-data"></a>6.3.2. ユーザーデータ</h4>
<div class="paragraph">
<p>任意のユーザーデータを特定の接続に関連付けることも可能です。
<code>WebSocketConnection#userData()</code> メソッドによって取得される <code>io.quarkus.websockets.next.UserData</code> オブジェクトは、接続に関連付けられたミュータブルなユーザーデータを表します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.websockets.next.WebSocketConnection;
import io.quarkus.websockets.next.UserData.TypedKey;

@WebSocket(path = "/endpoint/{username}")
class MyEndpoint {

  @Inject
  CoolService service;

  @OnOpen
  void open(WebSocketConnection connection) {
     connection.userData().put(TypedKey.forBoolean("isCool"), service.isCool(connection.pathParam("username"))); <i class="conum" data-value="1"></i><b>(1)</b>
  }

  @OnTextMessage
  String process(String message) {
     if (connection.userData().get(TypedKey.forBoolean("isCool"))) { <i class="conum" data-value="2"></i><b>(2)</b>
        return "Cool message processed!";
     } else {
        return "Message processed!";
     }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>CoolService#isCool()</code> は、現在の接続に関連付けられている <code>Boolean</code> を返します。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>TypedKey.forBoolean("isCool")</code> は、接続の作成時に保存されたデータを取得するために使用されるキーです。</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="server-cdi-events"><a class="anchor" href="#server-cdi-events"></a>6.3.3. CDI イベント</h4>
<div class="paragraph">
<p>Quarkus は、新しい接続が開かれると、修飾子 <code>@io.quarkus.websockets.next.Open</code> を持つ <code>io.quarkus.websockets.next.WebSocketConnection</code> タイプの CDI イベントを非同期的に起動します。
さらに、接続が閉じられると、修飾子 <code>@io.quarkus.websockets.next.Closed</code> を持つ <code>WebSocketConnection</code> タイプの CDI イベントが非同期的に起動します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import jakarta.enterprise.event.ObservesAsync;
import io.quarkus.websockets.next.Open;
import io.quarkus.websockets.next.WebSocketConnection;

class MyBean {

  void connectionOpened(@ObservesAsync @Open WebSocketConnection connection) { <i class="conum" data-value="1"></i><b>(1)</b>
     // This observer method is called when a connection is opened...
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>非同期オブザーバーメソッドは、デフォルトのブロッキングエグゼキューターサービスを使用して実行されます。</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="websocket-next-security"><a class="anchor" href="#websocket-next-security"></a>6.4. セキュリティー</h3>
<div class="paragraph">
<p>セキュリティー機能は、Quarkus Security エクステンションによって提供されます。
任意の <a href="security-identity-providers">アイデンティティープロバイダー</a> を使用して、最初の HTTP リクエストの認証情報を <code>SecurityIdentity</code> インスタンスに変換できます。
次に、 <code>SecurityIdentity</code> が Websocket 接続に関連付けられます。
認可オプションについては、次のセクションで説明します。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
OpenID Connect エクステンション (<code>quarkus-oidc</code>) が使用され、トークンの有効期限が切れると、Quarkus は自動的に接続を閉じます。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="secure-http-upgrade"><a class="anchor" href="#secure-http-upgrade"></a>6.4.1. セキュア HTTP アップグレード</h4>
<div class="paragraph">
<p>標準のセキュリティーアノテーションがエンドポイントクラスに配置されるか、HTTP セキュリティーポリシーが定義されている場合、HTTP アップグレードは保護されます。
HTTP アップグレードをセキュリティーで保護する利点は、処理が少なくなり、認可が早期に 1 回だけ実行されることです。
エラー時にアクションを実行する必要がある場合 (<a href="#secure-callback-methods">セキュアな WebSocket エンドポイントコールバックメソッド</a> 参照) や、ペイロードに基づいてセキュリティチェックを行う必要がある場合 (<a href="#secure-endpoints-with-permission-checkers">権限チェッカーでサーバーのエンドポイントを保護する</a> を参照) を除き、常に HTTP アップグレードセキュリティーを優先する必要があります。</p>
</div>
<div class="listingblock">
<div class="title">標準のセキュリティーアノテーションを使用して HTTP アップグレードを保護する</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkus.websockets.next.test.security;

import io.quarkus.security.Authenticated;
import jakarta.inject.Inject;

import io.quarkus.security.identity.SecurityIdentity;
import io.quarkus.websockets.next.OnOpen;
import io.quarkus.websockets.next.OnTextMessage;
import io.quarkus.websockets.next.WebSocket;

@Authenticated <i class="conum" data-value="1"></i><b>(1)</b>
@WebSocket(path = "/end")
public class Endpoint {

    @Inject
    SecurityIdentity currentIdentity;

    @OnOpen
    String open() {
        return "ready";
    }

    @OnTextMessage
    String echo(String message) {
        return message;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>匿名ユーザーの場合、最初の HTTP ハンドシェイクは 401 ステータスで終了します。
<code>quarkus.websockets-next.server.security.auth-failure-redirect-url</code> 設定プロパティーを使用して、認可失敗時にハンドシェイクリクエストをリダイレクトすることもできます。</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
HTTP アップグレードは、エンドポイントクラスで <code>@WebSocket</code> アノテーションの隣でセキュリティーアノテーションが宣言されている場合にのみ保護されます。
エンドポイント Bean にセキュリティーアノテーションを配置しても、Bean メソッドは保護されず、HTTP アップグレードのみが保護されます。
エンドポイントが意図したとおりに保護されていることを常に確認する必要があります。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">HTTP セキュリティーポリシーを使用して HTTP アップグレードを保護する</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.permission.http-upgrade.paths=/end
quarkus.http.auth.permission.http-upgrade.policy=authenticated</code></pre>
</div>
</div>
<div class="paragraph">
<p>認証時に使用されるセキュリティアノテーションはエンドポイントクラスにも配置する必要があります。 <code>SecurityIdentity</code> はウェブソケット接続がオープンされる前に作成されます。</p>
</div>
<div class="listingblock">
<div class="title">ベアラートークン認証メカニズムの選択</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkus.websockets.next.test.security;

import io.quarkus.oidc.BearerTokenAuthentication;
import io.quarkus.websockets.next.OnTextMessage;
import io.quarkus.websockets.next.WebSocket;

@BearerTokenAuthentication <i class="conum" data-value="1"></i><b>(1)</b>
@WebSocket(path = "/end")
public class Endpoint {

    @OnTextMessage
    String echo(String message) {
        return message;
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ベアラートークン認証を使用して、WebSocket ハンドシェイク要求が認証される必要があります。アノテーションを使用した認証メカニズムの選択に関する詳細については、 <a href="security-authentication-mechanisms#use-annotations-for-path-based-auth">Quarkusの認証メカニズム</a> を参照してください。</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.http.auth.proactive=false <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>io.quarkus.oidc.BearerTokenAuthentication</code> アノテーションが検出された場合にのみ、WebSocket ハンドシェイク リクエストの認証を開始します。</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="secure-callback-methods"><a class="anchor" href="#secure-callback-methods"></a>6.4.2. セキュアな WebSocket エンドポイントコールバックメソッド</h4>
<div class="paragraph">
<p>WebSocket エンドポイントのコールバックメソッドは、 <code>io.quarkus.security.Authenticated</code> や 
<code>jakarta.annotation.security.RolesAllowed</code> などのセキュリティーアノテーション、および <a href="security-authorize-web-endpoints-reference#standard-security-annotations">サポート対象セキュリティーアノテーション</a> ドキュメントに記載されているその他のアノテーションを使用して保護できます。</p>
</div>
<div class="paragraph">
<p>例えば、以下のようになります:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkus.websockets.next.test.security;

import jakarta.annotation.security.RolesAllowed;
import jakarta.inject.Inject;

import io.quarkus.security.ForbiddenException;
import io.quarkus.security.identity.SecurityIdentity;
import io.quarkus.websockets.next.OnError;
import io.quarkus.websockets.next.OnOpen;
import io.quarkus.websockets.next.OnTextMessage;
import io.quarkus.websockets.next.WebSocket;

@WebSocket(path = "/end")
public class Endpoint {

    @Inject
    SecurityIdentity currentIdentity;

    @OnOpen
    String open() {
        return "ready";
    }

    @RolesAllowed("admin")
    @OnTextMessage
    String echo(String message) { <i class="conum" data-value="1"></i><b>(1)</b>
        return message;
    }

    @OnError
    String error(ForbiddenException t) { <i class="conum" data-value="2"></i><b>(2)</b>
        return "forbidden:" + currentIdentity.getPrincipal().getName();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>エコーコールバックメソッドは、現在のセキュリティーアイデンティティーに <code>admin</code> ロールがある場合にのみ呼び出すことができます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>認可に失敗した場合はエラーハンドラーが呼び出されます。</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="secure-endpoints-with-permission-checkers"><a class="anchor" href="#secure-endpoints-with-permission-checkers"></a>6.4.3. 権限チェッカーでサーバーのエンドポイントを保護する</h4>
<div class="paragraph">
<p>WebSocket エンドポイントは、<a href="security-authorize-web-endpoints-reference#permission-checker">パーミッションチェッカー</a> を使用して保護できます。
個々のエンドポイントメソッドではなく、<a href="#secure-http-upgrade">セキュア HTTP アップグレード</a> を推奨します。以下に例を示します。</p>
</div>
<div class="listingblock">
<div class="title">セキュアな HTTP アップグレードを備えた WebSocket エンドポイントの例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkus.websockets.next.test.security;

import io.quarkus.security.PermissionsAllowed;
import io.quarkus.websockets.next.OnTextMessage;
import io.quarkus.websockets.next.WebSocket;

@PermissionsAllowed("product:premium")
@WebSocket(path = "/product/premium")
public class PremiumProductEndpoint {

    @OnTextMessage
    PremiumProduct getPremiumProduct(int productId) {
        return new PremiumProduct(productId);
    }

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">HTTP アップグレードを承認する権限チェッカーの例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkus.websockets.next.test.security;

import io.quarkus.security.identity.SecurityIdentity;
import io.quarkus.security.PermissionChecker;
import io.quarkus.vertx.http.runtime.security.HttpSecurityUtils;
import io.vertx.ext.web.RoutingContext;
import jakarta.enterprise.context.ApplicationScoped;

@ApplicationScoped
public class PermissionChecker {

    @PermissionChecker("product:premium")
    public boolean canGetPremiumProduct(SecurityIdentity securityIdentity) { <i class="conum" data-value="1"></i><b>(1)</b>
        String username = securityIdentity.getPrincipal().getName();

        RoutingContext routingContext = HttpSecurityUtils.getRoutingContextAttribute(securityIdentity);
        String initialHttpUpgradePath = routingContext == null ? null : routingContext.normalizedPath();
        if (!isUserAllowedToAccessPath(initialHttpUpgradePath, username)) {
            return false;
        }

        return isPremiumCustomer(username);
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>HTTP アップグレードを承認する権限チェッカーは、メソッドパラメーター <code>SecurityIdentity</code> を 1 つだけ宣言する必要があります。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>すべてのメッセージに対してセキュリティーチェックを実行することもできます。たとえば、メッセージペイロードには次のようにアクセスできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkus.websockets.next.test.security;

import io.quarkus.security.PermissionChecker;
import io.quarkus.security.PermissionsAllowed;
import jakarta.inject.Inject;

import io.quarkus.security.ForbiddenException;
import io.quarkus.security.identity.SecurityIdentity;
import io.quarkus.websockets.next.OnError;
import io.quarkus.websockets.next.OnOpen;
import io.quarkus.websockets.next.OnTextMessage;
import io.quarkus.websockets.next.WebSocket;

@WebSocket(path = "/product")
public class ProductEndpoint {

    private record Product(int id, String name) {}

    @Inject
    SecurityIdentity currentIdentity;

    @PermissionsAllowed("product:get")
    @OnTextMessage
    Product getProduct(int productId) { <i class="conum" data-value="1"></i><b>(1)</b>
        return new Product(productId, "Product " + productId);
    }

    @OnError
    String error(ForbiddenException t) { <i class="conum" data-value="2"></i><b>(2)</b>
        return "forbidden:" + currentIdentity.getPrincipal().getName();
    }

    @PermissionChecker("product:get")
    boolean canGetProduct(int productId) {
        String username = currentIdentity.getPrincipal().getName();
        return currentIdentity.hasRole("admin") || canUserGetProduct(productId, username);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>getProduct</code> コールバックメソッドは、現在のセキュリティーアイデンティティーに <code>admin</code> ロールがある場合、またはユーザーが製品の詳細を取得することを許可されている場合にのみ、呼び出すことができます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>認可に失敗した場合はエラーハンドラーが呼び出されます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>More information about permission checkers can be found on the JavaDoc of <a href="https://javadoc.io/doc/io.quarkus.security/quarkus-security/latest/io.quarkus.security.api/io/quarkus/security/PermissionChecker.html"><code>@PermissionChecker</code></a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="bearer-token-authentication"><a class="anchor" href="#bearer-token-authentication"></a>6.4.4. ベアラートークン認証</h4>
<div class="paragraph">
<p><a href="security-oidc-bearer-token-authentication">OIDC ベアラートークン認証</a> では、最初の HTTP ハンドシェイク中にベアラートークンが <code>Authorization</code> ヘッダーで渡されることを期待します。
<a href="#client-api">WebSockets Next Client</a> および <a href="https://vertx.io/docs/vertx-core/java/#_websockets_on_the_client">Vert.x WebSocketClient</a> などの Java WebSocket クライアントは、WebSocket オープニングハンドシェイクにカスタムヘッダーを追加することをサポートしています。
ただし、 <a href="https://websockets.spec.whatwg.org/#the-websocket-interface">WebSockets API</a> に準拠する JavaScript クライアントは、カスタムヘッダーの追加をサポートしていません。
したがって、JavaScript ベースの WebSocket クライアントでは、カスタム <code>Authorization</code> ヘッダーを使用してベアラーアクセストークンを渡すことはできません。
JavaScript WebSocket クライアントでは、サブプロトコルをネゴシエートするための HTTP <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Sec-WebSocket-Protocol">Sec-WebSocket-Protocol</a> リクエストヘッダーのみを設定できます。
絶対に必要な場合は、 <a href="https://websockets.spec.whatwg.org/#the-websocket-interface">WebSockets API</a> の制限を回避するために、 <code>Sec-WebSocket-Protocol</code> ヘッダーをカスタムヘッダーのキャリアーとして使用できます。
以下は、 <code>Authorization</code> ヘッダーをサブプロトコル値として伝播する JavaScript クライアントの例です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const token = getBearerToken()
const quarkusHeaderProtocol = encodeURIComponent("quarkus-http-upgrade#Authorization#Bearer " + token) <i class="conum" data-value="1"></i><b>(1)</b>
const socket = new WebSocket("wss://" + location.host + "/chat/" + username, ["bearer-token-carrier", quarkusHeaderProtocol]) <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Quarkus Header サブプロトコルの想定される形式は <code>quarkus-http-upgrade#header-name#header-value</code> です。
エンコードの問題を回避するために、サブプロトコル値を URI コンポーネントとしてエンコードすることを忘れないでください。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>クライアントでサポートされている 2 つのサブプロトコル (選択したサブプロトコルと Quarkus HTTP アップグレードサブプロトコル) を指定します。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>WebSocket サーバーがサブプロトコルとして渡された <code>Authorization</code> を受け入れるには、次の操作を行う必要があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>サポートされているサブプロトコルを使用して、WebSocket サーバーを設定します。WebSocket クライアントが HTTP <code>Sec-WebSocket-Protocol</code> リクエストヘッダーでサポートされているサブプロトコルのリストを提供する場合、WebSocket サーバーはそれらのいずれかを使用してコンテンツを提供することに同意する必要があります。</p>
</li>
<li>
<p>開いている WebSocket ハンドシェイクリクエストヘッダーへの Quarkus HTTP アップグレードサブプロトコルマッピングを有効にします。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.websockets-next.server.supported-subprotocols=bearer-token-carrier
quarkus.websockets-next.server.propagate-subprotocol-headers=true</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>WebSocket セキュリティーモデルはオリジンベースであり、ヘッダーまたは Cookie を使用したクライアント側認証用に設計されていません。
たとえば、Web ブラウザーは、WebSocket ハンドシェイクリクエストの開始時に、同一オリジンポリシーを強制しません。
WebSocket ハンドシェイクリクエストの開始時に、ベアラーアクセストークンを使用する予定の場合は、セキュリティーリスクを最小限に抑えるために、以下に示す追加のセキュリティー対策に従うことを強く推奨します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="security-cors#cors-filter">CORS フィルター</a> を使用して、サポートされている Origin を信頼できる Origin のみに制限します。</p>
</li>
<li>
<p>TLS 経由で暗号化された HTTP 接続を強制するには、 <code>wss</code> プロトコルを使用します。</p>
</li>
<li>
<p>ランダムトークンを HTML ページに提供するカスタム WebSocket チケットシステムを使用します。この HTML ページは、ハンドシェイクリクエストの開始時にクエリーパラメーターとしてこのトークンを提供する必要がある JavaScript WebSocket クライアントをホストします。</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before the bearer access token sent on the initial HTTP request expires, you can send a new bearer access token as part of a message and update current <code>SecurityIdentity</code> attached to the WebSocket server connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkus.websockets.next.test.security;

import io.quarkus.security.Authenticated;
import io.quarkus.security.identity.SecurityIdentity;
import io.quarkus.websockets.next.OnTextMessage;
import io.quarkus.websockets.next.WebSocket;
import io.quarkus.websockets.next.WebSocketSecurity;
import jakarta.inject.Inject;

@Authenticated
@WebSocket(path = "/end")
public class Endpoint {

    record Metadata(String token) {}
    record RequestDto(Metadata metadata, String message) {}

    @Inject
    SecurityIdentity securityIdentity;

    @Inject
    WebSocketSecurity webSocketSecurity;

    @OnTextMessage
    String echo(RequestDto request) {
        if (request.metadata != null &amp;&amp; request.metadata.token != null) {
            webSocketSecurity.updateSecurityIdentity(request.metadata.token); <i class="conum" data-value="1"></i><b>(1)</b>
        }
        String principalName = securityIdentity.getPrincipal().getName(); <i class="conum" data-value="2"></i><b>(2)</b>
        return request.message + " " + principalName;
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Asynchronously update the <code>SecurityIdentity</code> attached to the WebSocket server connection.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The current <code>SecurityIdentity</code> instance is still available and can be used during the <code>SecurityIdentity</code> update.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="security-oidc-bearer-token-authentication">OIDC Bearer token authentication</a> mechanism has builtin support for the <code>SecurityIdentity</code> update.
If you use other authentication mechanisms, you must implement the <code>io.quarkus.security.identity.IdentityProvider</code> provider that supports the <code>io.quarkus.websockets.next.runtime.spi.security.WebSocketIdentityUpdateRequest</code> authentication request.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The new bearer access token must have the same <code>sub</code> claim value as the token used during the initial HTTP request.
Please also make sure the <code>SecurityIdentity</code> is only updated when necessary and the WebSocket message with credentials do not appear in your application logs.
Always use the <code>wss</code> protocol to enforce encrypted HTTP connection via TLS when sending credentials as part of the WebSocket message.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>WebSocket client application have to send a new access token before previous one expires:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;script type="module"&gt;
    import Keycloak from 'https://cdn.jsdelivr.net/npm/keycloak-js@26.2.0/lib/keycloak.js'
    const keycloak = new Keycloak({
        url: 'http://localhost:39245',
        realm: 'quarkus',
        clientId: 'websockets-js-client'
    });
    function getToken() {
        return keycloak.token
    }

    await keycloak
        .init({onLoad: 'login-required'})
        .then(() =&gt; console.log('User is now authenticated.'))
        .catch(err =&gt; console.log('User is NOT authenticated.', err));

    // open Web socket - reduced for brevity
    let connectionOpened = true;
    const subprotocols = [ "quarkus", encodeURI("quarkus-http-upgrade" + "#Authorization#Bearer " + getToken()) ]
    const socket = new WebSocket("wss://" + location.host + "/chat/username", subprotocols);

    setInterval(() =&gt; {
        keycloak
            .updateToken(15)
            .then(result =&gt; {
                if (result &amp;&amp; connectionOpened) {
                    console.log('Token updated, sending new token to the server')
                    socket.send(JSON.stringify({
                        metadata: {
                            token: `${getToken()}`
                        }
                    }));
                }
            })
            .catch(err =&gt; console.error(err))
    }, 10000);
&lt;/script&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Complete example is located in the <code>security-openid-connect-websockets-next-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/development/security-openid-connect-websockets-next-quickstart">directory</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="inspect-andor-reject-http-upgrade"><a class="anchor" href="#inspect-andor-reject-http-upgrade"></a>6.5. HTTP アップグレードを検査および/または拒否する</h3>
<div class="paragraph">
<p>HTTP アップグレードを検査するには、 <code>io.quarkus.websockets.next.HttpUpgradeCheck</code> インターフェイスを実装する CDI Bean を提供する必要があります。
Quarkus は、WebSocket 接続にアップグレードする必要があるすべての HTTP リクエストに対して <code>HttpUpgradeCheck#perform</code> メソッドを呼び出します。
このメソッド内では、任意のビジネスロジックを実行したり、HTTP アップグレードを拒否したりできます。</p>
</div>
<div class="listingblock">
<div class="title">HttpUpgradeCheck の例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.quarkus.websockets.next.test;

import io.quarkus.websockets.next.HttpUpgradeCheck;
import io.smallrye.mutiny.Uni;
import jakarta.enterprise.context.ApplicationScoped;

@ApplicationScoped <i class="conum" data-value="1"></i><b>(1)</b>
public class ExampleHttpUpgradeCheck implements HttpUpgradeCheck {

    @Override
    public Uni&lt;CheckResult&gt; perform(HttpUpgradeContext ctx) {
        if (rejectUpgrade(ctx)) {
            return CheckResult.rejectUpgrade(400); <i class="conum" data-value="2"></i><b>(2)</b>
        }
        return CheckResult.permitUpgrade();
    }

    private boolean rejectUpgrade(HttpUpgradeContext ctx) {
        var headers = ctx.httpRequest().headers();
        // implement your business logic in here
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>HttpUpgradeCheck</code> インターフェイスを実装する CDI Bean は、 <code>@ApplicationScoped</code>、 <code>@Singleton</code>、または <code>@Dependent</code> Bean のいずれかになりますが、 <code>@RequestScoped</code> Bean になることはできません。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>HTTP アップグレードを拒否します。最初の HTTP ハンドシェイクは、400 Bad Request レスポンスステータスコードで終了します。</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>HttpUpgradeCheck#appliesTo</code> メソッドを使用して、 <code>HttpUpgradeCheck</code> を適用する WebSocket エンドポイントを選択できます。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="tls"><a class="anchor" href="#tls"></a>6.6. TLS</h3>
<div class="paragraph">
<p>このエクステンションは、<em>メイン</em> の HTTP サーバーを再利用するという事実の直接的な結果として、関連するすべてのサーバー設定が適用されます。詳細は、<a href="http-reference#ssl">HTTP ガイド</a> を参照してください。</p>
</div>
</div>
<div class="sect2">
<h3 id="hibernate-multitenancy"><a class="anchor" href="#hibernate-multitenancy"></a>6.7. Hibernate マルチテナンシー</h3>
<div class="paragraph">
<p>HTTP アップグレード後、 <code>RoutingContext</code> は使用できません。ただし、 <code>WebSocketConnection</code> を注入して、最初の HTTP リクエストのヘッダーにアクセスすることは可能です。</p>
</div>
<div class="paragraph">
<p>カスタムの <code>TenantResolver</code> を使用し、REST/HTTP と WebSocket を組み合わせる場合、コードは次のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RequestScoped
@PersistenceUnitExtension
public class CustomTenantResolver implements TenantResolver {

    @Inject
    RoutingContext context;
    @Inject
    WebSocketConnection connection;

    @Override
    public String getDefaultTenantId() {
        return "public";
    }

    @Override
    public String resolveTenantId() {
        String schema;
        try {
            //Handle WebSocket
            schema = connection.handshakeRequest().header("schema");
        } catch ( ContextNotActiveException e) {
            // Handle REST/HTTP
            schema = context.request().getHeader( "schema" );
        }

        if ( schema == null || schema.equalsIgnoreCase( "public" ) ) {
            return "public";
        }

        return schema;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hibernate マルチテナンシーの詳細は、 <a href="https://quarkus.io/guides/hibernate-orm#multitenancy">hibernate ドキュメント</a> を参照してください。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="client-api"><a class="anchor" href="#client-api"></a>7. クライアント API</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="client-connectors"><a class="anchor" href="#client-connectors"></a>7.1. クライアントコネクター</h3>
<div class="paragraph">
<p>コネクターを使用すると、メッセージの消費と送信に使用されるクライアントエンドポイントによってサポートされる新しいクライアント接続を設定して開くことができます。
Quarkus は、Bean タイプ <code>io.quarkus.websockets.next.WebSocketConnector&lt;CLIENT&gt;</code> の CDI Bean および他の Bean に注入できるデフォルトの修飾子を提供します。
注入ポイントの実際のタイプ引数は、クライアントエンドポイントを決定するために使用されます。
このタイプはビルド時に検証され、クライアントエンドポイントを表していない場合、ビルドは失敗します。</p>
</div>
<div class="paragraph">
<p>次のクライアントエンドポイントを考えてみましょう。</p>
</div>
<div class="listingblock">
<div class="title">クライアントエンドポイント</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@WebSocketClient(path = "/endpoint/{name}")
public class ClientEndpoint {

    @OnTextMessage
    void onMessage(@PathParam String name, String message, WebSocketClientConnection connection) {
        // ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>このクライアントエンドポイントのコネクターは次のように使用されます。</p>
</div>
<div class="listingblock">
<div class="title">コネクター</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Singleton
public class MyBean {

    @ConfigProperty(name = "endpoint.uri")
    URI myUri;

    @Inject
    WebSocketConnector&lt;ClientEndpoint&gt; connector; <i class="conum" data-value="1"></i><b>(1)</b>

    void openAndSendMessage() {
        WebSocketClientConnection connection = connector
            .baseUri(uri) <i class="conum" data-value="2"></i><b>(2)</b>
            .pathParam("name", "Roxanne") <i class="conum" data-value="3"></i><b>(3)</b>
            .connectAndAwait();
        connection.sendTextAndAwait("Hi!"); <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>ClientEndpoint</code> のコネクターを注入します。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ベース <code>URI</code> が指定されていない場合は、設定から値を取得しようとします。キーは、クライアント ID と <code>.base-uri</code> 接尾辞で構成されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>パスパラメーター値を設定します。クライアントエンドポイントパスに指定された名前のパラメーターが含まれていない場合は、 <code>IllegalArgumentException</code> がスローされます。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>必要に応じて、接続を使用してメッセージを送信します。</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
アプリケーションが、存在しないエンドポイントのコネクターを注入しようとすると、エラーがスローされます。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>コネクターはスレッドセーフではないため、同時に使用しないでください。
また、コネクターの再利用もしないでください。
連続して複数の接続を作成する必要がある場合は、 <code>Instance#get()</code> を使用してプログラムで新しいコネクターインスタンスを取得する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import jakarta.enterprise.inject.Instance;

@Singleton
public class MyBean {

    @Inject
    Instance&lt;WebSocketConnector&lt;MyEndpoint&gt;&gt; connector;

    void connect() {
        var connection1 = connector.get().baseUri(uri)
                .addHeader("Foo", "alpha")
                .connectAndAwait();
        var connection2 = connector.get().baseUri(uri)
                .addHeader("Foo", "bravo")
                .connectAndAwait();
    }
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="basic-connector"><a class="anchor" href="#basic-connector"></a>7.1.1. 基本コネクター</h4>
<div class="paragraph">
<p>アプリケーション開発者がクライアントエンドポイントとコネクターの組み合わせを必要としない場合は、<em>基本コネクター</em> を使用できます。
基本コネクターは、クライアントエンドポイントを定義せずに接続を作成し、メッセージを消費/送信する簡単な方法です。</p>
</div>
<div class="listingblock">
<div class="title">基本コネクター</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Singleton
public class MyBean {

    @Inject
    BasicWebSocketConnector connector; <i class="conum" data-value="1"></i><b>(1)</b>

    void openAndConsume() {
        WebSocketClientConnection connection = connector
            .baseUri(uri) <i class="conum" data-value="2"></i><b>(2)</b>
            .path("/ws") <i class="conum" data-value="3"></i><b>(3)</b>
            .executionModel(ExecutionModel.NON_BLOCKING) <i class="conum" data-value="4"></i><b>(4)</b>
            .onTextMessage((c, m) -&gt; { <i class="conum" data-value="5"></i><b>(5)</b>
               // ...
            })
            .connectAndAwait();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>コネクターを注入します。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ベース URI は常に設定する必要があります。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>ベース URI に追加する必要がある追加パス。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>コールバックハンドラーの実行モデルを設定します。デフォルトでは、コールバックは現在のスレッドをブロックする可能性があります。ただし、この場合、コールバックはイベントループで実行され、現在のスレッドをブロックしない可能性があります。</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>lambda は、サーバーから送信されるテキストメッセージごとに呼び出されます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>基本コネクターは低レベル API に近いため、上級ユーザー向けに予約されています。
ただし、他の低レベルの WebSocket クライアントとは異なり、これは引き続き CDI Bean であり、他の Bean に注入できます。
また、コールバックの実行モデルを設定する方法も提供し、Quarkus の他の部分との最適なインテグレーションを確保します。</p>
</div>
<div class="paragraph">
<p>コネクターはスレッドセーフではないため、同時に使用しないでください。
また、コネクターの再利用もしないでください。
連続して複数の接続を作成する必要がある場合は、 <code>Instance#get()</code> を使用してプログラムで新しいコネクターインスタンスを取得する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import jakarta.enterprise.inject.Instance;

@Singleton
public class MyBean {

    @Inject
    Instance&lt;BasicWebSocketConnector&gt; connector;

    void connect() {
        var connection1 = connector.get().baseUri(uri)
                .addHeader("Foo", "alpha")
                .connectAndAwait();
        var connection2 = connector.get().baseUri(uri)
                .addHeader("Foo", "bravo")
                .connectAndAwait();
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ws-client-connection"><a class="anchor" href="#ws-client-connection"></a>7.2. WebSocket クライアント接続</h3>
<div class="paragraph">
<p><code>io.quarkus.websockets.next.WebSocketClientConnection</code> オブジェクトは WebSocket 接続を表します。
Quarkus は、このインターフェイスを実装し、 <code>WebSocketClient</code> エンドポイントに注入して、接続されたサーバーと対話するために使用できる <code>@SessionScoped</code> CDI Bean を提供します。</p>
</div>
<div class="paragraph">
<p><code>@OnOpen</code>、 <code>@OnTextMessage</code>、 <code>@OnBinaryMessage</code>、および <code>@OnClose</code> アノテーションが付与されたメソッドは、注入された <code>WebSocketClientConnection</code> オブジェクトにアクセスできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject WebSocketClientConnection connection;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
これらのメソッド以外では、 <code>WebSocketClientConnection</code> オブジェクトは利用できないことに注意してください。ただし、<a href="#list-open-client-connections">開いているすべてのクライアント接続をリスト表示</a> することは可能です。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>この接続を使用して、クライアントにメッセージを送信したり、パスパラメーターにアクセスしたりできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Send a message:
connection.sendTextAndAwait("Hello!");

// Broadcast messages:
connection.broadcast().sendTextAndAwait(departure);

// Access path parameters:
String param = connection.pathParam("foo");</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>WebSocketClientConnection</code> は、メッセージを送信するためのブロッキングメソッドとノンブロッキングメソッドの両方のバリアントを提供します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sendTextAndAwait(String message)</code>: テキストメッセージをクライアントに送信し、メッセージが送信されるのを待ちます。これはブロッキングであり、エグゼキュータースレッドからのみ呼び出す必要があります。</p>
</li>
<li>
<p><code>sendText(String message)</code>: テキストメッセージをクライアントに送信します。 <code>Uni</code> を返します。これはノンブロッキングです。メッセージを送信するには、返された <code>Uni</code> をユーザーまたは Quarkus がサブスクライブしていることを確認してください。
Quarkus によって呼び出されたメソッド (Quarkus REST、Quarkus WebSocket Next、Quarkus Messaging など) から <code>Uni</code> を返すと、それをサブスクライブしてメッセージを送信します。
以下に例を示します。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@POST
public Uni&lt;Void&gt; send() {
    return connection.sendText("Hello!"); // Quarkus automatically subscribes to the returned Uni and sends the message.
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="list-open-client-connections"><a class="anchor" href="#list-open-client-connections"></a>7.2.1. 開いているクライアント接続をリスト表示する</h4>
<div class="paragraph">
<p>開いているすべての接続をリスト表示することもできます。
Quarkus は、接続にアクセスするための便利なメソッドを宣言する <code>io.quarkus.websockets.next.OpenClientConnections</code> タイプの CDI Bean を提供します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.logging.Log;
import io.quarkus.websockets.next.OpenClientConnections;

class MyBean {

  @Inject
  OpenClientConnections connections;

  void logAllOpenClinetConnections() {
     Log.infof("Open client connections: %s", connections.listAll()); <i class="conum" data-value="1"></i><b>(1)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>OpenClientConnections#listAll()</code> は、指定された時点で開いているすべての接続のイミュータブルなスナップショットを返します。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>他にも便利な方法があります。
たとえば、 <code>OpenClientConnections#findByClientId(String)</code> を使用すると、特定のエンドポイントの接続を簡単に見つけることができます。</p>
</div>
</div>
<div class="sect3">
<h4 id="user-data-2"><a class="anchor" href="#user-data-2"></a>7.2.2. ユーザーデータ</h4>
<div class="paragraph">
<p>任意のユーザーデータを特定の接続に関連付けることも可能です。
<code>WebSocketClientConnection#userData()</code> メソッドによって取得される <code>io.quarkus.websockets.next.UserData</code> オブジェクトは、接続に関連付けられたミュータブルなユーザーデータを表します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.websockets.next.WebSocketClientConnection;
import io.quarkus.websockets.next.UserData.TypedKey;

@WebSocketClient(path = "/endpoint/{username}")
class MyEndpoint {

  @Inject
  CoolService service;

  @OnOpen
  void open(WebSocketClientConnection connection) {
     connection.userData().put(TypedKey.forBoolean("isCool"), service.isCool(connection.pathParam("username"))); <i class="conum" data-value="1"></i><b>(1)</b>
  }

  @OnTextMessage
  String process(String message) {
     if (connection.userData().get(TypedKey.forBoolean("isCool"))) { <i class="conum" data-value="2"></i><b>(2)</b>
        return "Cool message processed!";
     } else {
        return "Message processed!";
     }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>CoolService#isCool()</code> は、現在の接続に関連付けられている <code>Boolean</code> を返します。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>TypedKey.forBoolean("isCool")</code> は、接続の作成時に保存されたデータを取得するために使用されるキーです。</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="specify-in-connector"><a class="anchor" href="#specify-in-connector"></a>7.2.2.1. Specify in connector</h5>
<div class="paragraph">
<p>In some scenarios you may wish to associate user data with a connection to be created by a <a href="#client-connectors">connector</a>. In this case, you can set values on the connector instance prior to obtaining the connection. This is particularly useful if you need to do something when the connection is opened and the necessary context cannot be otherwise inferred.</p>
</div>
<div class="listingblock">
<div class="title">コネクター</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Singleton
public class MyBean {

    @Inject
    MyService service;

    @Inject
    Instance&lt;WebSocketConnector&lt;MyEndpoint&gt;&gt; connectorInstance;

    public void openAndSendMessage(String internalId, String message) {
        var externalId = service.getExternalId(internalId);
        var connection = connectorInstance.get()
            .pathParam("externalId", externalId)
            .userData(TypedKey.forString("internalId"), internalId)
            .connectAndAwait();
        connection.sendTextAndAwait(message);
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">エンドポイント</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@WebSocketClient(path = "/endpoint/{externalId}")
class MyEndpoint {

    @Inject
    MyService service;

    @OnOpen
    void open(WebSocketClientConnection connection) {
        var internalId = connection.userData().get(TypedKey.forString("internalId"));
        service.doSomething(internalId);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="client-cdi-events"><a class="anchor" href="#client-cdi-events"></a>7.2.3. CDI イベント</h4>
<div class="paragraph">
<p>Quarkus は、新しい接続が開かれると、修飾子 <code>@io.quarkus.websockets.next.Open</code> を持つ <code>io.quarkus.websockets.next.WebSocketConnection</code> タイプの CDI イベントを非同期的に起動します。
さらに、接続が閉じられると、修飾子 <code>@io.quarkus.websockets.next.Closed</code> を持つ <code>WebSocketClientConnection</code> タイプの CDI イベントが非同期的に起動します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import jakarta.enterprise.event.ObservesAsync;
import io.quarkus.websockets.next.Open;
import io.quarkus.websockets.next.WebSocketClientConnection;

class MyBean {

  void connectionOpened(@ObservesAsync @Open WebSocketClientConnection connection) { <i class="conum" data-value="1"></i><b>(1)</b>
     // This observer method is called when a connection is opened...
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>非同期オブザーバーメソッドは、デフォルトのブロッキングエグゼキューターサービスを使用して実行されます。</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-ssltls"><a class="anchor" href="#configuring-ssltls"></a>7.3. SSL/TLS の設定</h3>
<div class="paragraph">
<p>To establish a TLS connection, you need to configure a <em>named</em> configuration using the <a href="./tls-registry-reference">TLS registry</a>. This is typically done via configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.tls.my-ws-client.trust-store.p12.path=server-truststore.p12
quarkus.tls.my-ws-client.trust-store.p12.password=secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>With a <em>named</em> TLS configuration established, you can then configure the client to use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.websockets-next.client.tls-configuration-name=my-ws-client</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can supply the configuration name using the <a href="#client-connectors">connector</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Singleton
public class MyBean {

    @Inject
    WebSocketConnector&lt;MyEndpoint&gt; connector;

    public void connect() {
        connector
            .tlsConfigurationName("my-ws-client")
            .connectAndAwait();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A name supplied to the connector will override any statically configured name. This can be useful for establishing a default configuration which can be overridden at runtime as necessary.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
WebSocket クライアントを使用する場合は、他の TLS 設定との競合を避けるために、<em>名前付き</em> 設定を使用する必要があります。
クライアントはデフォルトの TLS 設定を使用しません。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>名前付き</em> TLS 設定を行うと、TLS はデフォルトで有効になります。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="traffic-logging"><a class="anchor" href="#traffic-logging"></a>8. トラフィックロギング</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus は、デバッグの目的で送受信されたメッセージをログに記録できます。
サーバーのトラフィックロギングを有効にするには、 <code>quarkus.websockets-next.server.traffic-logging.enabled</code> 設定プロパティーを <code>true</code> に設定します。
クライアントのトラフィックロギングを有効にするには、 <code>quarkus.websockets-next.client.traffic-logging.enabled</code> 設定プロパティーを <code>true</code> に設定します。
テキストメッセージのペイロードも記録されます。
ただし、記録される文字数には制限があります。
デフォルトの制限は 100 ですが、 <code>quarkus.websockets-next.server.traffic-logging.text-payload-limit</code> および <code>quarkus.websockets-next.client.traffic-logging.text-payload-limit</code> 設定プロパティーをそれぞれ使用してこの制限を変更できます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
メッセージは、ロガー <code>io.quarkus.websockets.next.traffic</code> に対して <code>DEBUG</code> レベルが有効になっている場合にのみ記録されます。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">サーバー設定の例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.websockets-next.server.traffic-logging.enabled=true <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.websockets-next.server.traffic-logging.text-payload-limit=50 <i class="conum" data-value="2"></i><b>(2)</b>

quarkus.log.category."io.quarkus.websockets.next.traffic".level=DEBUG <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>トラフィックロギングを有効にします。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ログに記録されるテキストメッセージペイロードの文字数を設定します。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>ロガー <code>io.quarkus.websockets.next.traffic</code> に対して <code>DEBUG</code> レベルを有効にします。</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="subscribe-or-not-subscribe"><a class="anchor" href="#subscribe-or-not-subscribe"></a>9. <code>Uni</code> または <code>Multi</code> をサブスクライブするタイミング</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>Uni</code> と <code>Multi</code> は遅延タイプです。つまり、サブスクライブされるまで処理を開始しません。</p>
</div>
<div class="paragraph">
<p><code>Uni</code> または <code>Multi</code> を (パラメーターまたは呼び出したメソッドから) 取得する場合、それをサブスクライブするかどうかはコンテキストによって異なります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Quarkus によって呼び出されるメソッド (Quarkus REST、Quarkus WebSocket Next、Quarkus Messaging など) で <code>Uni</code> または <code>Multi</code> を返すと、Quarkus はそれをサブスクライブし、 <code>Multi</code> によって発行された項目または <code>Uni</code> によって発行された項目を処理します。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Incoming("...")
@Outgoing("...")
public Multi&lt;String&gt; process(Multi&lt;String&gt; input) {
    // No need to subscribe to the input Multi, the `process` method is called by Quarkus (Messaging).
    return input.map(String::toUpperCase);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@OnOpen</code>、 <code>@OnTextMessage</code>、 <code>@OnBinaryMessage</code>、または <code>@OnClose</code> アノテーションが付与されたメソッドから <code>Uni</code> または <code>Multi</code> が返されると、Quarkus はそれを自動的にサブスクライブします。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Quarkus によって呼び出されるメソッドで <code>Uni</code> または <code>Multi</code> を返さない場合は、それをサブスクライブする必要があります。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Incoming("...")
@Outgoing("...")
public void process(Multi&lt;String&gt; input) {
    input.map(String::toUpperCase)
        .subscribe().with(s -&gt; log(s));
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="telemetry"><a class="anchor" href="#telemetry"></a>10. テレメトリー</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OpenTelemetry エクステンションが存在する場合、開かれた WebSocket 接続と閉じられた WebSocket 接続のトレースがデフォルトで収集されます。
WebSocket トレースが必要ない場合は、次の例のようにトレースの収集を無効化できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.websockets-next.server.traces.enabled=false
quarkus.websockets-next.client.traces.enabled=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Micrometer エクステンションが存在する場合、Quarkus はメッセージ、エラー、転送されたバイトのメトリクスを収集できます。
WebSocket メトリクスが必要な場合は、次の例のようにメトリクスを有効化できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.websockets-next.server.metrics.enabled=true
quarkus.websockets-next.client.metrics.enabled=true</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>BasicWebSocketConnector</code> のテレメトリーは現在サポートされていません。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="websocket-next-configuration-reference"><a class="anchor" href="#websocket-next-configuration-reference"></a>11. 設定リファレンス</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span class="icon"><i class="fa fa-lock" title="ビルド時に固定"></i></span>ビルド時に固定される設定プロパティ - 他のすべての設定プロパティは実行時にオーバーライド可能 <input type="search" id="config-search-0" placeholder="FILTER CONFIGURATION" disabled></p>
</div>
<table class="tableblock frame-all grid-all stretch configuration-reference searchable configuration-reference-all-rows">
<colgroup>
<col style="width: 80%;">
<col style="width: 10%;">
<col style="width: 10%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><span class="header-title">Configuration property</span></p></th>
<th class="tableblock halign-left valign-middle"><p class="tableblock">タイプ</p></th>
<th class="tableblock halign-left valign-middle"><p class="tableblock">デフォルト</p></th>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><span class="icon"><i class="fa fa-lock" title="Fixed at build time"></i></span> <a id="quarkus-websockets-next_quarkus-websockets-next-server-activate-request-context"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-activate-request-context"><code>quarkus.websockets-next.server.activate-request-context</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.activate-request-context' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-1" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>Specifies the activation strategy for the CDI request context during endpoint callback invocation. By default, the request context is only activated if needed, i.e. if there is a bean with the given scope, or a bean annotated with a security annotation (such as <code>@RolesAllowed</code>), in the dependency tree of the endpoint.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74212">QUARKUS_WEBSOCKETS_NEXT_SERVER_ACTIVATE_REQUEST_CONTEXT</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74212" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><span class="asciidoc-tooltip-wrapper"><code>auto</code><span class="asciidoc-tooltip">The context is only activated if needed.</span></span>, <span class="asciidoc-tooltip-wrapper"><code>always</code><span class="asciidoc-tooltip">The context is always activated.</span></span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><span class="asciidoc-tooltip-wrapper"><code>auto</code><span class="asciidoc-tooltip">The context is only activated if needed.</span></span></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><span class="icon"><i class="fa fa-lock" title="Fixed at build time"></i></span> <a id="quarkus-websockets-next_quarkus-websockets-next-server-activate-session-context"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-activate-session-context"><code>quarkus.websockets-next.server.activate-session-context</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.activate-session-context' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-2" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>Specifies the activation strategy for the CDI session context during endpoint callback invocation. By default, the session context is only activated if needed, i.e. if there is a bean with the given scope in the dependency tree of the endpoint.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74213">QUARKUS_WEBSOCKETS_NEXT_SERVER_ACTIVATE_SESSION_CONTEXT</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74213" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><span class="asciidoc-tooltip-wrapper"><code>auto</code><span class="asciidoc-tooltip">The context is only activated if needed.</span></span>, <span class="asciidoc-tooltip-wrapper"><code>always</code><span class="asciidoc-tooltip">The context is always activated.</span></span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><span class="asciidoc-tooltip-wrapper"><code>auto</code><span class="asciidoc-tooltip">The context is only activated if needed.</span></span></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><span class="icon"><i class="fa fa-lock" title="Fixed at build time"></i></span> <a id="quarkus-websockets-next_quarkus-websockets-next-server-propagate-subprotocol-headers"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-propagate-subprotocol-headers"><code>quarkus.websockets-next.server.propagate-subprotocol-headers</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.propagate-subprotocol-headers' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-3" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>If enabled, the WebSocket opening handshake headers are enhanced with the 'Sec-WebSocket-Protocol' sub-protocol that match format 'quarkus-http-upgrade#header-name#header-value'. If the WebSocket client interface does not support setting headers to the WebSocket opening handshake, this is a way how to set authorization header required to authenticate user. The 'quarkus-http-upgrade' sub-protocol is removed and server selects from the sub-protocol one that is supported (don&#8217;t forget to configure the 'quarkus.websockets-next.server.supported-subprotocols' property). <strong>IMPORTANT: We strongly recommend to only enable this feature if the HTTP connection is encrypted via TLS, CORS origin check is enabled and custom WebSocket ticket system is in place. Please see the Quarkus WebSockets Next reference for more information.</strong></p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74214">QUARKUS_WEBSOCKETS_NEXT_SERVER_PROPAGATE_SUBPROTOCOL_HEADERS</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74214" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-client-offer-per-message-compression"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-client-offer-per-message-compression"><code>quarkus.websockets-next.client.offer-per-message-compression</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.client.offer-per-message-compression' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-4" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>Compression Extensions for WebSocket are supported by default.</p>
</div>
<div class="paragraph">
<p>See also <a href="https://datatracker.ietf.org/doc/html/rfc7692">RFC 7692</a></p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74215">QUARKUS_WEBSOCKETS_NEXT_CLIENT_OFFER_PER_MESSAGE_COMPRESSION</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74215" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-client-compression-level"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-client-compression-level"><code>quarkus.websockets-next.client.compression-level</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.client.compression-level' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-5" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The compression level must be a value between 0 and 9. The default value is <code>io.vertx.core.http.HttpClientOptions#DEFAULT_WEBSOCKET_COMPRESSION_LEVEL</code>.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74216">QUARKUS_WEBSOCKETS_NEXT_CLIENT_COMPRESSION_LEVEL</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74216" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-client-max-message-size"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-client-max-message-size"><code>quarkus.websockets-next.client.max-message-size</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.client.max-message-size' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-6" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The maximum size of a message in bytes. The default values is <code>io.vertx.core.http.HttpClientOptions#DEFAULT_MAX_WEBSOCKET_MESSAGE_SIZE</code>.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74217">QUARKUS_WEBSOCKETS_NEXT_CLIENT_MAX_MESSAGE_SIZE</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74217" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-client-max-frame-size"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-client-max-frame-size"><code>quarkus.websockets-next.client.max-frame-size</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.client.max-frame-size' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-7" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The maximum size of a frame in bytes. The default values is <code>io.vertx.core.http.HttpClientOptions#DEFAULT_MAX_WEBSOCKET_FRAME_SIZE</code>.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74218">QUARKUS_WEBSOCKETS_NEXT_CLIENT_MAX_FRAME_SIZE</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74218" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-client-auto-ping-interval"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-client-auto-ping-interval"><code>quarkus.websockets-next.client.auto-ping-interval</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.client.auto-ping-interval' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-8" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The interval after which, when set, the client sends a ping message to a connected server automatically.</p>
</div>
<div class="paragraph">
<p>Ping messages are not sent automatically by default.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74219">QUARKUS_WEBSOCKETS_NEXT_CLIENT_AUTO_PING_INTERVAL</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74219" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/time/Duration.html">Duration</a> <a href="#duration-note-anchor-quarkus-websockets-next_quarkus-websockets-next"><span class="icon"><i class="fa fa-question-circle" title="More information about the Duration format"></i></span></a></p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-client-connection-idle-timeout"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-client-connection-idle-timeout"><code>quarkus.websockets-next.client.connection-idle-timeout</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.client.connection-idle-timeout' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-9" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>If set then a connection will be closed if no data is received nor sent within the given timeout.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74220">QUARKUS_WEBSOCKETS_NEXT_CLIENT_CONNECTION_IDLE_TIMEOUT</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74220" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/time/Duration.html">Duration</a> <a href="#duration-note-anchor-quarkus-websockets-next_quarkus-websockets-next"><span class="icon"><i class="fa fa-question-circle" title="More information about the Duration format"></i></span></a></p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-client-connection-closing-timeout"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-client-connection-closing-timeout"><code>quarkus.websockets-next.client.connection-closing-timeout</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.client.connection-closing-timeout' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-10" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The amount of time a client will wait until it closes the TCP connection after sending a close frame. Any value will be <code>Duration#toSeconds() converted to seconds</code> and limited to <code>Integer#MAX_VALUE</code>. The default value is `io.vertx.core.http.HttpClientOptions#DEFAULT_WEBSOCKET_CLOSING_TIMEOUT`s</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74221">QUARKUS_WEBSOCKETS_NEXT_CLIENT_CONNECTION_CLOSING_TIMEOUT</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74221" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/time/Duration.html">Duration</a> <a href="#duration-note-anchor-quarkus-websockets-next_quarkus-websockets-next"><span class="icon"><i class="fa fa-question-circle" title="More information about the Duration format"></i></span></a></p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-client-unhandled-failure-strategy"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-client-unhandled-failure-strategy"><code>quarkus.websockets-next.client.unhandled-failure-strategy</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.client.unhandled-failure-strategy' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-11" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The strategy used when an error occurs but no error handler can handle the failure.</p>
</div>
<div class="paragraph">
<p>By default, the error message is logged when an unhandled failure occurs.</p>
</div>
<div class="paragraph">
<p>Note that clients should not close the WebSocket connection arbitrarily. See also RFC-6455 <a href="https://datatracker.ietf.org/doc/html/rfc6455#section-7.3">section 7.3</a>.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74222">QUARKUS_WEBSOCKETS_NEXT_CLIENT_UNHANDLED_FAILURE_STRATEGY</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74222" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><span class="asciidoc-tooltip-wrapper"><code>log-and-close</code><span class="asciidoc-tooltip">Log the error message and close the connection.</span></span>, <span class="asciidoc-tooltip-wrapper"><code>close</code><span class="asciidoc-tooltip">Close the connection silently.</span></span>, <span class="asciidoc-tooltip-wrapper"><code>log</code><span class="asciidoc-tooltip">Log the error message.</span></span>, <span class="asciidoc-tooltip-wrapper"><code>noop</code><span class="asciidoc-tooltip">No operation.</span></span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><span class="asciidoc-tooltip-wrapper"><code>log</code><span class="asciidoc-tooltip">Log the error message.</span></span></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-client-tls-configuration-name"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-client-tls-configuration-name"><code>quarkus.websockets-next.client.tls-configuration-name</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.client.tls-configuration-name' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-12" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The name of the TLS configuration to use.</p>
</div>
<div class="paragraph">
<p>If a name is configured, it uses the configuration from <code>quarkus.tls.&lt;name&gt;.*</code> If a name is configured, but no TLS configuration is found with that name then an error will be thrown.</p>
</div>
<div class="paragraph">
<p>The default TLS configuration is <strong>not</strong> used by default.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74223">QUARKUS_WEBSOCKETS_NEXT_CLIENT_TLS_CONFIGURATION_NAME</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74223" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-client-traffic-logging-enabled"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-client-traffic-logging-enabled"><code>quarkus.websockets-next.client.traffic-logging.enabled</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.client.traffic-logging.enabled' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-13" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>If set to true then binary/text messages received/sent are logged if the <code>DEBUG</code> level is enabled for the logger <code>io.quarkus.websockets.next.traffic</code>.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74224">QUARKUS_WEBSOCKETS_NEXT_CLIENT_TRAFFIC_LOGGING_ENABLED</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74224" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-client-traffic-logging-text-payload-limit"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-client-traffic-logging-text-payload-limit"><code>quarkus.websockets-next.client.traffic-logging.text-payload-limit</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.client.traffic-logging.text-payload-limit' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-14" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The number of characters of a text message which will be logged if traffic logging is enabled. The payload of a binary message is never logged.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74225">QUARKUS_WEBSOCKETS_NEXT_CLIENT_TRAFFIC_LOGGING_TEXT_PAYLOAD_LIMIT</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74225" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>100</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-client-traces-enabled"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-client-traces-enabled"><code>quarkus.websockets-next.client.traces.enabled</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.client.traces.enabled' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-15" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>If collection of WebSocket traces is enabled. Only applicable when the OpenTelemetry extension is present.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74226">QUARKUS_WEBSOCKETS_NEXT_CLIENT_TRACES_ENABLED</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74226" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-client-metrics-enabled"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-client-metrics-enabled"><code>quarkus.websockets-next.client.metrics.enabled</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.client.metrics.enabled' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-16" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>If collection of WebSocket metrics is enabled. Only applicable when the Micrometer extension is present.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74227">QUARKUS_WEBSOCKETS_NEXT_CLIENT_METRICS_ENABLED</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74227" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-server-supported-subprotocols"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-supported-subprotocols"><code>quarkus.websockets-next.server.supported-subprotocols</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.supported-subprotocols' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-17" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>See <a href="https://datatracker.ietf.org/doc/html/rfc6455#page-12">The WebSocket Protocol</a></p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74228">QUARKUS_WEBSOCKETS_NEXT_SERVER_SUPPORTED_SUBPROTOCOLS</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74228" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">list of string</p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-server-per-message-compression-supported"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-per-message-compression-supported"><code>quarkus.websockets-next.server.per-message-compression-supported</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.per-message-compression-supported' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-18" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>Compression Extensions for WebSocket are supported by default.</p>
</div>
<div class="paragraph">
<p>See also <a href="https://datatracker.ietf.org/doc/html/rfc7692">RFC 7692</a></p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74229">QUARKUS_WEBSOCKETS_NEXT_SERVER_PER_MESSAGE_COMPRESSION_SUPPORTED</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74229" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-server-compression-level"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-compression-level"><code>quarkus.websockets-next.server.compression-level</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.compression-level' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-19" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The compression level must be a value between 0 and 9. The default value is <code>io.vertx.core.http.HttpServerOptions#DEFAULT_WEBSOCKET_COMPRESSION_LEVEL</code>.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74230">QUARKUS_WEBSOCKETS_NEXT_SERVER_COMPRESSION_LEVEL</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74230" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-server-max-message-size"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-max-message-size"><code>quarkus.websockets-next.server.max-message-size</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.max-message-size' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-20" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The maximum size of a message in bytes. The default values is <code>io.vertx.core.http.HttpServerOptions#DEFAULT_MAX_WEBSOCKET_MESSAGE_SIZE</code>.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74231">QUARKUS_WEBSOCKETS_NEXT_SERVER_MAX_MESSAGE_SIZE</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74231" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-server-max-frame-size"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-max-frame-size"><code>quarkus.websockets-next.server.max-frame-size</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.max-frame-size' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-21" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The maximum size of a frame in bytes. The default values is <code>io.vertx.core.http.HttpServerOptions#DEFAULT_MAX_WEBSOCKET_FRAME_SIZE</code>.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74232">QUARKUS_WEBSOCKETS_NEXT_SERVER_MAX_FRAME_SIZE</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74232" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-server-auto-ping-interval"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-auto-ping-interval"><code>quarkus.websockets-next.server.auto-ping-interval</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.auto-ping-interval' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-22" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The interval after which, when set, the server sends a ping message to a connected client automatically.</p>
</div>
<div class="paragraph">
<p>Ping messages are not sent automatically by default.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74233">QUARKUS_WEBSOCKETS_NEXT_SERVER_AUTO_PING_INTERVAL</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74233" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/time/Duration.html">Duration</a> <a href="#duration-note-anchor-quarkus-websockets-next_quarkus-websockets-next"><span class="icon"><i class="fa fa-question-circle" title="More information about the Duration format"></i></span></a></p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-server-unhandled-failure-strategy"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-unhandled-failure-strategy"><code>quarkus.websockets-next.server.unhandled-failure-strategy</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.unhandled-failure-strategy' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-23" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The strategy used when an error occurs but no error handler can handle the failure.</p>
</div>
<div class="paragraph">
<p>By default, the error message is logged and the connection is closed when an unhandled failure occurs.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74234">QUARKUS_WEBSOCKETS_NEXT_SERVER_UNHANDLED_FAILURE_STRATEGY</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74234" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="paragraph">
<p><span class="asciidoc-tooltip-wrapper"><code>log-and-close</code><span class="asciidoc-tooltip">Log the error message and close the connection.</span></span>, <span class="asciidoc-tooltip-wrapper"><code>close</code><span class="asciidoc-tooltip">Close the connection silently.</span></span>, <span class="asciidoc-tooltip-wrapper"><code>log</code><span class="asciidoc-tooltip">Log the error message.</span></span>, <span class="asciidoc-tooltip-wrapper"><code>noop</code><span class="asciidoc-tooltip">No operation.</span></span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><span class="asciidoc-tooltip-wrapper"><code>log-and-close</code><span class="asciidoc-tooltip">Log the error message and close the connection.</span></span></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-server-security-auth-failure-redirect-url"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-security-auth-failure-redirect-url"><code>quarkus.websockets-next.server.security.auth-failure-redirect-url</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.security.auth-failure-redirect-url' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-24" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>Quarkus redirects HTTP handshake request to this URL if an HTTP upgrade is rejected due to the authorization failure. This configuration property takes effect when you secure endpoint with a standard security annotation. For example, the HTTP upgrade is secured if an endpoint class is annotated with the <code>@RolesAllowed</code> annotation.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74235">QUARKUS_WEBSOCKETS_NEXT_SERVER_SECURITY_AUTH_FAILURE_REDIRECT_URL</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74235" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-server-dev-mode-connection-messages-limit"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-dev-mode-connection-messages-limit"><code>quarkus.websockets-next.server.dev-mode.connection-messages-limit</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.dev-mode.connection-messages-limit' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-25" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The limit of messages kept for a Dev UI connection. If less than zero then no messages are stored and sent to the Dev UI view.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74236">QUARKUS_WEBSOCKETS_NEXT_SERVER_DEV_MODE_CONNECTION_MESSAGES_LIMIT</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74236" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">長</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>1000</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-server-traffic-logging-enabled"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-traffic-logging-enabled"><code>quarkus.websockets-next.server.traffic-logging.enabled</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.traffic-logging.enabled' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-26" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>If set to true then binary/text messages received/sent are logged if the <code>DEBUG</code> level is enabled for the logger <code>io.quarkus.websockets.next.traffic</code>.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74237">QUARKUS_WEBSOCKETS_NEXT_SERVER_TRAFFIC_LOGGING_ENABLED</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74237" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-server-traffic-logging-text-payload-limit"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-traffic-logging-text-payload-limit"><code>quarkus.websockets-next.server.traffic-logging.text-payload-limit</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.traffic-logging.text-payload-limit' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-27" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The number of characters of a text message which will be logged if traffic logging is enabled. The payload of a binary message is never logged.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74238">QUARKUS_WEBSOCKETS_NEXT_SERVER_TRAFFIC_LOGGING_TEXT_PAYLOAD_LIMIT</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74238" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">int</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>100</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-server-traces-enabled"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-traces-enabled"><code>quarkus.websockets-next.server.traces.enabled</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.traces.enabled' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-28" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>If collection of WebSocket traces is enabled. Only applicable when the OpenTelemetry extension is present.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74239">QUARKUS_WEBSOCKETS_NEXT_SERVER_TRACES_ENABLED</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74239" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-websockets-next_quarkus-websockets-next-server-metrics-enabled"></a> <span class="property-path"><a href="#quarkus-websockets-next_quarkus-websockets-next-server-metrics-enabled"><code>quarkus.websockets-next.server.metrics.enabled</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.websockets-next.server.metrics.enabled' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-29" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>If collection of WebSocket metrics is enabled. Only applicable when the Micrometer extension is present.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-74240">QUARKUS_WEBSOCKETS_NEXT_SERVER_METRICS_ENABLED</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-74240" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>false</code></p></td>
</tr>
</tbody>
</table>
<div id="duration-note-anchor-quarkus-websockets-next_quarkus-websockets-next" class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">期間フォーマットについて</div>
<div class="paragraph">
<p>期間の値を書くには、標準の <code>java.time.Duration</code> フォーマットを使います。
詳細は <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/time/Duration.html#parse(java.lang.CharSequence)">Duration#parse() Java API documentation</a> を参照してください。</p>
</div>
<div class="paragraph">
<p>数字で始まる簡略化した書式を使うこともできます:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>数値のみの場合は、秒単位の時間を表します。</p>
</li>
<li>
<p>数値の後に <code>ms</code> が続く場合は、ミリ秒単位の時間を表します。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>その他の場合は、簡略化されたフォーマットが解析のために <code>java.time.Duration</code> フォーマットに変換されます：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>数値の後に <code>h</code> 、 <code>m</code> 、 <code>s</code> が続く場合は、その前に <code>PT</code> が付けられます。</p>
</li>
<li>
<p>数値の後に <code>d</code> が続く場合は、その前に <code>P</code> が付けられます。</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
    </div>
    <div class="grid__item width-4-12 width-12-12-m tocwrapper">
      <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#the-websocket-protocol">1. WebSocket プロトコル</a></li>
<li><a href="#http-and-websocket-architecture-styles">2. HTTP および WebSocket アーキテクチャースタイル</a></li>
<li><a href="#quarkus-websockets-vs-quarkus-websockets-next">3. Quarkus WebSockets と Quarkus WebSockets Next</a></li>
<li><a href="#project-setup">4. プロジェクトのセットアップ</a></li>
<li><a href="#endpoints">5. Endpoints</a>
<ul class="sectlevel2">
<li><a href="#server-endpoints">5.1. サーバーエンドポイント</a></li>
<li><a href="#client-endpoints">5.2. クライアントエンドポイント</a></li>
<li><a href="#path-parameters">5.3. パスパラメーター</a></li>
<li><a href="#cdi-scopes">5.4. CDI スコープ</a></li>
<li><a href="#callback-methods">5.5. コールバックメソッド</a></li>
<li><a href="#processing-messages">5.6. メッセージの処理</a></li>
<li><a href="#error-handling">5.7. エラー処理</a></li>
<li><a href="#serialization">5.8. シリアライズとデシリアライズ</a></li>
<li><a href="#pingpong-messages">5.9. Ping/Pong メッセージ</a></li>
<li><a href="#inbound-processing-mode">5.10. 受信処理モード</a></li>
</ul>
</li>
<li><a href="#server-api">6. サーバー API</a>
<ul class="sectlevel2">
<li><a href="#http-server-configuration">6.1. HTTP サーバーの設定</a></li>
<li><a href="#sub-websockets-endpoints">6.2. sub-websocket エンドポイント</a></li>
<li><a href="#ws-connection">6.3. WebSocket 接続</a></li>
<li><a href="#websocket-next-security">6.4. セキュリティー</a></li>
<li><a href="#inspect-andor-reject-http-upgrade">6.5. HTTP アップグレードを検査および/または拒否する</a></li>
<li><a href="#tls">6.6. TLS</a></li>
<li><a href="#hibernate-multitenancy">6.7. Hibernate マルチテナンシー</a></li>
</ul>
</li>
<li><a href="#client-api">7. クライアント API</a>
<ul class="sectlevel2">
<li><a href="#client-connectors">7.1. クライアントコネクター</a></li>
<li><a href="#ws-client-connection">7.2. WebSocket クライアント接続</a></li>
<li><a href="#configuring-ssltls">7.3. SSL/TLS の設定</a></li>
</ul>
</li>
<li><a href="#traffic-logging">8. トラフィックロギング</a></li>
<li><a href="#subscribe-or-not-subscribe">9. <code>Uni</code> または <code>Multi</code> をサブスクライブするタイミング</a></li>
<li><a href="#telemetry">10. テレメトリー</a></li>
<li><a href="#websocket-next-configuration-reference">11. 設定リファレンス</a></li>
</ul></div>
    </div>
  </div>
  <h2>関連コンテンツ</h2>
  <div class="grid-wrapper relations">
    <div class="grid__item width-6-12 width-12-12-m">
      <h3>同じエクステンションについて</h3>
      <ul class="related-content">
      
        
        <li class="tutorial"><a href="/version/main/guides/websockets-next-tutorial">WebSockets Next入門</a></li>
      </ul>
    </div>
    <div class="grid__item width-6-12 width-12-12-m">
      <h3>同じトピックについて</h3>
      <ul class="related-content">
      
        
        <li class="tutorial"><a href="/version/main/guides/websockets-next-tutorial">WebSockets Next入門</a></li>
      
        
        <li class="guide"><a href="/version/main/guides/websockets">Using WebSockets with Undertow</a></li>
      
        
        <li class="reference"><a href="/version/main/guides/http-reference">HTTPリファレンス</a></li>
      
        
        <li class="reference"><a href="/version/main/guides/load-shedding-reference">負荷制限リファレンスガイド</a></li>
      
        
        <li class="guide"><a href="/version/main/guides/web">Web 向け Quarkus</a></li>
      
        
        <li class="guide"><a href="/version/main/guides/reactive-routes">リアクティブルートの使用</a></li>
      
        
        <li class="guide"><a href="/version/main/guides/web-dependency-locator">Web 依存関係ロケーター</a></li>
      </ul>
    </div>
    </div>
  </div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license. <i class='fab fa-creative-commons'></i><i class='fab fa-creative-commons-by'></i> <a href='https://creativecommons.org/licenses/by/3.0/' target='_blank'>CC by 3.0</a><br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">ホーム</a></li>
          
          
          
            <li><a href="/about" target="_blank">Quarkusについて</a></li>
          
          
          
            <li><a href="/blog" target="_blank">ブログ</a></li>
          
          
          
            <li><a href="/insights" target="_blank">ポッドキャスト</a></li>
          
          
          
            <li><a href="/events" target="_blank">イベント</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">ニュースレター</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">ユーザーストーリー</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">ロードマップ</a></li>
          
          
          
            <li><a href="/security" target="_blank">セキュリティ&nbsp;ポリシー</a></li>
          
          
          
            <li><a href="/usage" target="_blank">使用方法</a></li>
          
          
          
            <li><a href="/brand" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
          
            <li><a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy Policy</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォローする</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.threads.com/@quarkusio" target="_blank">Threads</a></li>
          
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">サポート</a></li>
          
          
          
            <li><a href="/guides" target="_blank">ガイド</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">入門</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">ディスカッション</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">開発メーリングリスト</a></li>
          
          
          
            <li><a href="https://stats.uptimerobot.com/ze1PfweT2p" target="_blank">Quarkus Service Status</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>言語</span>
        <ul class="footer-links">
          
          
            <li><a href=" https://quarkus.io/ " target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href=" https://es.quarkus.io/ " target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href=" https://ja.quarkus.io/ " target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate ORM</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">その他多数...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content cf-footer">
  <div class="flexcontainer">
    <div class="cf-logo">
      <a class="cf-logo" href="https://www.commonhaus.org/" target="_blank"><img src="https://raw.githubusercontent.com/commonhaus/artwork/main/foundation/brand/svg/CF_logo_horizontal_single_reverse.svg"/></a>
    </div>
    <div class="license">
      Copyright © Quarkus. All rights reserved. For details on our trademarks, please visit our <a href="https://www.commonhaus.org/policies/trademark-policy/">Trademark Policy</a> and <a href="https://www.commonhaus.org/trademarks/">Trademark List</a>. Trademarks of third parties are owned by their respective holders and their mention here does not suggest any endorsement or association.
    </div>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
  <script src="/assets/javascript/randomize.js" type="text/javascript"></script>
  <script src="/assets/javascript/time.js" type="text/javascript"></script>
</body>

</html>
