<!DOCTYPE html>
<html lang="ja">







<head>
  <title>JWT RBAC の使用 - 3.27 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/3.27/guides/security-jwt" />
  <meta property="og:title" content="JWT RBAC の使用 - 3.27" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/security-jwt">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="guides">

  


<div class="grid-wrapper communitysite">
  <div class="grid__item width-12-12">The <a href="https://quarkus.io/version/3.27/guides/security-jwt">English version of quarkus.io</a> is the official project site. Translated sites are community supported on a best-effort basis.</div>
</div>


  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="#">Why<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/performance" class="">パフォーマンス</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
          <li><a href="/versatility" class="">多用途性</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/spring" class="">USING SPRING?</a></li>
          <li class="tertiarydropdown">
            <span href="#">AI<i class="fas fa-chevron-down"></i></span>
            <ul class="tertiarymenu">
              <li><a href="/ai" class="">AI OVERVIEW</a></li>
              <li><a href="/java-for-ai" class="">JAVA FOR AI</a></li>
              <li><a href="/quarkus-for-ai" class="">WHY QUARKUS FOR AI</a></li>
              <li><a href="/ai-blueprints" class="">AI BLUEPRINTS</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Learn<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ドキュメント</a></li>
          <li><a href="/userstories/" class="">ユーザーストーリー</a></li>  
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="#">Extensions<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
<li><a href="https://quarkus.io/extensions/" class="">エクステンションを探す</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">エクステンションの使用</a></li>
          <li><a href="/guides/writing-extensions" class="">エクステンションの作成</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">エクステンションの共有</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Community<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/working-groups" class="">ワーキンググループ</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ロードマップ</a></li>
          <li><a href="/benefactors" class="">BENEFACTORS</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/version/3.27/guides/security-jwt" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/version/3.27/guides/security-jwt">ポルトガル（BR）</a></li>
          <li><a href="https://es.quarkus.io/version/3.27/guides/security-jwt">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/version/3.27/guides/security-jwt">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/version/3.27/guides/security-jwt">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas
fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    







<section class="full-width-version-bg flexfilterbar guides">
  <div class="guideflexcontainer">
    <div class="docslink">
      <a class="returnlink" href="/version/3.27/guides/"> Back to Guides</a>
    </div>
    <div class="flexlabel">
      <label>バージョン:</label>
    </div>
    <div class="guidepulldown version">
    <select id="guide-version-dropdown">
      
        
        
        <option value="main" >Main - SNAPSHOT</option>
        
        
        
        <option value="latest" >3.28.4 - Latest</option>
        
        
        
        <option value="3.27" selected>3.27</option>
        
        
        
        <option value="3.20" >3.20</option>
        
        
        
        <option value="3.15" >3.15</option>
        
        
        
        <option value="3.8" >3.8</option>
        </select>
    </div>
  </div>
</section>

<div class="guide">
  <div class="grid-wrapper">
    <div class="grid__item width-8-12 width-12-12-m">
      
      <h1 class="text-caps">JWT RBAC の使用 </h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>このガイドでは、Quarkus アプリケーションに <a href="https://github.com/smallrye/smallrye-jwt/">SmallRye JWT</a> を統合し、MicroProfile JWT 仕様に準拠した <a href="https://tools.ietf.org/html/rfc7519">JSON Web Token (JWT)</a> セキュリティーを実装する方法を説明します。

JWT の検証方法、MicroProfile JWT の <code>org.eclipse.microprofile.jwt.JsonWebToken</code> としての表現、およびベアラートークン認証と <a href="https://en.wikipedia.org/wiki/Role-based_access_control">ロールベースアクセス制御 (RBAC)</a> を使用して Quarkus の HTTP エンドポイントを保護する方法を学びます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Quarkus の OpenID Connect (<code>quarkus-oidc</code>) エクステンションもベアラートークン認証をサポートしており、 <code>smallrye-jwt</code> を使用してベアラートークンを <code>JsonWebToken</code> として表現します。
詳細については、<a href="security-oidc-bearer-token-authentication">OIDC ベアラートークン認証</a> ガイドを参照してください。</p>
</div>
<div class="paragraph">
<p>Quarkus アプリケーションで OIDC 認可コードフローを使用してユーザーを認証する必要がある場合は、OpenID Connect エクステンションを使用する必要があります。
詳細については、<a href="security-oidc-code-flow-authentication">Web アプリケーションを保護するための OIDC コードフローメカニズム</a> を参照してください。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>前提条件</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このガイドを完成させるには、以下が必要です:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>約15分</p>
</li>
<li>
<p>IDE</p>
</li>
<li>
<p>JDK 17+がインストールされ、 <code>JAVA_HOME</code> が適切に設定されていること</p>
</li>
<li>
<p>Apache Maven 3.9.9</p>
</li>
<li>
<p>使用したい場合は、 <a href="cli-tooling.html">Quarkus CLI</a></p>
</li>
<li>
<p>ネイティブ実行可能ファイルをビルドしたい場合、MandrelまたはGraalVM（あるいはネイティブなコンテナビルドを使用する場合はDocker）をインストールし、 <a href="building-native-image.html#configuring-graalvm">適切に設定</a>していること</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quickstart"><a class="anchor" href="#quickstart"></a>クイックスタート</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="solution"><a class="anchor" href="#solution"></a>ソリューション</h3>
<div class="paragraph">
<p>アプリケーションを段階的に作成するには、次のセクションの指示に従うことを推奨します。
必要に応じて、完成した例に進むこともできます。</p>
</div>
<div class="paragraph">
<p>例を利用するには、Git リポジトリーをクローンするか、アーカイブをダウンロードします。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>リポジトリーをクローンします (<code>git clone-b 3.27 <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code>)。</p>
</li>
<li>
<p><a href="https://github.com/quarkusio/quarkus-quickstarts/archive/3.27.zip">アーカイブ</a> をダウンロードします。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ソリューションは <code>security-jwt-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/3.27/security-jwt-quickstart">ディレクトリー</a> にあります。</p>
</div>
</div>
<div class="sect2">
<h3 id="creating-the-maven-project"><a class="anchor" href="#creating-the-maven-project"></a>Mavenプロジェクトの作成</h3>
<div class="paragraph">
<p>まず、以下のコマンドで新規プロジェクトを作成します:</p>
</div>
<div class="sidebarblock primary asciidoc-tabs-sync-cli">
<div class="content">
<div class="title">コマンドラインインタフェース</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus create app org.acme:security-jwt-quickstart \
    --extension='rest-jackson,smallrye-jwt,smallrye-jwt-build' \
    --no-code
cd security-jwt-quickstart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradleプロジェクトを作成するには、 <code>--gradle</code> または <code>--gradle-kotlin-dsl</code> オプションを追加します。</p>
</div>
<div class="paragraph">
<p>Quarkus CLIのインストールと使用方法の詳細については、 <a href="cli-tooling">Quarkus CLI</a> ガイドを参照してください。</p>
</div>
</div>
</div>
<div class="sidebarblock secondary asciidoc-tabs-sync-maven">
<div class="content">
<div class="title">Maven</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn io.quarkus.platform:quarkus-maven-plugin:3.27.0:create \
    -DprojectGroupId=org.acme \
    -DprojectArtifactId=security-jwt-quickstart \
    -Dextensions='rest-jackson,smallrye-jwt,smallrye-jwt-build' \
    -DnoCode
cd security-jwt-quickstart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradleプロジェクトを作成するには、 <code>-DbuildTool=gradle</code> または <code>-DbuildTool=gradle-kotlin-dsl</code> オプションを追加します。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Windowsユーザーの場合:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>cmdを使用する場合、（バックスラッシュ <code>\</code> を使用せず、すべてを同じ行に書かないでください）。</p>
</li>
<li>
<p>Powershellを使用する場合は、 <code>-D</code> パラメータを二重引用符で囲んでください。例: <code>"-DprojectArtifactId=security-jwt-quickstart"</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>このコマンドは、RESTエンドポイントを持つMavenプロジェクトを生成し、MicroProfile JWT RBAC サポートを含む <code>smallrye-jwt</code> エクステンションをインポートします。</p>
</div>
<div class="paragraph">
<p>すでにQuarkusプロジェクトが設定されている場合は、プロジェクトのベースディレクトリーで以下のコマンドを実行することで、プロジェクトに <code>smallrye-jwt</code> エクステンションを追加することができます。</p>
</div>
<div class="listingblock primary asciidoc-tabs-sync-cli">
<div class="title">コマンドラインインタフェース</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus extension add smallrye-jwt,smallrye-jwt-build</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-maven">
<div class="title">Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:add-extension -Dextensions='smallrye-jwt,smallrye-jwt-build'</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-gradle">
<div class="title">Gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./gradlew addExtension --extensions='smallrye-jwt,smallrye-jwt-build'</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドは、ビルドファイルに以下の依存関係を追加します。</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-smallrye-jwt&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-smallrye-jwt-build&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.quarkus:quarkus-smallrye-jwt")
implementation("io.quarkus:quarkus-smallrye-jwt-build")</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="examine-the-jakarta-rest-resource"><a class="anchor" href="#examine-the-jakarta-rest-resource"></a>Jakarta REST リソースの調査</h3>
<div class="paragraph">
<p>RESTエンドポイントを <code>src/main/java/org/acme/security/jwt/TokenSecuredResource.java</code> に以下の内容で作成します。</p>
</div>
<div class="listingblock">
<div class="title">REST エンドポイント V1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security.jwt;

import jakarta.annotation.security.PermitAll;
import jakarta.inject.Inject;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.InternalServerErrorException;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.Context;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.SecurityContext;

import org.eclipse.microprofile.jwt.JsonWebToken;

@Path("/secured")
public class TokenSecuredResource {

    @Inject
    JsonWebToken jwt; <i class="conum" data-value="1"></i><b>(1)</b>

    @GET
    @Path("permit-all")
    @PermitAll <i class="conum" data-value="2"></i><b>(2)</b>
    @Produces(MediaType.TEXT_PLAIN)
    public String hello(@Context SecurityContext ctx) {
        return getResponseString(ctx); <i class="conum" data-value="3"></i><b>(3)</b>
    }

    private String getResponseString(SecurityContext ctx) {
        String name;
        if (ctx.getUserPrincipal() == null) { <i class="conum" data-value="4"></i><b>(4)</b>
            name = "anonymous";
        } else if (!ctx.getUserPrincipal().getName().equals(jwt.getName())) { <i class="conum" data-value="5"></i><b>(5)</b>
            throw new InternalServerErrorException("Principal and JsonWebToken names do not match");
        } else {
            name = ctx.getUserPrincipal().getName(); <i class="conum" data-value="6"></i><b>(6)</b>
        }
        return String.format("hello %s,"
            + " isHttps: %s,"
            + " authScheme: %s,"
            + " hasJWT: %s",
            name, ctx.isSecure(), ctx.getAuthenticationScheme(), hasJwt()); <i class="conum" data-value="7"></i><b>(7)</b>
    }

    private boolean hasJwt() {
        return jwt.getClaimNames() != null;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>JsonWebToken</code> インターフェイスが挿入され、現在の認証済みトークンに関連付けられたクレームにアクセスできるようになります。このインターフェイスは <code>java.security.Principal</code> を継承します。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>@PermitAll</code> は標準の Jakarta セキュリティーアノテーションです。これは、認証されているかどうかに関係なく、指定されたエンドポイントがすべての呼び出し元からアクセスできることを示します。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Jakarta REST <code>SecurityContext</code> は、リクエストのセキュリティー状態を検査するために挿入されます。 <code>getResponseString()</code> 関数はレスポンスを生成します。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>リクエストのユーザー/呼び出し元の <code>Principal</code> を null と照合して、呼び出しが安全でないかどうかを確認します。</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>JsonWebToken</code> は現在の <code>Principal</code> を表すため、 <code>Principal</code> と <code>JsonWebToken</code> の名前が一致することを確認します。</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>Principal</code> の名前を取得します。</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>呼び出し元の名前、リクエスト <code>SecurityContext</code> の <code>isSecure()</code> および <code>getAuthenticationScheme()</code> の状態、および null 以外の <code>JsonWebToken</code> が挿入されたかどうかを含む応答を構築します。</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="run-application"><a class="anchor" href="#run-application"></a>アプリケーションを開発モードで実行する</h3>
<div class="paragraph">
<p>これで、次のいずれかのコマンドを使用して、アプリケーションを開発モードで実行する準備が整いました。</p>
</div>
<div class="listingblock primary asciidoc-tabs-sync-cli">
<div class="title">コマンドラインインタフェース</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus dev</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-maven">
<div class="title">Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:dev</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-gradle">
<div class="title">Gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./gradlew --console=plain quarkusDev</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、以下の例のような出力が表示されるはずです。</p>
</div>
<div class="listingblock">
<div class="title"><code>quarkus:dev</code> 出力</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[INFO] Scanning for projects...
[INFO]
[INFO] ----------------------&lt; org.acme:security-jwt-quickstart &gt;-----------------------
[INFO] Building security-jwt-quickstart 1.0.0-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
...
Listening for transport dt_socket at address: 5005
2020-07-15 16:09:50,883 INFO  [io.quarkus] (Quarkus Main Thread) security-jwt-quickstart 1.0.0-SNAPSHOT on JVM (powered by Quarkus 999-SNAPSHOT) started in 1.073s. Listening on: http://0.0.0.0:8080
2020-07-15 16:09:50,885 INFO  [io.quarkus] (Quarkus Main Thread) Profile dev activated. Live Coding activated.
2020-07-15 16:09:50,885 INFO  [io.quarkus] (Quarkus Main Thread) Installed features: [cdi, mutiny, rest, rest-jackson, security, smallrye-context-propagation, smallrye-jwt, vertx, vertx-web]</code></pre>
</div>
</div>
<div class="paragraph">
<p>REST エンドポイントが実行されているので、curl などのコマンドラインツールを使用してアクセスできます。</p>
</div>
<div class="listingblock">
<div class="title"><code>/secured/permit-all</code> の <code>curl</code> コマンド</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ curl http://127.0.0.1:8080/secured/permit-all; echo</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドは次の応答を返します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">hello anonymous, isHttps: false, authScheme: null, hasJWT: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>リクエストで JWT が提供されていないため、エンドポイントでセキュリティー状態が確認されることはなく、応答もそれと一致しています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>username</code> は匿名です。</p>
</li>
<li>
<p><code>https</code> が使用されていないため、 <code>isHttps</code> は <code>false</code> です。</p>
</li>
<li>
<p><code>authScheme</code> はnullです</p>
</li>
<li>
<p><code>hasJWT</code> は <code>false</code> です。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ctrl-Cを使用してQuarkusサーバーを停止します。</p>
</div>
<div class="paragraph">
<p>では実際に何かを保護してみましょう。下記の新しいエンドポイントメソッド <code>helloRolesAllowed</code> を見てみましょう。</p>
</div>
<div class="listingblock">
<div class="title">REST エンドポイント V2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security.jwt;

import jakarta.annotation.security.PermitAll;
import jakarta.annotation.security.RolesAllowed;
import jakarta.inject.Inject;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.InternalServerErrorException;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.Context;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.SecurityContext;

import org.eclipse.microprofile.jwt.JsonWebToken;

@Path("/secured")
public class TokenSecuredResource {

    @Inject
    JsonWebToken jwt; <i class="conum" data-value="1"></i><b>(1)</b>

    @GET
    @Path("permit-all")
    @PermitAll
    @Produces(MediaType.TEXT_PLAIN)
    public String hello(@Context SecurityContext ctx) {
        return getResponseString(ctx);
    }

    @GET
    @Path("roles-allowed") <i class="conum" data-value="2"></i><b>(2)</b>
    @RolesAllowed({ "User", "Admin" }) <i class="conum" data-value="3"></i><b>(3)</b>
    @Produces(MediaType.TEXT_PLAIN)
    public String helloRolesAllowed(@Context SecurityContext ctx) {
        return getResponseString(ctx) + ", birthdate: " + jwt.getClaim("birthdate").toString(); <i class="conum" data-value="4"></i><b>(4)</b>
    }

    private String getResponseString(SecurityContext ctx) {
        String name;
        if (ctx.getUserPrincipal() == null) {
            name = "anonymous";
        } else if (!ctx.getUserPrincipal().getName().equals(jwt.getName())) {
            throw new InternalServerErrorException("Principal and JsonWebToken names do not match");
        } else {
            name = ctx.getUserPrincipal().getName();
        }
        return String.format("hello %s,"
            + " isHttps: %s,"
            + " authScheme: %s,"
            + " hasJWT: %s",
            name, ctx.isSecure(), ctx.getAuthenticationScheme(), hasJwt());
    }

    private boolean hasJwt() {
        return jwt.getClaimNames() != null;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>JWT からのクレームにアクセスするために、 <code>JsonWebToken</code> が挿入されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>このエンドポイントは <code>/secured/roles-allowed</code> で公開されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>@RolesAllowed</code> アノテーションは、ユーザーまたは管理者のロールを持つユーザーへのアクセスを制限します。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>レスポンスは <code>hello</code> メソッドと同様に構築されますが、挿入された <code>JsonWebToken</code> から直接取得された <code>birthdate</code> クレームが追加されます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>TokenSecuredResource</code> にこれを追加した後、 <code>./mvnw quarkus:dev</code> コマンドを再実行し、 <code>curl -v <a href="http://127.0.0.1:8080/secured/roles-allowed" class="bare">http://127.0.0.1:8080/secured/roles-allowed</a>; echo</code> を実行して新しいエンドポイントへのアクセスを試みます。</p>
</div>
<div class="paragraph">
<p>出力は以下のようになるはずです:</p>
</div>
<div class="listingblock">
<div class="title">/secured/roles-allowed の curl コマンド</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ curl -v http://127.0.0.1:8080/secured/roles-allowed; echo</code></pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドは次の応答を返します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to 127.0.0.1 (127.0.0.1) port 8080 (#0)
&gt; GET /secured/roles-allowed HTTP/1.1
&gt; Host: 127.0.0.1:8080
&gt; User-Agent: curl/7.54.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 401 Unauthorized
&lt; Connection: keep-alive
&lt; Content-Type: text/html;charset=UTF-8
&lt; Content-Length: 14
&lt; Date: Sun, 03 Mar 2019 16:32:34 GMT
&lt;
* Connection #0 to host 127.0.0.1 left intact</code></pre>
</div>
</div>
<div class="paragraph">
<p>リクエストに JWT が指定されなかったため、エンドポイントへのアクセスが正しく拒否されました。
代わりに、HTTP 401 Unauthorized エラーが表示されました。</p>
</div>
<div class="paragraph">
<p>エンドポイントにアクセスするには、有効な JWT を取得してリクエストに含める必要があります。これには次の 2 つの手順が含まれます。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>JWT を検証するために必要な情報を含む SmallRye JWT エクステンションを設定する。</p>
</li>
<li>
<p>設定に一致する適切なクレームを含む JWT を生成する。</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="configuring-the-smallrye-jwt-extension-security-information"><a class="anchor" href="#configuring-the-smallrye-jwt-extension-security-information"></a>SmallRye JWT エクステンションのセキュリティー情報を設定する。</h3>
<div class="paragraph">
<p>次の内容で <code>security-jwt-quickstart/src/main/resources/application.properties</code> を作成します。</p>
</div>
<div class="listingblock">
<div class="title"><code>TokenSecuredResource</code> のアプリケーションプロパティー</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">mp.jwt.verify.publickey.location=publicKey.pem <i class="conum" data-value="1"></i><b>(1)</b>
mp.jwt.verify.issuer=https://example.com/issuer <i class="conum" data-value="2"></i><b>(2)</b>

quarkus.native.resources.includes=publicKey.pem <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>クラスパス上の公開鍵ファイル <code>publicKey.pem</code> の場所を指定します。
このキーの追加方法は <a href="#add-public-key">公開鍵の追加</a> を参照してください。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>発行者を <code><a href="https://example.com/issuer" class="bare">https://example.com/issuer</a></code> として定義します。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>publicKey.pem</code> ファイルがネイティブ実行可能ファイルのリソースとして含まれていることを確認します。</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="add-public-key"><a class="anchor" href="#add-public-key"></a>公開鍵の追加</h3>
<div class="paragraph">
<p><a href="https://tools.ietf.org/html/rfc7519">JWT 仕様</a> では、使用できる JWT のさまざまなセキュリティーレベルが定義されています。
MicroProfile JWT RBAC 仕様では、RSA-256 署名アルゴリズムで署名された JWT が必要です。
これには、RSA 公開鍵ペアが必要になります。
REST エンドポイントサーバー側では、リクエストとともに送信された JWT を検証するために使用する RSA 公開鍵の場所を設定する必要があります。
以前に設定された <code>mp.jwt.verify.publickey.location=publicKey.pem</code> 設定では、公開鍵がクラスパス上で <code>publicKey.pem</code> として使用可能であることが想定されています。
これを実現するには、次のコンテンツを <code>security-jwt-quickstart/src/main/resources/publicKey.pem</code> ファイルにコピーします。</p>
</div>
<div class="listingblock">
<div class="title">RSA 公開鍵 PEM コンテンツ</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAlivFI8qB4D0y2jy0CfEq
Fyy46R0o7S8TKpsx5xbHKoU1VWg6QkQm+ntyIv1p4kE1sPEQO73+HY8+Bzs75XwR
TYL1BmR1w8J5hmjVWjc6R2BTBGAYRPFRhor3kpM6ni2SPmNNhurEAHw7TaqszP5e
UF/F9+KEBWkwVta+PZ37bwqSE4sCb1soZFrVz/UT/LF4tYpuVYt3YbqToZ3pZOZ9
AX2o1GCG3xwOjkc4x0W7ezbQZdC9iftPxVHR8irOijJRRjcPDtA6vPKpzLl6CyYn
sIYPd99ltwxTHjr3npfv/3Lw50bAkbT4HeLFxTx4flEoZLKO/g0bAoV2uqBhkA9x
nQIDAQAB
-----END PUBLIC KEY-----</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="generating-a-jwt"><a class="anchor" href="#generating-a-jwt"></a>JWT の生成</h3>
<div class="paragraph">
<p>多くの場合、JWT は <a href="https://www.keycloak.org/">Keycloak</a> などのアイデンティティーマネージャーから取得されます。
ただし、このクイックスタートでは、 <code>smallrye-jwt</code> によって提供される JWT 生成 API を使用して独自の JWT を生成します。
詳細は、<a href="security-jwt-build">SmallRye JWT を使用して JWT トークンを生成する</a> を参照してください。</p>
</div>
<div class="paragraph">
<p>次のリストからコードを取得し、 <code>security-jwt-quickstart/src/test/java/org/acme/security/jwt/GenerateToken.java</code> に配置します。</p>
</div>
<div class="listingblock">
<div class="title"><code>GenerateToken</code> メインドライバークラス</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security.jwt;

import java.util.Arrays;
import java.util.HashSet;

import org.eclipse.microprofile.jwt.Claims;
import io.smallrye.jwt.build.Jwt;

/**
 * A utility class to generate and print a JWT token string to stdout.
 */
public class GenerateToken {

    /**
     * Generates and prints a JWT token.
     */
    public static void main(String[] args) {
        String token = Jwt.issuer("https://example.com/issuer") <i class="conum" data-value="1"></i><b>(1)</b>
                .upn("jdoe@quarkus.io") <i class="conum" data-value="2"></i><b>(2)</b>
                .groups(new HashSet&lt;&gt;(Arrays.asList("User", "Admin"))) <i class="conum" data-value="3"></i><b>(3)</b>
                .claim(Claims.birthdate.name(), "2001-07-13") <i class="conum" data-value="4"></i><b>(4)</b>
                .sign();

        System.out.println(token);
        System.exit(0);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>JWT に <code>iss</code> (発行者) クレームを設定します。
トークンが有効と見なされるためには、この値がサーバー側の <code>mp.jwt.verify.issuer</code> 設定と一致する必要があります。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>upn</code> (ユーザープリンシパル名) クレームを指定します。MicroProfile JWT RBAC 仕様では、コンテナーセキュリティー API で <code>Principal</code> を識別するための推奨クレームとして定義されています。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>JWT ベアラーに割り当てられたグループメンバーシップと最上位レベルのロールを提供する <code>groups</code> クレームを定義します。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>birthdate</code> クレームを追加します。
これは機密情報とみなされる可能性があるため、<a href="security-jwt-build">SmallRye JWT を使用して JWT トークンを生成する</a> で説明されているようにクレームを暗号化することを検討してください。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>このコードが機能するには、 <code>TokenSecuredResource</code> アプリケーションにある公開鍵に対応する RSA 秘密鍵の内容が必要であることに注意してください。
次の PEM コンテンツを取得して、 <code>security-jwt-quickstart/src/test/resources/privateKey.pem</code> に配置します。</p>
</div>
<div class="listingblock">
<div class="title">RSA 秘密鍵 PEM コンテンツ</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCWK8UjyoHgPTLa
PLQJ8SoXLLjpHSjtLxMqmzHnFscqhTVVaDpCRCb6e3Ii/WniQTWw8RA7vf4djz4H
OzvlfBFNgvUGZHXDwnmGaNVaNzpHYFMEYBhE8VGGiveSkzqeLZI+Y02G6sQAfDtN
qqzM/l5QX8X34oQFaTBW1r49nftvCpITiwJvWyhkWtXP9RP8sXi1im5Vi3dhupOh
nelk5n0BfajUYIbfHA6ORzjHRbt7NtBl0L2J+0/FUdHyKs6KMlFGNw8O0Dq88qnM
uXoLJiewhg9332W3DFMeOveel+//cvDnRsCRtPgd4sXFPHh+UShkso7+DRsChXa6
oGGQD3GdAgMBAAECggEAAjfTSZwMHwvIXIDZB+yP+pemg4ryt84iMlbofclQV8hv
6TsI4UGwcbKxFOM5VSYxbNOisb80qasb929gixsyBjsQ8284bhPJR7r0q8h1C+jY
URA6S4pk8d/LmFakXwG9Tz6YPo3pJziuh48lzkFTk0xW2Dp4SLwtAptZY/+ZXyJ6
96QXDrZKSSM99Jh9s7a0ST66WoxSS0UC51ak+Keb0KJ1jz4bIJ2C3r4rYlSu4hHB
Y73GfkWORtQuyUDa9yDOem0/z0nr6pp+pBSXPLHADsqvZiIhxD/O0Xk5I6/zVHB3
zuoQqLERk0WvA8FXz2o8AYwcQRY2g30eX9kU4uDQAQKBgQDmf7KGImUGitsEPepF
KH5yLWYWqghHx6wfV+fdbBxoqn9WlwcQ7JbynIiVx8MX8/1lLCCe8v41ypu/eLtP
iY1ev2IKdrUStvYRSsFigRkuPHUo1ajsGHQd+ucTDf58mn7kRLW1JGMeGxo/t32B
m96Af6AiPWPEJuVfgGV0iwg+HQKBgQCmyPzL9M2rhYZn1AozRUguvlpmJHU2DpqS
34Q+7x2Ghf7MgBUhqE0t3FAOxEC7IYBwHmeYOvFR8ZkVRKNF4gbnF9RtLdz0DMEG
5qsMnvJUSQbNB1yVjUCnDAtElqiFRlQ/k0LgYkjKDY7LfciZl9uJRl0OSYeX/qG2
tRW09tOpgQKBgBSGkpM3RN/MRayfBtmZvYjVWh3yjkI2GbHA1jj1g6IebLB9SnfL
WbXJErCj1U+wvoPf5hfBc7m+jRgD3Eo86YXibQyZfY5pFIh9q7Ll5CQl5hj4zc4Y
b16sFR+xQ1Q9Pcd+BuBWmSz5JOE/qcF869dthgkGhnfVLt/OQzqZluZRAoGAXQ09
nT0TkmKIvlza5Af/YbTqEpq8mlBDhTYXPlWCD4+qvMWpBII1rSSBtftgcgca9XLB
MXmRMbqtQeRtg4u7dishZVh1MeP7vbHsNLppUQT9Ol6lFPsd2xUpJDc6BkFat62d
Xjr3iWNPC9E9nhPPdCNBv7reX7q81obpeXFMXgECgYEAmk2Qlus3OV0tfoNRqNpe
Mb0teduf2+h3xaI1XDIzPVtZF35ELY/RkAHlmWRT4PCdR0zXDidE67L6XdJyecSt
FdOUH8z5qUraVVebRFvJqf/oGsXc4+ex1ZKUTbY0wqY1y9E39yvB3MaTmZFuuqk8
f3cg+fr8aou7pr9SHhJlZCU=
-----END PRIVATE KEY-----</code></pre>
</div>
</div>
<div class="paragraph">
<p>後で、 <code>smallrye.jwt.sign.key.location</code> プロパティーを設定して、秘密署名鍵の場所を指定します。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">OpenSSL でのキーの生成</div>
<div class="paragraph">
<p>OpenSSL コマンドラインツールを使用して公開鍵と秘密鍵のペアを生成することもできます。</p>
</div>
<div class="listingblock">
<div class="title">キーを生成するための <code>openssl</code> コマンド</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">openssl genrsa -out rsaPrivateKey.pem 2048
openssl rsa -pubout -in rsaPrivateKey.pem -out publicKey.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>秘密鍵を生成し、安全なキーの保管と転送に一般的に使用される PKCS#8 形式に変換するには、追加の手順が必要です。</p>
</div>
<div class="listingblock">
<div class="title">変換用の `openssl`コマンド</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">openssl pkcs8 -topk8 -nocrypt -inform pem -in rsaPrivateKey.pem -outform pem -out privateKey.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>このクイックスタートで使用されているキーペアの代わりに、生成されたキーペアを使用できます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>TokenSecuredResource</code> エンドポイントの JSON Web Token (JWT) を生成する前に <a href="#run-application">application is running</a> であることを確認します。</p>
</div>
<div class="paragraph">
<p>次に、次のコマンドを使用して JWT を生成します。</p>
</div>
<div class="listingblock">
<div class="title">JWT 生成の出力例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ mvn exec:java -Dexec.mainClass=org.acme.security.jwt.GenerateToken -Dexec.classpathScope=test -Dsmallrye.jwt.sign.key.location=privateKey.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>JWT 文字列は、 <code>.</code> 文字で区切られた 3 つの部分が含まれる Base64 URL エンコードされた文字列です。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>署名アルゴリズムなどのトークンに関するメタデータが含まれるヘッダー。</p>
</li>
<li>
<p>ペイロードはクレームとも呼ばれ、トークンのクレームまたはデータが含まれます。</p>
</li>
<li>
<p>トークンの整合性を検証する署名。</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="finally-secured-access-to-securedroles-allowed"><a class="anchor" href="#finally-secured-access-to-securedroles-allowed"></a>/secured/roles-allowed へのセキュリティーで保護されたアクセス</h3>
<div class="paragraph">
<p>ここで、これを使用して、 <code>/secured/roles-allowed</code> エンドポイントにセキュリティー保護されたリクエストを送信してみましょう。
Quarkus サーバーが開発モードで実行されていることを確認してから、次のコマンドを実行し、前の手順で生成された JWT のバージョンを必ず使用します。</p>
</div>
<div class="listingblock">
<div class="title">JWT を含む /secured/roles-allowed の curl コマンド</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ curl -H "Authorization: Bearer eyJraWQ..." http://127.0.0.1:8080/secured/roles-allowed; echo</code></pre>
</div>
</div>
<div class="paragraph">
<p>生成されたトークンを HTTP 認可 Bearer スキームの値として必ず使用してください。</p>
</div>
<div class="paragraph">
<p>このコマンドは次の応答を返します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">hello jdoe@quarkus.io, isHttps: false, authScheme: Bearer, hasJWT: true, birthdate: 2001-07-13</code></pre>
</div>
</div>
<div class="paragraph">
<p>正常に完了しました。これで次のようになりました。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>匿名でない発信者名: <code>jdoe@quarkus.io</code></p>
</li>
<li>
<p>認証スキーム: <code>Bearer</code></p>
</li>
<li>
<p>null 以外の <code>JsonWebToken</code></p>
</li>
<li>
<p><code>birthdate</code> クレーム値</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="using-the-jsonwebtoken-and-claim-injection"><a class="anchor" href="#using-the-jsonwebtoken-and-claim-injection"></a><code>JsonWebToken</code> とクレームインジェクションの使用</h3>
<div class="paragraph">
<p>これで、セキュリティー保護された REST エンドポイントにアクセスするための JWT を生成できるようになりました。次に、 <code>JsonWebToken</code> インターフェイスと JWT クレームを使用して何ができるかを見てみましょう。
<code>org.eclipse.microprofile.jwt.JsonWebToken</code> インターフェイスは <code>java.security.Principal</code> インターフェイスを継承し、以前に使用した <code>jakarta.ws.rs.core.SecurityContext#getUserPrincipal()</code> 呼び出しによって返されるオブジェクトタイプです。
つまり、CDI を使用しくても REST コンテナー <code>SecurityContext</code> にアクセスできるコードは、 <code>SecurityContext#getUserPrincipal()</code> をキャストすることで、呼び出し元の <code>JsonWebToken</code> インターフェイスを取得できます。</p>
</div>
<div class="paragraph">
<p><code>JsonWebToken</code> インターフェイスは、基盤となる JWT のクレームにアクセスするためのメソッドを定義します。これは、JWT に存在する可能性のある MicroProfile JWT RBAC 仕様および任意のクレームで必要な一般的クレームのアクセッサを提供します。。</p>
</div>
<div class="paragraph">
<p>すべての JWT クレームを挿入することもできます。
 (<code>JsonWebToken</code> から取得するのではなく) <code>TokenSecuredResource</code> を、挿入された <code>birthdate</code> クレームを使用する別のエンドポイント <code>/secured/roles-allowed-admin</code> で継承してみましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security.jwt;

import jakarta.annotation.security.PermitAll;
import jakarta.annotation.security.RolesAllowed;
import jakarta.enterprise.context.RequestScoped;
import jakarta.inject.Inject;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.InternalServerErrorException;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.Context;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.SecurityContext;

import org.eclipse.microprofile.jwt.Claim;
import org.eclipse.microprofile.jwt.Claims;
import org.eclipse.microprofile.jwt.JsonWebToken;

@Path("/secured")
@RequestScoped <i class="conum" data-value="1"></i><b>(1)</b>
public class TokenSecuredResource {

    @Inject
    JsonWebToken jwt; <i class="conum" data-value="2"></i><b>(2)</b>
    @Inject
    @Claim(standard = Claims.birthdate)
    String birthdate; <i class="conum" data-value="3"></i><b>(3)</b>

    @GET
    @Path("permit-all")
    @PermitAll
    @Produces(MediaType.TEXT_PLAIN)
    public String hello(@Context SecurityContext ctx) {
        return getResponseString(ctx);
    }

    @GET
    @Path("roles-allowed")
    @RolesAllowed({ "User", "Admin" })
    @Produces(MediaType.TEXT_PLAIN)
    public String helloRolesAllowed(@Context SecurityContext ctx) {
        return getResponseString(ctx) + ", birthdate: " + jwt.getClaim("birthdate").toString();
    }

    @GET
    @Path("roles-allowed-admin")
    @RolesAllowed("Admin")
    @Produces(MediaType.TEXT_PLAIN)
    public String helloRolesAllowedAdmin(@Context SecurityContext ctx) {
        return getResponseString(ctx) + ", birthdate: " + birthdate; <i class="conum" data-value="4"></i><b>(4)</b>
    }

    private String getResponseString(SecurityContext ctx) {
        String name;
        if (ctx.getUserPrincipal() == null) {
            name = "anonymous";
        } else if (!ctx.getUserPrincipal().getName().equals(jwt.getName())) {
            throw new InternalServerErrorException("Principal and JsonWebToken names do not match");
        } else {
            name = ctx.getUserPrincipal().getName();
        }
        return String.format("hello %s,"
            + " isHttps: %s,"
            + " authScheme: %s,"
            + " hasJWT: %s",
            name, ctx.isSecure(), ctx.getAuthenticationScheme(), hasJwt());
    }

    private boolean hasJwt() {
        return jwt.getClaimNames() != null;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>birthdate</code> クレームを <code>String</code> として挿入できるようにするには、 <code>@RequestScoped</code> スコープが必要です。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ここで <code>JsonWebToken</code> が挿入され、すべてのクレームと JWT 関連情報へのアクセスが提供されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>birthdate</code> クレームは <code>String</code> として挿入されます。これにより、 <code>@RequestScoped</code> スコープが必須である理由が強調されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>挿入された <code>birthdate</code> クレームは、応答を構築するために直接使用されます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次に、トークンを再度生成して実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ curl -H "Authorization: Bearer eyJraWQ..." http://127.0.0.1:8080/secured/roles-allowed-admin; echo</code></pre>
</div>
</div>
<div class="paragraph">
<p>生成されたトークンを HTTP 認可 Bearer スキームの値として必ず使用してください。</p>
</div>
<div class="paragraph">
<p>このコマンドは次の応答を返します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">hello jdoe@quarkus.io, isHttps: false, authScheme: Bearer, hasJWT: true, birthdate: 2001-07-13</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="run-the-application-in-jvm-mode"><a class="anchor" href="#run-the-application-in-jvm-mode"></a>JVM モードでアプリケーションを実行する</h3>
<div class="paragraph">
<p>アプリケーションを標準の Java アプリケーションとして実行できます。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>アプリケーションをコンパイルします:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock primary asciidoc-tabs-sync-cli">
<div class="title">コマンドラインインタフェース</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus build</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-maven">
<div class="title">Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw install</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-gradle">
<div class="title">Gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./gradlew build</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>アプリケーションの実行:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">java -jar target/quarkus-app/quarkus-run.jar</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="run-the-application-in-native-mode"><a class="anchor" href="#run-the-application-in-native-mode"></a>ネイティブ・モードでアプリケーションを実行</h3>
<div class="paragraph">
<p>この同じデモを、変更を加えることなくネイティブモードにコンパイルできます。
つまり、実稼働環境に JVM をインストールする必要はありません。
ランタイムテクノロジーは生成されたバイナリーに組み込まれ、最小限のリソースで実行できるように最適化されています。</p>
</div>
<div class="paragraph">
<p>コンパイルには少し時間がかかるため、この手順はデフォルトで無効になっています。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>native</code> プロファイルを有効にして、アプリケーションを再度ビルドします。</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock primary asciidoc-tabs-sync-cli">
<div class="title">コマンドラインインタフェース</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus build --native</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-maven">
<div class="title">Maven</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw install -Dnative</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-sync-gradle">
<div class="title">Gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./gradlew build -Dquarkus.native.enabled=true</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>次のバイナリーを直接実行します。</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./target/security-jwt-quickstart-1.0.0-SNAPSHOT-runner</code></pre>
</div>
</div>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="explore-the-solution"><a class="anchor" href="#explore-the-solution"></a>ソリューションの探索</h3>
<div class="paragraph">
<p><code>security-jwt-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/3.27/security-jwt-quickstart">directory</a> リポジトリには、このクイックスタートガイドで扱うすべてのバージョンが含まれており、さらに CDI API を使用して <code>JsonWebToken</code> トークンとそのクレームを注入し、サブリソースを示す追加のエンドポイントも含まれています。</p>
</div>
<div class="paragraph">
<p>`security-jwt-quickstart`ディレクトリーでクイックスタートソリューションを確認し、SmallRye JWT エクステンションの機能に関する情報を学習することを推奨します。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reference-guide"><a class="anchor" href="#reference-guide"></a>リファレンスガイド</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="supported-injection-scopes"><a class="anchor" href="#supported-injection-scopes"></a>サポートされている注入スコープ</h3>
<div class="paragraph">
<p><code>org.eclipse.microprofile.jwt.JsonWebToken</code> が注入される場合、 <code>@ApplicationScoped</code>、 <code>@Singleton</code>、および <code>@RequestScoped</code> の外部 Bean 注入スコープがすべてサポートされます。また、現在のトークンが示されていることを確認するために、 <code>JsonWebToken</code> の <code>@RequestScoped</code> スコープが適用されます。</p>
</div>
<div class="paragraph">
<p>ただし、個々のトークンクレームが <code>String</code> などの単純な型として挿入される場合は、 <code>@RequestScoped</code> を使用する必要があります。以下はその例です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security.jwt;

import jakarta.inject.Inject;
import org.eclipse.microprofile.jwt.Claim;
import org.eclipse.microprofile.jwt.Claims;

@Path("/secured")
@RequestScoped
public class TokenSecuredResource {

    @Inject
    @Claim(standard = Claims.birthdate)
    String birthdate;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>注入された <code>JsonWebToken</code> を使用して個々のクレームにアクセスすることもできますが、この場合は <code>@RequestScoped</code> を設定する必要はありません。</p>
</div>
<div class="paragraph">
<p>詳細については、 <a href="https://download.eclipse.org/microprofile/microprofile-jwt-auth-1.2/microprofile-jwt-auth-spec-1.2.html#_cdi_injection_requirements">MP JWT CDI 注入要件</a> を参照してください。</p>
</div>
</div>
<div class="sect2">
<h3 id="supported-public-key-formats"><a class="anchor" href="#supported-public-key-formats"></a>サポートされている公開鍵形式</h3>
<div class="paragraph">
<p>公開鍵は、優先順位に従って、次のいずれかの形式でフォーマットできます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Public Key Cryptography Standards #8 (PKCS#8) PEM</p>
</li>
<li>
<p>JSON Web Key (JWK)</p>
</li>
<li>
<p>JSON Web Key Set (JWKS)</p>
</li>
<li>
<p>JSON Web Key (JWK) Base64 URL エンコード</p>
</li>
<li>
<p>JSON Web Key Set (JWKS) Base64 URL エンコード</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="dealing-with-verification-keys"><a class="anchor" href="#dealing-with-verification-keys"></a>検証鍵の扱い</h3>
<div class="paragraph">
<p>非対称 RSA または楕円曲線 (EC) 鍵を使用してトークンの署名を検証する必要がある場合は、 <code>mp.jwt.verify.publickey.location</code> プロパティーを使用してローカルまたはリモートの検証鍵を参照します。</p>
</div>
<div class="paragraph">
<p><code>mp.jwt.verify.publickey.algorithm</code> を使用して検証アルゴリズムをカスタマイズします (デフォルトは <code>RS256</code>)。たとえば、EC 鍵を操作する場合は <code>ES256</code> に設定します。</p>
</div>
<div class="paragraph">
<p>対称秘密鍵を使用してトークン署名を検証する必要がある場合は、JSON Web 鍵 (JWK) または JSON Web 鍵セット (JWK セット) 形式のいずれかを使用して、この秘密鍵を表す必要があります。以下はその例です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
 "keys": [
   {
     "kty":"oct",
     "kid":"secretKey",
     "k":"AyM1SysPpbyDfgZld3umj1qzKObwVMkoqQ-EstJQLr_T-1qS0gZH75aKtMN3Yj0iPS4hcgUuTwjAzZr1Z9CAow"
   }
 ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>この秘密鍵 JWK は、 <code>smallrye.jwt.verify.key.location</code> でも参照する必要があります。
<code>smallrye.jwt.verify.algorithm</code> は <code>HS256</code>/<code>HS384</code>/<code>HS512</code> に設定する必要があります。</p>
</div>
</div>
<div class="sect2">
<h3 id="jwt-parser"><a class="anchor" href="#jwt-parser"></a>JWTParser を使用した JsonWebToken の解析と検証</h3>
<div class="paragraph">
<p>JWT トークンを挿入できない場合、たとえば、サービスリクエストペイロードに埋め込まれていたり、サービスエンドポイントが帯域外でトークンを取得する場合、 <code>JWTParser</code> を使用できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.eclipse.microprofile.jwt.JsonWebToken;
import io.smallrye.jwt.auth.principal.JWTParser;
...
@Inject JWTParser parser;

String token = getTokenFromOidcServer();

// Parse and verify the token
JsonWebToken jwt = parser.parse(token);</code></pre>
</div>
</div>
<div class="paragraph">
<p>また、トークンの検証方法や復号化方法をカスタマイズするためにも使用できます。
たとえば、ローカルの <code>SecretKey</code> を指定できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.security.jwt;

import io.smallrye.jwt.auth.principal.ParseException;
import jakarta.inject.Inject;
import jakarta.ws.rs.CookieParam;
import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import jakarta.ws.rs.Produces;
import jakarta.ws.rs.core.NewCookie;
import jakarta.ws.rs.core.Response;
import org.eclipse.microprofile.jwt.JsonWebToken;
import io.smallrye.jwt.auth.principal.JWTParser;
import io.smallrye.jwt.build.Jwt;

@Path("/secured")
public class SecuredResource {
    private static final String SECRET = "AyM1SysPpbyDfgZld3umj1qzKObwVMko";

    @Inject
    JWTParser parser;

    @GET
    @Produces("text/plain")
    public Response getUserName(@CookieParam("jwt") String jwtCookie) throws ParseException {
        if (jwtCookie == null) {
            // Create a JWT token signed by using the 'HS256' algorithm
            String newJwtCookie = Jwt.upn("Alice").signWithSecret(SECRET);
            // or create a JWT token encrypted by using the 'A256KW' algorithm
            // Jwt.upn("alice").encryptWithSecret(secret);
            return Response.ok("Alice").cookie(new NewCookie("jwt", newJwtCookie)).build();
        } else {
            // All mp.jwt and smallrye.jwt properties are still effective; only the verification key is customized.
            JsonWebToken jwt = parser.verify(jwtCookie, SECRET);
            // or jwt = parser.decrypt(jwtCookie, secret);
            return Response.ok(jwt.getName()).build();
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>quarkus-smallrye-jwt</code> で提供される <code>HTTP</code> サポートなしで <code>JWTParser</code> を使用する方法については、<a href="#add-smallrye-jwt">How to Add SmallRye JWT directly</a> セクションも参照してください。</p>
</div>
</div>
<div class="sect2">
<h3 id="token-decryption"><a class="anchor" href="#token-decryption"></a>トークン復号化</h3>
<div class="paragraph">
<p>アプリケーションが暗号化されたクレームまたは暗号化された内部署名付きクレームを含むトークンを受け入れる必要がある場合は、復号化キーを指すように <code>smallrye.jwt.decrypt.key.location</code> プロパティーを設定するだけです。</p>
</div>
<div class="paragraph">
<p>この鍵プロパティのみが設定されている場合、受信トークンには暗号化クレームのみが含まれる必要があります。 <code>mp.jwt.verify.publickey</code> または <code>mp.jwt.verify.publickey.location</code> のいずれかの検証プロパティーも設定されている場合、受信トークンには暗号化、内部署名付きトークンが含まれている必要があります。</p>
</div>
<div class="paragraph">
<p><a href="security-jwt-build">SmallRye JWT を使用した JWT トークンの生成</a> を参照して、暗号化されたトークンまたは内部署名されたトークンをすばやく生成して暗号化する方法を学習します。</p>
</div>
</div>
<div class="sect2">
<h3 id="custom-factories"><a class="anchor" href="#custom-factories"></a>カスタムファクトリー</h3>
<div class="paragraph">
<p><code>io.smallrye.jwt.auth.principal.DefaultJWTCallerPrincipalFactory</code> は、JWT トークンを解析および検証し、 <code>JsonWebToken</code> プリンシパルに変換するために使用されるデフォルトの実装です。このファクトリーは、 <code>Configuration</code> セクションで説明されているように、 <code>MP JWT</code> および <code>smallrye-jwt</code> プロパティーに依存して、JWT トークンを検証およびカスタマイズします。</p>
</div>
<div class="paragraph">
<p>ファイアウォールによってすでに検証されているトークンの再検証をスキップするなど、カスタムファクトリーを実装する必要がある場合は、次のいずれかの方法で実装できます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>META-INF/services/io.smallrye.jwt.auth.principal.JWTCallerPrincipalFactory</code> リソースを作成して、 <code>ServiceLoader</code> メカニズムを使用します。</p>
</li>
<li>
<p>以下の例のように、 <code>Alternative</code> CDI Bean 実装を提供します。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import java.nio.charset.StandardCharsets;
import java.util.Base64;
import jakarta.annotation.Priority;
import jakarta.enterprise.context.ApplicationScoped;
import jakarta.enterprise.inject.Alternative;
import org.jose4j.jwt.JwtClaims;
import org.jose4j.jwt.consumer.InvalidJwtException;
import io.smallrye.jwt.auth.principal.DefaultJWTCallerPrincipal;
import io.smallrye.jwt.auth.principal.JWTAuthContextInfo;
import io.smallrye.jwt.auth.principal.JWTCallerPrincipal;
import io.smallrye.jwt.auth.principal.JWTCallerPrincipalFactory;
import io.smallrye.jwt.auth.principal.ParseException;

@ApplicationScoped
@Alternative
@Priority(1)
public class TestJWTCallerPrincipalFactory extends JWTCallerPrincipalFactory {

    @Override
    public JWTCallerPrincipal parse(String token, JWTAuthContextInfo authContextInfo) throws ParseException {
        try {
            // Token has already been verified; parse the token claims only
            String json = new String(Base64.getUrlDecoder().decode(token.split("\\.")[1]), StandardCharsets.UTF_8);
            return new DefaultJWTCallerPrincipal(JwtClaims.parse(json));
        } catch (InvalidJwtException ex) {
            throw new ParseException(ex.getMessage());
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="blocking-calls"><a class="anchor" href="#blocking-calls"></a>ブロッキング呼出</h3>
<div class="paragraph">
<p><code>quarkus-smallrye-jwt</code> エクステンションでは、現在リアクティブではない <a href="https://github.com/smallrye/smallrye-jwt">SmallRye JWT</a> ライブラリを使用します。</p>
</div>
<div class="paragraph">
<p>`quarkus-smallrye-jwt`がリアクティブな Quarkus セキュリティーアーキテクチャーの一部として動作する観点からすると、<a href="https://github.com/smallrye/smallrye-jwt">SmallRye JWT</a> 検証または復号化コードに入る IO スレッドが、以下のいずれかのケースでブロックされる可能性があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>デフォルトのキーリゾルバーが、OIDCエンドポイントへのリモートコールを伴うキーを含む <code>JsonWebKey</code> セットを更新します</p>
</li>
<li>
<p>AWS Application Load Balancer (ALB) キーリゾルバーなどのカスタムキーリゾルバーは、現在のトークンのキー識別子ヘッダー値を使用して、AWS ALB キーエンドポイントに対してキーを解決します。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>このような場合、接続が遅い場合 (たとえば、キーエンドポイントへの応答に 3 秒以上かかる場合)、現在のイベントループスレッドがブロックされる可能性があります。</p>
</div>
<div class="paragraph">
<p>ブロックされないようにするには、 <code>quarkus.smallrye-jwt.blocking-authentication=true</code> を設定します。</p>
</div>
</div>
<div class="sect2">
<h3 id="token-propagation"><a class="anchor" href="#token-propagation"></a>トークンの伝播</h3>
<div class="paragraph">
<p>下流サービスへのベアラアクセストークンの伝播については、<a href="security-openid-connect-client-reference#token-propagation-rest">トークン伝播</a> の項を参照してください。</p>
</div>
</div>
<div class="sect2">
<h3 id="integration-testing"><a class="anchor" href="#integration-testing"></a>テスト</h3>
<div class="sect3">
<h4 id="auto-generated-keys"><a class="anchor" href="#auto-generated-keys"></a>Automatic key generation</h4>
<div class="paragraph">
<p>This extension generates an asymmetric RSA 2024 bit signing key pair in the dev and test modes if the verification key has not been configured.
Once the key pair is generated, the public RSA key is used to configure the <code>mp.jwt.verify.publickey</code> property, and the RSA private key is available to tests to sign tokens using <code>smallrye-jwt-build</code>, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.smallrye.jwt.build.Jwt;
import jakarta.ws.rs.GET;

@GET
public String token() {
   return Jwt.upn("Alice").sign();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="security-jwt-build#sign-claims">signing claims guide</a> for mode details.</p>
</div>
<div class="paragraph">
<p>You can disable automatic key generation by setting at least one of the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mp.jwt.verify.publickey.location</code></p>
</li>
<li>
<p><code>mp.jwt.verify.publickey</code></p>
</li>
<li>
<p><code>mp.jwt.decrypt.key.location</code></p>
</li>
<li>
<p><code>smallrye.jwt.encrypt.key.location</code></p>
</li>
<li>
<p><code>smallrye.jwt.sign.key.location</code></p>
</li>
<li>
<p><code>smallrye.jwt.sign.key</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In <strong>dev</strong> mode, if you do not explicitly configure the issuer using the <code>mp.jwt.verify.issuer</code> property, the SmallRye JWT extension will set a default issuer of <code><a href="https://quarkus.io/issuer" class="bare">https://quarkus.io/issuer</a></code>.</p>
</div>
<div class="paragraph">
<p>If you prefer to configure the issuer programmatically, set <code>mp.jwt.verify.issuer</code> to <code>NONE</code> to prevent the default value from being applied.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="integration-testing-wiremock"><a class="anchor" href="#integration-testing-wiremock"></a>Wiremock</h4>
<div class="paragraph">
<p><code>mp.jwt.verify.publickey.location</code> を HTTPS または HTTP ベースの JsonWebKey (JWK) セットを指すように設定する場合は、<a href="security-oidc-bearer-token-authentication#bearer-token-integration-testing">OpenID Connect Bearer Token Integration testing</a> <code>Wiremock</code> セクションで説明されているのと同じアプローチを使用できますが、代わりに MP JWT 設定プロパティーを使用するように <code>application.properties</code> のみを変更します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># keycloak.url is set by OidcWiremockTestResource
mp.jwt.verify.publickey.location=${keycloak.url}/realms/quarkus/protocol/openid-connect/certs
mp.jwt.verify.issuer=${keycloak.url}/realms/quarkus</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="integration-testing-keycloak"><a class="anchor" href="#integration-testing-keycloak"></a>Keycloak</h4>
<div class="paragraph">
<p>Keycloak を使用していて、 <code>mp.jwt.verify.publickey.location</code> を HTTPS または HTTP ベースの JsonWebKey (JWK) セットを指すように設定する場合は、<a href="security-oidc-bearer-token-authentication#bearer-token-integration-testing">OpenID Connect Bearer Token Integration testing</a> Keycloak セクションで説明されているのと同じアプローチを使用できますが、代わりに MP JWT 設定プロパティーを使用するように <code>application.properties</code> のみを変更します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># keycloak.url is set by DevServices for Keycloak
mp.jwt.verify.publickey.location=${keycloak.url}/realms/quarkus/protocol/openid-connect/certs
mp.jwt.verify.issuer=${keycloak.url}/realms/quarkus</code></pre>
</div>
</div>
<div class="paragraph">
<p>Keycloakが発行したトークンは、レルムエンドポイントアドレスが <code>iss</code> （発行者）クレームに設定されていることに注目してください。</p>
</div>
<div class="paragraph">
<p>Quarkus アプリケーションが Docker コンテナー内で実行される場合、DevServices for Keycloak によって起動された Keycloak コンテナーとネットワークインターフェイスを共有する可能性があります。
このシナリオでは、Quarkus アプリケーションと Keycloak は内部の共有 Docker ネットワークを介して通信します。</p>
</div>
<div class="paragraph">
<p>そのような場合は、代わりに以下のような設定にしてください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># keycloak.url is set by DevServices for Keycloak,
# Quarkus accesses it through an internal shared docker network interface.
mp.jwt.verify.publickey.location=${keycloak.url}/realms/quarkus/protocol/openid-connect/certs

# Issuer is set to the docker bridge localhost endpoint address represented by the `client.quarkus.oidc.auth-server-url` property
mp.jwt.verify.issuer=${client.quarkus.oidc.auth-server-url}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="integration-testing-public-key"><a class="anchor" href="#integration-testing-public-key"></a>ローカル公開鍵</h4>
<div class="paragraph">
<p><a href="security-oidc-bearer-token-authentication#bearer-token-integration-testing">OpenID Connect Bearer Token Integration testing</a> <code>Local public key</code> セクションで説明されているのと同じアプローチを使用できますが、代わりに MP JWT 設定プロパティーを使用するように <code>application.properties</code> のみを変更します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">mp.jwt.verify.publickey=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAlivFI8qB4D0y2jy0CfEqFyy46R0o7S8TKpsx5xbHKoU1VWg6QkQm+ntyIv1p4kE1sPEQO73+HY8+Bzs75XwRTYL1BmR1w8J5hmjVWjc6R2BTBGAYRPFRhor3kpM6ni2SPmNNhurEAHw7TaqszP5eUF/F9+KEBWkwVta+PZ37bwqSE4sCb1soZFrVz/UT/LF4tYpuVYt3YbqToZ3pZOZ9AX2o1GCG3xwOjkc4x0W7ezbQZdC9iftPxVHR8irOijJRRjcPDtA6vPKpzLl6CyYnsIYPd99ltwxTHjr3npfv/3Lw50bAkbT4HeLFxTx4flEoZLKO/g0bAoV2uqBhkA9xnQIDAQAB
# set it to the issuer value which is used to generate the tokens
mp.jwt.verify.issuer=${keycloak.url}/realms/quarkus

# required to sign the tokens
smallrye.jwt.sign.key.location=privateKey.pem</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="integration-testing-security-annotation"><a class="anchor" href="#integration-testing-security-annotation"></a><code>TestSecurity</code> アノテーション</h4>
<div class="paragraph">
<p>次の依存関係を追加します。</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-test-security-jwt&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">testImplementation("io.quarkus:quarkus-test-security-jwt")</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、以下のようなテストコードを記述します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import static org.hamcrest.Matchers.is;
import org.junit.jupiter.api.Test;
import io.quarkus.test.common.http.TestHTTPEndpoint;
import io.quarkus.test.junit.QuarkusTest;
import io.quarkus.test.security.TestSecurity;
import io.quarkus.test.security.jwt.Claim;
import io.quarkus.test.security.jwt.JwtSecurity;
import io.restassured.RestAssured;

@QuarkusTest
@TestHTTPEndpoint(ProtectedResource.class)
public class TestSecurityAuthTest {

    @Test
    @TestSecurity(user = "userJwt", roles = "viewer")
    public void testJwt() {
        RestAssured.when().get("test-security-jwt").then()
                .body(is("userJwt:viewer"));
    }

    @Test
    @TestSecurity(user = "userJwt", roles = "viewer")
    @JwtSecurity(claims = {
            @Claim(key = "email", value = "user@gmail.com")
    })
    public void testJwtWithClaims() {
        RestAssured.when().get("test-security-jwt-claims").then()
                .body(is("userJwt:viewer:user@gmail.com"));
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>ここで、 <code>ProtectedResource</code> クラスは次のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Path("/web-app")
@Authenticated
public class ProtectedResource {

    @Inject
    JsonWebToken accessToken;

    @GET
    @Path("test-security-jwt")
    public String testSecurityOidc() {
        return accessToken.getName() + ":" + accessToken.getGroups().iterator().next();
    }

    @GET
    @Path("test-security-jwt-claims")
    public String testSecurityOidcUserInfoMetadata() {
        return accessToken.getName() + ":" + accessToken.getGroups().iterator().next()
                + ":" + accessToken.getClaim("email");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@TestSecurity</code> アノテーションは常に使用する必要があり、その <code>user</code> プロパティーは <code>JsonWebToken.getName()</code> として返され、 <code>roles</code> プロパティーは <code>JsonWebToken.getGroups()</code> として返されることに注意してください。
<code>@JwtSecurity</code> アノテーションはオプションであり、追加のトークン要求を設定するために使用できます。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>@TestSecurity</code> と <code>@JwtSecurity</code> は、次のようにメタアノテーションで組み合わせることができます：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @Retention(RetentionPolicy.RUNTIME)
    @Target({ ElementType.METHOD })
    @TestSecurity(user = "userOidc", roles = "viewer")
    @OidcSecurity(introspectionRequired = true,
        introspection = {
            @TokenIntrospection(key = "email", value = "user@gmail.com")
        }
    )
    public @interface TestSecurityMetaAnnotation {

    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは、同じセキュリティ設定のセットを複数のテストメソッドで使用する必要がある場合に特に便利です。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="how-to-check-the-errors-in-the-logs"><a class="anchor" href="#how-to-check-the-errors-in-the-logs"></a>ログでエラーを確認する方法</h3>
<div class="paragraph">
<p>トークンの検証または復号化エラーの詳細を確認するには、 <code>io.quarkus.smallrye.jwt.runtime.auth.MpJwtValidator</code> <code>TRACE</code> レベルのログを有効にしてください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.log.category."io.quarkus.smallrye.jwt.runtime.auth.MpJwtValidator".level=TRACE
quarkus.log.category."io.quarkus.smallrye.jwt.runtime.auth.MpJwtValidator".min-level=TRACE</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="proactive-authentication"><a class="anchor" href="#proactive-authentication"></a>プロアクティブ認証</h3>
<div class="paragraph">
<p>パブリックエンドポイントメソッド呼び出し時のトークン検証を省略したい場合は、 <a href="security-proactive-authentication">プロアクティブ認証</a> を無効にします。</p>
</div>
<div class="paragraph">
<p>トークンの検証が行われていない場合、挿入された <code>JsonWebToken</code> にパブリックメソッドを通じてアクセスできないことに注意してください。</p>
</div>
</div>
<div class="sect2">
<h3 id="add-smallrye-jwt"><a class="anchor" href="#add-smallrye-jwt"></a>SmallRye JWT を直接追加する方法</h3>
<div class="paragraph">
<p><a href="#jwt-parser">parse and verify JsonWebToken with JWTParser</a> の場合、以下の状況では <code>quarkus-smallrye-jwt</code> の代わりに <code>smallrye-jwt</code> を直接使用してください。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>HTTP</code> をサポートしていないQuarkusエクステンション、例えば <code>Quarkus GRPC</code> などを使用している場合。</p>
</li>
<li>
<p>エクステンション固有の <code>HTTP</code> を指定し、そのサポートは <code>quarkus-smallrye-jwt</code> および <code>Vert.x HTTP</code> (<code>Quarkus AWS Lambda</code> など) によって提供されるサポートと競合している場合。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>まず、 <code>smallrye-jwt</code> の依存関係を追加することから始めます:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.smallrye&lt;/groupId&gt;
    &lt;artifactId&gt;smallrye-jwt&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.smallrye:smallrye-jwt")</code></pre>
</div>
</div>
<div class="paragraph">
<p>さらに、 <code>application.properties</code> を更新して、 <code>smallrye-jwt</code> によって提供されるすべての CDI プロデューサーを次のように含めます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.index-dependency.smallrye-jwt.group-id=io.smallrye
quarkus.index-dependency.smallrye-jwt.artifact-id=smallrye-jwt</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration-reference"><a class="anchor" href="#configuration-reference"></a>設定リファレンス</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="quarkus-configuration"><a class="anchor" href="#quarkus-configuration"></a>Quarkus の設定</h3>
<div class="paragraph">
<p><span class="icon"><i class="fa fa-lock" title="ビルド時に固定"></i></span>ビルド時に固定される設定プロパティ - 他のすべての設定プロパティは実行時にオーバーライド可能 <input type="search" id="config-search-0" placeholder="FILTER CONFIGURATION" disabled></p>
</div>
<table class="tableblock frame-all grid-all stretch configuration-reference searchable configuration-reference-all-rows">
<colgroup>
<col style="width: 80%;">
<col style="width: 10%;">
<col style="width: 10%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><span class="header-title">Configuration property</span></p></th>
<th class="tableblock halign-left valign-middle"><p class="tableblock">型</p></th>
<th class="tableblock halign-left valign-middle"><p class="tableblock">デフォルト</p></th>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><span class="icon"><i class="fa fa-lock" title="Fixed at build time"></i></span> <a id="quarkus-smallrye-jwt_quarkus-smallrye-jwt-enabled"></a> <span class="property-path"><a href="#quarkus-smallrye-jwt_quarkus-smallrye-jwt-enabled"><code>quarkus.smallrye-jwt.enabled</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.smallrye-jwt.enabled' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-1" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The MP-JWT configuration object</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-56417">QUARKUS_SMALLRYE_JWT_ENABLED</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-56417" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><span class="icon"><i class="fa fa-lock" title="Fixed at build time"></i></span> <a id="quarkus-smallrye-jwt_quarkus-smallrye-jwt-rsa-sig-provider"></a> <span class="property-path"><a href="#quarkus-smallrye-jwt_quarkus-smallrye-jwt-rsa-sig-provider"><code>quarkus.smallrye-jwt.rsa-sig-provider</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.smallrye-jwt.rsa-sig-provider' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-2" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>The name of the <code>java.security.Provider</code> that supports SHA256withRSA signatures</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-56418">QUARKUS_SMALLRYE_JWT_RSA_SIG_PROVIDER</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-56418" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>SunRsaSign</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc odd">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-smallrye-jwt_quarkus-smallrye-jwt-blocking-authentication"></a> <span class="property-path"><a href="#quarkus-smallrye-jwt_quarkus-smallrye-jwt-blocking-authentication"><code>quarkus.smallrye-jwt.blocking-authentication</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.smallrye-jwt.blocking-authentication' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-3" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>Enable this property if fetching the remote keys can be a time-consuming operation. Do not enable it if you use the local keys.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-56419">QUARKUS_SMALLRYE_JWT_BLOCKING_AUTHENTICATION</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-56419" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr class="row-collapsible row-collapsed row-with-desc">
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><a id="quarkus-smallrye-jwt_quarkus-smallrye-jwt-silent"></a> <span class="property-path"><a href="#quarkus-smallrye-jwt_quarkus-smallrye-jwt-silent"><code>quarkus.smallrye-jwt.silent</code></a></span>
<button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-text='quarkus.smallrye-jwt.silent' title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
<div id="conf-collapsible-desc-4" class="openblock description description-collapsed">
<div class="content">
<div class="paragraph">
<p>Always create HTTP 401 challenge, even for requests containing no authentication credentials. JWT authentication mechanism will return HTTP 401 when an authentication challenge is required. However if it is used alongside one of the interactive authentication mechanisms then returning HTTP 401 to the users accessing the application from a browser may not be desired. If you prefer you can request that JWT authentication mechanism does not create a challenge in such cases by setting this property to 'true'.</p>
</div>
<div class="paragraph">
<p>Environment variable: <code id="env-var-56420">QUARKUS_SMALLRYE_JWT_SILENT</code><button class="btn-copy fa fa-clipboard inline-btn-copy" data-clipboard-action="copy" data-clipboard-target="#env-var-56420" title="Copy to clipboard" do-not-collapse="true"></button></p>
</div>
</div>
</div>
<div class="paragraph description-decoration">
<p><i class="fa fa-chevron-down"></i><span>Show more</span></p>
</div></div></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock"><code>false</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="microprofile-jwt-configuration"><a class="anchor" href="#microprofile-jwt-configuration"></a>MicroProfile JWT の設定</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">デフォルト</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>mp.jwt.verify.publickey</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mp.jwt.verify.publickey</code> 設定プロパティーを使用すると、公開鍵テキスト自体を文字列として提供できます。公開鍵は、<a href="#supported-public-key-formats">サポートされている公開鍵形式</a> セクションで定義された順序で、提供された文字列から解析されます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>mp.jwt.verify.publickey.location</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Config プロパティーでは、公開鍵の外部または内部の場所を指定できます。値は、相対パスまたは URL を使用できます。値が HTTPS ベースの JWK セットを指している場合、ネイティブモードで動作させるには、 <code>quarkus.ssl.native</code> プロパティーも <code>true</code> に設定する必要があります。詳細は、<a href="native-and-ssl">ネイティブ実行可能ファイルでの SSL の使用</a> を参照してください。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>mp.jwt.verify.publickey.algorithm</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>RS256</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">署名アルゴリズムのリスト。楕円曲線署名アルゴリズムをサポートするには、 <code>ES256</code> に設定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>mp.jwt.decrypt.key.location</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Config プロパティーを使用すると、秘密復号化キーの外部または内部の場所を指定できます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>mp.jwt.decrypt.key.algorithm</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>RSA-OAEP</code>、 <code>RSA-OAEP-256</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">復号化アルゴリズムのリスト。SHA-256 のみの RSA-OAEP をサポートするには、 <code>RSA-OAEP-256</code> に設定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>mp.jwt.verify.issuer</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Config プロパティーは、サーバーが有効として受け入れる JWT の <code>iss</code> (発行者) クレームの値を指定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>mp.jwt.verify.audiences</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トークン aud クレームに含まれる可能性のあるオーディエンスのコンマ区切りリスト。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>mp.jwt.verify.clock.skew</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>60</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トークンの有効期限と年齢確認時に使用されるクロックスキュー（秒）。トークンの有効期限切れ後、現在時刻がこのプロパティで指定された秒数以内であれば、期限切れのトークンは受理されます。デフォルト値は60秒です。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>mp.jwt.verify.token.age</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>none</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トークン発行時刻 <code>iat</code> から経過してはならない秒数です。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>mp.jwt.token.header</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>Authorization</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cookie</code> などの別のヘッダーを使用してトークンを渡す場合は、このプロパティーを設定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>mp.jwt.token.cookie</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トークンを含む Cookie の名前。このプロパティーは、 <code>mp.jwt.token.header</code> が <code>Cookie</code> に設定されている場合にのみ有効です。</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="additional-smallrye-jwt-configuration"><a class="anchor" href="#additional-smallrye-jwt-configuration"></a>追加の SmallRye JWT 設定</h3>
<div class="paragraph">
<p>SmallRye JWT は、トークン処理のカスタマイズに使用できるプロパティーを他にも提供します。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">プロパティ名</th>
<th class="tableblock halign-left valign-top">デフォルト</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.verify.secretkey</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">秘密鍵は文字列として提供されます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.verify.key.location</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NONE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">公開鍵と秘密鍵の両方を指すことができる検証鍵の場所。秘密鍵は JWK 形式でのみ使用できます。このプロパティーが設定されている場合、'mp.jwt.verify.publickey.location' は無視されることに注意してください。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.verify.algorithm</code></code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">署名アルゴリズム。このプロパティーは、 <code>HS256</code> などの対称アルゴリズムを設定する場合にのみ使用してください。 <code>ES256</code> などの非対称アルゴリズムの設定には非推奨です。代わりに 'mp.jwt.verify.publickey.algorithm' を使用してください。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.verify.key-format</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>ANY</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このプロパティーを <code>PEM_KEY</code>、 <code>PEM_CERTIFICATE</code>、 <code>JWK</code>、 <code>JWK_BASE64URL</code> などの特定のキー鍵形式に設定して、検証鍵のロード方法を最適化します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.verify.key-provider</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>DEFAULT</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">デフォルトでは、PEM、JWK、または JWK キーセットは、MicroProfile JWT 仕様で要求されているように、ローカルファイルシステムから読み取ったり、URI から取得したりできます。AWS Application Load Balancer 検証キー解決をサポートするには、このプロパティーを <code>AWS_ALB</code> に設定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.verify.relax-key-validation</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">検証キーの検証を緩和します。このプロパティーを <code>true</code> に設定すると、長さが 2048 ビット未満である公開 RSA 鍵が許可されます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.verify.certificate-thumbprint</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このプロパティーが有効になっている場合、署名されたトークンには、x5t または x5t#S256X509Certificate サムプリントヘッダーが含まれている必要があります。検証鍵は、JWK または PEM 証明書鍵形式でのみ使用できます。JWK 鍵には、x5c (Base64 でエンコードされた X509Certificate) プロパティーセットが必要です。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.token.header</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>Authorization</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cookie</code> などの別のヘッダーを使用してトークンを渡す場合は、このプロパティーを設定します。このプロパティーは推奨されていません。'mp.jwt.token.header' を使用してください。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.key-cache-size</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>100</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">キーキャッシュのサイズ。このプロパティは、 <code>smallrye.jwt.key-cache-time-to-live</code> と同様に、 <code>AWS_ALB</code> のようなキープロバイダーが、鍵を動的に解決するために <code>smallrye.jwt.verify.key-provider=AWS_ALB</code> で構成されている場合に、キーキャッシュを制御するために使用します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.key-cache-time-to-live</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>10</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">キーキャッシュエントリーの有効期間 (分単位)。 <code>AWS_ALB</code> などのキープロバイダーが <code>smallrye.jwt.verify.key-provider=AWS_ALB</code> で設定され、キーが動的に解決される場合、このプロパティーと <code>smallrye.jwt.key-cache-size</code> を使用してキーキャッシュを制御します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.token.cookie</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トークンを含むクッキーの名前。このプロパティ＝は、 <code>smallrye.jwt.token.header</code> が <code>Cookie</code> に設定されている場合にのみ有効です。 このプロパティーは非推奨です。 <code>mp.jwt.token.cookie</code> を使用してください。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.always-check-authorization</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>smallrye.jwt.token.header</code> が <code>Cookie</code> に設定されていても、名前が <code>smallrye.jwt.token.cookie</code> の Cookie が存在しない場合、 <code>Authorization</code> ヘッダーがチェックされるようにこのプロパティーを <code>true</code> に設定します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.token.schemes</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>Bearer</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DPoP</code> などの単一または複数の代替スキームを含むコンマ区切りのリスト。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.token.kid</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">鍵の識別子。検証 JWK キーとすべての JWT トークンには、設定されている場合は一致する <code>kid</code> ヘッダーが必要です。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.time-to-live</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JWT を発行して使用できる最大秒数。実質的に、JWT の有効期限と発行日の差はこの値を超えてはなりません。このプロパティーを正以外の値に設定すると、トークンに有効な iat (発行日) クレームが必要であるという要件が緩和されます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.require.named-principal</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>true</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">アプリケーションが名前を返す <code>java.security.Principal</code> に依存している場合、トークンには <code>upn</code> または <code>preferred_username</code> または <code>sub</code> クレームセットが必要です。このプロパティーを設定すると、アプリケーションコードが null 以外の <code>Principal</code> 名を確実に処理するためにこれらのクレームがいずれも利用できない場合、SmallRye JWT は例外を出力します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.path.sub</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">件名を含むクレームへのパス。これは最上位の JSON オブジェクトから始まり、各セグメントが JSON オブジェクト名のみを表す複数のセグメントを含めることができます (例: <code>レルム s/subject</code>)。このプロパティーは、トークンに 'sub' クレームがなく、サブジェクトが別のクレームに設定されている場合に使用できます。名前空間修飾クレームには二重引用符を使用します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.claims.sub</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">現在のトークンに使用可能な標準またはカスタムの <code>sub</code> クレームがない場合に、このプロパティーを使用して、デフォルトのサブクレーム値を設定できます。事実上、このプロパティーを使用して、 <code>upn</code>、 <code>preferred_username</code>、 <code>sub`クレームが設定されていない場合に `java.security.Principal</code> 名をカスタマイズできます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.path.groups</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">グループを含むクレームへのパス。これは最上位の JSON オブジェクトから始まり、各セグメントが JSON オブジェクト名のみを表す複数のセグメントを含めることができます (例: <code>レルム/groups</code>)。このプロパティーは、トークンに 'groups' クレームがなく、別のクレームにグループが設定されている場合に使用できます。名前空間修飾クレームには二重引用符を使用します。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.groups-separator</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>space</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">複数のグループ値を含む可能性のある文字列を分割するためのセパレーター。これは、 <code>smallrye.jwt.path.groups</code> プロパティーが値が文字列のカスタムクレームを指している場合にのみ使用されます。標準の OAuth2 <code>scope</code> クレームにはスペースで区切られたシーケンスが含まれている可能性があるため、デフォルト値はスペース 1 個です。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.claims.groups</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このプロパティーでは、現在のトークンに使用可能な標準またはカスタムのグループクレームがない場合に、デフォルトのグループクレーム値を設定できます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.jwks.refresh-interval</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>60</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JWK キャッシュの更新間隔 (分単位)。 <code>mp.jwt.verify.publickey.location</code> が HTTP または HTTPS URL ベースの JWK セットを指し、正の <code>max-age</code> パラメーター値を持つ HTTP <code>Cache-Control</code> レスポンスヘッダーが JWK HTTPS エンドポイントから返されない限り無視されます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.jwks.forced-refresh-interval</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>30</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">強制 JWK キャッシュ更新間隔 (分単位)。現在のトークンの <code>kid</code> ヘッダーと一致する <code>kid</code> プロパティーを持つ JWK キーがキャッシュにないためにトークンの検証が失敗した場合に発生する可能性がある強制更新の試行頻度を制限するために使用されます。 <code>mp.jwt.verify.publickey.location</code> が HTTP または HTTPS URL ベースの JWK セットを指していない限り、無視されます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.expiration.grace</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">有効期限を秒単位で指定します。デフォルトでは、現在時刻がトークンの有効期限から 1 分以内であれば、期限切れのトークンはまだ受け入れられます。このプロパティーは非推奨です。代わりに <code>mp.jwt.verify.clock.skew</code> を使用してください。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.verify.aud</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トークン <code>aud</code> クレームに含まれる可能性のあるオーディエンスのコンマ区切りリスト。このプロパティーは非推奨です。 <code>mp.jwt.verify.audiences</code> を使用してください。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.required.claims</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">トークンに含める必要があるクレームのコンマ区切りリスト。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.decrypt.key.location</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">秘密復号鍵の外部または内部の場所を指定するための設定プロパティー。このプロパティーは非推奨です。 <code>mp.jwt.decrypt.key.location</code> を使用してください。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.decrypt.algorithm</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>RSA_OAEP</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">復号化アルゴリズム。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.decrypt.key</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">文字列として提供される復号化キー。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.token.decryption.kid</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">復号化キー識別子。設定されている場合、復号化 JWK キーとすべての JWT トークンには、一致する <code>kid</code> ヘッダーが必要です。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.client.tls.certificate.path</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">鍵を <code>HTTPS</code> 経由で取得する必要がある場合に設定する必要がある可能性のある TLS 信頼済み証明書へのパス。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.client.tls.trust-all</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">すべてのホスト名を信頼します。キーを <code>HTTPS</code> 経由でフェッチする必要があり、このプロパティーが <code>true</code> に設定されている場合、デフォルトですべてのホスト名が信頼されます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.client.tls.hosts</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">信頼できるホスト名のセット。キーを <code>HTTPS</code> 経由でフェッチする必要があり、 <code>smallrye.jwt.client.tls.trust-all</code> が <code>false</code> に設定されている場合、このプロパティーを使用して信頼できるホスト名を設定できます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.http.proxy.host</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP プロキシーホスト。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.http.proxy.port</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>80</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP プロキシーポート。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.keystore.type</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>JKS</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このプロパティーは、 <code>mp.jwt.verify.publickey.location</code> または <code>mp.jwt.decrypt.key.location</code> のいずれかが <code>KeyStore</code> ファイルを指している場合に、キーストアタイプをカスタマイズするために使用できます。設定されていない場合は、ファイル名のチェックおよびキーストアタイプの決定が行われ、デフォルトで <code>JKS</code> に設定されます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.keystore.provider</code></code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mp.jwt.verify.publickey.location</code> または <code>mp.jwt.decrypt.key.location</code> が <code>KeyStore</code> ファイルを指している場合、このプロパティーを使用して <code>KeyStore</code> プロバイダーをカスタマイズできます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.keystore.password</code></code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">キーストアのパスワード。 <code>mp.jwt.verify.publickey.location</code> または <code>mp.jwt.decrypt.key.location</code> の場合は、このプロパティーを設定する必要があります。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.keystore.verify.key.alias</code></code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このプロパティーは、 <code>mp.jwt.verify.publickey.location`が `KeyStore`ファイルを指している場合に、 `KeyStore</code> から抽出される公開検証鍵を一致する証明書から識別するために設定する必要があります。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.keystore.decrypt.key.alias</code></code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This property has to be set to identify a private decryption key if <code>mp.jwt.decrypt.key.location</code> points to a <code>KeyStore</code> file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.keystore.decrypt.key.password</code></code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">このプロパティーは、 <code>mp.jwt.decrypt.key.location</code> が <code>KeyStore</code> ファイルを指しているときに、 <code>KeyStore</code> 内の秘密復号化鍵のパスワードが <code>smallrye.jwt.keystore.password</code> と異なる場合に設定できます。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><code>smallrye.jwt.resolve-remote-keys-at-startup</code></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">アプリケーションの起動時にリモート鍵を解決するには、このプロパティーを true に設定します。</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references"><a class="anchor" href="#references"></a>リファレンス</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://download.eclipse.org/microprofile/microprofile-jwt-auth-1.2/microprofile-jwt-auth-spec-1.2.html">MP JWT 1.2 HTML</a></p>
</li>
<li>
<p><a href="https://download.eclipse.org/microprofile/microprofile-jwt-auth-1.2/microprofile-jwt-auth-spec-1.2.pdf">MP JWT 1.2 PDF</a></p>
</li>
<li>
<p><a href="https://github.com/smallrye/smallrye-jwt">SmallRye JWT</a></p>
</li>
<li>
<p><a href="https://tools.ietf.org/html/rfc7519">JSON Web Token</a></p>
</li>
<li>
<p><a href="https://tools.ietf.org/html/rfc7515">JSON Web Signature</a></p>
</li>
<li>
<p><a href="https://tools.ietf.org/html/rfc7516">JSON Web Encryption</a></p>
</li>
<li>
<p><a href="https://tools.ietf.org/html/rfc7518">JSON Web Algorithms</a></p>
</li>
<li>
<p><a href="security-jwt-build">JSONウェブトークン (JWT) のビルド、署名、暗号化</a></p>
</li>
<li>
<p><a href="security-authentication-mechanisms#combining-authentication-mechanisms">認証メカニズムの組み合わせ</a></p>
</li>
<li>
<p><a href="security-overview">Quarkus Securityの概要</a></p>
</li>
</ul>
</div>
</div>
</div>
    </div>
    <div class="grid__item width-4-12 width-12-12-m tocwrapper">
      <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#prerequisites">前提条件</a></li>
<li><a href="#quickstart">クイックスタート</a>
<ul class="sectlevel2">
<li><a href="#solution">ソリューション</a></li>
<li><a href="#creating-the-maven-project">Mavenプロジェクトの作成</a></li>
<li><a href="#examine-the-jakarta-rest-resource">Jakarta REST リソースの調査</a></li>
<li><a href="#run-application">アプリケーションを開発モードで実行する</a></li>
<li><a href="#configuring-the-smallrye-jwt-extension-security-information">SmallRye JWT エクステンションのセキュリティー情報を設定する。</a></li>
<li><a href="#add-public-key">公開鍵の追加</a></li>
<li><a href="#generating-a-jwt">JWT の生成</a></li>
<li><a href="#finally-secured-access-to-securedroles-allowed">/secured/roles-allowed へのセキュリティーで保護されたアクセス</a></li>
<li><a href="#using-the-jsonwebtoken-and-claim-injection"><code>JsonWebToken</code> とクレームインジェクションの使用</a></li>
<li><a href="#run-the-application-in-jvm-mode">JVM モードでアプリケーションを実行する</a></li>
<li><a href="#run-the-application-in-native-mode">ネイティブ・モードでアプリケーションを実行</a></li>
<li><a href="#explore-the-solution">ソリューションの探索</a></li>
</ul>
</li>
<li><a href="#reference-guide">リファレンスガイド</a>
<ul class="sectlevel2">
<li><a href="#supported-injection-scopes">サポートされている注入スコープ</a></li>
<li><a href="#supported-public-key-formats">サポートされている公開鍵形式</a></li>
<li><a href="#dealing-with-verification-keys">検証鍵の扱い</a></li>
<li><a href="#jwt-parser">JWTParser を使用した JsonWebToken の解析と検証</a></li>
<li><a href="#token-decryption">トークン復号化</a></li>
<li><a href="#custom-factories">カスタムファクトリー</a></li>
<li><a href="#blocking-calls">ブロッキング呼出</a></li>
<li><a href="#token-propagation">トークンの伝播</a></li>
<li><a href="#integration-testing">テスト</a></li>
<li><a href="#how-to-check-the-errors-in-the-logs">ログでエラーを確認する方法</a></li>
<li><a href="#proactive-authentication">プロアクティブ認証</a></li>
<li><a href="#add-smallrye-jwt">SmallRye JWT を直接追加する方法</a></li>
</ul>
</li>
<li><a href="#configuration-reference">設定リファレンス</a>
<ul class="sectlevel2">
<li><a href="#quarkus-configuration">Quarkus の設定</a></li>
<li><a href="#microprofile-jwt-configuration">MicroProfile JWT の設定</a></li>
<li><a href="#additional-smallrye-jwt-configuration">追加の SmallRye JWT 設定</a></li>
</ul>
</li>
<li><a href="#references">リファレンス</a></li>
</ul></div>
    </div>
  </div>
  <h2>関連コンテンツ</h2>
  <div class="grid-wrapper relations">
    <div class="grid__item width-6-12 width-12-12-m">
      <h3>同じトピックについて</h3>
      <ul class="related-content">
      
        
        <li class="guide"><a href="/version/3.27/guides/security-jwt-build">JSON Web トークン (JWT) のビルド、署名、暗号化</a></li>
      
        
        <li class="concepts"><a href="/version/3.27/guides/security-authentication-mechanisms">Quarkusの認証メカニズム</a></li>
      
        
        <li class="reference"><a href="/version/3.27/guides/security-authorize-web-endpoints-reference">ウェブエンドポイントの認可</a></li>
      
        
        <li class="concepts"><a href="/version/3.27/guides/security-basic-authentication">Basic認証</a></li>
      
        
        <li class="concepts"><a href="/version/3.27/guides/security-openid-connect-providers">よく知られたOpenID Connect プロバイダーの設定</a></li>
      
        
        <li class="guide"><a href="/version/3.27/guides/security-csrf-prevention">クロスサイトリクエストフォージェリー対策</a></li>
      
        
        <li class="howto"><a href="/version/3.27/guides/security-openid-connect-dev-services">OpenID Connect (OIDC)のDev ServicesとDev UI</a></li>
      
        
        <li class="howto"><a href="/version/3.27/guides/security-basic-authentication-howto">ベーシック認証の有効化</a></li>
      
        
        <li class="tutorial"><a href="/version/3.27/guides/security-getting-started-tutorial">Basic認証とJakarta Persistenceを使用したセキュリティの入門</a></li>
      
        
        <li class="concepts"><a href="/version/3.27/guides/security-identity-providers">アイデンティティ・プロバイダー</a></li>
      
        
        <li class="tutorial"><a href="/version/3.27/guides/security-vertx-oidc-to-quarkus-oidc-migration">Migrate from Vert.x OIDC to Quarkus OIDC</a></li>
      
        
        <li class="reference"><a href="/version/3.27/guides/security-openid-connect-client-reference">OpenID Connect (OIDC) と OAuth2 クライアントおよびフィルター</a></li>
      
        
        <li class="reference"><a href="/version/3.27/guides/security-openid-connect-client-registration">OpenID Connect (OIDC) と OAuth2 の動的クライアント登録</a></li>
      
        
        <li class="concepts"><a href="/version/3.27/guides/security-oidc-bearer-token-authentication">OpenID Connect (OIDC) ベアラートークン認証</a></li>
      
        
        <li class="reference"><a href="/version/3.27/guides/security-oidc-configuration-properties-reference">OpenID Connect (OIDC) 設定プロパティ</a></li>
      
        
        <li class="concepts"><a href="/version/3.27/guides/security-oidc-code-flow-authentication">Web アプリケーションを保護するための OpenID Connect 認可コードフローメカニズム</a></li>
      
        
        <li class="tutorial"><a href="/version/3.27/guides/security-openid-connect-client">OpenID Connectクライアントとトークン伝搬クイックスタート</a></li>
      
        
        <li class="concepts"><a href="/version/3.27/guides/security-proactive-authentication">プロアクティブ認証</a></li>
      
        
        <li class="tutorial"><a href="/version/3.27/guides/security-oidc-bearer-token-authentication-tutorial">OpenID Connect（OIDC）ベアラートークン認証によるサービスアプリケーションの保護</a></li>
      
        
        <li class="tutorial"><a href="/version/3.27/guides/security-oidc-code-flow-authentication-tutorial">Quarkus - 認可コードフローのOpenID Connectを使用してWebアプリケーションを保護</a></li>
      </ul>
    </div>
    </div>
  </div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license. <i class='fab fa-creative-commons'></i><i class='fab fa-creative-commons-by'></i> <a href='https://creativecommons.org/licenses/by/3.0/' target='_blank'>CC by 3.0</a><br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">ホーム</a></li>
          
          
          
            <li><a href="/about" target="_blank">Quarkusについて</a></li>
          
          
          
            <li><a href="/blog" target="_blank">ブログ</a></li>
          
          
          
            <li><a href="/insights" target="_blank">ポッドキャスト</a></li>
          
          
          
            <li><a href="/events" target="_blank">イベント</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">ニュースレター</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">ユーザーストーリー</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">ロードマップ</a></li>
          
          
          
            <li><a href="/security" target="_blank">セキュリティ&nbsp;ポリシー</a></li>
          
          
          
            <li><a href="/usage" target="_blank">使用方法</a></li>
          
          
          
            <li><a href="/brand" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
          
            <li><a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy Policy</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォローする</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.threads.com/@quarkusio" target="_blank">Threads</a></li>
          
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">サポート</a></li>
          
          
          
            <li><a href="/guides" target="_blank">ガイド</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">入門</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">ディスカッション</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">開発メーリングリスト</a></li>
          
          
          
            <li><a href="https://stats.uptimerobot.com/ze1PfweT2p" target="_blank">Quarkus Service Status</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>言語</span>
        <ul class="footer-links">
          
          
            <li><a href=" https://quarkus.io/ " target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href=" https://es.quarkus.io/ " target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href=" https://ja.quarkus.io/ " target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate ORM</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">その他多数...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content cf-footer">
  <div class="flexcontainer">
    <div class="cf-logo">
      <a class="cf-logo" href="https://www.commonhaus.org/" target="_blank"><img src="https://raw.githubusercontent.com/commonhaus/artwork/main/foundation/brand/svg/CF_logo_horizontal_single_reverse.svg"/></a>
    </div>
    <div class="license">
      Copyright © Quarkus. All rights reserved. For details on our trademarks, please visit our <a href="https://www.commonhaus.org/policies/trademark-policy/">Trademark Policy</a> and <a href="https://www.commonhaus.org/trademarks/">Trademark List</a>. Trademarks of third parties are owned by their respective holders and their mention here does not suggest any endorsement or association.
    </div>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
  <script src="/assets/javascript/randomize.js" type="text/javascript"></script>
  <script src="/assets/javascript/time.js" type="text/javascript"></script>
</body>

</html>
