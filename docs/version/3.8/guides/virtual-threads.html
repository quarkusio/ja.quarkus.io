<!DOCTYPE html>
<html lang="ja">







<head>
  <title>仮想スレッドサポートリファレンス - 3.8 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com https://ajax.googleapis.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />

  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/3.8/guides/virtual-threads" />
  <meta property="og:title" content="仮想スレッドサポートリファレンス - 3.8" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/virtual-threads">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="guides">

  


<div class="grid-wrapper communitysite">
  <div class="grid__item width-12-12">The <a href="https://quarkus.io/version/3.8/guides/virtual-threads">English version of quarkus.io</a> is the official project site. Translated sites are community supported on a best-effort basis.</div>
</div>


  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="#">Why<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/performance" class="">パフォーマンス</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
          <li><a href="/versatility" class="">多用途性</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/spring" class="">USING SPRING?</a></li>
          <li class="tertiarydropdown">
            <span href="#">AI<i class="fas fa-chevron-down"></i></span>
            <ul class="tertiarymenu">
              <li><a href="/ai" class="">AI OVERVIEW</a></li>
              <li><a href="/java-for-ai" class="">JAVA FOR AI</a></li>
              <li><a href="/quarkus-for-ai" class="">WHY QUARKUS FOR AI</a></li>
              <li><a href="/ai-blueprints" class="">AI BLUEPRINTS</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Learn<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ドキュメント</a></li>
          <li><a href="/userstories/" class="">ユーザーストーリー</a></li>  
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="#">Extensions<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
<li><a href="https://quarkus.io/extensions/" class="">エクステンションを探す</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">エクステンションの使用</a></li>
          <li><a href="/guides/writing-extensions" class="">エクステンションの作成</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">エクステンションの共有</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Community<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/working-groups" class="">ワーキンググループ</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ロードマップ</a></li>
          <li><a href="/benefactors" class="">BENEFACTORS</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/version/3.8/guides/virtual-threads" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/version/3.8/guides/virtual-threads">ポルトガル（BR）</a></li>
          <li><a href="https://es.quarkus.io/version/3.8/guides/virtual-threads">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/version/3.8/guides/virtual-threads">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/version/3.8/guides/virtual-threads">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas
fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    







<section class="full-width-version-bg flexfilterbar guides">
  <div class="guideflexcontainer">
    <div class="docslink">
      <a class="returnlink" href="/version/3.8/guides/"> Back to Guides</a>
    </div>
    <div class="flexlabel">
      <label>バージョン:</label>
    </div>
    <div class="guidepulldown version">
    <select id="guide-version-dropdown">
      
        
        
        <option value="main" >Main - SNAPSHOT</option>
        
        
        
        <option value="latest" >3.31.3 - Latest</option>
        
        
        
        <option value="3.27" >3.27</option>
        
        
        
        <option value="3.20" >3.20</option>
        
        
        
        <option value="3.15" >3.15</option>
        
        
        
        <option value="3.8" selected>3.8</option>
        </select>
    </div>
  </div>
</section>

<div class="guide">
  <div class="grid-wrapper">
    <div class="grid__item width-8-12 width-12-12-m">
      
      <h1 class="text-caps">仮想スレッドサポートリファレンス </h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>このガイドでは、QuarkusアプリケーションでJava 21+の仮想スレッドを使用する方法について説明します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-are-virtual-threads"><a class="anchor" href="#what-are-virtual-threads"></a>仮想スレッドとは？</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="terminology"><a class="anchor" href="#terminology"></a>用語解説</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">OSスレッド</dt>
<dd>
<p>オペレーティング・システムによって管理される「スレッドのような」データ構造。</p>
</dd>
<dt class="hdlist1">プラットフォームスレッド</dt>
<dd>
<p>Java 19までは、 <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/lang/Thread.html">Thread</a> クラスのインスタンスはすべて、OSスレッドのラッパーであるプラットフォーム・スレッドでした。
プラットフォーム・スレッドを作成するとOSスレッドが作成され、プラットフォーム・スレッドをブロックするとOSスレッドがブロックされます。</p>
</dd>
<dt class="hdlist1">仮想スレッド</dt>
<dd>
<p>軽量で、JVMが管理するスレッド。 <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/lang/Thread.html">Thread</a> クラスを拡張していますが、1つの特定のOSスレッドに縛られることはありません。したがって、仮想スレッドのスケジューリングはJVMの責任です。</p>
</dd>
<dt class="hdlist1">キャリアスレッド</dt>
<dd>
<p>仮想スレッドを実行するために使用されるプラットフォームスレッドは、 <strong>キャリアスレッド</strong> と呼ばれます。
これは <a href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/lang/Thread.html">Thread</a> や <code>VirtualThread</code> とは異なるクラスではなく、機能的な呼称です。</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="differences-between-virtual-threads-and-platform-threads"><a class="anchor" href="#differences-between-virtual-threads-and-platform-threads"></a>仮想スレッドとプラットフォームスレッドの違い</h3>
<div class="paragraph">
<p>ここではその概要を説明します。詳細は <a href="https://openjdk.org/jeps/425">JEP425</a> を参照してください。</p>
</div>
<div class="paragraph">
<p>仮想スレッドは、Java 19から利用可能な機能で（Java 21は、仮想スレッドを含む最初のLTSバージョン）、
I/Oバウンドのワークロードに対して、プラットフォームスレッドの安価な代替を提供することを目的としています。</p>
</div>
<div class="paragraph">
<p>これまで、プラットフォーム・スレッドがJVMの同時実行ユニットでした。
スレッドは、OS構造体のラッパーです。
Javaプラットフォーム・スレッドを作成すると、オペレーティング・システムに「スレッドのような」構造が作成されます。</p>
</div>
<div class="paragraph">
<p>一方、仮想スレッドはJVMによって管理されます。実行するには、（その仮想スレッドのキャリアとして機能する）プラットフォーム・スレッドにマウントする必要があります。
そのため、以下のような特徴があります:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">軽量</dt>
<dd>
<p>仮想スレッドは、プラットフォーム・スレッドよりもメモリ上の占有領域が小さくなります。
したがって、メモリを消費することなく、プラットフォーム・スレッドよりも多くの仮想スレッドを同時に使用することが可能になります。
デフォルトでは、プラットフォーム・スレッドは約1MBのスタックで作成されますが、仮想スレッドのスタックは "pay-as-you-go "です。
Loomプロジェクト（JVMに仮想スレッドサポートを追加したプロジェクト）のリード開発者が行った <a href="https://youtu.be/lIq-x_iI-kc?t=543">プレゼンテーション</a> で、これらの数字や仮想スレッドの他の動機を見つけることができます。</p>
</dd>
<dt class="hdlist1">作成が安価</dt>
<dd>
<p>Javaでプラットフォーム・スレッドを作成するには時間がかかります。
現在では、スレッドを一度作成してから再利用するプーリングのようなテクニックが、スレッドの起動にかかる時間のロスを最小限に抑えるために強く推奨されています（同様に、メモリ消費量を低く抑えるためにスレッドの最大数を制限することも推奨されています）。
仮想スレッドは必要なときに作成する使い捨てのものであり、
スレッドをプールしたり別のタスクに再利用したりすることは推奨されません。</p>
</dd>
<dt class="hdlist1">安価なブロック</dt>
<dd>
<p>ブロッキングI/Oを実行するとき、Javaプラットフォームのスレッドによってラップされた基礎となるOSスレッドは待ち行列に入れられ、新しいスレッドコンテキストをCPUコアにロードするためにコンテキストスイッチが発生します。
この操作には時間がかかります。JVMは仮想スレッドを管理するため、OSスレッドがブロッキング操作を実行しても、そのスレッドがブロックされることはありません。
それらの状態はヒープに格納され、別の仮想スレッドが同じJavaプラットフォーム（キャリア）スレッド上で実行されます。</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="the-continuation-dance"><a class="anchor" href="#the-continuation-dance"></a>継続ダンス</h3>
<div class="paragraph">
<p>前述のように、JVM は仮想スレッドをスケジュールします。これらの仮想スレッドはキャリアースレッドにマウントされます。このスケジューリングには少し魔法のような仕組みがあります。仮想スレッドがブロッキング I/O を使用しようとすると、JVM はこの呼び出しをノンブロッキングの呼び出しに <em>変換</em> し、仮想スレッドをアンマウントして、別の仮想スレッドをキャリアースレッドにマウントします。I/O が完了すると、<em>待機していた</em> 仮想スレッドが再び実行可能な状態になり、再びキャリアースレッドにマウントされて処理を続行します。ユーザーからは、この一連の動作はすべて見えません。同期コードは非同期で実行されます。</p>
</div>
<div class="paragraph">
<p>仮想スレッドを同じキャリアスレッドに再マウントすることはできません。</p>
</div>
</div>
<div class="sect2">
<h3 id="cpu-bound"><a class="anchor" href="#cpu-bound"></a>仮想スレッドはI/Oバウンドワークロードにのみに有効</h3>
<div class="paragraph">
<p>私たちは、プラットフォームスレッドよりも多くの仮想スレッドを作成できることを理解しました。このため、長時間の計算 (CPU バウンドワークロード) をするために仮想スレッドを使用したいと考えるかもしれません。
しかし、これは無意味であり、逆効果です。
CPU バウンド処理は、I/O の完了を待つ間にスレッドをすばやく切り替えるのではなく、
スレッドを CPU コアにアタッチして何らかの計算を行うものです。
このようなケースでは、数十個の CPU コアに対して数千個のスレッドを持つことは非常に無意味で、仮想スレッドが CPU バウンドワークロードのパフォーマンスを向上させることはありません。
それどころか、仮想スレッド上で CPU バウンドワークロードを実行すると、仮想スレッドがマウントされているキャリアースレッドをその仮想スレッドが独占してしまいます。
その結果、他の仮想スレッドが実行される機会が減るか、新しいキャリアースレッドが次々に作成されることになり、メモリー使用量が増大してしまいます。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="run-code-on-virtual-threads-using-runonvirtualthread"><a class="anchor" href="#run-code-on-virtual-threads-using-runonvirtualthread"></a>@RunOnVirtualThread を使用した仮想スレッド上でのコード実行</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quarkus では、仮想スレッドのサポートは <a href="https://javadoc.io/doc/io.smallrye.common/smallrye-common-annotation/latest/io/smallrye/common/annotation/RunOnVirtualThread.html">@RunOnVirtualThread</a> アノテーションを使用して実装されています。
このセクションでは、その論理的根拠と使い方について簡単に説明します。
このアノテーションをサポートするエクステンションには、以下のような専用のガイドも用意されています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./resteasy-reactive-virtual-threads">RESTアプリケーションにおける仮想スレッド</a></p>
</li>
<li>
<p><a href="./messaging-virtual-threads">リアクティブ・メッセージング・アプリケーションにおける仮想スレッド</a></p>
</li>
<li>
<p><a href="./grpc-virtual-threads">gRPCサービスの仮想スレッド</a></p>
</li>
<li>
<p><a href="./scheduler-reference#virtual_threads">仮想スレッドでの定期的なタスクの実行</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="why-not"><a class="anchor" href="#why-not"></a>なぜすべてを仮想スレッドで実行しないのか？</h3>
<div class="paragraph">
<p>前述したように、すべてが仮想スレッド上で安全に実行できるわけではありません。 
<strong>独占</strong> のリスクはメモリ使用量の多さにつながります。
また、仮想スレッドをキャリアスレッドからアンマウントできない状況もあります。
これは <strong>pinning</strong> と呼ばれます。
最後に、一部のライブラリは <code>ThreadLocal</code> を使用してオブジェクトを保存し再利用します。
これらのライブラリで仮想スレッドを使用すると、意図的にプールされたオブジェクトが（使い捨てで一般に短命な）仮想スレッドごとにインスタンス化されるため、大量の割り当てが発生します。</p>
</div>
<div class="paragraph">
<p>現在のところ、仮想スレッドを自由に使うことはできません。
このような自由放任のアプローチをとると、すぐにメモリやリソースの枯渇という問題が発生します。
そのためQuarkusでは、前述の問題がなくなるまで（Javaエコシステムが成熟するまで）、明示的なモデルを使用します。 
<em>リアクティブ</em> エクステンションが仮想スレッドをサポートし、 <em>古典的な</em> スレッドをほとんどサポートしない理由もここにあります。
仮想スレッドでディスパッチするタイミングを知る必要があります。</p>
</div>
<div class="paragraph">
<p>これらの問題は、Quarkusの制限やバグではなく、仮想スレッドフレンドリーに進化する必要があるJavaエコシステムの現状によるものであることを理解することが重要です。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
内部設計と選択の詳細については、 <a href="https://dl.acm.org/doi/10.1145/3583678.3596895">Considerations for integrating virtual threads in Java framework: a Quarkus example in resource-constrained environment</a> を参照してください。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="monopolization"><a class="anchor" href="#monopolization"></a>独占の場合</h4>
<div class="paragraph">
<p>独占については、 <a href="#cpu-bound">仮想スレッドはI/Oバウンドのワークロードにのみ有効</a> のセクションで説明しました。
長い計算を実行する場合、仮想スレッドが終了するまで、JVMがアンマウントして別の仮想スレッドに切り替えることを許可しません。
実際、現在のスケジューラはタスクのプリエンプトをサポートしていません。</p>
</div>
<div class="paragraph">
<p>この独占は、他の仮想スレッドを実行するために新しいキャリアスレッドを作成することにつながります。
キャリア・スレッドを作成すると、プラットフォーム・スレッドを作成することになります。
そのため、この作成にはメモリ・コストがかかります。</p>
</div>
<div class="paragraph">
<p>コンテナのような制約のある環境で実行するとします。
その場合、メモリ使用量の多さがメモリ不足の問題やコンテナの終了につながる可能性があるため、独占はすぐに懸念事項となります。
メモリ使用量は、スケジューリングと仮想スレッドに固有のコストがかかるため、通常のワーカースレッドよりも高くなる可能性があります。</p>
</div>
</div>
<div class="sect3">
<h4 id="pinning"><a class="anchor" href="#pinning"></a>拘束の場合</h4>
<div class="paragraph">
<p>「安価なブロッキング」の約束は常に成り立つわけではありません。仮想スレッドは特定の状況でそのキャリアーを <em>ピン</em> することがあります。
この場合、プラットフォームスレッドはブロックされ、通常のブロッキングシナリオと同様に動作します。</p>
</div>
<div class="paragraph">
<p><a href="https://openjdk.org/jeps/425">JEP 425</a> によると、これは2つの状況で発生する場合があります:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>仮想スレッドが <code>synchronized</code> ブロックまたはメソッドの内部でブロッキング操作を実行する場合</p>
</li>
<li>
<p>ネイティブメソッドや外部関数内でブロッキング操作を実行した場合</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>コード内でこのような状況を回避するのは比較的簡単ですが、使用する依存関係をすべて検証することは困難です。
通常、仮想スレッドを試している際に、<a href="https://javadoc.io/doc/org.postgresql/postgresql/latest/index.html">postgresql-JDBC driver</a> の 42.6.0 より古いバージョンでは、頻繁にピニングが発生することがわかりました。
ほとんどの JDBC ドライバーは、引き続きキャリアースレッドをピン留めします。
さらに悪いことに、多くのライブラリーではコードの変更が必要になります。</p>
</div>
<div class="paragraph">
<p>詳細は、<a href="https://quarkus.io/blog/virtual-thread-1/">When Quarkus meets Virtual Threads</a> を参照してください。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
このピンニングのケースに関する情報は、PostgreSQL JDBC ドライバー 42.5.4 以前に適用されます。
PostgreSQL JDBC ドライバー 42.6.0 以降では、事実上すべての同期されたメソッドが再入可能ロックに置き換えられています。
詳細は、PostgreSQL JDBC ドライバー 42.6.0 の <a href="https://jdbc.postgresql.org/changelogs/2023-03-17-42.6.0-release/">Notable Changes</a> を参照してください。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="pooling"><a class="anchor" href="#pooling"></a>プーリングの場合</h4>
<div class="paragraph">
<p>一部のライブラリーは、オブジェクトプーリングメカニズムとして <code>ThreadLocal</code> を使用しています。
<a href="https://github.com/FasterXML/jackson-core/issues/919">Jackson</a> および Netty などの非常に人気の高いライブラリーは、アプリケーションが限られた数のスレッドを使用し、それらのスレッドが (スレッドプールを使用して) リサイクルされて、複数の (無関係だが連続した) タスクを実行することを前提としています。</p>
</div>
<div class="paragraph">
<p>このパターンには、次のような複数の利点があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>割り当ての利点: 重いオブジェクトはスレッドごとに 1 回だけ割り当てられますが、これらのスレッドの数は制限されることが意図されているため、メモリーがあまり使用されません。</p>
</li>
<li>
<p>スレッドの安全性: スレッドローカルに格納されたオブジェクトにアクセスできるのは 1 つのスレッドのみであり、同時アクセスを防止します。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ただし、このパターンは仮想スレッドを使用する場合には逆効果になります。
仮想スレッドはプールされず、一般的に短命です。
そのため、少数のスレッドを使用するのではなく、大量のスレッドを扱うことになります。
それぞれのスレッドに対して、 <code>ThreadLocal</code> に格納されるオブジェクトが作成されます (多くの場合、サイズが大きく、コストもかかります)。しかし、仮想スレッドはプールされず (実行が完了した後に別のタスクを実行することもないため)、これらのオブジェクトは再利用されません。
この問題により、メモリー使用量が増加します。
残念ながら、この問題を解決するには、ライブラリー自体に高度なコード変更が必要になります。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="use-runonvirtualthread-with-resteasy-reactive"><a class="anchor" href="#use-runonvirtualthread-with-resteasy-reactive"></a>RESTEasy Reactiveで@RunOnVirtualThreadを使用する。</h3>
<div class="paragraph">
<p>このセクションでは、 <a href="https://javadoc.io/doc/io.smallrye.common/smallrye-common-annotation/latest/io/smallrye/common/annotation/RunOnVirtualThread.html">@RunOnVirtualThread</a> アノテーションの簡単な使用例を示します。
また、Quarkusが提供するさまざまな開発モデルと実行モデルについても説明します。</p>
</div>
<div class="paragraph">
<p><code>@RunOnVirtualThread</code> アノテーションは、Quarkusに対して、現在のスレッドではなく <strong>新しい</strong> 仮想スレッドでアノテーションされたメソッドを呼び出すように指示します。
Quarkusは仮想スレッドの作成とオフロードを処理します。</p>
</div>
<div class="paragraph">
<p>仮想スレッドは使い捨てのエンティティであるため、 <code>@RunOnVirtualThread</code> の基本的な考え方は、エンドポイントハンドラの実行をイベントループやワーカースレッド（RESTEasy Reactiveの場合）で実行する代わりに、新しい仮想スレッド上でオフロードすることです。</p>
</div>
<div class="paragraph">
<p>そのためには、エンドポイントに <a href="https://javadoc.io/doc/io.smallrye.common/smallrye-common-annotation/latest/io/smallrye/common/annotation/RunOnVirtualThread.html">@RunOnVirtualThread</a> アノテーションを追加すれば十分です。
アプリケーションの <strong>実行</strong> に使用される Java 仮想マシンが仮想スレッドのサポートを提供している場合 (Java 21 以降のバージョン)、エンドポイントの実行は仮想スレッドにオフロードされます。
これにより、仮想スレッドがマウントされているプラットフォーム・スレッドをブロックすることなく、ブロッキング処理を実行できるようになります。</p>
</div>
<div class="paragraph">
<p>In the case of RESTEasy Reactive, this annotation can only be used on endpoints annotated with <a href="https://javadoc.io/doc/io.smallrye.common/smallrye-common-annotation/latest/io/smallrye/common/annotation/Blocking.html">@Blocking</a> or
considered blocking because of their signature.
You can visit <a href="resteasy-reactive#execution-model-blocking-non-blocking">Execution model, blocking, non-blocking</a>
for more information.</p>
</div>
<div class="sect3">
<h4 id="get-started-with-virtual-threads-with-resteasy-reactive"><a class="anchor" href="#get-started-with-virtual-threads-with-resteasy-reactive"></a>RESTEasy Reactiveで仮想スレッド入門</h4>
<div class="paragraph">
<p>ビルドファイルに以下の依存関係を追加します：</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-resteasy-reactive&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">implementation("io.quarkus:quarkus-resteasy-reactive")</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、Java 21 以降を使用していることも確認する必要があります。これは、pom.xml ファイルで次のように強制できます。</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;properties&gt;
    &lt;maven.compiler.source&gt;21&lt;/maven.compiler.source&gt;
    &lt;maven.compiler.target&gt;21&lt;/maven.compiler.target&gt;
&lt;/properties&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="three-development-and-execution-models"><a class="anchor" href="#three-development-and-execution-models"></a>3つの開発・実行モデル</h4>
<div class="paragraph">
<p>以下の例は、3つのエンドポイントの違いを示しています。これらのエンドポイントはすべて、データベース上の <em>財産</em> を照会し、それをクライアントに返します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1つ目は伝統的なブロッキングスタイルを採用しており、そのシグネチャからブロッキングとみなされます。</p>
</li>
<li>
<p>2つ目はMutinyを使用し、そのシグネチャによりノンブロッキングとみなされます。</p>
</li>
<li>
<p>3番目はMutinyを使用しますが、同期的な方法で使用し、"リアクティブ型"を返さないので、ブロッキングとみなされ、 <a href="https://javadoc.io/doc/io.smallrye.common/smallrye-common-annotation/latest/io/smallrye/common/annotation/RunOnVirtualThread.html">@RunOnVirtualThread</a> アノテーションが使用できます。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme.rest;

import org.acme.fortune.model.Fortune;
import org.acme.fortune.repository.FortuneRepository;
import io.smallrye.common.annotation.RunOnVirtualThread;
import io.smallrye.mutiny.Uni;

import jakarta.ws.rs.GET;
import jakarta.ws.rs.Path;
import java.util.List;
import java.util.Random;


@Path("")
public class FortuneResource {

    @Inject FortuneRepository repository;

    @GET
    @Path("/blocking")
    public Fortune blocking() {
        // Runs on a worker (platform) thread
        var list = repository.findAllBlocking();
        return pickOne(list);
    }

    @GET
    @Path("/reactive")
    public Uni&lt;Fortune&gt; reactive() {
        // Runs on the event loop
        return repository.findAllAsync()
                .map(this::pickOne);
    }

    @GET
    @Path("/virtual")
    @RunOnVirtualThread
    public Fortune virtualThread() {
        // Runs on a virtual thread
        var list = repository.findAllAsyncAndAwait();
        return pickOne(list);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下の表は各選択肢の概要です：</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">モデル</th>
<th class="tableblock halign-left valign-top">シグネチャの例</th>
<th class="tableblock halign-left valign-top">長所</th>
<th class="tableblock halign-left valign-top">短所</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">同期コードでワーカースレッド上</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Fortune blocking()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">シンプルなコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ワーカースレッドを使用 (同時実行に制限)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">リアクティブコードでイベントループ上</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Uni&lt;Fortune&gt; reactive()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">高い同時実行性と低いリソース使用量</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">より複雑なコード</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">同期コードで仮想スレッド上</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>@RunOnVirtualThread Fortune vt()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">シンプルなコード</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ピン止め、独占、効率の悪いオブジェクト・プーリングのリスク</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>この3つのモデルすべてを1つのアプリケーションで使用できます。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="use-virtual-thread-friendly-clients"><a class="anchor" href="#use-virtual-thread-friendly-clients"></a>仮想スレッドフレンドリーなクライアントの使用</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#why-not">すべてを仮想スレッドで実行しない理由</a> セクションで述べたように、Java エコシステムは仮想スレッドに完全には対応していません。
したがって、特に I/O を実行するライブラリーを使用する場合は注意が必要です。</p>
</div>
<div class="paragraph">
<p>幸いなことに、Quarkus は仮想スレッドですぐに使用できる大規模なエコシステムを提供しています。
Quarkus で使用されるリアクティブプログラミングライブラリーである Mutiny と Vert.x Mutiny バインディングは、キャリアースレッドをピン留めしないブロッキングコード (したがって、恐れる必要はなく、学習曲線もありません) を記述する機能を提供します。</p>
</div>
<div class="paragraph">
<p>上記の結果として、以下のようになります。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Quarkus extensions providing blocking APIs on top of reactive APIs can be used in virtual threads.
This includes the reactive rest client, the redis client, the mailer&#8230;&#8203;</p>
</li>
<li>
<p><code>Uni</code> を返す API は、 <code>uni.await().atMost(&#8230;&#8203;)</code> を使用して直接使用できます。これは、キャリアースレッドをブロックせずに仮想スレッドをブロックし、簡単な (非ブロッキング) タイムアウトサポートによってアプリケーションの耐障害性も向上させます。</p>
</li>
<li>
<p><a href="https://smallrye.io/smallrye-mutiny-vertx-bindings/latest/">Mutiny バインディングを使用する Vert.x クライアント</a> を使用する場合は、キャリアースレッドをピニングせずに結果を取得するまでブロックする <code>andAwait()</code> メソッドを使用します。これには、すべてのリアクティブ SQL ドライバーが含まれます。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="detect-pinned-thread-in-tests"><a class="anchor" href="#detect-pinned-thread-in-tests"></a>テストでピン止めされたスレッドを検出</h2>
<div class="sectionbody">
<div class="paragraph">
<p>仮想スレッドを使用するアプリケーションでテストを実行する場合は、以下の設定を使用することをお勧めします。
テストが失敗することはありませんが、コードがキャリアのスレッドをピン留めした場合は、少なくともスタートトレースをダンプします：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
  &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
  &lt;version&gt;${surefire-plugin.version}&lt;/version&gt;
  &lt;configuration&gt;
      &lt;systemPropertyVariables&gt;
        &lt;java.util.logging.manager&gt;org.jboss.logmanager.LogManager&lt;/java.util.logging.manager&gt;
        &lt;maven.home&gt;${maven.home}&lt;/maven.home&gt;
      &lt;/systemPropertyVariables&gt;
      &lt;argLine&gt;-Djdk.tracePinnedThreads&lt;/argLine&gt;
  &lt;/configuration&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="run-application-using-virtual-threads"><a class="anchor" href="#run-application-using-virtual-threads"></a>仮想スレッドを使用したアプリケーションの実行</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">java -jar target/quarkus-app/quarkus-run.jar</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Java 21以前では、仮想スレッドはまだ実験的な機能であったため、 <code>--enable-preview</code> フラグを付けてアプリケーションを起動する必要があります。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="build-containers-for-application-using-virtual-threads"><a class="anchor" href="#build-containers-for-application-using-virtual-threads"></a>仮想スレッドを使用したアプリケーションのコンテナのビルド</h2>
<div class="sectionbody">
<div class="paragraph">
<p>アプリケーションをJVMモードで実行する場合（つまりネイティブにコンパイルしない場合、ネイティブについては <a href="#native">専用のセクション</a> を参照してください）、 <a href="./container-image">コンテナ化ガイド</a> に従ってコンテナをビルドすることができます。</p>
</div>
<div class="paragraph">
<p>このセクションでは、JIB を使用してコンテナをビルドします。
他の方法については、 <a href="./container-image">コンテナ化ガイド</a> を参照してください。</p>
</div>
<div class="paragraph">
<p><code>@RunOnVirtualThread</code> を使用する Quarkus アプリケーションをコンテナ化するには、 <code>application.properties</code> に以下のプロパティを追加します：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.container-image.build=true
quarkus.container-image.group=&lt;your-group-name&gt;
quarkus.container-image.name=&lt;you-container-name&gt;
quarkus.jib.base-jvm-image=registry.access.redhat.com/ubi8/openjdk-21-runtime <i class="conum" data-value="1"></i><b>(1)</b>
quarkus.jib.platforms=linux/amd64,linux/arm64 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>仮想スレッドをサポートするベースイメージを使用するようにしてください。ここでは、Java 21 を提供するイメージを使用します。設定しない場合は、Quarkus によって Java 21+ を提供するイメージが自動的に選択されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ターゲットアーキテクチャーを選択します。複数選択して multi-archs イメージを構築できます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次に、通常と同じようにコンテナをビルドします。
例えば、Mavenを使用している場合、次を実行します：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn package</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="native"><a class="anchor" href="#native"></a>仮想スレッドを使用したQuarkusアプリケーションのネイティブ実行可能ファイルへのコンパイル</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="using-a-local-graalvm-installation"><a class="anchor" href="#using-a-local-graalvm-installation"></a>ローカルにインストールしたGraalVMの使用</h3>
<div class="paragraph">
<p><code>@RunOnVirtualThread</code> を活用した Quarkus アプリケーションをネイティブ実行可能ファイルにコンパイルするには、仮想スレッドをサポートする GraalVM/Mandrel <code>native-image</code> を使用する必要があり、少なくとも Java 21 を提供する必要があります。</p>
</div>
<div class="paragraph">
<p><a href="./building-native-image">ネイティブコンパイルガイド</a> に示されているように、ネイティブ実行可能ファイルをビルドします。
たとえば、Maven の場合は、以下を実行します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn package -Dnative</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-an-in-container-build"><a class="anchor" href="#using-an-in-container-build"></a>コンテナ内ビルドの使用</h3>
<div class="paragraph">
<p>コンテナ内ビルドでは、コンテナ内で動作する <code>native-image</code> コンパイラを使用して Linux 64 実行可能ファイルをビルドできます。
これは、 <code>native-image</code> をマシンにインストールする手間を省き、必要な GraalVM バージョンを設定することもできます。
コンテナ内ビルドを使用するには、DockerまたはPodmanがマシンにインストールされている必要があることに注意してください。</p>
</div>
<div class="paragraph">
<p>そして、 <code>application.properties</code> ファイルに追加します:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># In-container build to get a linux 64 executable
quarkus.native.container-build=true <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>コンテナ内ビルドを有効にします。</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">ARM/64からAMD/64へ</div>
<div class="paragraph">
<p>Mac M1またはM2（ARM64 CPUを使用）を使用している場合、コンテナ内ビルドを使用して取得するネイティブ実行可能ファイルはLinux実行可能ファイルですが、ホスト（ARM64）アーキテクチャを使用していることに注意する必要があります。
以下のプロパティでDockerを使用する際に、エミュレーションを使用して強制的にアーキテクチャを変更することができます：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.native.container-runtime-options=--platform=linux/amd64</code></pre>
</div>
</div>
<div class="paragraph">
<p>コンパイル時間がかなり長くなる（10分以上）ことに注意してください。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="containerize-native-applications-using-virtual-threads"><a class="anchor" href="#containerize-native-applications-using-virtual-threads"></a>仮想スレッドを使用したネイティブ・アプリケーションのコンテナ化</h3>
<div class="paragraph">
<p>ネイティブ実行可能ファイルにコンパイルされた仮想スレッドを使用してQuarkusアプリケーションを実行するコンテナをビルドするには、
Linux/AMD64実行ファイル（ARMマシンを対象としている場合はARM64）を用意する必要があります。</p>
</div>
<div class="paragraph">
<p><code>application.properties</code> に <a href="#native">ネイティブ・コンパイルのセクション</a> で説明した設定が含まれているようにしてください。</p>
</div>
<div class="paragraph">
<p>次に、通常と同じようにコンテナをビルドします。
例えば、Mavenを使用している場合、次を実行します：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn package -Dnative</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
ネイティブコンテナイメージをビルドしたいときに、すでに既存のネイティブイメージがある場合は、 <code>-Dquarkus.native.reuse-existing=true</code> を設定すれば、ネイティブイメージのビルドは再実行されません。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="use-the-duplicated-context-in-virtual-threads"><a class="anchor" href="#use-the-duplicated-context-in-virtual-threads"></a>仮想スレッドで複製されたコンテキストの使用</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>@RunOnVirtualThread</code> でアノテーションされたメソッドは、複製された元のコンテキストを継承します (詳細は <a href="duplicated-context">複製されたコンテキストのリファレンスガイド</a> を参照ください)。
そのため、フィルタやインターセプタによって複製されたコンテキストに書き込まれたデータ (およびリクエストスコープが複製されたコンテキストに格納されているため、リクエストスコープ) は、メソッドの実行中に (フィルタやインターセプタが仮想スレッド上で実行されていなくても) 利用可能です。</p>
</div>
<div class="paragraph">
<p>ただし、スレッドローカルは伝播されません。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="virtual-thread-names"><a class="anchor" href="#virtual-thread-names"></a>仮想スレッド名</h2>
<div class="sectionbody">
<div class="paragraph">
<p>仮想スレッドは、デフォルトではスレッド名なしで作成されます。これは、デバッグやロギング目的で実行を識別するためには実用的ではありません。
Quarkusの管理対象仮想スレッドには名前が付けられ、 <code>quarkus-virtual-thread-</code> というプレフィックスが付けられます。
このプレフィックスはカスタマイズすることも、空の値を設定して命名を完全に無効にすることもできます:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.virtual-threads.name-prefix=</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inject-the-virtual-thread-executor"><a class="anchor" href="#inject-the-virtual-thread-executor"></a>仮想スレッドエグゼキュータの注入</h2>
<div class="sectionbody">
<div class="paragraph">
<p>仮想スレッド上でタスクを実行するために、Quarkusは内部 <code>ThreadPerTaskExecutor</code> を管理します。
まれにこのエクゼキューターに直接アクセスする必要がある場合は、 <code>@VirtualThreads</code> CDI修飾子を使用して注入できます：</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Virtual Thread ExecutorService の注入は実験的なもので、将来のバージョンで変更される可能性があります。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package org.acme;

import org.acme.fortune.repository.FortuneRepository;

import java.util.concurrent.ExecutorService;

import jakarta.enterprise.event.Observes;
import jakarta.inject.Inject;
import jakarta.transaction.Transactional;

import io.quarkus.logging.Log;
import io.quarkus.runtime.StartupEvent;
import io.quarkus.virtual.threads.VirtualThreads;

public class MyApplication {

    @Inject
    FortuneRepository repository;

    @Inject
    @VirtualThreads
    ExecutorService vThreads;

    void onEvent(@Observes StartupEvent event) {
        vThreads.execute(this::findAll);
    }

    @Transactional
    void findAll() {
        Log.info(repository.findAllBlocking());
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing-virtual-thread-applications"><a class="anchor" href="#testing-virtual-thread-applications"></a>仮想スレッドアプリケーションのテスト</h2>
<div class="sectionbody">
<div class="paragraph">
<p>上述したように、仮想スレッドにはいくつかの制限があり、 アプリケーションのパフォーマンスやメモリ使用量に大きな影響を与える可能性があります。
<em>junit5-virtual-threads</em> エクステンションは、テストの実行中にピン留めされたキャリアスレッドを検出する方法を提供します。
このため、最も顕著な制限のひとつを取り除いたり、 問題に気づいたりすることができます。</p>
</div>
<div class="paragraph">
<p>この検出を有効にするには</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1) <code>junit5-virtual-threads</code> の依存関係をプロジェクトに追加します：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus.junit5&lt;/groupId&gt;
    &lt;artifactId&gt;junit5-virtual-threads&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>2) テストケースに、 <code>io.quarkus.test.junit5.virtual.VirtualThreadUnit</code> と <code>io.quarkus.test.junit.virtual.ShouldNotPin</code> のアノテーションを追加します：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@QuarkusTest
@TestMethodOrder(MethodOrderer.OrderAnnotation.class)
@VirtualThreadUnit // Use the extension
@ShouldNotPin // Detect pinned carrier thread
class TodoResourceTest {
    // ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>テストを実行すると（Java 21+を使用することを忘れないでください）、Quarkusはピンされたキャリアスレッドを検出します。
この場合、テストは失敗します。</p>
</div>
<div class="paragraph">
<p><code>@ShouldNotPin</code> はメソッドに直接使うこともできます。</p>
</div>
<div class="paragraph">
<p><em>junit5-virtual-threadsは</em> 、ピニングが避けられない場合のために <code>@ShouldPin</code> アノテーションも提供しています。
次のスニペットは <code>@ShouldPin</code> アノテーションの使い方を示しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@VirtualThreadUnit // Use the extension
public class LoomUnitExampleTest {

    CodeUnderTest codeUnderTest = new CodeUnderTest();

    @Test
    @ShouldNotPin
    public void testThatShouldNotPin() {
        // ...
    }

    @Test
    @ShouldPin(atMost = 1)
    public void testThatShouldPinAtMostOnce() {
        codeUnderTest.pin();
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="additional-references"><a class="anchor" href="#additional-references"></a>参考文献</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://dl.acm.org/doi/10.1145/3583678.3596895">Javaフレームワークにおける仮想スレッドの統合に関する考察：リソース制約環境におけるQuarkusの例</a></p>
</li>
</ul>
</div>
</div>
</div>
    </div>
    <div class="grid__item width-4-12 width-12-12-m tocwrapper">
      <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#what-are-virtual-threads">仮想スレッドとは？</a>
<ul class="sectlevel2">
<li><a href="#terminology">用語解説</a></li>
<li><a href="#differences-between-virtual-threads-and-platform-threads">仮想スレッドとプラットフォームスレッドの違い</a></li>
<li><a href="#the-continuation-dance">継続ダンス</a></li>
<li><a href="#cpu-bound">仮想スレッドはI/Oバウンドワークロードにのみに有効</a></li>
</ul>
</li>
<li><a href="#run-code-on-virtual-threads-using-runonvirtualthread">@RunOnVirtualThread を使用した仮想スレッド上でのコード実行</a>
<ul class="sectlevel2">
<li><a href="#why-not">なぜすべてを仮想スレッドで実行しないのか？</a></li>
<li><a href="#use-runonvirtualthread-with-resteasy-reactive">RESTEasy Reactiveで@RunOnVirtualThreadを使用する。</a></li>
</ul>
</li>
<li><a href="#use-virtual-thread-friendly-clients">仮想スレッドフレンドリーなクライアントの使用</a></li>
<li><a href="#detect-pinned-thread-in-tests">テストでピン止めされたスレッドを検出</a></li>
<li><a href="#run-application-using-virtual-threads">仮想スレッドを使用したアプリケーションの実行</a></li>
<li><a href="#build-containers-for-application-using-virtual-threads">仮想スレッドを使用したアプリケーションのコンテナのビルド</a></li>
<li><a href="#native">仮想スレッドを使用したQuarkusアプリケーションのネイティブ実行可能ファイルへのコンパイル</a>
<ul class="sectlevel2">
<li><a href="#using-a-local-graalvm-installation">ローカルにインストールしたGraalVMの使用</a></li>
<li><a href="#using-an-in-container-build">コンテナ内ビルドの使用</a></li>
<li><a href="#containerize-native-applications-using-virtual-threads">仮想スレッドを使用したネイティブ・アプリケーションのコンテナ化</a></li>
</ul>
</li>
<li><a href="#use-the-duplicated-context-in-virtual-threads">仮想スレッドで複製されたコンテキストの使用</a></li>
<li><a href="#virtual-thread-names">仮想スレッド名</a></li>
<li><a href="#inject-the-virtual-thread-executor">仮想スレッドエグゼキュータの注入</a></li>
<li><a href="#testing-virtual-thread-applications">仮想スレッドアプリケーションのテスト</a></li>
<li><a href="#additional-references">参考文献</a></li>
</ul></div>
    </div>
  </div>
  <h2>関連コンテンツ</h2>
  <div class="grid-wrapper relations">
    <div class="grid__item width-6-12 width-12-12-m">
      <h3>同じトピックについて</h3>
      <ul class="related-content">
      
        
        <li class="guide"><a href="/version/3.8/guides/grpc-virtual-threads">Quarkusの仮想スレッドによるgRPCサービスのサポート</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/messaging-virtual-threads">Reactive MessagingによるQuarkus仮想スレッドのサポート</a></li>
      
        
        <li class="howto"><a href="/version/3.8/guides/resteasy-reactive-virtual-threads">RESTアプリケーションで仮想スレッドを使用</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/resteasy-reactive">RESTEasy Reactive を使用して REST サービスを作成する</a></li>
      </ul>
    </div>
    </div>
  </div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license. <i class='fab fa-creative-commons'></i><i class='fab fa-creative-commons-by'></i> <a href='https://creativecommons.org/licenses/by/3.0/' target='_blank'>CC by 3.0</a><br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">ホーム</a></li>
          
          
          
            <li><a href="/about" target="_blank">Quarkusについて</a></li>
          
          
          
            <li><a href="/blog" target="_blank">ブログ</a></li>
          
          
          
            <li><a href="/insights" target="_blank">ポッドキャスト</a></li>
          
          
          
            <li><a href="/events" target="_blank">イベント</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">ニュースレター</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">ユーザーストーリー</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">ロードマップ</a></li>
          
          
          
            <li><a href="/security" target="_blank">セキュリティ&nbsp;ポリシー</a></li>
          
          
          
            <li><a href="/usage" target="_blank">使用方法</a></li>
          
          
          
            <li><a href="https://github.com/commonhaus/artwork/tree/main/projects/quarkus" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
          
            <li><a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy Policy</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォローする</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.threads.com/@quarkusio" target="_blank">Threads</a></li>
          
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">サポート</a></li>
          
          
          
            <li><a href="/guides" target="_blank">ガイド</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">入門</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">ディスカッション</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">開発メーリングリスト</a></li>
          
          
          
            <li><a href="https://stats.uptimerobot.com/ze1PfweT2p" target="_blank">Quarkus Service Status</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>言語</span>
        <ul class="footer-links">
          
          
            <li><a href=" https://quarkus.io/ " target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href=" https://es.quarkus.io/ " target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href=" https://ja.quarkus.io/ " target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate ORM</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">その他多数...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content cf-footer">
  <div class="flexcontainer">
    <div class="cf-logo">
      <a class="cf-logo" href="https://www.commonhaus.org/" target="_blank"><img src="https://raw.githubusercontent.com/commonhaus/artwork/main/foundation/brand/svg/CF_logo_horizontal_single_reverse.svg"/></a>
    </div>
    <div class="license">
      Copyright © Quarkus. All rights reserved. For details on our trademarks, please visit our <a href="https://www.commonhaus.org/policies/trademark-policy/">Trademark Policy</a> and <a href="https://www.commonhaus.org/trademarks/">Trademark List</a>. Trademarks of third parties are owned by their respective holders and their mention here does not suggest any endorsement or association.
    </div>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
  <script src="/assets/javascript/randomize.js" type="text/javascript"></script>
  <script src="/assets/javascript/time.js" type="text/javascript"></script>
</body>

</html>
