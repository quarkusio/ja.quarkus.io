<!DOCTYPE html>
<html lang="ja">







<head>
  <title>PanacheでシンプルになったHibernate Reactive - 3.8 - Quarkus</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="
  connect-src 'self' https://dpm.demdex.net https://adobedc.demdex.net https://analytics.ossupstream.org/ https://search.quarkus.io https://smetrics.redhat.com https://ajax.googleapis.com; 
  script-src 'self' 'unsafe-inline' 'unsafe-eval'
      
      https://assets.adobedtm.com
      js.bizographics.com
      https://www.redhat.com
      https://static.redhat.com
      https://app.requestly.io/
      jsonip.com
      https://ajax.googleapis.com
      https://use.fontawesome.com
      http://www.youtube.com
      http://www.googleadservices.com
      https://googleads.g.doubleclick.net
      https://giscus.app
      https://analytics.ossupstream.org/
      https://app.mailjet.com;

  style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; 
  img-src 'self' * data:; 
  media-src 'self'; 
  frame-src https://redhat.demdex.net https://www.youtube.com https://player.restream.io https://app.mailjet.com http://xy0p2.mjt.lu https://mj.quarkus.io https://giscus.app; 
  base-uri 'none'; 
  object-src 'none'; 
  form-action 'none'; 
  font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />

  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/3.8/guides/hibernate-reactive-panache" />
  <meta property="og:title" content="PanacheでシンプルになったHibernate Reactive - 3.8" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/hibernate-reactive-panache">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
  
  
  
  
  <link rel="alternate" hreflang="x-default" href="https://quarkus.io/" />  
  <script src="/assets/javascript/tracking.js"></script>
  
  <script src="/assets/javascript/colormode.js" type="text/javascript"></script>

</head>

<body class="guides">

  


<div class="grid-wrapper communitysite">
  <div class="grid__item width-12-12">The <a href="https://quarkus.io/version/3.8/guides/hibernate-reactive-panache">English version of quarkus.io</a> is the official project site. Translated sites are community supported on a best-effort basis.</div>
</div>


  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
        <div class="logo-wrapper">
           <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
        </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="#">Why<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUSとは何か?</a></li>
          <li><a href="/developer-joy" class="">開発者満足</a></li>
          <li><a href="/performance" class="">パフォーマンス</a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES NATIVE</a></li>
          <li><a href="/standards" class="">標準</a></li>
          <li><a href="/versatility" class="">多用途性</a></li>
          <li><a href="/container-first" class="">コンテナ・ファースト</a></li>
          <li><a href="/spring" class="">USING SPRING?</a></li>
          <li class="tertiarydropdown">
            <span href="#">AI<i class="fas fa-chevron-down"></i></span>
            <ul class="tertiarymenu">
              <li><a href="/ai" class="">AI OVERVIEW</a></li>
              <li><a href="/java-for-ai" class="">JAVA FOR AI</a></li>
              <li><a href="/quarkus-for-ai" class="">WHY QUARKUS FOR AI</a></li>
              <li><a href="/ai-blueprints" class="">AI BLUEPRINTS</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Learn<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入門</a></li>
          <li><a href="/guides" class="active">ドキュメント</a></li>
          <li><a href="/userstories/" class="">ユーザーストーリー</a></li>  
          <li><a href="/qtips" class="">"Q" Tipsビデオ</a></li>          
          <li><a href="/books" class="">書籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="#">Extensions<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          
          <!-- Note that quarkus.io is hardcoded here, because it is the only url which supports extensions -->
<li><a href="https://quarkus.io/extensions/" class="">エクステンションを探す</a></li>
          <li><a href="/faq/#what-is-a-quarkus-extension" class="">エクステンションの使用</a></li>
          <li><a href="/guides/writing-extensions" class="">エクステンションの作成</a></li>
          <li><a href="https://hub.quarkiverse.io" class="">エクステンションの共有</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="#">Community<i class="fas fa-chevron-down firsti"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">サポート</a></li>
          <li><a href="/blog" class="">ブログ</a></li>
          <li><a href="/discussion" class="">ディスカッション</a></li>
          <li><a href="/working-groups" class="">ワーキンググループ</a></li>
          <li><a href="/insights" class="">ポッドキャスト</a></li>
          <li><a href="/events" class="">イベント</a></li>
          <li><a href="/newsletter" class="">ニュースレター</a></li>
          <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" class="">ロードマップ</a></li>
          <li><a href="/benefactors" class="">BENEFACTORS</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">コーディングを開始</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/version/3.8/guides/hibernate-reactive-panache" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://pt.quarkus.io/version/3.8/guides/hibernate-reactive-panache">ポルトガル（BR）</a></li>
          <li><a href="https://es.quarkus.io/version/3.8/guides/hibernate-reactive-panache">ESPAÑOL</a></li>
          <li><a href="https://cn.quarkus.io/version/3.8/guides/hibernate-reactive-panache">简体中文</a></li>
          <li><a href="https://ja.quarkus.io/version/3.8/guides/hibernate-reactive-panache">日本語</a></li>
          </ul>
      </li>
      <li>
        <span href="#" class="modeswitcher" id='theme-toggle'><i class="fas
fa-sun"></i><i class="fas fa-moon"></i><i class="fas fa-cog"></i></span>
      </li>
    </ul>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    







<section class="full-width-version-bg flexfilterbar guides">
  <div class="guideflexcontainer">
    <div class="docslink">
      <a class="returnlink" href="/version/3.8/guides/"> Back to Guides</a>
    </div>
    <div class="flexlabel">
      <label>バージョン:</label>
    </div>
    <div class="guidepulldown version">
    <select id="guide-version-dropdown">
      
        
        
        <option value="main" >Main - SNAPSHOT</option>
        
        
        
        <option value="latest" >3.31.3 - Latest</option>
        
        
        
        <option value="3.27" >3.27</option>
        
        
        
        <option value="3.20" >3.20</option>
        
        
        
        <option value="3.15" >3.15</option>
        
        
        
        <option value="3.8" selected>3.8</option>
        </select>
    </div>
  </div>
</section>

<div class="guide">
  <div class="grid-wrapper">
    <div class="grid__item width-8-12 width-12-12-m">
      
      <h1 class="text-caps">PanacheでシンプルになったHibernate Reactive </h1>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://hibernate.org/reactive/">Hibernate Reactive</a>は 、唯一のリアクティブ Jakarta Persistence（旧JPA）実装で、リアクティブドライバでデータベースにアクセスできるObject Relational Mapperの全機能を提供します。複雑なマッピングを可能にしますが、単純で一般的なマッピングを容易なものにするわけではありません。Hibernate Reactive with Panacheは、Quarkusでエンティティを簡単に、楽しく書けるようにすることに重点を置いています。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Hibernate Reactive は、<a href="hibernate-orm-panache">Hibernate ORM</a> を置き換えるものでも、次世代の Hibernate ORM でもありません。
これは、高い同時実行性が必要なリアクティブなユースケース向けに調整された別のスタックです。</p>
</div>
<div class="paragraph">
<p>Furthermore, using RESTEasy Reactive, our default REST layer, does not require the use of Hibernate Reactive.
It is perfectly valid to use RESTEasy Reactive with Hibernate ORM,
and if you do not need high-concurrency, or are not accustomed to the reactive paradigm, it is recommended to use Hibernate ORM.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="first-an-example"><a class="anchor" href="#first-an-example"></a>最初に:例</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Panacheでは、HibernateのReactiveエンティティをこのように書けるようにしています:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.hibernate.reactive.panache.PanacheEntity;

@Entity
public class Person extends PanacheEntity {
    public String name;
    public LocalDate birth;
    public Status status;

    public static Uni&lt;Person&gt; findByName(String name){
        return find("name", name).firstResult();
    }

    public static Uni&lt;List&lt;Person&gt;&gt; findAlive(){
        return list("status", Status.Alive);
    }

    public static Uni&lt;Long&gt; deleteStefs(){
        return delete("name", "Stef");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>コードがどれだけコンパクトで読みやすくなっているかお気づきですか?面白いと思いませんか?読んでみてください。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>list()</code> メソッドには、最初は驚くかもしれません。これはHQL（JP-QL）クエリのフラグメントを取り、残りをコンテキスト化するものです。そのため、非常に簡潔で、しかも読みやすいコードになります。
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
上記で説明したのは、基本的に <a href="https://www.martinfowler.com/eaaCatalog/activeRecord.html">アクティブレコードパターン</a> であり、単にエンティティパターンと呼ばれることもあります。Hibernate with Panacheでは、 <code>PanacheRepository</code> を介して、より古典的な <a href="https://martinfowler.com/eaaCatalog/repository.html">リポジトリパターン</a> を使用することも可能です。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution"><a class="anchor" href="#solution"></a>ソリューション</h2>
<div class="sectionbody">
<div class="paragraph">
<p>次の章で紹介する手順に沿って、ステップを踏んでアプリを作成することをお勧めします。ただし、完成した例にそのまま進んでも構いません。</p>
</div>
<div class="paragraph">
<p>Gitレポジトリをクローンするか <code>git clone -b 3.8 <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code> 、 <a href="https://github.com/quarkusio/quarkus-quickstarts/archive/3.8.zip">アーカイブ</a> をダウンロードします。</p>
</div>
<div class="paragraph">
<p>ソリューションは <code>hibernate-reactive-panache-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/3.8/hibernate-reactive-panache-quickstart">ディレクトリ</a> にあります。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>プロジェクトがすでに他のアノテーションプロセッサーを使用するように設定されている場合、追加でPanacheアノテーションプロセッサーを追加する必要があります:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
    &lt;version&gt;${compiler-plugin.version}&lt;/version&gt;
    &lt;configuration&gt;
        &lt;parameters&gt;${maven.compiler.parameters}&lt;/parameters&gt;
        &lt;annotationProcessorPaths&gt;
            &lt;!-- Your existing annotation processor(s)... --&gt;
            &lt;path&gt;
                &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
                &lt;artifactId&gt;quarkus-panache-common&lt;/artifactId&gt;
                &lt;version&gt;${quarkus.platform.version}&lt;/version&gt;
            &lt;/path&gt;
        &lt;/annotationProcessorPaths&gt;
    &lt;/configuration&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">annotationProcessor("io.quarkus:quarkus-panache-common")</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-up-and-configuring-hibernate-reactive-with-panache"><a class="anchor" href="#setting-up-and-configuring-hibernate-reactive-with-panache"></a>PanacheによるHibernate Reactiveのセットアップと設定</h2>
<div class="sectionbody">
<div class="paragraph">
<p>始めるには</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>application.properties</code> に設定を追加する。</p>
</li>
<li>
<p>エンティティに <code>@Entity</code> アノテーションを付けます</p>
</li>
<li>
<p>エンティティが <code>PanacheEntity</code> を拡張するようにする(リポジトリパターンを使用している場合はオプションです)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>すべての設定は、 <a href="hibernate-orm.html#setting-up-and-configuring-hibernate-orm">Hibernateセットアップガイド</a>を確認してください。</p>
</div>
<div class="paragraph">
<p>ビルドファイルに、以下の依存関係を追加します:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hibernate Reactive with Panache エクステンション</p>
</li>
<li>
<p>お使いのリアクティブドライバのエクステンション ( <code>quarkus-reactive-pg-client</code> , <code>quarkus-reactive-mysql-client</code> , <code>quarkus-reactive-db2-client</code> , &#8230;&#8203; )</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>例えば</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- Hibernate Reactive dependency --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-hibernate-reactive-panache&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- Reactive SQL client for PostgreSQL --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-reactive-pg-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">// Hibernate Reactive dependency
implementation("io.quarkus:quarkus-hibernate-reactive-panache")

Reactive SQL client for PostgreSQL
implementation("io.quarkus:quarkus-reactive-pg-client")</code></pre>
</div>
</div>
<div class="paragraph">
<p>そして、 <code>application.properties</code> に関連する設定プロパティーを追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># configure your datasource
quarkus.datasource.db-kind = postgresql
quarkus.datasource.username = sarah
quarkus.datasource.password = connor
quarkus.datasource.reactive.url = vertx-reactive:postgresql://localhost:5432/mydatabase

# drop and create the database at startup (use `update` to only update the schema)
quarkus.hibernate-orm.database.generation = drop-and-create</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution-1-using-the-active-record-pattern"><a class="anchor" href="#solution-1-using-the-active-record-pattern"></a>解決策1:アクティブレコードパターンを使用する</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="defining-your-entity"><a class="anchor" href="#defining-your-entity"></a>エンティティの定義</h3>
<div class="paragraph">
<p>Panache エンティティーを定義するには、 <code>PanacheEntity</code> を拡張して <code>@Entity</code> とアノテーションを付け、列をパブリック フィールドとして追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person extends PanacheEntity {
    public String name;
    public LocalDate birth;
    public Status status;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>publicフィールドには、すべてのJakarta Persistenceのカラムアノテーションを付けることができます。永続化しないフィールドが必要な場合は、 <code>@Transient</code> アノテーションをそのフィールドに使用します。アクセサーを書く必要がある場合は、次のようにできます:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person extends PanacheEntity {
    public String name;
    public LocalDate birth;
    public Status status;

    // return name as uppercase in the model
    public String getName(){
        return name.toUpperCase();
    }

    // store all names in lowercase in the DB
    public void setName(String name){
        this.name = name.toLowerCase();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>また、当社のフィールドアクセスリライトのおかげで、ユーザーが <code>person.name</code> を読むときには、実際に <code>getName()</code> アクセサが呼び出されます。これはフィールドの書き込みやセッターについても同様です。これにより、すべてのフィールドの呼び出しが、対応するゲッター/セッターの呼び出しに置き換えられるため、実行時に適切なカプセル化が可能になります。</p>
</div>
</div>
<div class="sect2">
<h3 id="most-useful-operations"><a class="anchor" href="#most-useful-operations"></a>最も便利な操作</h3>
<div class="paragraph">
<p>エンティティを記述したら、ここでは実行できる最も一般的な操作を紹介します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// creating a person
Person person = new Person();
person.name = "Stef";
person.birth = LocalDate.of(1910, Month.FEBRUARY, 1);
person.status = Status.Alive;

// persist it
Uni&lt;Void&gt; persistOperation = person.persist();

// note that once persisted, you don't need to explicitly save your entity: all
// modifications are automatically persisted on transaction commit.

// check if it is persistent
if(person.isPersistent()){
    // delete it
    Uni&lt;Void&gt; deleteOperation = person.delete();
}

// getting a list of all Person entities
Uni&lt;List&lt;Person&gt;&gt; allPersons = Person.listAll();

// finding a specific person by ID
Uni&lt;Person&gt; personById = Person.findById(23L);

// finding all living persons
Uni&lt;List&lt;Person&gt;&gt; livingPersons = Person.list("status", Status.Alive);

// counting all persons
Uni&lt;Long&gt; countAll = Person.count();

// counting all living persons
Uni&lt;Long&gt; countAlive = Person.count("status", Status.Alive);

// delete all living persons
Uni&lt;Long&gt; deleteAliveOperation = Person.delete("status", Status.Alive);

// delete all persons
Uni&lt;Long&gt; deleteAllOperation = Person.deleteAll();

// delete by id
Uni&lt;Boolean&gt; deleteByIdOperation = Person.deleteById(23L);

// set the name of all living persons to 'Mortal'
Uni&lt;Integer&gt; updateOperation = Person.update("name = 'Mortal' where status = ?1", Status.Alive);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding-entity-methods"><a class="anchor" href="#adding-entity-methods"></a>エンティティメソッドの追加</h3>
<div class="paragraph">
<p>エンティティに対するカスタムクエリを、エンティティ自体の中に追加できます。そうすることで、自分や同僚が簡単に見つけることができ、クエリは操作するオブジェクトと一緒に配置されます。エンティティクラスにスタティックメソッドとして追加するのがPanache Active Recordのやり方です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person extends PanacheEntity {
    public String name;
    public LocalDate birth;
    public Status status;

    public static Uni&lt;Person&gt; findByName(String name){
        return find("name", name).firstResult();
    }

    public static Uni&lt;List&lt;Person&gt;&gt; findAlive(){
        return list("status", Status.Alive);
    }

    public static Uni&lt;Long&gt; deleteStefs(){
        return delete("name", "Stef");
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution-2-using-the-repository-pattern"><a class="anchor" href="#solution-2-using-the-repository-pattern"></a>解決策2：リポジトリパターンの使用</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="defining-your-entity-2"><a class="anchor" href="#defining-your-entity-2"></a>エンティティの定義</h3>
<div class="paragraph">
<p>リポジトリパターンを使用する場合、エンティティを通常のJakarta Persistenceエンティティとして定義することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person {
    @Id @GeneratedValue private Long id;
    private String name;
    private LocalDate birth;
    private Status status;

    public Long getId(){
        return id;
    }
    public void setId(Long id){
        this.id = id;
    }
    public String getName() {
        return name;
    }
    public void setName(String name) {
        this.name = name;
    }
    public LocalDate getBirth() {
        return birth;
    }
    public void setBirth(LocalDate birth) {
        this.birth = birth;
    }
    public Status getStatus() {
        return status;
    }
    public void setStatus(Status status) {
        this.status = status;
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
エンティティにゲッター/セッターを定義するのが面倒な場合は、 <code>PanacheEntityBase</code> を拡張するようにすればQuarkusが生成してくれます。また、 <code>PanacheEntity</code> を拡張して、デフォルトのIDを利用することもできます。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="defining-your-repository"><a class="anchor" href="#defining-your-repository"></a>リポジトリの定義</h3>
<div class="paragraph">
<p>リポジトリを使用する場合、 <code>PanacheRepository</code> を実装することでアクティブレコードパターンとまったく同じ便利なメソッドをリポジトリにインジェクションできます:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class PersonRepository implements PanacheRepository&lt;Person&gt; {

   // put your custom logic here as instance methods

   public Uni&lt;Person&gt; findByName(String name){
       return find("name", name).firstResult();
   }

   public Uni&lt;List&lt;Person&gt;&gt; findAlive(){
       return list("status", Status.Alive);
   }

   public Uni&lt;Long&gt; deleteStefs(){
       return delete("name", "Stef");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>PanacheEntityBase</code> で定義されている操作はすべてリポジトリ上で利用可能なので、これを使用することはアクティブレコードパターンを使用するのと全く同じですが、それを注入する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject
PersonRepository personRepository;

@GET
public Uni&lt;Long&gt; count(){
    return personRepository.count();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="most-useful-operations-2"><a class="anchor" href="#most-useful-operations-2"></a>最も便利な操作</h3>
<div class="paragraph">
<p>リポジトリを書くことで実行可能な最も一般的な操作は以下の通りです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// creating a person
Person person = new Person();
person.setName("Stef");
person.setBirth(LocalDate.of(1910, Month.FEBRUARY, 1));
person.setStatus(Status.Alive);

// persist it
Uni&lt;Void&gt; persistOperation = personRepository.persist(person);

// note that once persisted, you don't need to explicitly save your entity: all
// modifications are automatically persisted on transaction commit.

// check if it is persistent
if(personRepository.isPersistent(person)){
    // delete it
    Uni&lt;Void&gt; deleteOperation = personRepository.delete(person);
}

// getting a list of all Person entities
Uni&lt;List&lt;Person&gt;&gt; allPersons = personRepository.listAll();

// finding a specific person by ID
Uni&lt;Person&gt; personById = personRepository.findById(23L);

// finding all living persons
Uni&lt;List&lt;Person&gt;&gt; livingPersons = personRepository.list("status", Status.Alive);

// counting all persons
Uni&lt;Long&gt; countAll = personRepository.count();

// counting all living persons
Uni&lt;Long&gt; countAlive = personRepository.count("status", Status.Alive);

// delete all living persons
Uni&lt;Long&gt; deleteLivingOperation = personRepository.delete("status", Status.Alive);

// delete all persons
Uni&lt;Long&gt; deleteAllOperation = personRepository.deleteAll();

// delete by id
Uni&lt;Boolean&gt; deleteByIdOperation = personRepository.deleteById(23L);

// set the name of all living persons to 'Mortal'
Uni&lt;Integer&gt; updateOperation = personRepository.update("name = 'Mortal' where status = ?1", Status.Alive);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
残りのドキュメントでは、アクティブレコードパターンに基づく使用法のみを示していますが、リポジトリパターンでも実行できることを覚えておいてください。リポジトリパターンの例は簡潔にするために省略しています。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advanced-query"><a class="anchor" href="#advanced-query"></a>アドバンスドクエリー</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="paging"><a class="anchor" href="#paging"></a>ページング</h3>
<div class="paragraph">
<p><code>list</code>  メソッドは、テーブルに含まれるデータセットが十分に小さい場合にのみ使用してください。より大きなデータセットの場合は、同等の <code>find</code> メソッドを使用して、ページングが可能な <code>PanacheQuery</code> を返すことができます:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// create a query for all living persons
PanacheQuery&lt;Person&gt; livingPersons = Person.find("status", Status.Alive);

// make it use pages of 25 entries at a time
livingPersons.page(Page.ofSize(25));

// get the first page
Uni&lt;List&lt;Person&gt;&gt; firstPage = livingPersons.list();

// get the second page
Uni&lt;List&lt;Person&gt;&gt; secondPage = livingPersons.nextPage().list();

// get page 7
Uni&lt;List&lt;Person&gt;&gt; page7 = livingPersons.page(Page.of(7, 25)).list();

// get the number of pages
Uni&lt;Integer&gt; numberOfPages = livingPersons.pageCount();

// get the total number of entities returned by this query without paging
Uni&lt;Long&gt; count = livingPersons.count();

// and you can chain methods of course
Uni&lt;List&lt;Person&gt;&gt; persons = Person.find("status", Status.Alive)
        .page(Page.ofSize(25))
        .nextPage()
        .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>PanacheQuery</code> 型には、ページングやリターンストリームを処理するための他の多くのメソッドがあります。</p>
</div>
</div>
<div class="sect2">
<h3 id="using-a-range-instead-of-pages"><a class="anchor" href="#using-a-range-instead-of-pages"></a>ページではなく範囲を使用する</h3>
<div class="paragraph">
<p><code>PanacheQuery</code> では、範囲ベースのクエリも可能です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// create a query for all living persons
PanacheQuery&lt;Person&gt; livingPersons = Person.find("status", Status.Alive);

// make it use a range: start at index 0 until index 24 (inclusive).
livingPersons.range(0, 24);

// get the range
Uni&lt;List&lt;Person&gt;&gt; firstRange = livingPersons.list();

// to get the next range, you need to call range again
Uni&lt;List&lt;Person&gt;&gt; secondRange = livingPersons.range(25, 49).list();</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>範囲とページを混在させることはできません。範囲を使用した場合、現在のページを持っていることに依存するすべてのメソッドは <code>UnsupportedOperationException</code> をスローします。 <code>page(Page)</code> もしくは <code>page(int, int)</code> を使用してページングに切り換えられます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="sorting"><a class="anchor" href="#sorting"></a>ソート</h3>
<div class="paragraph">
<p>クエリー文字列を受け付けるすべてのメソッドは、以下の簡略化されたクエリー形式も受け付けます:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Uni&lt;List&lt;Person&gt;&gt; persons = Person.list("order by name,birth");</code></pre>
</div>
</div>
<div class="paragraph">
<p>しかし、これらのメソッドには、オプションで <code>Sort</code> というパラメータが用意されており、これによってソートの抽象化が可能になります:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Uni&lt;List&lt;Person&gt;&gt; persons = Person.list(Sort.by("name").and("birth"));

// and with more restrictions
Uni&lt;List&lt;Person&gt;&gt; persons = Person.list("status", Sort.by("name").and("birth"), Status.Alive);

// and list first the entries with null values in the field "birth"
Uni&lt;List&lt;Person&gt;&gt; persons = Person.list(Sort.by("birth", Sort.NullPrecedence.NULLS_FIRST));</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Sort</code> クラスには、列を追加したり、ソート方向を指定したり、nullの優先順位を指定したりするメソッドが豊富に用意されています。</p>
</div>
</div>
<div class="sect2">
<h3 id="simplified-queries"><a class="anchor" href="#simplified-queries"></a>シンプルなクエリ</h3>
<div class="paragraph">
<p>通常、HQLのクエリは <code>from EntityName [where …​] [order by …​]</code> というように最後にオプションの要素を持つという形式になっています。</p>
</div>
<div class="paragraph">
<p>選択クエリーが <code>from</code> で始まらない場合は、以下の追加の形式をサポートしています:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>order by &#8230;&#8203;</code> は <code>from EntityName order by &#8230;&#8203;</code> に展開されます</p>
</li>
<li>
<p><code>&lt;singleColumnName&gt;</code> （およびシングルパラメータ は <code>from EntityName where &lt;singleColumnName&gt; = ?</code> に展開されます</p>
</li>
<li>
<p><code>&lt;query&gt;</code> は <code>from EntityName where &lt;query&gt;</code> に展開されます</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>更新クエリーが <code>update</code> で始まらない場合は、以下の追加の形式をサポートしています:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>from EntityName &#8230;&#8203;</code> は <code>update from EntityName &#8230;&#8203;</code> に展開されます</p>
</li>
<li>
<p><code>set? &lt;singleColumnName&gt;</code> （およびシングルパラメータ） は <code>update from EntityName set &lt;singleColumnName&gt; = ?</code> に展開されます</p>
</li>
<li>
<p><code>set? &lt;update-query&gt;</code> は <code>update from EntityName set &lt;update-query&gt;</code> に展開されます</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>削除クエリーが <code>delete</code> で始まらない場合は、以下の追加の形式をサポートしています:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>from EntityName …​</code> は <code>delete from EntityName &#8230;&#8203;</code> に展開されます</p>
</li>
<li>
<p><code>&lt;singleColumnName&gt;</code> （およびシングルパラメータ）は <code>delete from EntityName where &lt;singleColumnName&gt; = ?</code> に展開されます</p>
</li>
<li>
<p><code>&lt;query&gt;</code> は <code>delete from EntityName where &lt;query&gt;</code> に展開されます</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
また、プレーンな <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#hql">HQL</a> でクエリを記述することもできます：
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Order.find("select distinct o from Order o left join fetch o.lineItems");
Order.update("update from Person set name = 'Mortal' where status = ?", Status.Alive);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="named-queries"><a class="anchor" href="#named-queries"></a>名前付きクエリー</h3>
<div class="paragraph">
<p>名前付きのクエリーは、その名前の前に「#」文字を付けることで、（簡易）HQLクエリーの代わりに参照することができます。また、名前付きのクエリーは、カウント、更新、削除のクエリーにも使用できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
@NamedQueries({
    @NamedQuery(name = "Person.getByName", query = "from Person where name = ?1"),
    @NamedQuery(name = "Person.countByStatus", query = "select count(*) from Person p where p.status = :status"),
    @NamedQuery(name = "Person.updateStatusById", query = "update Person p set p.status = :status where p.id = :id"),
    @NamedQuery(name = "Person.deleteById", query = "delete from Person p where p.id = ?1")
})
public class Person extends PanacheEntity {
    public String name;
    public LocalDate birth;
    public Status status;

    public static Uni&lt;Person&gt; findByName(String name){
        return find("#Person.getByName", name).firstResult();
    }

    public static Uni&lt;Long&gt; countByStatus(Status status) {
        return count("#Person.countByStatus", Parameters.with("status", status).map());
    }

    public static Uni&lt;Long&gt; updateStatusById(Status status, Long id) {
        return update("#Person.updateStatusById", Parameters.with("status", status).and("id", id));
    }

    public static Uni&lt;Long&gt; deleteById(Long id) {
        return delete("#Person.deleteById", id);
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>名前付きクエリは、Jakarta Persistence エンティティ クラス内、またはそのスーパークラスの 1 つでのみ定義できます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="query-parameters"><a class="anchor" href="#query-parameters"></a>クエリパラメーター</h3>
<div class="paragraph">
<p>以下のように、インデックス（1ベース）でクエリーパラメーターを渡すことができます:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Person.find("name = ?1 and status = ?2", "stef", Status.Alive);</code></pre>
</div>
</div>
<div class="paragraph">
<p>または、 <code>Map</code> を使った名前で、</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();
params.put("name", "stef");
params.put("status", Status.Alive);
Person.find("name = :name and status = :status", params);</code></pre>
</div>
</div>
<div class="paragraph">
<p>または便利なクラスである <code>Parameters</code> をそのまま使用するか、 <code>Map</code> を構築します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// generate a Map
Person.find("name = :name and status = :status",
         Parameters.with("name", "stef").and("status", Status.Alive).map());

// use it as-is
Person.find("name = :name and status = :status",
         Parameters.with("name", "stef").and("status", Status.Alive));</code></pre>
</div>
</div>
<div class="paragraph">
<p>すべてのクエリ操作は、インデックス (<code>Object…​</code>) または名前 (<code>Map&lt;String,Object&gt;</code> または <code>Parameters</code>) でパラメータを渡すことができます。</p>
</div>
</div>
<div class="sect2">
<h3 id="query-projection"><a class="anchor" href="#query-projection"></a>クエリの射影レコード</h3>
<div class="paragraph">
<p>クエリの射影は、 <code>find()</code> のメソッドが返す <code>PanacheQuery</code> オブジェクトに対して <code>project(Class)</code> のメソッドで行うことができます。</p>
</div>
<div class="paragraph">
<p>これを使って、データベースから返されるフィールドを制限することができます。</p>
</div>
<div class="paragraph">
<p>Hibernateは <strong>DTOプロジェクション</strong> を使用し、プロジェクションクラスからの属性を持つSELECT句を生成します。これは <strong>動的インスタンス化</strong> または <strong>コンストラクタ式</strong> とも呼ばれ、詳細は Hibernate ガイドの <a href="https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#hql-select-clause">hql select 節</a> を参照してください。</p>
</div>
<div class="paragraph">
<p>射影クラスは、有効な Java Bean であり、すべての属性を含むコンストラクタを持つ必要があります。このコンストラクタは、エンティティクラスを使用する代わりに、射影のDTOをインスタンス化するために使用されます。このクラスは、すべてのクラス属性をパラメータとして持つ一致するコンストラクタを持つ必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.runtime.annotations.RegisterForReflection;

@RegisterForReflection <i class="conum" data-value="1"></i><b>(1)</b>
public class PersonName {
    public final String name; <i class="conum" data-value="2"></i><b>(2)</b>

    public PersonName(String name){ <i class="conum" data-value="3"></i><b>(3)</b>
        this.name = name;
    }
}

// only 'name' will be loaded from the database
PanacheQuery&lt;PersonName&gt; query = Person.find("status", Status.Alive).project(PersonName.class);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@RegisterForReflection</code> アノテーションは、ネイティブコンパイル時にクラスとそのメンバーを保持するようQuarkusに指示します。 <code>@RegisterForReflection</code> アノテーションの詳細については、 <a href="writing-native-applications-tips.html#registerForReflection">ネイティブアプリケーションのヒント</a>のページを参照してください。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ここではパブリックフィールドを使用していますが、必要に応じてプライベートフィールドやゲッター/セッターを使用することもできます。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>このコンストラクタはHibernate によって使用されます。このコンストラクタはクラス内の唯一のコンストラクタであり、パラメータとしてクラスのすべての属性を持つ必要があります。</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>project(Class)</code> メソッドの実装では、コンストラクタのパラメータ名を使用してクエリーの select 節を構築するため、コンパイルされたクラスの中にパラメータ名を格納するようにコンパイラを設定する必要があります。Quarkus Mavenアーキタイプを使用している場合はデフォルトで有効になっています。使用していない場合はプロパティ <code>&lt;maven.compiler.parameters&gt;true&lt;/maven.compiler.parameters&gt;</code> を <code>pom.xml</code> に追加してください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>DTO射影のオブジェクトから参照されるエンティティのフィールドがある場合、 <code>@ProjectedFieldName</code> アノテーションを使用してSELECT文のパスを提供することができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Dog extends PanacheEntity {
    public String name;
    public String race;
    public Double weight;
    @ManyToOne
    public Person owner;
}

@RegisterForReflection
public class DogDto {
    public String name;
    public String ownerName;

    public DogDto(String name, @ProjectedFieldName("owner.name") String ownerName) {  <i class="conum" data-value="1"></i><b>(1)</b>
        this.name = name;
        this.ownerName = ownerName;
    }
}

PanacheQuery&lt;DogDto&gt; query = Dog.findAll().project(DogDto.class);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>ownerName</code> DTOコンストラクタのパラメータは <code>owner.name</code> HQLプロパティから読み込まれます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>また、select句でHQLクエリを指定できます。この場合、射影クラスは、select句が返す値に一致するコンストラクタを持つ必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.runtime.annotations.RegisterForReflection;

@RegisterForReflection
public class RaceWeight {
    public final String race;
    public final Double weight

    public RaceWeight(String race) {
        this(race, null);
    }

    public RaceWeight(String race, Double weight) { <i class="conum" data-value="1"></i><b>(1)</b>
        this.race = race;
        this.weight = weight;
    }
}

// Only the race and the average weight will be loaded
PanacheQuery&lt;RaceWeight&gt; query = Person.find("select d.race, AVG(d.weight) from Dog d group by d.race").project(RaceWeight.class);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hibernate Reactive は、このコンストラクタを使用します。クエリが select 節を持つ場合、複数のコンストラクタを持つことが可能です。</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>HQL <code>select new</code> クエリと <code>.project(Class)</code> を同時に行うことはできません。どちらかの方法を選択する必要があります。</p>
</div>
<div class="paragraph">
<p>例えば、このような場合、失敗します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">PanacheQuery&lt;RaceWeight&gt; query = Person.find("select new MyView(d.race, AVG(d.weight)) from Dog d group by d.race").project(AnotherView.class);</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multiple-persistence-units"><a class="anchor" href="#multiple-persistence-units"></a>複数の永続性ユニット</h2>
<div class="sectionbody">
<div class="paragraph">
<p>QuarkusのHibernate Reactiveは現時点では複数の永続化ユニットをサポートしていません。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="transactions"><a class="anchor" href="#transactions"></a>セッションとトランザクション</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First of all, most of the methods of a Panache entity must be invoked within the scope of a reactive <code>Mutiny.Session</code>.
In some cases, the session is opened automatically on demand.
For example, if a Panache entity method is invoked in a Jakarta REST resource method in an application that includes the <code>quarkus-resteasy-reactive</code> extension.
For other cases, there are both a declarative and a programmatic way to ensure the session is opened.
You can annotate a CDI business method that returns <code>Uni</code> with the <code>@WithSession</code> annotation.
The method will be intercepted and the returned <code>Uni</code> will be triggered within a scope of a reactive session.
Alternatively, you can use the <code>Panache.withSession()</code> method to achieve the same effect.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Panache エンティティーはブロッキングスレッドから使用できないことに注意してください。Quarkus のリアクティブ原則の基礎を説明する <a href="getting-started-reactive">リアクティブ入門</a> ガイドも参照してください。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>また、データベースを変更するメソッドや複数のクエリー (例: <code>entity.persist()</code>) を伴うメソッドをトランザクション内でラップしてください。
<code>Uni</code> を返す CDI ビジネスメソッドに <code>@WithTransaction</code> アノテーションを付けることができます。
メソッドはインターセプトされ、返された <code>Uni</code> はトランザクション境界内でトリガーされます。
または、 <code>Panache.withTransaction()</code> メソッドを使用して同じ効果を得ることもできます。</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Hibernate Reactive で <code>@Transactional</code> アノテーションをトランザクションに使用することはできません。 <code>@WithTransaction</code> を使用する必要があります。また、アノテーションが付けられたメソッドが非ブロッキングとなるように <code>Uni</code> を返す必要があります。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Hibernate Reactive は、エンティティーに加えられた変更をバッチ処理し、トランザクションの終了時またはクエリーの前に変更を送信します (これはフラッシュと呼ばれます)。
これは通常、より効率的であるため良いことです。
しかし、楽観的なロックの失敗をチェックしたり、オブジェクト検証をすぐに実行したり、一般的に即時のフィードバックを取得する場合は、 <code>entity.flush()</code> を呼び出してフラッシュ操作を強制したり、 <code>entity.persistAndFlush()</code> を使用して単一のメソッド呼び出しにすることができます。これにより、Hibernate Reactive がデータベースに変更を送信したときに発生する可能性のある <code>PersistenceException</code> をキャッチできます。
ただし、これは効率が悪いので乱用しないでください。
また、トランザクションは依然としてコミットされる必要があります。</p>
</div>
<div class="paragraph">
<p>ここでは <code>PersistenceException</code> が発生した場合に特定の動作を行えるようにするための flush メソッドの使用例を示します:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@WithTransaction
public Uni&lt;Void&gt; create(Person person){
    // Here we use the persistAndFlush() shorthand method on a Panache repository to persist to database then flush the changes.
    return person.persistAndFlush()
            .onFailure(PersistenceException.class)
            .recoverWithItem(() -&gt; {
                LOG.error("Unable to create the parameter", pe);
                //in case of error, I save it to disk
                diskPersister.save(person);
                return null;
            });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@WithTransaction</code> アノテーションもテストに使用できます。
これは、テスト中に行われた変更がデータベースに伝播されることを意味します。
テスト終了時に変更をロールバックする場合は、 <code>io.quarkus.test.TestReactiveTransaction</code> アノテーションを使用できます。
これにより、トランザクション内でテストメソッドが実行されますが、テストメソッドが完了するとロールバックされ、データベースの変更が元に戻ります。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lock-management"><a class="anchor" href="#lock-management"></a>ロック管理</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Panacheは <code>findById(Object, LockModeType)</code> や <code>find().withLock(LockModeType)</code> を使用してエンティティ/リポジトリでデータベースロックを直接サポートします。</p>
</div>
<div class="paragraph">
<p>以下の例はアクティブレコードパターンの場合ですが、リポジトリでも同じように使用できます。</p>
</div>
<div class="sect2">
<h3 id="first-locking-using-findbyid"><a class="anchor" href="#first-locking-using-findbyid"></a>1つ目: findById()を使ってロックする。</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class PersonEndpoint {

    @GET
    public Uni&lt;Person&gt; findByIdForUpdate(Long id){
        return Panache.withTransaction(() -&gt; {
            return Person.&lt;Person&gt;findById(id, LockModeType.PESSIMISTIC_WRITE)
                    .invoke(person -&gt; {
                        //do something useful, the lock will be released when the transaction ends.
                    });
        });
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="second-locking-in-a-find"><a class="anchor" href="#second-locking-in-a-find"></a>2つ目：find()でロックする。</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class PersonEndpoint {

    @GET
    public Uni&lt;Person&gt; findByNameForUpdate(String name){
        return Panache.withTransaction(() -&gt; {
            return Person.&lt;Person&gt;find("name", name).withLock(LockModeType.PESSIMISTIC_WRITE).firstResult()
                    .invoke(person -&gt; {
                        //do something useful, the lock will be released when the transaction ends.
                    });
        });
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>トランザクションが終了するとロックが解放されるため、ロッククエリーを呼び出すメソッドはトランザクション内で呼び出す必要があることに注意してください。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="custom-ids"><a class="anchor" href="#custom-ids"></a>カスタムID</h2>
<div class="sectionbody">
<div class="paragraph">
<p>IDは微妙な問題で、誰もがフレームワークに任せることができるわけではありませんが、今回も私たちはカバーします。</p>
</div>
<div class="paragraph">
<p><code>PanacheEntity</code> の代わりに <code>PanacheEntityBase</code> を拡張することで独自のID戦略を指定することができます。そのあとに好きなIDをパブリック・フィールドとして宣言するだけです:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person extends PanacheEntityBase {

    @Id
    @SequenceGenerator(
            name = "personSequence",
            sequenceName = "person_id_seq",
            allocationSize = 1,
            initialValue = 4)
    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "personSequence")
    public Integer id;

    //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>リポジトリを使用している場合は <code>PanacheRepository</code> の代わりに <code>PanacheRepositoryBase</code> を拡張し、IDの型を追加の型パラメーターとして指定することになります:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class PersonRepository implements PanacheRepositoryBase&lt;Person,Integer&gt; {
    //...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing"><a class="anchor" href="#testing"></a>テスト</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>@QuarkusTest</code> におけるリアクティブPanacheエンティティのテストは、APIの非同期性と、すべての操作がVert.xイベントループ上で実行される必要があるという事実のために、通常のPanacheエンティティのテストよりも若干複雑です。</p>
</div>
<div class="paragraph">
<p><code>quarkus-test-vertx</code> 依存関係は、まさにこの目的のために <code>@io.quarkus.test.vertx.RunOnVertxContext</code> アノテーションと <code>io.quarkus.test.vertx.UniAsserter</code> クラスを提供します。使用方法は、 <a href="hibernate-reactive#testing">Hibernate Reactive</a> ガイドに記載されています。</p>
</div>
<div class="paragraph">
<p>さらに、 <code>quarkus-test-hibernate-reactive-panache</code> 依存関係は、 <code>@RunOnVertxContext</code> でアノテーションが付けられたテストメソッドのメソッドパラメーターとして注入できる <code>io.quarkus.test.hibernate.reactive.panache.TransactionalUniAsserter</code> を提供します。
<code>TransactionalUniAsserter</code> は、各アサートメソッドを個別のリアクティブトランザクション内にラップする <code>io.quarkus.test.vertx.UniAsserterInterceptor</code> です。</p>
</div>
<div class="listingblock">
<div class="title"><code>TransactionalUniAsserter</code> 例</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.test.hibernate.reactive.panache.TransactionalUniAsserter;

@QuarkusTest
public class SomeTest {

    @Test
    @RunOnVertxContext
    public void testEntity(TransactionalUniAsserter asserter) {
        asserter.execute(() -&gt; new MyEntity().persist()); <i class="conum" data-value="1"></i><b>(1)</b>
        asserter.assertEquals(() -&gt; MyEntity.count(), 1l); <i class="conum" data-value="2"></i><b>(2)</b>
        asserter.execute(() -&gt; MyEntity.deleteAll()); <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>1 つ目のリアクティブトランザクションは、エンティティーを永続化するために使用されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>2 つ目のリアクティブトランザクションは、エンティティーをカウントするために使用されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>3 つ目のリアクティブトランザクションは、すべてのエンティティーを削除するために使用されます。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>もちろん、カスタムの <code>UniAsserterInterceptor</code> を定義して、注入された <code>UniAsserter</code> をラップし、動作をカスタマイズすることもできます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mocking"><a class="anchor" href="#mocking"></a>モック</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="using-the-active-record-pattern"><a class="anchor" href="#using-the-active-record-pattern"></a>アクティブレコードパターンの使用</h3>
<div class="paragraph">
<p>アクティブレコードパターンを使用している場合、Mockitoは静的メソッドのモックをサポートしていないため、直接使用することはできませんが、 <code>quarkus-panache-mock</code> モジュールを使用することで、Mockitoを使用して、あなた自身のメソッドを含む、提供されたすべての静的メソッドをモックすることができます。</p>
</div>
<div class="paragraph">
<p>この依存関係をビルドファイルに追加してください:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-panache-mock&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">testImplementation("io.quarkus:quarkus-panache-mock")</code></pre>
</div>
</div>
<div class="paragraph">
<p>このシンプルなエンティティがある場合に</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person extends PanacheEntity {

    public String name;

    public static Uni&lt;List&lt;Person&gt;&gt; findOrdered() {
        return find("ORDER BY name").list();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>モッキングテストはこのように書くことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.test.vertx.UniAsserter;
import io.quarkus.test.vertx.RunOnVertxContext;

@QuarkusTest
public class PanacheFunctionalityTest {

    @RunOnVertxContext <i class="conum" data-value="1"></i><b>(1)</b>
    @Test
    public void testPanacheMocking(UniAsserter asserter) { <i class="conum" data-value="2"></i><b>(2)</b>
        asserter.execute(() -&gt; PanacheMock.mock(Person.class));

        // Mocked classes always return a default value
        asserter.assertEquals(() -&gt; Person.count(), 0l);

        // Now let's specify the return value
        asserter.execute(() -&gt; Mockito.when(Person.count()).thenReturn(Uni.createFrom().item(23l)));
        asserter.assertEquals(() -&gt; Person.count(), 23l);

        // Now let's change the return value
        asserter.execute(() -&gt; Mockito.when(Person.count()).thenReturn(Uni.createFrom().item(42l)));
        asserter.assertEquals(() -&gt; Person.count(), 42l);

        // Now let's call the original method
        asserter.execute(() -&gt; Mockito.when(Person.count()).thenCallRealMethod());
        asserter.assertEquals(() -&gt; Person.count(), 0l);

        // Check that we called it 4 times
        asserter.execute(() -&gt; {
            PanacheMock.verify(Person.class, Mockito.times(4)).count(); <i class="conum" data-value="3"></i><b>(3)</b>
        });

        // Mock only with specific parameters
        asserter.execute(() -&gt; {
            Person p = new Person();
            Mockito.when(Person.findById(12l)).thenReturn(Uni.createFrom().item(p));
            asserter.putData(key, p);
        });
        asserter.assertThat(() -&gt; Person.findById(12l), p -&gt; Assertions.assertSame(p, asserter.getData(key)));
        asserter.assertNull(() -&gt; Person.findById(42l));

        // Mock throwing
        asserter.execute(() -&gt; Mockito.when(Person.findById(12l)).thenThrow(new WebApplicationException()));
        asserter.assertFailedWith(() -&gt; {
            try {
                return Person.findById(12l);
            } catch (Exception e) {
                return Uni.createFrom().failure(e);
            }
        }, t -&gt; assertEquals(WebApplicationException.class, t.getClass()));

        // We can even mock your custom methods
        asserter.execute(() -&gt; Mockito.when(Person.findOrdered()).thenReturn(Uni.createFrom().item(Collections.emptyList())));
        asserter.assertThat(() -&gt; Person.findOrdered(), list -&gt; list.isEmpty());

        asserter.execute(() -&gt; {
            PanacheMock.verify(Person.class).findOrdered();
            PanacheMock.verify(Person.class, Mockito.atLeastOnce()).findById(Mockito.any());
            PanacheMock.verifyNoMoreInteractions(Person.class);
        });

        // IMPORTANT: We need to execute the asserter within a reactive session
        asserter.surroundWith(u -&gt; Panache.withSession(() -&gt; u));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>テストメソッドがVert.xのイベントループで実行されるようにします。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>注入された <code>UniAsserter</code> 引数はアサーションを行うために使用されます。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>verify</code> と <code>do*</code> のメソッドは <code>Mockito</code> ではなく <code>PanacheMock</code> で呼び出すようにしてください。そうしないとどのモックオブジェクトを渡せばいいのかわからなくなってしまいます。</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="using-the-repository-pattern"><a class="anchor" href="#using-the-repository-pattern"></a>リポジトリパターンの使用</h3>
<div class="paragraph">
<p>リポジトリパターンを使用している場合は、 <code>quarkus-junit5-mockito</code> モジュールを使用して、Mockito を直接使用することができます。これにより、ビーンのモッキングが非常に簡単になります。</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-junit5-mockito&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">testImplementation("io.quarkus:quarkus-junit5-mockito")</code></pre>
</div>
</div>
<div class="paragraph">
<p>このシンプルなエンティティがある場合に</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person {

    @Id
    @GeneratedValue
    public Long id;

    public String name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>そしてこのリポジトリ。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class PersonRepository implements PanacheRepository&lt;Person&gt; {
    public Uni&lt;List&lt;Person&gt;&gt; findOrdered() {
        return find("ORDER BY name").list();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>モッキングテストはこのように書くことができます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.test.vertx.UniAsserter;
import io.quarkus.test.vertx.RunOnVertxContext;

@QuarkusTest
public class PanacheFunctionalityTest {
    @InjectMock
    PersonRepository personRepository;

    @RunOnVertxContext <i class="conum" data-value="1"></i><b>(1)</b>
    @Test
    public void testPanacheRepositoryMocking(UniAsserter asserter) { <i class="conum" data-value="2"></i><b>(2)</b>

        // Mocked classes always return a default value
        asserter.assertEquals(() -&gt; mockablePersonRepository.count(), 0l);

        // Now let's specify the return value
        asserter.execute(() -&gt; Mockito.when(mockablePersonRepository.count()).thenReturn(Uni.createFrom().item(23l)));
        asserter.assertEquals(() -&gt; mockablePersonRepository.count(), 23l);

        // Now let's change the return value
        asserter.execute(() -&gt; Mockito.when(mockablePersonRepository.count()).thenReturn(Uni.createFrom().item(42l)));
        asserter.assertEquals(() -&gt; mockablePersonRepository.count(), 42l);

        // Now let's call the original method
        asserter.execute(() -&gt; Mockito.when(mockablePersonRepository.count()).thenCallRealMethod());
        asserter.assertEquals(() -&gt; mockablePersonRepository.count(), 0l);

        // Check that we called it 4 times
        asserter.execute(() -&gt; {
            Mockito.verify(mockablePersonRepository, Mockito.times(4)).count();
        });

        // Mock only with specific parameters
        asserter.execute(() -&gt; {
            Person p = new Person();
            Mockito.when(mockablePersonRepository.findById(12l)).thenReturn(Uni.createFrom().item(p));
            asserter.putData(key, p);
        });
        asserter.assertThat(() -&gt; mockablePersonRepository.findById(12l), p -&gt; Assertions.assertSame(p, asserter.getData(key)));
        asserter.assertNull(() -&gt; mockablePersonRepository.findById(42l));

        // Mock throwing
        asserter.execute(() -&gt; Mockito.when(mockablePersonRepository.findById(12l)).thenThrow(new WebApplicationException()));
        asserter.assertFailedWith(() -&gt; {
            try {
                return mockablePersonRepository.findById(12l);
            } catch (Exception e) {
                return Uni.createFrom().failure(e);
            }
        }, t -&gt; assertEquals(WebApplicationException.class, t.getClass()));

        // We can even mock your custom methods
        asserter.execute(() -&gt; Mockito.when(mockablePersonRepository.findOrdered())
                .thenReturn(Uni.createFrom().item(Collections.emptyList())));
        asserter.assertThat(() -&gt; mockablePersonRepository.findOrdered(), list -&gt; list.isEmpty());

        asserter.execute(() -&gt; {
            Mockito.verify(mockablePersonRepository).findOrdered();
            Mockito.verify(mockablePersonRepository, Mockito.atLeastOnce()).findById(Mockito.any());
            Mockito.verify(mockablePersonRepository).persist(Mockito.&lt;Person&gt; any());
            Mockito.verifyNoMoreInteractions(mockablePersonRepository);
        });

        // IMPORTANT: We need to execute the asserter within a reactive session
        asserter.surroundWith(u -&gt; Panache.withSession(() -&gt; u));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>テストメソッドがVert.xのイベントループで実行されるようにします。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The injected <code>UniAsserter</code> agrument is used to make assertions.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="how-and-why-we-simplify-hibernate-reactive-mappings"><a class="anchor" href="#how-and-why-we-simplify-hibernate-reactive-mappings"></a>HibernateのReactiveマッピングを単純化する方法と理由</h2>
<div class="sectionbody">
<div class="paragraph">
<p>HibernateのReactiveエンティティを書くときに、ユーザーが不本意ながらも対処することに慣れてしまった、いくつかの厄介事があります:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>IDロジックの重複:ほとんどのエンティティにはIDが必要ですが、モデルとはあまり関係がないため、ほとんどの人はIDの設定方法を気にしません。</p>
</li>
<li>
<p>ダサいゲッターとセッター：Javaは言語でプロパティをサポートしていないので、フィールドに対して読み書きを行わなかったとしてもフィールドを作成し、そのフィールドのためにゲッターとセッターを生成しなければなりません。</p>
</li>
<li>
<p>オブジェクト指向アーキテクチャの通常のオブジェクトでは、ステートとメソッドが同じクラスにないことはあり得ないのに、伝統的なEEパターンでは、エンティティの定義（モデル）とそれに対する操作（DAOやリポジトリ）を分けることが推奨されており、実際にはステートとその操作を不自然に分ける必要があります。さらに、エンティティごとに2つのクラスが必要になり、エンティティの操作を行う必要があるDAOやRepositoryをインジェクションする必要があるため、編集フローが崩れ、書いているコードから抜けてインジェクションポイントを設定してから戻って使用しなければなりません。</p>
</li>
<li>
<p>Hibernateのクエリは非常に強力ですが、一般的な操作には冗長すぎるため、すべての部分が必要ない場合でもクエリを書く必要があります。</p>
</li>
<li>
<p>Hibernateは非常に汎用性が高いのですが、モデルの使用量の9割を占めるような些細な操作をしても些細にはなりません。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Panacheでは、これらの問題に対して、定見に基づいたアプローチをとりました。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>エンティティは <code>PanacheEntity</code> を拡張するようにしてください: 自動生成されるIDフィールドがあります。カスタムID戦略が必要な場合は代わりに <code>PanacheEntityBase</code> を拡張するとIDを自分で処理することができます。</p>
</li>
<li>
<p>パブリックフィールドを使ってください。無駄なゲッターとセッターを無くせます。フードの下では、不足しているすべてのゲッターとセッターを生成し、これらのフィールドへのすべてのアクセスを、アクセサ・メソッドを使用するように書き換えます。この方法では、必要なときに <em>便利な</em> アクセサを書くことができ、エンティティ・ユーザーがフィールド・アクセスを使用していても、それが使用されます。</p>
</li>
<li>
<p>アクティブレコードパターンの使用: アクティブレコードパターンでは、すべてのエンティティロジックをエンティティクラスのスタティックメソッドに置き、DAOを作りません。エンティティスーパークラスには、非常に便利なスタティックメソッドがたくさん用意されていますし、エンティティクラスに独自のメソッドを追加することもできます。 <code>Person</code> ユーザーは、 <code>Person</code> と入力するだけで、すべての操作を一か所で完了させることができます。</p>
</li>
<li>
<p><code>Person.find("order by name")</code> や <code>Person.find("name = ?1 and status = ?2", "stef", Status.Alive)</code> 、さらには <code>Person.find("name", "stef")</code> のように、必要のない部分を書かないようにしましょう。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以上、Panacheを使えば、Hibernate Reactiveがこれほどまでにすっきりするのかということでした。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="defining-entities-in-external-projects-or-jars"><a class="anchor" href="#defining-entities-in-external-projects-or-jars"></a>外部プロジェクトや jar でエンティティーを定義する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hibernate Reactive with Panacheは、コンパイル時のエンティティに対するバイトコード拡張に依存しています。</p>
</div>
<div class="paragraph">
<p>この機能は、マーカーファイル <code>META-INF/panache-archive.marker</code> の存在によって Panache エンティティー の存在するアーカイブ(および Panache エンティティーの消費者) を識別しようとします 。Panache にはアノテーション プロセッサーが含まれており、 (間接的であっても) Panache に依存しているアーカイヴでこのファイルを自動的に作成します。アノテーションプロセッサーを無効にしている場合は、場合によってはこのファイルを手動で作成する必要があるかもしれません。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
jpa-modelgenアノテーションプロセッサーをインクルードすると、デフォルトでPanacheアノテーションプロセッサが除外されます。この場合はマーカーファイルを自分で作成するか、以下のように <code>quarkus-panache-common</code> を追加する必要があります:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
    &lt;version&gt;${compiler-plugin.version}&lt;/version&gt;
    &lt;configuration&gt;
      &lt;annotationProcessorPaths&gt;
        &lt;annotationProcessorPath&gt;
          &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
          &lt;artifactId&gt;hibernate-jpamodelgen&lt;/artifactId&gt;
          &lt;version&gt;${hibernate.version}&lt;/version&gt;
        &lt;/annotationProcessorPath&gt;
        &lt;annotationProcessorPath&gt;
          &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
          &lt;artifactId&gt;quarkus-panache-common&lt;/artifactId&gt;
          &lt;version&gt;${quarkus.platform.version}&lt;/version&gt;
        &lt;/annotationProcessorPath&gt;
      &lt;/annotationProcessorPaths&gt;
    &lt;/configuration&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
</div>
</div>
    </div>
    <div class="grid__item width-4-12 width-12-12-m tocwrapper">
      <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#first-an-example">最初に:例</a></li>
<li><a href="#solution">ソリューション</a></li>
<li><a href="#setting-up-and-configuring-hibernate-reactive-with-panache">PanacheによるHibernate Reactiveのセットアップと設定</a></li>
<li><a href="#solution-1-using-the-active-record-pattern">解決策1:アクティブレコードパターンを使用する</a>
<ul class="sectlevel2">
<li><a href="#defining-your-entity">エンティティの定義</a></li>
<li><a href="#most-useful-operations">最も便利な操作</a></li>
<li><a href="#adding-entity-methods">エンティティメソッドの追加</a></li>
</ul>
</li>
<li><a href="#solution-2-using-the-repository-pattern">解決策2：リポジトリパターンの使用</a>
<ul class="sectlevel2">
<li><a href="#defining-your-entity-2">エンティティの定義</a></li>
<li><a href="#defining-your-repository">リポジトリの定義</a></li>
<li><a href="#most-useful-operations-2">最も便利な操作</a></li>
</ul>
</li>
<li><a href="#advanced-query">アドバンスドクエリー</a>
<ul class="sectlevel2">
<li><a href="#paging">ページング</a></li>
<li><a href="#using-a-range-instead-of-pages">ページではなく範囲を使用する</a></li>
<li><a href="#sorting">ソート</a></li>
<li><a href="#simplified-queries">シンプルなクエリ</a></li>
<li><a href="#named-queries">名前付きクエリー</a></li>
<li><a href="#query-parameters">クエリパラメーター</a></li>
<li><a href="#query-projection">クエリの射影レコード</a></li>
</ul>
</li>
<li><a href="#multiple-persistence-units">複数の永続性ユニット</a></li>
<li><a href="#transactions">セッションとトランザクション</a></li>
<li><a href="#lock-management">ロック管理</a>
<ul class="sectlevel2">
<li><a href="#first-locking-using-findbyid">1つ目: findById()を使ってロックする。</a></li>
<li><a href="#second-locking-in-a-find">2つ目：find()でロックする。</a></li>
</ul>
</li>
<li><a href="#custom-ids">カスタムID</a></li>
<li><a href="#testing">テスト</a></li>
<li><a href="#mocking">モック</a>
<ul class="sectlevel2">
<li><a href="#using-the-active-record-pattern">アクティブレコードパターンの使用</a></li>
<li><a href="#using-the-repository-pattern">リポジトリパターンの使用</a></li>
</ul>
</li>
<li><a href="#how-and-why-we-simplify-hibernate-reactive-mappings">HibernateのReactiveマッピングを単純化する方法と理由</a></li>
<li><a href="#defining-entities-in-external-projects-or-jars">外部プロジェクトや jar でエンティティーを定義する</a></li>
</ul></div>
    </div>
  </div>
  <h2>関連コンテンツ</h2>
  <div class="grid-wrapper relations">
    <div class="grid__item width-6-12 width-12-12-m">
      <h3>同じエクステンションについて</h3>
      <ul class="related-content">
      
        
        <li class="guide"><a href="/version/3.8/guides/hibernate-reactive">Hibernate Reactiveの使用</a></li>
      </ul>
    </div>
    <div class="grid__item width-6-12 width-12-12-m">
      <h3>同じトピックについて</h3>
      <ul class="related-content">
      
        
        <li class="guide"><a href="/version/3.8/guides/hibernate-orm-panache">Simplified Hibernate ORM with Panache</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/hibernate-orm-panache-kotlin">Simplified Hibernate ORM with PanacheとKotlin</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/hibernate-reactive">Hibernate Reactiveの使用</a></li>
      
        
        <li class="reference"><a href="/version/3.8/guides/datasource">Quarkusでデータソースを設定</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/rest-data-panache">PanacheでJakarta RESTリソースを生成する</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/reactive-sql-clients">リアクティブ SQL クライアント</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/mongodb-panache">シンプルになったMongoDB with Panache</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/mongodb-panache-kotlin">シンプルになったMongoDB with PanacheとKotlin</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/hibernate-orm">Hibernate ORMとJakarta Persistenceの使用</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/cache">アプリケーションデータのキャッシング</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/elasticsearch">Elasticsearchクラスターの実行</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/databases-dev-services">Dev Services for Databases</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/elasticsearch-dev-services">Dev Services for Elasticsearch</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/infinispan-dev-services">Dev Services for Infinispan</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/redis-dev-services">Dev Services for Redis</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/hibernate-search-orm-elasticsearch">Hibernate Search ガイド</a></li>
      
        
        <li class="reference"><a href="/version/3.8/guides/infinispan-client-reference">Infinispanクライアントエクステンションリファレンスガイド</a></li>
      
        
        <li class="guide"><a href="/version/3.8/guides/lra">Narayana LRA 参加者サポート</a></li>
      
        
        <li class="howto"><a href="/version/3.8/guides/security-jpa">Quarkus SecurityとJakarta Persistence</a></li>
      
        
        <li class="reference"><a href="/version/3.8/guides/cache-redis-reference">Redisキャッシュ</a></li>
      </ul>
    </div>
    </div>
  </div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license. <i class='fab fa-creative-commons'></i><i class='fab fa-creative-commons-by'></i> <a href='https://creativecommons.org/licenses/by/3.0/' target='_blank'>CC by 3.0</a><br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>GitHub Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>ナビゲーション</span>
        <ul class="footer-links">
          
          
            <li><a href="/" target="_blank">ホーム</a></li>
          
          
          
            <li><a href="/about" target="_blank">Quarkusについて</a></li>
          
          
          
            <li><a href="/blog" target="_blank">ブログ</a></li>
          
          
          
            <li><a href="/insights" target="_blank">ポッドキャスト</a></li>
          
          
          
            <li><a href="/events" target="_blank">イベント</a></li>
          
          
          
            <li><a href="/newsletter" target="_blank">ニュースレター</a></li>
          
          
          
            <li><a href="/userstories" target="_blank">ユーザーストーリー</a></li>
          
          
          
            <li><a href="https://github.com/orgs/quarkusio/projects/13/views/1" target="_blank">ロードマップ</a></li>
          
          
          
            <li><a href="/security" target="_blank">セキュリティ&nbsp;ポリシー</a></li>
          
          
          
            <li><a href="/usage" target="_blank">使用方法</a></li>
          
          
          
            <li><a href="https://github.com/commonhaus/artwork/tree/main/projects/quarkus" target="_blank">Brand</a></li>
          
          
          
            <li><a href="/desktopwallpapers" target="_blank">Wallpapers</a></li>
          
          
          
            <li><a href="https://www.redhat.com/en/about/privacy-policy" target="_blank">Privacy Policy</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>フォローする</span>
        <ul class="footer-links">
          
          
            <li><a href="https://x.com/quarkusio" target="_blank">X</a></li>
          
          
          
            <li><a href="https://bsky.app/profile/quarkus.io" target="_blank">Bluesky</a></li>
          
          
          
            <li><a rel="me" href="https://fosstodon.org/@quarkusio" target="_blank">Mastodon</a></li>
            
          
          
            <li><a href="https://www.threads.com/@quarkusio" target="_blank">Threads</a></li>
          
          
          
            <li><a href="https://www.facebook.com/quarkusio" target="_blank">Facebook</a></li>
          
          
          
            <li><a href="https://www.linkedin.com/company/quarkusio/" target="_blank">Linkedin</a></li>
          
          
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg" target="_blank">Youtube</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio" target="_blank">GitHub</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>ヘルプ</span>
        <ul class="footer-links">
          
          
            <li><a href="/support" target="_blank">サポート</a></li>
          
          
          
            <li><a href="/guides" target="_blank">ガイド</a></li>
          
          
          
            <li><a href="/faq" target="_blank">FAQ</a></li>
          
          
          
            <li><a href="/get-started" target="_blank">入門</a></li>
          
          
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus" target="_blank">Stack Overflow</a></li>
          
          
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions" target="_blank">ディスカッション</a></li>
          
          
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev" target="_blank">開発メーリングリスト</a></li>
          
          
          
            <li><a href="https://stats.uptimerobot.com/ze1PfweT2p" target="_blank">Quarkus Service Status</a></li>
          
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>言語</span>
        <ul class="footer-links">
          
          
            <li><a href=" https://quarkus.io/ " target="_blank">English</a></li>
          
          
          
            <li><a href="https://pt.quarkus.io/" target="_blank">Português&nbsp;(Brasileiro)</a></li>
          
          
          
            <li><a href=" https://es.quarkus.io/ " target="_blank">Español</a></li>
          
          
          
            <li><a href="https://cn.quarkus.io/" target="_blank">简体中文</a></li>
          
          
          
            <li><a href=" https://ja.quarkus.io/ " target="_blank">日本語</a></li>
          
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkusはコミュニティプロジェクトで構成されています</span>
        <ul class="footer-links">
          
            <li><a blah href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a blah href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a blah href="https://hibernate.org" target="_blank">Hibernate ORM</a></li>
          
            <li><a blah href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a blah href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a blah href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a blah href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a blah href="https://code.quarkus.io/" target="_blank">その他多数...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content cf-footer">
  <div class="flexcontainer">
    <div class="cf-logo">
      <a class="cf-logo" href="https://www.commonhaus.org/" target="_blank"><img src="https://raw.githubusercontent.com/commonhaus/artwork/main/foundation/brand/svg/CF_logo_horizontal_single_reverse.svg"/></a>
    </div>
    <div class="license">
      Copyright © Quarkus. All rights reserved. For details on our trademarks, please visit our <a href="https://www.commonhaus.org/policies/trademark-policy/">Trademark Policy</a> and <a href="https://www.commonhaus.org/trademarks/">Trademark List</a>. Trademarks of third parties are owned by their respective holders and their mention here does not suggest any endorsement or association.
    </div>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
  <script src="/assets/javascript/future-date.js" type="text/javascript"></script>
  <script src="/assets/javascript/randomize.js" type="text/javascript"></script>
  <script src="/assets/javascript/time.js" type="text/javascript"></script>
</body>

</html>
